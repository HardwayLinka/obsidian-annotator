{"version":3,"file":"annotator.bundle.js","sources":["app:///../../node_modules/focus-visible/dist/focus-visible.js","app:///../../node_modules/preact/dist/preact.mjs","app:///../../node_modules/preact/devtools/dist/devtools.mjs","app:///../../node_modules/preact/debug/dist/debug.mjs","app:///../../node_modules/classnames/index.js","app:///../../node_modules/preact/hooks/dist/hooks.mjs","app:///../../node_modules/preact/jsx-runtime/dist/jsxRuntime.mjs","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/SvgIcon.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/buttons.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/Checkbox.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/Dialog.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/Icon.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/Link.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/Panel.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/Spinner.js","app:///../../src/annotator/icons.js","app:///../../src/shared/listener-collection.ts","app:///../../src/shared/random.js","app:///../../src/shared/messaging/port-util.js","app:///../../src/shared/messaging/port-finder.js","app:///../../node_modules/tiny-emitter/index.js","app:///../../src/shared/frame-error-capture.js","app:///../../src/shared/messaging/port-provider.js","app:///../../src/shared/messaging/port-rpc.js","app:///../../src/shared/has-own.js","app:///../../src/boot/parse-json-config.js","app:///../../src/shared/type-coercions.js","app:///../../src/annotator/config/url-from-link-tag.js","app:///../../src/annotator/config/settings.js","app:///../../src/annotator/config/config-func-settings-from.js","app:///../../src/annotator/config/index.js","app:///../../src/annotator/config/is-browser-extension.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/icons/Annotate.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/icons/CaretLeft.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/icons/CaretRight.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/icons/Highlight.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/icons/PointerDown.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/icons/PointerUp.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/data/ScrollContext.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/data/TableContext.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/data/TableSectionContext.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/input/ButtonBase.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/input/InputGroup.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/navigation/LinkBase.js","app:///../../node_modules/@hypothesis/frontend-shared/lib/components/navigation/Link.js","app:///../../src/shared/shortcut.js","app:///../../src/annotator/components/AdderToolbar.tsx","app:///../../src/shared/user-agent.js","app:///../../src/annotator/util/shadow-root.js","app:///../../src/annotator/adder.js","app:///../../src/annotator/anchoring/text-range.js","app:///../../src/annotator/anchoring/placeholder.js","app:///../../src/annotator/range-util.js","app:///../../src/annotator/highlighter.js","app:///../../src/annotator/bucket-bar-client.js","app:///../../src/annotator/util/buckets.js","app:///../../src/shared/warn-once.js","app:///../../src/annotator/features.js","app:///../../node_modules/approx-string-match/build/src/index.js","app:///../../src/annotator/anchoring/match-quote.js","app:///../../src/annotator/anchoring/xpath.js","app:///../../src/annotator/anchoring/types.js","app:///../../src/annotator/anchoring/html.js","app:///../../src/annotator/util/url.js","app:///../../src/annotator/integrations/html-metadata.js","app:///../../src/annotator/util/geometry.js","app:///../../src/annotator/integrations/html-side-by-side.js","app:///../../src/annotator/util/navigation-observer.js","app:///../../node_modules/scroll-into-view/scrollIntoView.js","app:///../../src/annotator/util/scroll.js","app:///../../src/annotator/integrations/html.js","app:///../../node_modules/lodash.debounce/index.js","app:///../../src/annotator/util/normalize.js","app:///../../src/annotator/anchoring/pdf.js","app:///../../src/annotator/components/Banners.js","app:///../../src/annotator/components/ContentInfoBanner.js","app:///../../src/annotator/components/WarningBanner.js","app:///../../src/annotator/integrations/pdf-metadata.js","app:///../../src/annotator/integrations/pdf.js","app:///../../src/annotator/frame-observer.js","app:///../../src/annotator/integrations/image-text-layer.js","app:///../../src/annotator/hypothesis-injector.js","app:///../../src/annotator/integrations/vitalsource.js","app:///../../src/annotator/integrations/index.js","app:///../../src/annotator/selection-observer.js","app:///../../src/annotator/guest.js","app:///../../src/annotator/util/frame.js","app:///../../src/shared/config-fragment.js","app:///../../src/annotator/config/app.js","app:///../../src/annotator/components/NotebookModal.js","app:///../../src/annotator/notebook.js","app:///../../node_modules/hammerjs/hammer.js","app:///../../src/annotator/components/Buckets.js","app:///../../src/annotator/bucket-bar.js","app:///../../src/annotator/components/Toolbar.js","app:///../../src/annotator/toolbar.js","app:///../../src/annotator/sidebar.js","app:///../../src/annotator/annotation-counts.js","app:///../../src/annotator/sidebar-trigger.js","app:///../../src/annotator/util/emitter.js","app:///../../src/annotator/index.js"],"sourcesContent":["(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory() :\n  typeof define === 'function' && define.amd ? define(factory) :\n  (factory());\n}(this, (function () { 'use strict';\n\n  /**\n   * Applies the :focus-visible polyfill at the given scope.\n   * A scope in this case is either the top-level Document or a Shadow Root.\n   *\n   * @param {(Document|ShadowRoot)} scope\n   * @see https://github.com/WICG/focus-visible\n   */\n  function applyFocusVisiblePolyfill(scope) {\n    var hadKeyboardEvent = true;\n    var hadFocusVisibleRecently = false;\n    var hadFocusVisibleRecentlyTimeout = null;\n\n    var inputTypesAllowlist = {\n      text: true,\n      search: true,\n      url: true,\n      tel: true,\n      email: true,\n      password: true,\n      number: true,\n      date: true,\n      month: true,\n      week: true,\n      time: true,\n      datetime: true,\n      'datetime-local': true\n    };\n\n    /**\n     * Helper function for legacy browsers and iframes which sometimes focus\n     * elements like document, body, and non-interactive SVG.\n     * @param {Element} el\n     */\n    function isValidFocusTarget(el) {\n      if (\n        el &&\n        el !== document &&\n        el.nodeName !== 'HTML' &&\n        el.nodeName !== 'BODY' &&\n        'classList' in el &&\n        'contains' in el.classList\n      ) {\n        return true;\n      }\n      return false;\n    }\n\n    /**\n     * Computes whether the given element should automatically trigger the\n     * `focus-visible` class being added, i.e. whether it should always match\n     * `:focus-visible` when focused.\n     * @param {Element} el\n     * @return {boolean}\n     */\n    function focusTriggersKeyboardModality(el) {\n      var type = el.type;\n      var tagName = el.tagName;\n\n      if (tagName === 'INPUT' && inputTypesAllowlist[type] && !el.readOnly) {\n        return true;\n      }\n\n      if (tagName === 'TEXTAREA' && !el.readOnly) {\n        return true;\n      }\n\n      if (el.isContentEditable) {\n        return true;\n      }\n\n      return false;\n    }\n\n    /**\n     * Add the `focus-visible` class to the given element if it was not added by\n     * the author.\n     * @param {Element} el\n     */\n    function addFocusVisibleClass(el) {\n      if (el.classList.contains('focus-visible')) {\n        return;\n      }\n      el.classList.add('focus-visible');\n      el.setAttribute('data-focus-visible-added', '');\n    }\n\n    /**\n     * Remove the `focus-visible` class from the given element if it was not\n     * originally added by the author.\n     * @param {Element} el\n     */\n    function removeFocusVisibleClass(el) {\n      if (!el.hasAttribute('data-focus-visible-added')) {\n        return;\n      }\n      el.classList.remove('focus-visible');\n      el.removeAttribute('data-focus-visible-added');\n    }\n\n    /**\n     * If the most recent user interaction was via the keyboard;\n     * and the key press did not include a meta, alt/option, or control key;\n     * then the modality is keyboard. Otherwise, the modality is not keyboard.\n     * Apply `focus-visible` to any current active element and keep track\n     * of our keyboard modality state with `hadKeyboardEvent`.\n     * @param {KeyboardEvent} e\n     */\n    function onKeyDown(e) {\n      if (e.metaKey || e.altKey || e.ctrlKey) {\n        return;\n      }\n\n      if (isValidFocusTarget(scope.activeElement)) {\n        addFocusVisibleClass(scope.activeElement);\n      }\n\n      hadKeyboardEvent = true;\n    }\n\n    /**\n     * If at any point a user clicks with a pointing device, ensure that we change\n     * the modality away from keyboard.\n     * This avoids the situation where a user presses a key on an already focused\n     * element, and then clicks on a different element, focusing it with a\n     * pointing device, while we still think we're in keyboard modality.\n     * @param {Event} e\n     */\n    function onPointerDown(e) {\n      hadKeyboardEvent = false;\n    }\n\n    /**\n     * On `focus`, add the `focus-visible` class to the target if:\n     * - the target received focus as a result of keyboard navigation, or\n     * - the event target is an element that will likely require interaction\n     *   via the keyboard (e.g. a text box)\n     * @param {Event} e\n     */\n    function onFocus(e) {\n      // Prevent IE from focusing the document or HTML element.\n      if (!isValidFocusTarget(e.target)) {\n        return;\n      }\n\n      if (hadKeyboardEvent || focusTriggersKeyboardModality(e.target)) {\n        addFocusVisibleClass(e.target);\n      }\n    }\n\n    /**\n     * On `blur`, remove the `focus-visible` class from the target.\n     * @param {Event} e\n     */\n    function onBlur(e) {\n      if (!isValidFocusTarget(e.target)) {\n        return;\n      }\n\n      if (\n        e.target.classList.contains('focus-visible') ||\n        e.target.hasAttribute('data-focus-visible-added')\n      ) {\n        // To detect a tab/window switch, we look for a blur event followed\n        // rapidly by a visibility change.\n        // If we don't see a visibility change within 100ms, it's probably a\n        // regular focus change.\n        hadFocusVisibleRecently = true;\n        window.clearTimeout(hadFocusVisibleRecentlyTimeout);\n        hadFocusVisibleRecentlyTimeout = window.setTimeout(function() {\n          hadFocusVisibleRecently = false;\n        }, 100);\n        removeFocusVisibleClass(e.target);\n      }\n    }\n\n    /**\n     * If the user changes tabs, keep track of whether or not the previously\n     * focused element had .focus-visible.\n     * @param {Event} e\n     */\n    function onVisibilityChange(e) {\n      if (document.visibilityState === 'hidden') {\n        // If the tab becomes active again, the browser will handle calling focus\n        // on the element (Safari actually calls it twice).\n        // If this tab change caused a blur on an element with focus-visible,\n        // re-apply the class when the user switches back to the tab.\n        if (hadFocusVisibleRecently) {\n          hadKeyboardEvent = true;\n        }\n        addInitialPointerMoveListeners();\n      }\n    }\n\n    /**\n     * Add a group of listeners to detect usage of any pointing devices.\n     * These listeners will be added when the polyfill first loads, and anytime\n     * the window is blurred, so that they are active when the window regains\n     * focus.\n     */\n    function addInitialPointerMoveListeners() {\n      document.addEventListener('mousemove', onInitialPointerMove);\n      document.addEventListener('mousedown', onInitialPointerMove);\n      document.addEventListener('mouseup', onInitialPointerMove);\n      document.addEventListener('pointermove', onInitialPointerMove);\n      document.addEventListener('pointerdown', onInitialPointerMove);\n      document.addEventListener('pointerup', onInitialPointerMove);\n      document.addEventListener('touchmove', onInitialPointerMove);\n      document.addEventListener('touchstart', onInitialPointerMove);\n      document.addEventListener('touchend', onInitialPointerMove);\n    }\n\n    function removeInitialPointerMoveListeners() {\n      document.removeEventListener('mousemove', onInitialPointerMove);\n      document.removeEventListener('mousedown', onInitialPointerMove);\n      document.removeEventListener('mouseup', onInitialPointerMove);\n      document.removeEventListener('pointermove', onInitialPointerMove);\n      document.removeEventListener('pointerdown', onInitialPointerMove);\n      document.removeEventListener('pointerup', onInitialPointerMove);\n      document.removeEventListener('touchmove', onInitialPointerMove);\n      document.removeEventListener('touchstart', onInitialPointerMove);\n      document.removeEventListener('touchend', onInitialPointerMove);\n    }\n\n    /**\n     * When the polfyill first loads, assume the user is in keyboard modality.\n     * If any event is received from a pointing device (e.g. mouse, pointer,\n     * touch), turn off keyboard modality.\n     * This accounts for situations where focus enters the page from the URL bar.\n     * @param {Event} e\n     */\n    function onInitialPointerMove(e) {\n      // Work around a Safari quirk that fires a mousemove on <html> whenever the\n      // window blurs, even if you're tabbing out of the page. ¯\\_(ツ)_/¯\n      if (e.target.nodeName && e.target.nodeName.toLowerCase() === 'html') {\n        return;\n      }\n\n      hadKeyboardEvent = false;\n      removeInitialPointerMoveListeners();\n    }\n\n    // For some kinds of state, we are interested in changes at the global scope\n    // only. For example, global pointer input, global key presses and global\n    // visibility change should affect the state at every scope:\n    document.addEventListener('keydown', onKeyDown, true);\n    document.addEventListener('mousedown', onPointerDown, true);\n    document.addEventListener('pointerdown', onPointerDown, true);\n    document.addEventListener('touchstart', onPointerDown, true);\n    document.addEventListener('visibilitychange', onVisibilityChange, true);\n\n    addInitialPointerMoveListeners();\n\n    // For focus and blur, we specifically care about state changes in the local\n    // scope. This is because focus / blur events that originate from within a\n    // shadow root are not re-dispatched from the host element if it was already\n    // the active element in its own scope:\n    scope.addEventListener('focus', onFocus, true);\n    scope.addEventListener('blur', onBlur, true);\n\n    // We detect that a node is a ShadowRoot by ensuring that it is a\n    // DocumentFragment and also has a host property. This check covers native\n    // implementation and polyfill implementation transparently. If we only cared\n    // about the native implementation, we could just check if the scope was\n    // an instance of a ShadowRoot.\n    if (scope.nodeType === Node.DOCUMENT_FRAGMENT_NODE && scope.host) {\n      // Since a ShadowRoot is a special kind of DocumentFragment, it does not\n      // have a root element to add a class to. So, we add this attribute to the\n      // host element instead:\n      scope.host.setAttribute('data-js-focus-visible', '');\n    } else if (scope.nodeType === Node.DOCUMENT_NODE) {\n      document.documentElement.classList.add('js-focus-visible');\n      document.documentElement.setAttribute('data-js-focus-visible', '');\n    }\n  }\n\n  // It is important to wrap all references to global window and document in\n  // these checks to support server-side rendering use cases\n  // @see https://github.com/WICG/focus-visible/issues/199\n  if (typeof window !== 'undefined' && typeof document !== 'undefined') {\n    // Make the polyfill helper globally available. This can be used as a signal\n    // to interested libraries that wish to coordinate with the polyfill for e.g.,\n    // applying the polyfill to a shadow root:\n    window.applyFocusVisiblePolyfill = applyFocusVisiblePolyfill;\n\n    // Notify interested libraries of the polyfill's presence, in case the\n    // polyfill was loaded lazily:\n    var event;\n\n    try {\n      event = new CustomEvent('focus-visible-polyfill-ready');\n    } catch (error) {\n      // IE11 does not support using CustomEvent as a constructor directly:\n      event = document.createEvent('CustomEvent');\n      event.initCustomEvent('focus-visible-polyfill-ready', false, false, {});\n    }\n\n    window.dispatchEvent(event);\n  }\n\n  if (typeof document !== 'undefined') {\n    // Apply the polyfill to the global document, so that no JavaScript\n    // coordination is required to use the polyfill in the top-level document:\n    applyFocusVisiblePolyfill(document);\n  }\n\n})));\n","var n,l,u,i,t,o,r,f,e={},c=[],s=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function a(n,l){for(var u in l)n[u]=l[u];return n}function h(n){var l=n.parentNode;l&&l.removeChild(n)}function v(l,u,i){var t,o,r,f={};for(r in u)\"key\"==r?t=u[r]:\"ref\"==r?o=u[r]:f[r]=u[r];if(arguments.length>2&&(f.children=arguments.length>3?n.call(arguments,2):i),\"function\"==typeof l&&null!=l.defaultProps)for(r in l.defaultProps)void 0===f[r]&&(f[r]=l.defaultProps[r]);return y(l,f,t,o,null)}function y(n,i,t,o,r){var f={type:n,props:i,key:t,ref:o,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==r?++u:r};return null==r&&null!=l.vnode&&l.vnode(f),f}function p(){return{current:null}}function d(n){return n.children}function _(n,l){this.props=n,this.context=l}function k(n,l){if(null==l)return n.__?k(n.__,n.__.__k.indexOf(n)+1):null;for(var u;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e)return u.__e;return\"function\"==typeof n.type?k(n):null}function b(n){var l,u;if(null!=(n=n.__)&&null!=n.__c){for(n.__e=n.__c.base=null,l=0;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e){n.__e=n.__c.base=u.__e;break}return b(n)}}function m(n){(!n.__d&&(n.__d=!0)&&t.push(n)&&!g.__r++||r!==l.debounceRendering)&&((r=l.debounceRendering)||o)(g)}function g(){for(var n;g.__r=t.length;)n=t.sort(function(n,l){return n.__v.__b-l.__v.__b}),t=[],n.some(function(n){var l,u,i,t,o,r;n.__d&&(o=(t=(l=n).__v).__e,(r=l.__P)&&(u=[],(i=a({},t)).__v=t.__v+1,j(r,t,i,l.__n,void 0!==r.ownerSVGElement,null!=t.__h?[o]:null,u,null==o?k(t):o,t.__h),z(u,t),t.__e!=o&&b(t)))})}function w(n,l,u,i,t,o,r,f,s,a){var h,v,p,_,b,m,g,w=i&&i.__k||c,A=w.length;for(u.__k=[],h=0;h<l.length;h++)if(null!=(_=u.__k[h]=null==(_=l[h])||\"boolean\"==typeof _?null:\"string\"==typeof _||\"number\"==typeof _||\"bigint\"==typeof _?y(null,_,null,null,_):Array.isArray(_)?y(d,{children:_},null,null,null):_.__b>0?y(_.type,_.props,_.key,null,_.__v):_)){if(_.__=u,_.__b=u.__b+1,null===(p=w[h])||p&&_.key==p.key&&_.type===p.type)w[h]=void 0;else for(v=0;v<A;v++){if((p=w[v])&&_.key==p.key&&_.type===p.type){w[v]=void 0;break}p=null}j(n,_,p=p||e,t,o,r,f,s,a),b=_.__e,(v=_.ref)&&p.ref!=v&&(g||(g=[]),p.ref&&g.push(p.ref,null,_),g.push(v,_.__c||b,_)),null!=b?(null==m&&(m=b),\"function\"==typeof _.type&&_.__k===p.__k?_.__d=s=x(_,s,n):s=P(n,_,p,w,b,s),\"function\"==typeof u.type&&(u.__d=s)):s&&p.__e==s&&s.parentNode!=n&&(s=k(p))}for(u.__e=m,h=A;h--;)null!=w[h]&&(\"function\"==typeof u.type&&null!=w[h].__e&&w[h].__e==u.__d&&(u.__d=k(i,h+1)),N(w[h],w[h]));if(g)for(h=0;h<g.length;h++)M(g[h],g[++h],g[++h])}function x(n,l,u){for(var i,t=n.__k,o=0;t&&o<t.length;o++)(i=t[o])&&(i.__=n,l=\"function\"==typeof i.type?x(i,l,u):P(u,i,i,t,i.__e,l));return l}function A(n,l){return l=l||[],null==n||\"boolean\"==typeof n||(Array.isArray(n)?n.some(function(n){A(n,l)}):l.push(n)),l}function P(n,l,u,i,t,o){var r,f,e;if(void 0!==l.__d)r=l.__d,l.__d=void 0;else if(null==u||t!=o||null==t.parentNode)n:if(null==o||o.parentNode!==n)n.appendChild(t),r=null;else{for(f=o,e=0;(f=f.nextSibling)&&e<i.length;e+=2)if(f==t)break n;n.insertBefore(t,o),r=o}return void 0!==r?r:t.nextSibling}function C(n,l,u,i,t){var o;for(o in u)\"children\"===o||\"key\"===o||o in l||H(n,o,null,u[o],i);for(o in l)t&&\"function\"!=typeof l[o]||\"children\"===o||\"key\"===o||\"value\"===o||\"checked\"===o||u[o]===l[o]||H(n,o,l[o],u[o],i)}function $(n,l,u){\"-\"===l[0]?n.setProperty(l,u):n[l]=null==u?\"\":\"number\"!=typeof u||s.test(l)?u:u+\"px\"}function H(n,l,u,i,t){var o;n:if(\"style\"===l)if(\"string\"==typeof u)n.style.cssText=u;else{if(\"string\"==typeof i&&(n.style.cssText=i=\"\"),i)for(l in i)u&&l in u||$(n.style,l,\"\");if(u)for(l in u)i&&u[l]===i[l]||$(n.style,l,u[l])}else if(\"o\"===l[0]&&\"n\"===l[1])o=l!==(l=l.replace(/Capture$/,\"\")),l=l.toLowerCase()in n?l.toLowerCase().slice(2):l.slice(2),n.l||(n.l={}),n.l[l+o]=u,u?i||n.addEventListener(l,o?T:I,o):n.removeEventListener(l,o?T:I,o);else if(\"dangerouslySetInnerHTML\"!==l){if(t)l=l.replace(/xlink(H|:h)/,\"h\").replace(/sName$/,\"s\");else if(\"href\"!==l&&\"list\"!==l&&\"form\"!==l&&\"tabIndex\"!==l&&\"download\"!==l&&l in n)try{n[l]=null==u?\"\":u;break n}catch(n){}\"function\"==typeof u||(null!=u&&(!1!==u||\"a\"===l[0]&&\"r\"===l[1])?n.setAttribute(l,u):n.removeAttribute(l))}}function I(n){this.l[n.type+!1](l.event?l.event(n):n)}function T(n){this.l[n.type+!0](l.event?l.event(n):n)}function j(n,u,i,t,o,r,f,e,c){var s,h,v,y,p,k,b,m,g,x,A,P=u.type;if(void 0!==u.constructor)return null;null!=i.__h&&(c=i.__h,e=u.__e=i.__e,u.__h=null,r=[e]),(s=l.__b)&&s(u);try{n:if(\"function\"==typeof P){if(m=u.props,g=(s=P.contextType)&&t[s.__c],x=s?g?g.props.value:s.__:t,i.__c?b=(h=u.__c=i.__c).__=h.__E:(\"prototype\"in P&&P.prototype.render?u.__c=h=new P(m,x):(u.__c=h=new _(m,x),h.constructor=P,h.render=O),g&&g.sub(h),h.props=m,h.state||(h.state={}),h.context=x,h.__n=t,v=h.__d=!0,h.__h=[]),null==h.__s&&(h.__s=h.state),null!=P.getDerivedStateFromProps&&(h.__s==h.state&&(h.__s=a({},h.__s)),a(h.__s,P.getDerivedStateFromProps(m,h.__s))),y=h.props,p=h.state,v)null==P.getDerivedStateFromProps&&null!=h.componentWillMount&&h.componentWillMount(),null!=h.componentDidMount&&h.__h.push(h.componentDidMount);else{if(null==P.getDerivedStateFromProps&&m!==y&&null!=h.componentWillReceiveProps&&h.componentWillReceiveProps(m,x),!h.__e&&null!=h.shouldComponentUpdate&&!1===h.shouldComponentUpdate(m,h.__s,x)||u.__v===i.__v){h.props=m,h.state=h.__s,u.__v!==i.__v&&(h.__d=!1),h.__v=u,u.__e=i.__e,u.__k=i.__k,u.__k.forEach(function(n){n&&(n.__=u)}),h.__h.length&&f.push(h);break n}null!=h.componentWillUpdate&&h.componentWillUpdate(m,h.__s,x),null!=h.componentDidUpdate&&h.__h.push(function(){h.componentDidUpdate(y,p,k)})}h.context=x,h.props=m,h.state=h.__s,(s=l.__r)&&s(u),h.__d=!1,h.__v=u,h.__P=n,s=h.render(h.props,h.state,h.context),h.state=h.__s,null!=h.getChildContext&&(t=a(a({},t),h.getChildContext())),v||null==h.getSnapshotBeforeUpdate||(k=h.getSnapshotBeforeUpdate(y,p)),A=null!=s&&s.type===d&&null==s.key?s.props.children:s,w(n,Array.isArray(A)?A:[A],u,i,t,o,r,f,e,c),h.base=u.__e,u.__h=null,h.__h.length&&f.push(h),b&&(h.__E=h.__=null),h.__e=!1}else null==r&&u.__v===i.__v?(u.__k=i.__k,u.__e=i.__e):u.__e=L(i.__e,u,i,t,o,r,f,c);(s=l.diffed)&&s(u)}catch(n){u.__v=null,(c||null!=r)&&(u.__e=e,u.__h=!!c,r[r.indexOf(e)]=null),l.__e(n,u,i)}}function z(n,u){l.__c&&l.__c(u,n),n.some(function(u){try{n=u.__h,u.__h=[],n.some(function(n){n.call(u)})}catch(n){l.__e(n,u.__v)}})}function L(l,u,i,t,o,r,f,c){var s,a,v,y=i.props,p=u.props,d=u.type,_=0;if(\"svg\"===d&&(o=!0),null!=r)for(;_<r.length;_++)if((s=r[_])&&\"setAttribute\"in s==!!d&&(d?s.localName===d:3===s.nodeType)){l=s,r[_]=null;break}if(null==l){if(null===d)return document.createTextNode(p);l=o?document.createElementNS(\"http://www.w3.org/2000/svg\",d):document.createElement(d,p.is&&p),r=null,c=!1}if(null===d)y===p||c&&l.data===p||(l.data=p);else{if(r=r&&n.call(l.childNodes),a=(y=i.props||e).dangerouslySetInnerHTML,v=p.dangerouslySetInnerHTML,!c){if(null!=r)for(y={},_=0;_<l.attributes.length;_++)y[l.attributes[_].name]=l.attributes[_].value;(v||a)&&(v&&(a&&v.__html==a.__html||v.__html===l.innerHTML)||(l.innerHTML=v&&v.__html||\"\"))}if(C(l,p,y,o,c),v)u.__k=[];else if(_=u.props.children,w(l,Array.isArray(_)?_:[_],u,i,t,o&&\"foreignObject\"!==d,r,f,r?r[0]:i.__k&&k(i,0),c),null!=r)for(_=r.length;_--;)null!=r[_]&&h(r[_]);c||(\"value\"in p&&void 0!==(_=p.value)&&(_!==l.value||\"progress\"===d&&!_||\"option\"===d&&_!==y.value)&&H(l,\"value\",_,y.value,!1),\"checked\"in p&&void 0!==(_=p.checked)&&_!==l.checked&&H(l,\"checked\",_,y.checked,!1))}return l}function M(n,u,i){try{\"function\"==typeof n?n(u):n.current=u}catch(n){l.__e(n,i)}}function N(n,u,i){var t,o;if(l.unmount&&l.unmount(n),(t=n.ref)&&(t.current&&t.current!==n.__e||M(t,null,u)),null!=(t=n.__c)){if(t.componentWillUnmount)try{t.componentWillUnmount()}catch(n){l.__e(n,u)}t.base=t.__P=null}if(t=n.__k)for(o=0;o<t.length;o++)t[o]&&N(t[o],u,\"function\"!=typeof n.type);i||null==n.__e||h(n.__e),n.__e=n.__d=void 0}function O(n,l,u){return this.constructor(n,u)}function S(u,i,t){var o,r,f;l.__&&l.__(u,i),r=(o=\"function\"==typeof t)?null:t&&t.__k||i.__k,f=[],j(i,u=(!o&&t||i).__k=v(d,null,[u]),r||e,e,void 0!==i.ownerSVGElement,!o&&t?[t]:r?null:i.firstChild?n.call(i.childNodes):null,f,!o&&t?t:r?r.__e:i.firstChild,o),z(f,u)}function q(n,l){S(n,l,q)}function B(l,u,i){var t,o,r,f=a({},l.props);for(r in u)\"key\"==r?t=u[r]:\"ref\"==r?o=u[r]:f[r]=u[r];return arguments.length>2&&(f.children=arguments.length>3?n.call(arguments,2):i),y(l.type,f,t||l.key,o||l.ref,null)}function D(n,l){var u={__c:l=\"__cC\"+f++,__:n,Consumer:function(n,l){return n.children(l)},Provider:function(n){var u,i;return this.getChildContext||(u=[],(i={})[l]=this,this.getChildContext=function(){return i},this.shouldComponentUpdate=function(n){this.props.value!==n.value&&u.some(m)},this.sub=function(n){u.push(n);var l=n.componentWillUnmount;n.componentWillUnmount=function(){u.splice(u.indexOf(n),1),l&&l.call(n)}}),n.children}};return u.Provider.__=u.Consumer.contextType=u}n=c.slice,l={__e:function(n,l,u,i){for(var t,o,r;l=l.__;)if((t=l.__c)&&!t.__)try{if((o=t.constructor)&&null!=o.getDerivedStateFromError&&(t.setState(o.getDerivedStateFromError(n)),r=t.__d),null!=t.componentDidCatch&&(t.componentDidCatch(n,i||{}),r=t.__d),r)return t.__E=t}catch(l){n=l}throw n}},u=0,i=function(n){return null!=n&&void 0===n.constructor},_.prototype.setState=function(n,l){var u;u=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=a({},this.state),\"function\"==typeof n&&(n=n(a({},u),this.props)),n&&a(u,n),null!=n&&this.__v&&(l&&this.__h.push(l),m(this))},_.prototype.forceUpdate=function(n){this.__v&&(this.__e=!0,n&&this.__h.push(n),m(this))},_.prototype.render=d,t=[],o=\"function\"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,g.__r=0,f=0;export{S as render,q as hydrate,v as createElement,v as h,d as Fragment,p as createRef,i as isValidElement,_ as Component,B as cloneElement,D as createContext,A as toChildArray,l as options};\n//# sourceMappingURL=preact.module.js.map\n","import{options as n,Fragment as o,Component as e}from\"preact\";function t(o,e){return n.__a&&n.__a(e),o}\"undefined\"!=typeof window&&window.__PREACT_DEVTOOLS__&&window.__PREACT_DEVTOOLS__.attachPreact(\"10.7.1\",n,{Fragment:o,Component:e});export{t as addHookName};\n//# sourceMappingURL=devtools.module.js.map\n","import{options as n,Fragment as t,Component as e}from\"preact\";import\"preact/devtools\";var o={};function r(){o={}}function a(n){return n.type===t?\"Fragment\":\"function\"==typeof n.type?n.type.displayName||n.type.name:\"string\"==typeof n.type?n.type:\"#text\"}var i=[],s=[];function c(){return i.length>0?i[i.length-1]:null}var l=!1;function u(n){return\"function\"==typeof n.type&&n.type!=t}function f(n){for(var t=[n],e=n;null!=e.__o;)t.push(e.__o),e=e.__o;return t.reduce(function(n,t){n+=\"  in \"+a(t);var e=t.__source;return e?n+=\" (at \"+e.fileName+\":\"+e.lineNumber+\")\":l||(l=!0,console.warn(\"Add @babel/plugin-transform-react-jsx-source to get a more detailed component stack. Note that you should not add it to production builds of your App for bundle size reasons.\")),n+\"\\n\"},\"\")}var p=\"function\"==typeof WeakMap,d=e.prototype.setState;e.prototype.setState=function(n,t){return null==this.__v?null==this.state&&console.warn('Calling \"this.setState\" inside the constructor of a component is a no-op and might be a bug in your application. Instead, set \"this.state = {}\" directly.\\n\\n'+f(c())):null==this.__P&&console.warn('Can\\'t call \"this.setState\" on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in the componentWillUnmount method.\\n\\n'+f(this.__v)),d.call(this,n,t)};var h=e.prototype.forceUpdate;function y(n){var t=n.props,e=a(n),o=\"\";for(var r in t)if(t.hasOwnProperty(r)&&\"children\"!==r){var i=t[r];\"function\"==typeof i&&(i=\"function \"+(i.displayName||i.name)+\"() {}\"),i=Object(i)!==i||i.toString?i+\"\":Object.prototype.toString.call(i),o+=\" \"+r+\"=\"+JSON.stringify(i)}var s=t.children;return\"<\"+e+o+(s&&s.length?\">..</\"+e+\">\":\" />\")}e.prototype.forceUpdate=function(n){return null==this.__v?console.warn('Calling \"this.forceUpdate\" inside the constructor of a component is a no-op and might be a bug in your application.\\n\\n'+f(c())):null==this.__P&&console.warn('Can\\'t call \"this.forceUpdate\" on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in the componentWillUnmount method.\\n\\n'+f(this.__v)),h.call(this,n)},function(){!function(){var t=n.__b,e=n.diffed,o=n.__,r=n.vnode,a=n.__r;n.diffed=function(n){u(n)&&s.pop(),i.pop(),e&&e(n)},n.__b=function(n){u(n)&&i.push(n),t&&t(n)},n.__=function(n,t){s=[],o&&o(n,t)},n.vnode=function(n){n.__o=s.length>0?s[s.length-1]:null,r&&r(n)},n.__r=function(n){u(n)&&s.push(n),a&&a(n)}}();var t=!1,e=n.__b,r=n.diffed,c=n.vnode,l=n.__e,d=n.__,h=n.__h,m=p?{useEffect:new WeakMap,useLayoutEffect:new WeakMap,lazyPropTypes:new WeakMap}:null,v=[];n.__e=function(n,t,e,o){if(t&&t.__c&&\"function\"==typeof n.then){var r=n;n=new Error(\"Missing Suspense. The throwing component was: \"+a(t));for(var i=t;i;i=i.__)if(i.__c&&i.__c.__c){n=r;break}if(n instanceof Error)throw n}try{(o=o||{}).componentStack=f(t),l(n,t,e,o),\"function\"!=typeof n.then&&setTimeout(function(){throw n})}catch(n){throw n}},n.__=function(n,t){if(!t)throw new Error(\"Undefined parent passed to render(), this is the second argument.\\nCheck if the element is available in the DOM/has the correct id.\");var e;switch(t.nodeType){case 1:case 11:case 9:e=!0;break;default:e=!1}if(!e){var o=a(n);throw new Error(\"Expected a valid HTML node as a second argument to render.\\tReceived \"+t+\" instead: render(<\"+o+\" />, \"+t+\");\")}d&&d(n,t)},n.__b=function(n){var r=n.type,i=function n(t){return t?\"function\"==typeof t.type?n(t.__):t:{}}(n.__);if(t=!0,void 0===r)throw new Error(\"Undefined component passed to createElement()\\n\\nYou likely forgot to export your component or might have mixed up default and named imports\"+y(n)+\"\\n\\n\"+f(n));if(null!=r&&\"object\"==typeof r){if(void 0!==r.__k&&void 0!==r.__e)throw new Error(\"Invalid type passed to createElement(): \"+r+\"\\n\\nDid you accidentally pass a JSX literal as JSX twice?\\n\\n  let My\"+a(n)+\" = \"+y(r)+\";\\n  let vnode = <My\"+a(n)+\" />;\\n\\nThis usually happens when you export a JSX literal and not the component.\\n\\n\"+f(n));throw new Error(\"Invalid type passed to createElement(): \"+(Array.isArray(r)?\"array\":r))}if(\"thead\"!==r&&\"tfoot\"!==r&&\"tbody\"!==r||\"table\"===i.type?\"tr\"===r&&\"thead\"!==i.type&&\"tfoot\"!==i.type&&\"tbody\"!==i.type&&\"table\"!==i.type?console.error(\"Improper nesting of table. Your <tr> should have a <thead/tbody/tfoot/table> parent.\"+y(n)+\"\\n\\n\"+f(n)):\"td\"===r&&\"tr\"!==i.type?console.error(\"Improper nesting of table. Your <td> should have a <tr> parent.\"+y(n)+\"\\n\\n\"+f(n)):\"th\"===r&&\"tr\"!==i.type&&console.error(\"Improper nesting of table. Your <th> should have a <tr>.\"+y(n)+\"\\n\\n\"+f(n)):console.error(\"Improper nesting of table. Your <thead/tbody/tfoot> should have a <table> parent.\"+y(n)+\"\\n\\n\"+f(n)),void 0!==n.ref&&\"function\"!=typeof n.ref&&\"object\"!=typeof n.ref&&!(\"$$typeof\"in n))throw new Error('Component\\'s \"ref\" property should be a function, or an object created by createRef(), but got ['+typeof n.ref+\"] instead\\n\"+y(n)+\"\\n\\n\"+f(n));if(\"string\"==typeof n.type)for(var s in n.props)if(\"o\"===s[0]&&\"n\"===s[1]&&\"function\"!=typeof n.props[s]&&null!=n.props[s])throw new Error(\"Component's \\\"\"+s+'\" property should be a function, but got ['+typeof n.props[s]+\"] instead\\n\"+y(n)+\"\\n\\n\"+f(n));if(\"function\"==typeof n.type&&n.type.propTypes){if(\"Lazy\"===n.type.displayName&&m&&!m.lazyPropTypes.has(n.type)){var c=\"PropTypes are not supported on lazy(). Use propTypes on the wrapped component itself. \";try{var l=n.type();m.lazyPropTypes.set(n.type,!0),console.warn(c+\"Component wrapped in lazy() is \"+a(l))}catch(n){console.warn(c+\"We will log the wrapped component's name once it is loaded.\")}}var u=n.props;n.type.__f&&delete(u=function(n,t){for(var e in t)n[e]=t[e];return n}({},u)).ref,function(n,t,e,r,a){Object.keys(n).forEach(function(e){var i;try{i=n[e](t,e,r,\"prop\",null,\"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED\")}catch(n){i=n}!i||i.message in o||(o[i.message]=!0,console.error(\"Failed prop type: \"+i.message+(a&&\"\\n\"+a()||\"\")))})}(n.type.propTypes,u,0,a(n),function(){return f(n)})}e&&e(n)},n.__h=function(n,e,o){if(!n||!t)throw new Error(\"Hook can only be invoked from render methods.\");h&&h(n,e,o)};var b=function(n,t){return{get:function(){var e=\"get\"+n+t;v&&v.indexOf(e)<0&&(v.push(e),console.warn(\"getting vnode.\"+n+\" is deprecated, \"+t))},set:function(){var e=\"set\"+n+t;v&&v.indexOf(e)<0&&(v.push(e),console.warn(\"setting vnode.\"+n+\" is not allowed, \"+t))}}},w={nodeName:b(\"nodeName\",\"use vnode.type\"),attributes:b(\"attributes\",\"use vnode.props\"),children:b(\"children\",\"use vnode.props.children\")},g=Object.create({},w);n.vnode=function(n){var t=n.props;if(null!==n.type&&null!=t&&(\"__source\"in t||\"__self\"in t)){var e=n.props={};for(var o in t){var r=t[o];\"__source\"===o?n.__source=r:\"__self\"===o?n.__self=r:e[o]=r}}n.__proto__=g,c&&c(n)},n.diffed=function(n){if(n.__k&&n.__k.forEach(function(t){if(t&&void 0===t.type){delete t.__,delete t.__b;var e=Object.keys(t).join(\",\");throw new Error(\"Objects are not valid as a child. Encountered an object with the keys {\"+e+\"}.\\n\\n\"+f(n))}}),t=!1,r&&r(n),null!=n.__k)for(var e=[],o=0;o<n.__k.length;o++){var a=n.__k[o];if(a&&null!=a.key){var i=a.key;if(-1!==e.indexOf(i)){console.error('Following component has two or more children with the same key attribute: \"'+i+'\". This may cause glitches and misbehavior in rendering process. Component: \\n\\n'+y(n)+\"\\n\\n\"+f(n));break}e.push(i)}}}}();export{r as resetPropWarnings};\n//# sourceMappingURL=debug.module.js.map\n","/*!\n  Copyright (c) 2018 Jed Watson.\n  Licensed under the MIT License (MIT), see\n  http://jedwatson.github.io/classnames\n*/\n/* global define */\n\n(function () {\n\t'use strict';\n\n\tvar hasOwn = {}.hasOwnProperty;\n\n\tfunction classNames() {\n\t\tvar classes = [];\n\n\t\tfor (var i = 0; i < arguments.length; i++) {\n\t\t\tvar arg = arguments[i];\n\t\t\tif (!arg) continue;\n\n\t\t\tvar argType = typeof arg;\n\n\t\t\tif (argType === 'string' || argType === 'number') {\n\t\t\t\tclasses.push(arg);\n\t\t\t} else if (Array.isArray(arg)) {\n\t\t\t\tif (arg.length) {\n\t\t\t\t\tvar inner = classNames.apply(null, arg);\n\t\t\t\t\tif (inner) {\n\t\t\t\t\t\tclasses.push(inner);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (argType === 'object') {\n\t\t\t\tif (arg.toString === Object.prototype.toString) {\n\t\t\t\t\tfor (var key in arg) {\n\t\t\t\t\t\tif (hasOwn.call(arg, key) && arg[key]) {\n\t\t\t\t\t\t\tclasses.push(key);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tclasses.push(arg.toString());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn classes.join(' ');\n\t}\n\n\tif (typeof module !== 'undefined' && module.exports) {\n\t\tclassNames.default = classNames;\n\t\tmodule.exports = classNames;\n\t} else if (typeof define === 'function' && typeof define.amd === 'object' && define.amd) {\n\t\t// register as 'classnames', consistent with npm package name\n\t\tdefine('classnames', [], function () {\n\t\t\treturn classNames;\n\t\t});\n\t} else {\n\t\twindow.classNames = classNames;\n\t}\n}());\n","import{options as n}from\"preact\";var t,u,r,o=0,i=[],c=n.__b,f=n.__r,e=n.diffed,a=n.__c,v=n.unmount;function l(t,r){n.__h&&n.__h(u,t,o||r),o=0;var i=u.__H||(u.__H={__:[],__h:[]});return t>=i.__.length&&i.__.push({}),i.__[t]}function m(n){return o=1,p(w,n)}function p(n,r,o){var i=l(t++,2);return i.t=n,i.__c||(i.__=[o?o(r):w(void 0,r),function(n){var t=i.t(i.__[0],n);i.__[0]!==t&&(i.__=[t,i.__[1]],i.__c.setState({}))}],i.__c=u),i.__}function y(r,o){var i=l(t++,3);!n.__s&&k(i.__H,o)&&(i.__=r,i.__H=o,u.__H.__h.push(i))}function d(r,o){var i=l(t++,4);!n.__s&&k(i.__H,o)&&(i.__=r,i.__H=o,u.__h.push(i))}function h(n){return o=5,_(function(){return{current:n}},[])}function s(n,t,u){o=6,d(function(){return\"function\"==typeof n?(n(t()),function(){return n(null)}):n?(n.current=t(),function(){return n.current=null}):void 0},null==u?u:u.concat(n))}function _(n,u){var r=l(t++,7);return k(r.__H,u)&&(r.__=n(),r.__H=u,r.__h=n),r.__}function A(n,t){return o=8,_(function(){return n},t)}function F(n){var r=u.context[n.__c],o=l(t++,9);return o.c=n,r?(null==o.__&&(o.__=!0,r.sub(u)),r.props.value):n.__}function T(t,u){n.useDebugValue&&n.useDebugValue(u?u(t):t)}function q(n){var r=l(t++,10),o=m();return r.__=n,u.componentDidCatch||(u.componentDidCatch=function(n){r.__&&r.__(n),o[1](n)}),[o[0],function(){o[1](void 0)}]}function x(){for(var t;t=i.shift();)if(t.__P)try{t.__H.__h.forEach(g),t.__H.__h.forEach(j),t.__H.__h=[]}catch(u){t.__H.__h=[],n.__e(u,t.__v)}}n.__b=function(n){u=null,c&&c(n)},n.__r=function(n){f&&f(n),t=0;var r=(u=n.__c).__H;r&&(r.__h.forEach(g),r.__h.forEach(j),r.__h=[])},n.diffed=function(t){e&&e(t);var o=t.__c;o&&o.__H&&o.__H.__h.length&&(1!==i.push(o)&&r===n.requestAnimationFrame||((r=n.requestAnimationFrame)||function(n){var t,u=function(){clearTimeout(r),b&&cancelAnimationFrame(t),setTimeout(n)},r=setTimeout(u,100);b&&(t=requestAnimationFrame(u))})(x)),u=null},n.__c=function(t,u){u.some(function(t){try{t.__h.forEach(g),t.__h=t.__h.filter(function(n){return!n.__||j(n)})}catch(r){u.some(function(n){n.__h&&(n.__h=[])}),u=[],n.__e(r,t.__v)}}),a&&a(t,u)},n.unmount=function(t){v&&v(t);var u,r=t.__c;r&&r.__H&&(r.__H.__.forEach(function(n){try{g(n)}catch(n){u=n}}),u&&n.__e(u,r.__v))};var b=\"function\"==typeof requestAnimationFrame;function g(n){var t=u,r=n.__c;\"function\"==typeof r&&(n.__c=void 0,r()),u=t}function j(n){var t=u;n.__c=n.__(),u=t}function k(n,t){return!n||n.length!==t.length||t.some(function(t,u){return t!==n[u]})}function w(n,t){return\"function\"==typeof t?t(n):t}export{m as useState,p as useReducer,y as useEffect,d as useLayoutEffect,h as useRef,s as useImperativeHandle,_ as useMemo,A as useCallback,F as useContext,T as useDebugValue,q as useErrorBoundary};\n//# sourceMappingURL=hooks.module.js.map\n","import{options as r,Fragment as _}from\"preact\";export{Fragment}from\"preact\";var o=0;function e(_,e,n,t,f){var l,s,u={};for(s in e)\"ref\"==s?l=e[s]:u[s]=e[s];var a={type:_,props:u,key:n,ref:l,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:--o,__source:f,__self:t};if(\"function\"==typeof _&&(l=_.defaultProps))for(s in l)void 0===u[s]&&(u[s]=l[s]);return r.vnode&&r.vnode(a),a}export{e as jsx,e as jsxs,e as jsxDEV};\n//# sourceMappingURL=jsxRuntime.module.js.map\n","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/SvgIcon.js\";\nimport classnames from 'classnames';\nimport { useLayoutEffect, useRef } from 'preact/hooks';\n/**\n * Object mapping icon names to SVG markup.\n *\n * @typedef {Map<string|symbol, string>} IconMap\n */\n\n/**\n * @template T\n * @typedef {import(\"preact/hooks\").Ref<T>} Ref\n */\n\n/**\n * Map of icon name to SVG data.\n *\n * @type {IconMap}\n */\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nconst iconRegistry = new Map();\n/**\n * @typedef SvgIconProps\n * @prop {string|symbol} name - The name of the icon to display.\n *   The name must match a name that has already been registered using the\n *   `registerIcon` or `registerIcons` functions.\n * @prop {string} [className] - A CSS class to apply to the `<svg>` element.\n * @prop {boolean} [inline] - Apply a style allowing for inline display of icon wrapper.\n * @prop {string} [title] - Optional title attribute to apply to the SVG's containing `span`.\n */\n\n/**\n * Component that renders icons using inline `<svg>` elements.\n * This enables their appearance to be customized via CSS.\n *\n * This matches the way we do icons on the website, see\n * https://github.com/hypothesis/h/pull/3675\n *\n * @param {SvgIconProps} props\n */\n\nexport function SvgIcon({\n  name,\n  className = '',\n  inline = false,\n  title = ''\n}) {\n  const markup = iconRegistry.get(name);\n\n  if (!markup) {\n    throw new Error(`Icon \"${name.toString()}\" is not registered`);\n  }\n\n  const element =\n  /** @type {{ current: HTMLElement }} */\n  useRef();\n  useLayoutEffect(() => {\n    const svg = element.current.querySelector('svg'); // The icon should always contain an `<svg>` element, but check here as we\n    // don't validate the markup when it is registered.\n\n    if (svg) {\n      svg.setAttribute('class', className);\n    }\n  }, [className, // `markup` is a dependency of this effect because the SVG is replaced if\n  // it changes.\n  markup]);\n  const spanProps = {};\n\n  if (title) {\n    spanProps.title = title;\n  }\n\n  return _jsxDEV(\"span\", {\n    className: classnames('Hyp-SvgIcon', {\n      'Hyp-SvgIcon--inline': inline\n    }),\n    dangerouslySetInnerHTML: {\n      __html: markup\n    },\n    ref: element,\n    ...spanProps\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 69,\n    columnNumber: 5\n  }, this);\n}\n/**\n * Register an icon for use with the `SvgIcon` component.\n *\n * Returns a symbol that can be passed as the `name` prop to `SvgIcon` in order\n * to render this icon.\n *\n * @param {string|symbol} name - A name for this icon\n * @param {string} markup - SVG markup for the icon\n * @return {symbol}\n */\n\nexport function registerIcon(name, markup) {\n  const key = typeof name === 'string' ? Symbol(name) : name;\n  iconRegistry.set(key, markup);\n  return key;\n}\n/**\n * Register icons for use with the `SvgIcon` component.\n *\n * @deprecated Prefer the `registerIcon` function instead which will return a\n * key that does not conflict with existing icons.\n *\n * @param {Record<string, string>} icons\n * @param {Object} options\n *  @param {boolean} [options.reset] - If `true`, remove existing registered icons.\n */\n\nexport function registerIcons(icons, {\n  reset = false\n} = {}) {\n  if (reset) {\n    iconRegistry.clear();\n  }\n\n  for (let [key, value] of Object.entries(icons)) {\n    iconRegistry.set(key, value);\n  }\n}\n/**\n * Return the currently available icons.\n *\n * To register icons, don't mutate this directly but call `registerIcons`\n * instead.\n *\n * @return {IconMap}\n */\n\nexport function availableIcons() {\n  return iconRegistry;\n}\n//# sourceMappingURL=SvgIcon.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/buttons.js\";\nimport classnames from 'classnames';\nimport { SvgIcon } from './SvgIcon';\n/**\n * @typedef ButtonProps\n * @prop {import('preact').Ref<HTMLButtonElement>} [buttonRef]\n * @prop {string} [classes] - Optional CSS class name(s) to use _in addition_\n *   to the button component's own clases\n * @prop {string} [className] - Optional CSS class name that will _replace_\n *   the button component's own classes\n * @prop {string|symbol} [icon] - Name of `SvgIcon` to render in the button\n * @prop {'left'|'right'} [iconPosition] - Icon positioned to left or to\n *   right of button text\n * @prop {boolean} [expanded] - Is the element associated with this button\n *   expanded (set `aria-expanded`)\n * @prop {never} [aria-expanded] - Use `expanded` prop instead\n * @prop {boolean} [pressed] - Is this button currently \"active?\" (set\n *   `aria-pressed` or `aria-selected` depending on button `role`)\n * @prop {never} [aria-pressed] - Use `pressed` prop instead\n * @prop {'small'|'medium'|'large'} [size='medium'] - Relative button size:\n *   affects padding\n * @prop {string} [title] - Button title; used for `aria-label` attribute\n * @prop {never} [aria-label] - Use `title` prop instead\n * @prop {'normal'|'primary'|'light'|'dark'} [variant='normal'] - For styling: element variant\n */\n\n/**\n * Fold in HTML button prop definitions into ButtonProps, but ignore `size` because it's inherited\n * from HTMLElement and conflicts with the _ButtonProps.size prop above. Ignore `icon`\n * because it is typed to `string` only and we need to be able to accept {string|symbol}\n *\n * @typedef {Omit<import('preact').JSX.HTMLAttributes<HTMLButtonElement>, 'size' | 'icon'> } HTMLButtonElementProps\n * @typedef {ButtonProps & HTMLButtonElementProps} ButtonBaseProps\n */\n\n/**\n * @typedef IconButtonBaseProps\n * @prop {string|symbol} icon - Icon is required for icon buttons\n * @prop {string} title - Title is required for icon buttons\n * @prop {never} [children] - children are not allowed (use LabeledButton instead)\n */\n\n/**\n * @typedef {ButtonBaseProps & IconButtonBaseProps} IconButtonProps\n */\n\n/**\n * @param {ButtonBaseProps} props\n */\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n\nfunction ButtonBase({\n  // Custom props.\n  buttonRef,\n  classes,\n  className,\n  icon,\n  iconPosition = 'left',\n  size = 'medium',\n  variant = 'normal',\n  expanded,\n  pressed,\n  // Standard <button> props.\n  type = 'button',\n  ...restProps\n}) {\n  var _restProps$role;\n\n  const role = (_restProps$role = restProps === null || restProps === void 0 ? void 0 : restProps.role) !== null && _restProps$role !== void 0 ? _restProps$role : 'button';\n  const ariaProps = {\n    'aria-label': restProps.title\n  }; // aria-pressed and aria-expanded are not allowed for buttons with\n  // an aria role of `tab`. Instead, the aria-selected attribute is expected.\n\n  if (role === 'tab') {\n    ariaProps['aria-selected'] = pressed;\n  } else {\n    ariaProps['aria-pressed'] = pressed;\n    ariaProps['aria-expanded'] = expanded;\n  }\n\n  return _jsxDEV(\"button\", {\n    ref: buttonRef,\n    className: classnames(className, `${className}--${size}`, `${className}--${variant}`, {\n      [`${className}--icon-${iconPosition}`]: icon\n    }, classes),\n    type: type,\n    ...ariaProps,\n    ...restProps\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 82,\n    columnNumber: 5\n  }, this);\n}\n/**\n * An icon-only button\n *\n * @deprecated - Use re-implemented component in the input group\n * @param {IconButtonProps} props\n */\n\n\nexport function IconButton({\n  className = 'Hyp-IconButton',\n  ...restProps\n}) {\n  const {\n    icon\n  } = restProps;\n  return _jsxDEV(ButtonBase, {\n    className: className,\n    ...restProps,\n    children: _jsxDEV(SvgIcon, {\n      name: icon\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 110,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 109,\n    columnNumber: 5\n  }, this);\n}\n/**\n * A labeled button, with or without an icon\n *\n * @deprecated - Use re-implemented component in the input group\n * @param {ButtonBaseProps} props\n */\n\nexport function LabeledButton({\n  children,\n  className = 'Hyp-LabeledButton',\n  ...restProps\n}) {\n  const {\n    icon,\n    iconPosition = 'left'\n  } = restProps;\n  return _jsxDEV(ButtonBase, {\n    className: className,\n    ...restProps,\n    children: [icon && iconPosition === 'left' && _jsxDEV(SvgIcon, {\n      name: icon\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 129,\n      columnNumber: 43\n    }, this), children, icon && iconPosition === 'right' && _jsxDEV(SvgIcon, {\n      name: icon\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 131,\n      columnNumber: 44\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 128,\n    columnNumber: 5\n  }, this);\n}\n/**\n * A button styled to appear as an HTML link (<a>)\n *\n * @deprecated - Use re-implemented component in the navigation group\n * @param {ButtonBaseProps} props\n */\n\nexport function LinkButton(props) {\n  return _jsxDEV(ButtonBase, {\n    className: \"Hyp-LinkButton\",\n    ...props\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 143,\n    columnNumber: 10\n  }, this);\n}\n//# sourceMappingURL=buttons.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/Checkbox.js\";\n// @ts-ignore\nimport checkboxSVG from '../../images/icons/checkbox.svg';\nimport classnames from 'classnames';\nimport { registerIcon, SvgIcon } from './SvgIcon'; // Register the checkbox icon for use\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"preact/jsx-dev-runtime\";\nconst checkboxIcon = registerIcon('checkbox', checkboxSVG);\n/**\n * @typedef CheckboxBaseProps\n * @prop {string} [classes] - Additional CSS classes to apply to the <input>\n * @prop {string} name - The `name` of the checkbox.\n * @prop {import('preact').Ref<HTMLInputElement>} [inputRef] - Access to the input\n *    element in case a parent element wants for example to focus on it.\n * @prop {(checked: boolean) => void} [onToggle] - Callback when checkbox is\n *   checked/unchecked\n * @prop {never} [type] - Type is always 'checkbox'\n * @prop {never} [children] - Children are not allowed\n *\n * The props for Checkbox component extends and narrows the attributes of the native input element.\n * `onToggle` event should only be associated to HTMLDetailsElement, but Preact is not very strict with types.\n * We omit the `onToggle` because it clashes with our definition.\n * @typedef {Omit<import('preact').JSX.HTMLAttributes<HTMLInputElement>, 'onToggle'> & CheckboxBaseProps} CheckboxProps\n */\n\n/**\n * @typedef LabeledCheckboxBaseProps\n * @prop {import('preact').ComponentChildren} children - Label text or elements\n * @prop {string} [containerClasses] - Optional additional classes for the container\n *   <label> element\n *\n * @typedef {Omit<CheckboxProps, 'children'> & LabeledCheckboxBaseProps} LabeledCheckboxProps\n */\n\n/**\n * A checkbox input.\n *\n * A checkbox component is a combination of an <input> element and a sibling\n * <svg> element that is used for the visual appearance of the checkbox.\n *\n * @deprecated - Use re-implemented Checkbox component in the input group\n * @param {CheckboxProps} props\n */\n\nexport function Checkbox({\n  classes = '',\n  inputRef,\n  onToggle,\n  onClick,\n  ...restProps\n}) {\n  /**\n   * @param {import('preact').JSX.TargetedMouseEvent<HTMLInputElement>} event\n   * @this HTMLInputElement\n   */\n  function onPressed(event) {\n    onToggle === null || onToggle === void 0 ? void 0 : onToggle(event.currentTarget.checked); // preact event handlers expects `this` context to be of type `never`\n    // https://github.com/preactjs/preact/issues/3137\n\n    onClick === null || onClick === void 0 ? void 0 : onClick.call(\n    /** @type {never} */\n    this, event);\n  }\n\n  return _jsxDEV(_Fragment, {\n    children: [_jsxDEV(\"input\", {\n      className: classnames('Hyp-Checkbox', classes),\n      ref: inputRef,\n      type: \"checkbox\",\n      onClick: onPressed,\n      ...restProps\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 65,\n      columnNumber: 7\n    }, this), _jsxDEV(SvgIcon, {\n      className: \"hyp-svg-checkbox\",\n      name: checkboxIcon\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 72,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true);\n}\n/**\n * @deprecated - Use re-implemented Checkbox component in the input group\n * A labeled checkbox input\n *\n * @param {LabeledCheckboxProps} props\n */\n\nexport function LabeledCheckbox({\n  children,\n  id,\n  containerClasses = '',\n  ...restProps\n}) {\n  var _id;\n\n  (_id = id) !== null && _id !== void 0 ? _id : id = restProps.name;\n  return _jsxDEV(\"label\", {\n    htmlFor: id,\n    className: classnames('Hyp-LabeledCheckbox', containerClasses),\n    children: [_jsxDEV(Checkbox, {\n      id: id,\n      ...restProps\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 95,\n      columnNumber: 7\n    }, this), _jsxDEV(\"span\", {\n      \"data-testid\": \"label-text\",\n      children: children\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 96,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 91,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Checkbox.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/Dialog.js\";\nimport classnames from 'classnames';\nimport { useEffect, useLayoutEffect, useRef, useState } from 'preact/hooks'; // @ts-ignore\n\nimport cancelSVG from '../../images/icons/cancel.svg';\nimport { IconButton, LabeledButton } from './buttons';\nimport { registerIcon, SvgIcon } from './SvgIcon'; // Register the checkbox icon for use\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nconst cancelIcon = registerIcon('cancel', cancelSVG);\nlet idCounter = 0;\n/**\n * Return an element ID beginning with `prefix` that is unique per component instance.\n *\n * This avoids different instances of a component re-using the same ID.\n *\n * @param {string} prefix\n */\n\nfunction useUniqueId(prefix) {\n  const [id] = useState(() => {\n    ++idCounter;\n    return `${prefix}-${idCounter}`;\n  });\n  return id;\n}\n/**\n * @typedef {import('preact').ComponentChildren} Children\n *\n * @typedef DialogProps\n * @prop {Children} [buttons] -\n *   Additional `Button` elements to display at the bottom of the dialog.\n *   A \"Cancel\" button is added automatically if the `onCancel` prop is set.\n * @prop {string} [cancelLabel] - Label for the cancel button\n * @prop {Children} children\n * @prop {string} [contentClass] - CSS class to apply to the dialog's content\n * @prop {string|symbol} [icon] - Name of optional icon to render in header\n * @prop {import(\"preact/hooks\").Ref<HTMLElement>|null} [initialFocus] -\n *   Child element to focus when the dialog is rendered. If not provided,\n *   the Dialog's container will be automatically focused on opening. Set to\n *   `null` to opt out of automatic focus control.\n * @prop {() => void} [onCancel] -\n *   A callback to invoke when the user cancels the dialog. If provided, a\n *   \"Cancel\" button will be displayed.\n * @prop {'dialog'|'alertdialog'} [role] - The aria role for the dialog (defaults to\" dialog\")\n * @prop {string} title\n * @prop {boolean} [withCancelButton=true] - If `onCancel` is provided, render\n *   a Cancel button as one of the Dialog's buttons (along with any other\n *   `buttons`)\n * @prop {boolean} [withCloseButton=true] - If `onCancel` is provided, render\n *   a close button (X icon) in the Dialog's header\n */\n\n/**\n * HTML control that can be disabled.\n *\n * @typedef {HTMLElement & { disabled: boolean }} InputElement\n */\n\n/**\n * Render a \"panel\"-like interface with a title and optional icon and/or\n * close button. Grabs focus on initial render, defaulting to the entire\n * Dialog container element, or `initialFocus` HTMLElement if provided.\n *\n * @param {DialogProps} props\n */\n\n\nexport function Dialog({\n  buttons,\n  cancelLabel = 'Cancel',\n  children,\n  contentClass,\n  icon,\n  initialFocus,\n  onCancel,\n  role = 'dialog',\n  title,\n  withCancelButton = true,\n  withCloseButton = true\n}) {\n  const dialogDescriptionId = useUniqueId('dialog-description');\n  const dialogTitleId = useUniqueId('dialog-title');\n  const rootEl =\n  /** @type {{ current: HTMLDivElement }} */\n  useRef();\n  useEffect(() => {\n    // Setting `initialFocus` to `null` opts out of focus handling\n    if (initialFocus !== null) {\n      const focusEl =\n      /** @type {InputElement|null} */\n      initialFocus === null || initialFocus === void 0 ? void 0 : initialFocus.current;\n\n      if (focusEl && !focusEl.disabled) {\n        focusEl.focus();\n      } else {\n        // The `initialFocus` prop has not been set, so use automatic focus handling.\n        // Modern accessibility guidance is to focus the dialog itself rather than\n        // trying to be smart about focusing a particular control within the\n        // dialog.\n        rootEl.current.focus();\n      }\n    } // We only want to run this effect once when the dialog is mounted.\n    //\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n\n  }, []); // Try to assign the dialog an accessible description, using the content of\n  // the first paragraph of text in it.\n  //\n  // A limitation of this approach is that it doesn't update if the dialog's\n  // content changes after the initial render.\n\n  useLayoutEffect(() => {\n    const description = rootEl.current.querySelector('p');\n\n    if (description) {\n      description.id = dialogDescriptionId;\n      rootEl.current.setAttribute('aria-describedby', dialogDescriptionId);\n    }\n  }, [dialogDescriptionId]);\n  const hasCancelButton = onCancel && withCancelButton;\n  const hasCloseButton = onCancel && withCloseButton;\n  const hasButtons = buttons || hasCancelButton;\n  return _jsxDEV(\"div\", {\n    \"aria-labelledby\": dialogTitleId,\n    className: classnames('Hyp-Dialog', {\n      'Hyp-Dialog--closeable': hasCloseButton\n    }, contentClass),\n    ref: rootEl,\n    role: role,\n    tabIndex: -1,\n    children: [_jsxDEV(\"header\", {\n      className: \"Hyp-Dialog__header\",\n      children: [icon && _jsxDEV(\"div\", {\n        className: \"Hyp-Dialog__header-icon\",\n        children: _jsxDEV(SvgIcon, {\n          name: icon,\n          title: title,\n          \"data-testid\": \"header-icon\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 139,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 138,\n        columnNumber: 11\n      }, this), _jsxDEV(\"h2\", {\n        className: \"Hyp-Dialog__title\",\n        id: dialogTitleId,\n        children: title\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 142,\n        columnNumber: 9\n      }, this), onCancel && withCloseButton && _jsxDEV(\"div\", {\n        className: \"Hyp-Dialog__close\",\n        children: _jsxDEV(IconButton, {\n          \"data-testid\": \"close-button\",\n          icon: cancelIcon,\n          title: \"Close\",\n          onClick: onCancel\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 147,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 146,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 136,\n      columnNumber: 7\n    }, this), children, hasButtons && _jsxDEV(\"div\", {\n      className: \"Hyp-Dialog__actions\",\n      children: [hasCancelButton && _jsxDEV(LabeledButton, {\n        \"data-testid\": \"cancel-button\",\n        onClick: onCancel,\n        children: cancelLabel\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 160,\n        columnNumber: 13\n      }, this), buttons]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 158,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 125,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Dialog.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/Icon.js\";\nimport classnames from 'classnames';\nimport { useLayoutEffect, useRef } from 'preact/hooks';\nimport { availableIcons } from './SvgIcon';\n/**\n * @template T\n * @typedef {import(\"preact/hooks\").Ref<T>} Ref\n */\n\n/**\n * @typedef IconProps\n * @prop {string|symbol} name - The name of the icon to display.\n *   The name must match a name that has already been registered using the\n *   `registerIcon` or `registerIcons` functions.\n * @prop {string} [classes] - CSS classes to apply to the `<svg>` element.\n * @prop {string} [containerClasses] - CSS classes to apply to wrapping element.\n * @prop {string} [title] - Optional title attribute to apply to the SVG's containing `span`.\n */\n\n/**\n * Component that renders icons using inline `<svg>` elements.\n *\n * @deprecated - Use standalone icon components instead\n *\n * @param {IconProps} props\n */\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nexport function Icon({\n  name,\n  classes = '',\n  containerClasses = '',\n  title = ''\n}) {\n  const registeredIcons = availableIcons();\n  const markup = registeredIcons.get(name);\n\n  if (!markup) {\n    throw new Error(`Icon \"${name.toString()}\" is not registered`);\n  }\n\n  const element =\n  /** @type {{ current: HTMLElement }} */\n  useRef();\n  useLayoutEffect(() => {\n    const svg = element.current.querySelector('svg'); // The icon should always contain an `<svg>` element, but check here as we\n    // don't validate the markup when it is registered.\n\n    if (svg) {\n      svg.setAttribute('class', classnames('Hyp-Icon', classes));\n    }\n  }, [classes, // `markup` is a dependency of this effect because the SVG is replaced if\n  // it changes.\n  markup]);\n  const spanProps = {};\n\n  if (title) {\n    spanProps.title = title;\n  }\n\n  return _jsxDEV(\"span\", {\n    className: containerClasses,\n    dangerouslySetInnerHTML: {\n      __html: markup\n    },\n    ref: element,\n    ...spanProps\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 62,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Icon.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/Link.js\";\nimport classnames from 'classnames';\n/**\n * @typedef {import('preact').ComponentChildren} Children\n *\n * @typedef LinkBaseProps\n * @prop {Children} children\n * @prop {string} [classes] - Additional CSS classes to apply\n * @prop {import('preact').Ref<HTMLAnchorElement>} [linkRef] - Optional ref for\n *   the rendered anchor element\n */\n\n/**\n * @typedef {LinkBaseProps & import('preact').JSX.HTMLAttributes<HTMLAnchorElement>} LinkProps\n */\n\n/**\n * Style and add some attributes to an anchor (`<a>`) element\n *\n * @deprecated - Use re-implemented component in the navigation group\n *\n * @param {LinkProps} props\n */\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nexport function Link({\n  children,\n  classes = '',\n  linkRef,\n  ...restProps\n}) {\n  return _jsxDEV(\"a\", {\n    className: classnames('Hyp-Link', classes),\n    ref: linkRef,\n    rel: \"noopener noreferrer\",\n    ...restProps,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 26,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Link.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/Panel.js\";\nimport classnames from 'classnames'; // @ts-ignore\n\nimport cancelSVG from '../../images/icons/cancel.svg';\nimport { IconButton } from './buttons';\nimport { registerIcon, SvgIcon } from './SvgIcon'; // Register the cancel icon for use\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nconst cancelIcon = registerIcon('cancel', cancelSVG);\n/**\n * @typedef PanelProps\n * @prop {import(\"preact\").ComponentChildren} children\n * @prop {string} [icon] - Name of optional icon to render in header\n * @prop {() => void} [onClose] - handler for closing the panel; if provided,\n *   will render a close button that invokes this onClick\n * @prop {string} title\n */\n\n/**\n * Render a \"panel\"-like interface with a title and optional icon and/or\n * close button.\n *\n * @deprecated - Use re-implemented Panel component in the layout group\n * @param {PanelProps} props\n */\n\nexport function Panel({\n  children,\n  icon,\n  onClose,\n  title\n}) {\n  const withCloseButton = !!onClose;\n  return _jsxDEV(\"div\", {\n    className: classnames('Hyp-Panel', {\n      'Hyp-Panel--closeable': withCloseButton\n    }),\n    children: [_jsxDEV(\"header\", {\n      className: \"Hyp-Panel__header\",\n      children: [icon && _jsxDEV(\"div\", {\n        className: \"Hyp-Panel__header-icon\",\n        children: _jsxDEV(SvgIcon, {\n          name: icon,\n          title: title\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 38,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 37,\n        columnNumber: 11\n      }, this), _jsxDEV(\"h2\", {\n        className: \"Hyp-Panel__title\",\n        children: title\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 41,\n        columnNumber: 9\n      }, this), withCloseButton && _jsxDEV(\"div\", {\n        className: \"Hyp-Panel__close\",\n        children: _jsxDEV(IconButton, {\n          icon: cancelIcon,\n          title: \"Close\",\n          onClick: onClose\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 44,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 43,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 35,\n      columnNumber: 7\n    }, this), _jsxDEV(\"div\", {\n      className: \"Hyp-Panel__content\",\n      children: children\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 48,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 30,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Panel.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/Spinner.js\";\nimport classnames from 'classnames'; // @ts-ignore\n\nimport spinnerSVG from '../../images/icons/spinner--spokes.svg';\nimport { Icon } from './Icon';\nimport { registerIcon } from './SvgIcon'; // Register the spinner icon for use\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nconst spinnerIcon = registerIcon('spinner', spinnerSVG);\n/**\n * @typedef SpinnerProps\n * @prop {string} [classes] - Additional CSS classes to apply\n * @prop {'small'|'medium'|'large'} [size='medium'] - Relative size of spinner\n *   to surrounding content\n */\n\n/**\n * @typedef FullScreenSpinnerProps\n * @prop {string} [classes] - Additional CSS classes to apply\n * @prop {string} [containerClasses] - CSS classes to apply to wrapping element.\n */\n\n/**\n * Loading indicator.\n *\n * @deprecated - Use re-implemented component in the feedback group\n * @param {SpinnerProps} props\n */\n\nexport function Spinner({\n  classes = '',\n  size = 'medium'\n}) {\n  const baseClass = `Hyp-Spinner--${size}`;\n  return _jsxDEV(Icon, {\n    name: spinnerIcon,\n    containerClasses: classnames(baseClass, classes)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 33,\n    columnNumber: 5\n  }, this);\n}\n/**\n * Full-screen loading indicator.\n *\n * @param {FullScreenSpinnerProps} props\n */\n\nexport function FullScreenSpinner({\n  classes = '',\n  containerClasses = ''\n}) {\n  return _jsxDEV(\"div\", {\n    className: classnames('Hyp-FullScreenSpinner', containerClasses),\n    children: _jsxDEV(Spinner, {\n      classes: classnames('Hyp-FullScreenSpinner__spinner', classes),\n      size: \"large\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 48,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 47,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Spinner.js.map","// @ts-nocheck\r\n\r\nimport {\r\n  cancel,\r\n  caretLeft,\r\n  caretRight,\r\n  caution,\r\n  hide,\r\n  highlight,\r\n  note,\r\n  show,\r\n} from '@hypothesis/frontend-shared/lib/icons';\r\n\r\n// Different variant than shared icon\r\nimport annotateIcon from '../images/icons/annotate.svg';\r\n// Not in shared icon set\r\nimport pointerIcon from '../images/icons/pointer.svg';\r\n\r\n/**\r\n * Set of icons used by the annotator part of the application via the `Icon`\r\n * component.\r\n */\r\nexport const annotatorIcons = {\r\n  annotate: annotateIcon,\r\n  cancel,\r\n  caution,\r\n  'caret-left': caretLeft,\r\n  'caret-right': caretRight,\r\n  hide,\r\n  highlight,\r\n  note,\r\n  pointer: pointerIcon,\r\n  show,\r\n};\r\n","type Listener = {\r\n  eventTarget: EventTarget;\r\n  eventType: string;\r\n  listener: (event: Event) => void;\r\n};\r\n\r\n/**\r\n * Return the event type that a listener will receive.\r\n *\r\n * For example `EventType<HTMLElement, 'keydown'>` evaluates to `KeyboardEvent`.\r\n *\r\n * The event type is extracted from the target's `on${Type}` property (eg.\r\n * `HTMLElement.onkeydown` here) If there is no such property, the type defaults\r\n * to `Event`.\r\n */\r\ntype EventType<\r\n  Target extends EventTarget,\r\n  Type extends string\r\n> = `on${Type}` extends keyof Target\r\n  ? Target[`on${Type}`] extends ((...args: any[]) => void) | null\r\n    ? Parameters<NonNullable<Target[`on${Type}`]>>[0]\r\n    : Event\r\n  : Event;\r\n\r\n/**\r\n * Utility that provides a way to conveniently remove a set of DOM event\r\n * listeners when they are no longer needed.\r\n */\r\nexport class ListenerCollection {\r\n  private _listeners: Map<symbol, Listener>;\r\n\r\n  constructor() {\r\n    this._listeners = new Map();\r\n  }\r\n\r\n  /**\r\n   * Add a listener and return an ID that can be used to remove it later\r\n   */\r\n  add<Type extends string, Target extends EventTarget>(\r\n    eventTarget: Target,\r\n    eventType: Type,\r\n    listener: (event: EventType<Target, Type>) => void,\r\n    options?: AddEventListenerOptions\r\n  ) {\r\n    eventTarget.addEventListener(eventType, listener as EventListener, options);\r\n    const symbol = Symbol();\r\n    this._listeners.set(symbol, {\r\n      eventTarget,\r\n      eventType,\r\n      // eslint-disable-next-line object-shorthand\r\n      listener: listener as EventListener,\r\n    });\r\n    return symbol;\r\n  }\r\n\r\n  /**\r\n   * Remove a specific listener.\r\n   */\r\n  remove(listenerId: symbol) {\r\n    const event = this._listeners.get(listenerId);\r\n    if (event) {\r\n      const { eventTarget, eventType, listener } = event;\r\n      eventTarget.removeEventListener(eventType, listener);\r\n      this._listeners.delete(listenerId);\r\n    }\r\n  }\r\n\r\n  removeAll() {\r\n    this._listeners.forEach(({ eventTarget, eventType, listener }) => {\r\n      eventTarget.removeEventListener(eventType, listener);\r\n    });\r\n    this._listeners.clear();\r\n  }\r\n}\r\n","/** @param {number} val */\r\nfunction byteToHex(val) {\r\n  const str = val.toString(16);\r\n  return str.length === 1 ? '0' + str : str;\r\n}\r\n\r\n/**\r\n * Generate a random hex string of `len` chars.\r\n *\r\n * @param {number} len - An even-numbered length string to generate.\r\n * @return {string}\r\n */\r\nexport function generateHexString(len) {\r\n  const bytes = new Uint8Array(len / 2);\r\n  window.crypto.getRandomValues(bytes);\r\n  return Array.from(bytes).map(byteToHex).join('');\r\n}\r\n","/**\r\n * These types are the used in by `PortProvider` and `PortFinder` for the\r\n * inter-frame discovery and communication processes.\r\n *\r\n * @typedef {'guest'|'host'|'notebook'|'sidebar'} Frame\r\n *\r\n * @typedef Message\r\n * @prop {Frame} frame1\r\n * @prop {Frame} frame2\r\n * @prop {'offer'|'request'} type\r\n * @prop {string} requestId - ID of the request. Used to associate `offer`\r\n *   responses with requests and enable PortProvider to ignore re-sent requests.\r\n */\r\n\r\n/**\r\n * Return true if an object, eg. from the data field of a `MessageEvent`, is a\r\n * valid `Message`.\r\n *\r\n * @param {any} data\r\n * @return {data is Message}\r\n */\r\nexport function isMessage(data) {\r\n  if (data === null || typeof data !== 'object') {\r\n    return false;\r\n  }\r\n\r\n  for (let property of ['frame1', 'frame2', 'type', 'requestId']) {\r\n    if (typeof data[property] !== 'string') {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n/**\r\n * Return true if the data payload from a MessageEvent matches `message`.\r\n *\r\n * @param {any} data\r\n * @param {Partial<Message>} message\r\n */\r\nexport function isMessageEqual(data, message) {\r\n  if (!isMessage(data)) {\r\n    return false;\r\n  }\r\n\r\n  // We assume `JSON.stringify` cannot throw because `isMessage` verifies that\r\n  // all the fields we serialize here are serializable values.\r\n  return (\r\n    JSON.stringify(data, Object.keys(message).sort()) ===\r\n    JSON.stringify(message, Object.keys(message).sort())\r\n  );\r\n}\r\n\r\n/**\r\n * Check that source is of type Window.\r\n *\r\n * @param {MessageEventSource|null} source\r\n * @return {source is Window}\r\n */\r\nexport function isSourceWindow(source) {\r\n  if (\r\n    // `source` can be of type Window, MessagePort, ServiceWorker, or null.\r\n    // `source instanceof Window` doesn't work in Chrome if `source` is a\r\n    // cross-origin window.\r\n    source === null ||\r\n    source instanceof MessagePort ||\r\n    (window.ServiceWorker && source instanceof ServiceWorker)\r\n  ) {\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n}\r\n","import { ListenerCollection } from '../listener-collection';\r\nimport { generateHexString } from '../random';\r\nimport { isMessageEqual } from './port-util';\r\n\r\n/** Timeout for waiting for the host frame to respond to a port request. */\r\nexport const MAX_WAIT_FOR_PORT = 1000 * 20;\r\n\r\n/** Polling interval for requests to the host frame for a port. */\r\nexport const POLLING_INTERVAL_FOR_PORT = 250;\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').Destroyable} Destroyable\r\n * @typedef {import('./port-util').Message} Message\r\n * @typedef {import('./port-util').Frame} Frame\r\n */\r\n\r\n/**\r\n * PortFinder is used by non-host frames in the client to establish a\r\n * MessagePort-based connection to other frames. It is used together with\r\n * PortProvider which runs in the host frame. See PortProvider for an overview.\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class PortFinder {\r\n  /**\r\n   * @param {object} options\r\n   *   @param {Exclude<Frame, 'host'>} options.source - the role of this frame\r\n   *   @param {Window} options.hostFrame - the frame where the `PortProvider` is\r\n   *     listening for messages.\r\n   */\r\n  constructor({ hostFrame, source }) {\r\n    this._hostFrame = hostFrame;\r\n    this._source = source;\r\n    this._listeners = new ListenerCollection();\r\n  }\r\n\r\n  destroy() {\r\n    this._listeners.removeAll();\r\n  }\r\n\r\n  /**\r\n   * Request a specific port from the host frame\r\n   *\r\n   * @param {Frame} target - the frame aiming to be discovered\r\n   * @return {Promise<MessagePort>}\r\n   */\r\n  async discover(target) {\r\n    let isValidRequest = false;\r\n    if (\r\n      (this._source === 'guest' && target === 'host') ||\r\n      (this._source === 'guest' && target === 'sidebar') ||\r\n      (this._source === 'sidebar' && target === 'host') ||\r\n      (this._source === 'notebook' && target === 'sidebar')\r\n    ) {\r\n      isValidRequest = true;\r\n    }\r\n\r\n    if (!isValidRequest) {\r\n      throw new Error('Invalid request of channel/port');\r\n    }\r\n\r\n    const requestId = generateHexString(6);\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const postRequest = () => {\r\n        this._hostFrame.postMessage(\r\n          {\r\n            frame1: this._source,\r\n            frame2: target,\r\n            type: 'request',\r\n            requestId,\r\n          },\r\n          '*'\r\n        );\r\n      };\r\n\r\n      // Because `guest` iframes load in parallel to the `host` frame, we can\r\n      // not assume that the code in the `host` frame is executed before the\r\n      // code in a `guest` frame. Hence, we can't assume that `PortProvider` (in\r\n      // the `host` frame) is initialized before `PortFinder` (in the non-host\r\n      // frames). Therefore, for the `PortFinder`, we implement a polling\r\n      // strategy (sending a message every N milliseconds) until a response is\r\n      // received.\r\n      const intervalId = setInterval(postRequest, POLLING_INTERVAL_FOR_PORT);\r\n\r\n      // The `host` frame maybe busy, that's why we should wait.\r\n      const timeoutId = setTimeout(() => {\r\n        clearInterval(intervalId);\r\n        reject(\r\n          new Error(\r\n            `Unable to establish ${this._source}-${target} communication channel`\r\n          )\r\n        );\r\n      }, MAX_WAIT_FOR_PORT);\r\n\r\n      const listenerId = this._listeners.add(window, 'message', event => {\r\n        const { data, ports } = event;\r\n        if (\r\n          isMessageEqual(data, {\r\n            frame1: this._source,\r\n            frame2: target,\r\n            type: 'offer',\r\n            requestId,\r\n          })\r\n        ) {\r\n          clearInterval(intervalId);\r\n          clearTimeout(timeoutId);\r\n          this._listeners.remove(listenerId);\r\n          resolve(ports[0]);\r\n        }\r\n      });\r\n\r\n      postRequest();\r\n    });\r\n  }\r\n}\r\n","function E () {\n  // Keep this empty so it's easier to inherit from\n  // (via https://github.com/lipsmack from https://github.com/scottcorgan/tiny-emitter/issues/3)\n}\n\nE.prototype = {\n  on: function (name, callback, ctx) {\n    var e = this.e || (this.e = {});\n\n    (e[name] || (e[name] = [])).push({\n      fn: callback,\n      ctx: ctx\n    });\n\n    return this;\n  },\n\n  once: function (name, callback, ctx) {\n    var self = this;\n    function listener () {\n      self.off(name, listener);\n      callback.apply(ctx, arguments);\n    };\n\n    listener._ = callback\n    return this.on(name, listener, ctx);\n  },\n\n  emit: function (name) {\n    var data = [].slice.call(arguments, 1);\n    var evtArr = ((this.e || (this.e = {}))[name] || []).slice();\n    var i = 0;\n    var len = evtArr.length;\n\n    for (i; i < len; i++) {\n      evtArr[i].fn.apply(evtArr[i].ctx, data);\n    }\n\n    return this;\n  },\n\n  off: function (name, callback) {\n    var e = this.e || (this.e = {});\n    var evts = e[name];\n    var liveEvents = [];\n\n    if (evts && callback) {\n      for (var i = 0, len = evts.length; i < len; i++) {\n        if (evts[i].fn !== callback && evts[i].fn._ !== callback)\n          liveEvents.push(evts[i]);\n      }\n    }\n\n    // Remove event from queue to prevent memory leak\n    // Suggested by https://github.com/lazd\n    // Ref: https://github.com/scottcorgan/tiny-emitter/commit/c6ebfaa9bc973b33d110a84a307742b7cf94c953#commitcomment-5024910\n\n    (liveEvents.length)\n      ? e[name] = liveEvents\n      : delete e[name];\n\n    return this;\n  }\n};\n\nmodule.exports = E;\nmodule.exports.TinyEmitter = E;\n","/** @type {Window|null} */\r\nlet errorDestination = null;\r\n\r\n/**\r\n * Wrap a callback with an error handler which forwards errors to another frame\r\n * using {@link sendError}.\r\n *\r\n * @template {unknown[]} Args\r\n * @template Result\r\n * @param {(...args: Args) => Result} callback\r\n * @param {string} context - A short message indicating where the error happened.\r\n * @return {(...args: Args) => Result}\r\n */\r\nexport function captureErrors(callback, context) {\r\n  return (...args) => {\r\n    try {\r\n      return callback(...args);\r\n    } catch (err) {\r\n      sendError(err, context);\r\n      throw err;\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * @typedef ErrorData\r\n * @prop {string} message\r\n * @prop {string} [stack]\r\n */\r\n\r\n/**\r\n * Return a cloneable representation of an Error.\r\n *\r\n * This is needed in browsers that don't support structured-cloning of Error\r\n * objects, or if the error is not cloneable for some reason.\r\n *\r\n * @param {Error|unknown} err\r\n * @return {ErrorData}\r\n */\r\nfunction serializeError(err) {\r\n  if (!(err instanceof Error)) {\r\n    return { message: String(err), stack: undefined };\r\n  }\r\n\r\n  return {\r\n    message: err.message,\r\n    stack: err.stack,\r\n  };\r\n}\r\n\r\n/**\r\n * Convert error data serialized by {@link serializeError} back into an Error.\r\n *\r\n * @param {ErrorData} data\r\n * @return {Error}\r\n */\r\nfunction deserializeError(data) {\r\n  const err = new Error(data.message);\r\n  err.stack = data.stack;\r\n  return err;\r\n}\r\n\r\n/**\r\n * Forward an error to the frame registered with {@link sendErrorsTo}.\r\n *\r\n * Errors are delivered on a best-effort basis. If no error handling frame has\r\n * been registered or the frame is still loading, the error will not be received.\r\n *\r\n * Ideally we would use a more robust delivery system which can queue messages\r\n * until they can be processed (eg. using MessagePort). We use `window.postMessage`\r\n * for the moment because we are trying to rule out problems with\r\n * MessageChannel/MessagePort when setting up sidebar <-> host communication.\r\n *\r\n * @param {unknown} error\r\n * @param {string} context - A short message indicating where the error happened.\r\n */\r\nexport function sendError(error, context) {\r\n  if (!errorDestination) {\r\n    return;\r\n  }\r\n\r\n  const data = {\r\n    type: 'hypothesis-error',\r\n    error: error instanceof Error ? error : serializeError(error),\r\n    context,\r\n  };\r\n\r\n  try {\r\n    // Try to send the error. If this fails because the browser doesn't support\r\n    // structured cloning of errors, use a fallback.\r\n    try {\r\n      errorDestination.postMessage(data, '*');\r\n    } catch (postErr) {\r\n      if (\r\n        postErr instanceof DOMException &&\r\n        postErr.name === 'DataCloneError'\r\n      ) {\r\n        data.error = serializeError(data.error);\r\n        errorDestination.postMessage(data, '*');\r\n      } else {\r\n        throw postErr;\r\n      }\r\n    }\r\n  } catch (sendErr) {\r\n    console.warn('Unable to report Hypothesis error', sendErr);\r\n  }\r\n}\r\n\r\n/**\r\n * Register a handler for errors sent to the current frame using {@link sendError}\r\n *\r\n * @param {(error: unknown, context: string) => void} callback\r\n * @return {() => void} A function that unregisters the handler\r\n */\r\nexport function handleErrorsInFrames(callback) {\r\n  /** @param {MessageEvent} event */\r\n  const handleMessage = event => {\r\n    const { data } = event;\r\n    if (data && data?.type === 'hypothesis-error') {\r\n      const { context, error } = data;\r\n      callback(\r\n        error instanceof Error ? error : deserializeError(error),\r\n        context\r\n      );\r\n    }\r\n  };\r\n  window.addEventListener('message', handleMessage);\r\n  return () => window.removeEventListener('message', handleMessage);\r\n}\r\n\r\n/**\r\n * Register a destination frame that {@link sendError} should submit errors to.\r\n *\r\n * @param {Window|null} destination\r\n */\r\nexport function sendErrorsTo(destination) {\r\n  errorDestination = destination;\r\n}\r\n","import { TinyEmitter } from 'tiny-emitter';\r\n\r\nimport { captureErrors, sendError } from '../frame-error-capture';\r\nimport { ListenerCollection } from '../listener-collection';\r\nimport { isMessage, isMessageEqual, isSourceWindow } from './port-util';\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').Destroyable} Destroyable\r\n * @typedef {import('./port-util').Message} Message\r\n * @typedef {import('./port-util').Frame} Frame\r\n * @typedef {'guest-host'|'guest-sidebar'|'notebook-sidebar'|'sidebar-host'} Channel\r\n */\r\n\r\n/**\r\n * PortProvider creates a `MessageChannel` for communication between two\r\n * frames.\r\n *\r\n * There are 4 types of frames:\r\n * - `host`: frame where the Hypothesis client is initially loaded.\r\n * - `guest`: frames with annotatable content. In some instances a `guest`\r\n *    frame can be the same as the `host` frame, in other cases, it is an iframe\r\n *    where either (1) the hypothesis client has been injected or (2) the\r\n *    hypothesis client has been configured to act exclusively as a `guest` (not\r\n *    showing the sidebar).\r\n * - `notebook`: another hypothesis app that runs in a separate iframe.\r\n * - `sidebar`: the main hypothesis app. It runs in an iframe on a different\r\n *    origin than the host and is responsible for the communication with the\r\n *    backend (fetching and saving annotations).\r\n *\r\n * This layout represents the current arrangement of frames:\r\n *\r\n * `host` frame\r\n * |-> `sidebar` iframe\r\n * |-> `notebook` iframe\r\n * |-> [`guest` iframes]\r\n *\r\n * Currently, we support communication between the following pairs of frames:\r\n * - `guest-host`\r\n * - `guest-sidebar`\r\n * - `notebook-sidebar`\r\n * - `sidebar-host`\r\n *\r\n * `PortProvider` is used only in the `host` frame. The other frames use the\r\n * companion class, `PortFinder`. `PortProvider` creates a `MessageChannel`\r\n * for two frames to communicate with each other. It also listens to requests for\r\n * particular `MessagePort` and dispatches the corresponding `MessagePort`.\r\n *\r\n *\r\n *        PortFinder (non-host frame)                 |       PortProvider (host frame)\r\n * -----------------------------------------------------------------------------------------------\r\n * 1. Request `MessagePort` via `window.postMessage` ---> 2. Receive request and create port pair\r\n *                                                                          |\r\n *                                                                          V\r\n * 4. Receive requested port      <---------------------- 3. Send first port to requesting frame\r\n *                                                        5. Send second port to other frame\r\n *                                                           (eg. via MessageChannel connection\r\n *                                                           between host and other frame)\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class PortProvider {\r\n  /**\r\n   * Begin listening to port requests from other frames.\r\n   *\r\n   * @param {string} hypothesisAppsOrigin - the origin of the hypothesis apps\r\n   *   is use to send the notebook and sidebar ports to only the frames that\r\n   *   match the origin.\r\n   */\r\n  constructor(hypothesisAppsOrigin) {\r\n    this._hypothesisAppsOrigin = '*';\r\n    this._emitter = new TinyEmitter();\r\n\r\n    /**\r\n     * IDs of port requests that have been handled.\r\n     *\r\n     * This is used to avoid responding to the same request multiple times.\r\n     * Guest frames in particular may send duplicate requests (see comments in\r\n     * PortFinder).\r\n     *\r\n     * @type {Set<string>}\r\n     */\r\n    this._handledRequests = new Set();\r\n\r\n    // Create the `sidebar-host` channel immediately, while other channels are\r\n    // created on demand\r\n    this._sidebarHostChannel = new MessageChannel();\r\n\r\n    this._listeners = new ListenerCollection();\r\n\r\n    /** @type {Array<Partial<Message> & {allowedOrigin: string}>} */\r\n    this._allowedMessages = [\r\n      {\r\n        allowedOrigin: '*',\r\n        frame1: 'guest',\r\n        frame2: 'host',\r\n        type: 'request',\r\n      },\r\n      {\r\n        allowedOrigin: '*',\r\n        frame1: 'guest',\r\n        frame2: 'sidebar',\r\n        type: 'request',\r\n      },\r\n      {\r\n        allowedOrigin: this._hypothesisAppsOrigin,\r\n        frame1: 'sidebar',\r\n        frame2: 'host',\r\n        type: 'request',\r\n      },\r\n      {\r\n        allowedOrigin: this._hypothesisAppsOrigin,\r\n        frame1: 'notebook',\r\n        frame2: 'sidebar',\r\n        type: 'request',\r\n      },\r\n    ];\r\n\r\n    this._listen();\r\n  }\r\n\r\n  _listen() {\r\n    const errorContext = 'Handling port request';\r\n    const sentErrors = /** @type {Set<string>} */ (new Set());\r\n\r\n    /** @param {string} message */\r\n    const reportError = message => {\r\n      if (sentErrors.has(message)) {\r\n        // PortFinder will send requests repeatedly until it gets a response or\r\n        // a timeout is reached.\r\n        //\r\n        // Only send errors once to avoid spamming Sentry.\r\n        return;\r\n      }\r\n      sentErrors.add(message);\r\n      sendError(new Error(message), errorContext);\r\n    };\r\n\r\n    /** @param {MessageEvent} event */\r\n    const handleRequest = event => {\r\n      const { data, origin, source } = event;\r\n\r\n      if (!isMessage(data) || data.type !== 'request') {\r\n        // If this does not look like a message intended for us, ignore it.\r\n        return;\r\n      }\r\n\r\n      const { frame1, frame2, requestId } = data;\r\n      const channel = /** @type {Channel} */ (`${frame1}-${frame2}`);\r\n\r\n      if (!isSourceWindow(source)) {\r\n        reportError(\r\n          `Ignored port request for channel ${channel} from non-Window source`\r\n        );\r\n        return;\r\n      }\r\n\r\n      const match = this._allowedMessages.find(\r\n        ({ allowedOrigin, ...allowedMessage }) =>\r\n          this._messageMatches({\r\n            allowedMessage,\r\n            allowedOrigin,\r\n            data,\r\n            origin,\r\n          })\r\n      );\r\n\r\n      if (match === undefined) {\r\n        reportError(\r\n          `Ignored invalid port request for channel ${channel} from ${origin}`\r\n        );\r\n        return;\r\n      }\r\n\r\n      if (this._handledRequests.has(requestId)) {\r\n        return;\r\n      }\r\n      this._handledRequests.add(requestId);\r\n\r\n      // Create the channel for these two frames to communicate and send the\r\n      // corresponding ports to them.\r\n      const messageChannel =\r\n        channel === 'sidebar-host'\r\n          ? this._sidebarHostChannel\r\n          : new MessageChannel();\r\n\r\n      const message = { frame1, frame2, type: 'offer', requestId };\r\n\r\n      source.postMessage(message, '*', [messageChannel.port1]);\r\n\r\n      if (frame2 === 'sidebar') {\r\n        this._sidebarHostChannel.port2.postMessage(message, [\r\n          messageChannel.port2,\r\n        ]);\r\n      } else if (frame2 === 'host') {\r\n        this._emitter.emit('frameConnected', frame1, messageChannel.port2);\r\n      }\r\n    };\r\n\r\n    this._listeners.add(\r\n      window,\r\n      'message',\r\n      captureErrors(handleRequest, errorContext)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @param {object} options\r\n   *   @param {Partial<Message>} options.allowedMessage - the `data` must match this\r\n   *     `Message`.\r\n   *   @param {string} options.allowedOrigin - the `origin` must match this\r\n   *     value. If `allowedOrigin` is '*', the origin is ignored.\r\n   *   @param {unknown} options.data - the data to be compared with `allowedMessage`.\r\n   *   @param {string} options.origin - the origin to be compared with\r\n   *     `allowedOrigin`.\r\n   */\r\n  _messageMatches({ allowedMessage, allowedOrigin, data, origin }) {\r\n    if (allowedOrigin !== '*' && origin !== allowedOrigin) {\r\n      return false;\r\n    }\r\n\r\n    return isMessageEqual(data, allowedMessage);\r\n  }\r\n\r\n  /**\r\n   * @param {'frameConnected'} eventName\r\n   * @param {(source: 'guest'|'sidebar', port: MessagePort) => void} handler - this handler\r\n   *   fires when a frame connects to the host frame\r\n   */\r\n  on(eventName, handler) {\r\n    this._emitter.on(eventName, handler);\r\n  }\r\n\r\n  destroy() {\r\n    this._listeners.removeAll();\r\n  }\r\n}\r\n","import { ListenerCollection } from '../listener-collection';\r\n\r\n/*\r\n  This module was adapted from `index.js` in https://github.com/substack/frame-rpc.\r\n\r\n  This software is released under the MIT license:\r\n\r\n  Permission is hereby granted, free of charge, to any person obtaining a copy\r\n  of this software and associated documentation files (the \"Software\"), to deal\r\n  in the Software without restriction, including without limitation the rights\r\n  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n  copies of the Software, and to permit persons to whom the Software is\r\n  furnished to do so, subject to the following conditions:\r\n\r\n  The above copyright notice and this permission notice shall be included in\r\n  all copies or substantial portions of the Software.\r\n\r\n  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n  SOFTWARE.\r\n */\r\n\r\nconst VERSION = '1.0.0';\r\nconst PROTOCOL = 'frame-rpc';\r\n\r\n/**\r\n * Format of messages sent between frames.\r\n *\r\n * See https://github.com/substack/frame-rpc#protocol\r\n *\r\n * @typedef RequestMessage\r\n * @prop {unknown[]} arguments\r\n * @prop {string} method\r\n * @prop {PROTOCOL} protocol\r\n * @prop {number} sequence\r\n * @prop {VERSION} version\r\n *\r\n * @typedef ResponseMessage\r\n * @prop {unknown[]} arguments\r\n * @prop {PROTOCOL} protocol\r\n * @prop {number} response\r\n * @prop {VERSION} version\r\n *\r\n * @typedef {RequestMessage|ResponseMessage} Message\r\n *\r\n * @typedef {import('../../types/annotator').Destroyable} Destroyable\r\n */\r\n\r\n/**\r\n * Send a PortRPC method call.\r\n *\r\n * @param {MessagePort} port\r\n * @param {string} method\r\n * @param {unknown[]} [args]\r\n * @param {number} [sequence] - Sequence number used for replies\r\n */\r\nfunction sendCall(port, method, args = [], sequence = -1) {\r\n  port.postMessage(\r\n    /** @type {RequestMessage} */ ({\r\n      protocol: PROTOCOL,\r\n      version: VERSION,\r\n      arguments: args,\r\n      method,\r\n      sequence,\r\n    })\r\n  );\r\n}\r\n\r\n/**\r\n * Install a message listener that ensures proper delivery of \"close\" notifications\r\n * from {@link PortRPC}s in Safari <= 15.\r\n *\r\n * This must be called in the _parent_ frame of the frame that owns the port.\r\n * In Hypothesis this means for example that the workaround would be installed\r\n * in the host frame to ensure delivery of \"close\" notifications from \"guest\"\r\n * frames.\r\n *\r\n * @param {string} [userAgent] - Test seam\r\n * @return {() => void} - Callback that removes the listener\r\n */\r\nexport function installPortCloseWorkaroundForSafari(\r\n  /* istanbul ignore next */\r\n  userAgent = navigator.userAgent\r\n) {\r\n  if (!shouldUseSafariWorkaround(userAgent)) {\r\n    return () => {};\r\n  }\r\n\r\n  /** @param {MessageEvent} event */\r\n  const handler = event => {\r\n    if (event.data?.type === 'hypothesisPortClosed' && event.ports[0]) {\r\n      const port = event.ports[0];\r\n      sendCall(port, 'close');\r\n      port.close();\r\n    }\r\n  };\r\n\r\n  window.addEventListener('message', handler);\r\n  return () => window.removeEventListener('message', handler);\r\n}\r\n\r\n/**\r\n * Test whether this browser needs the workaround for https://bugs.webkit.org/show_bug.cgi?id=231167.\r\n *\r\n * @param {string} userAgent\r\n */\r\nfunction shouldUseSafariWorkaround(userAgent) {\r\n  const webkitVersionMatch = userAgent.match(/\\bAppleWebKit\\/([0-9]+)\\b/);\r\n  if (!webkitVersionMatch) {\r\n    return false;\r\n  }\r\n  const version = parseInt(webkitVersionMatch[1]);\r\n\r\n  // Chrome's user agent contains the token \"AppleWebKit/537.36\", where the\r\n  // version number is frozen. This corresponds to a version of Safari from 2013,\r\n  // which is older than all supported Safari versions.\r\n  if (version <= 537) {\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n/**\r\n * Callback type used for RPC method handlers and result callbacks.\r\n *\r\n * @typedef {(...args: unknown[]) => void} Callback\r\n */\r\n\r\n/**\r\n * @param {any} value\r\n * @return {value is Callback}\r\n */\r\nfunction isCallback(value) {\r\n  return typeof value === 'function';\r\n}\r\n\r\n/**\r\n * PortRPC provides remote procedure calls between frames or workers. It uses\r\n * the Channel Messaging API [1] as a transport.\r\n *\r\n * To communicate between two frames with this class, construct a PortRPC\r\n * instance in each and register method handlers with {@link on}. Create a\r\n * {@link MessageChannel} and send one of its two ports to each frame. Then call\r\n * {@link connect} to make the PortRPC instance in each frame use the corresponding\r\n * port.\r\n *\r\n * In addition to the custom methods that a PortRPC handles, there are several\r\n * built-in events which are sent automatically:\r\n *\r\n * - \"connect\" is sent when a PortRPC connects to a port. This event can\r\n *   be used to confirm that the sending frame has received the port and will\r\n *   send a \"close\" event when it goes away.\r\n * - \"close\" is sent when a PortRPC is destroyed or the owning frame is\r\n *   unloaded. This event may not be dispatched if the guest frame terminates\r\n *   abnormally (eg. due to an OS process crash).\r\n *\r\n * [1] https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API\r\n *\r\n * @template {string} OnMethod - Names of RPC methods this client responds to\r\n * @template {string} CallMethod - Names of RPC methods this client invokes\r\n * @implements {Destroyable}\r\n */\r\nexport class PortRPC {\r\n  /**\r\n   * @param {object} options\r\n   *   @param {string} [options.userAgent] - Test seam\r\n   *   @param {Window} [options.currentWindow] - Test seam\r\n   */\r\n  constructor({\r\n    userAgent = navigator.userAgent,\r\n    currentWindow = window,\r\n  } = {}) {\r\n    /** @type {MessagePort|null} */\r\n    this._port = null;\r\n\r\n    /** @type {Map<string, Callback>} */\r\n    this._methods = new Map();\r\n\r\n    this._sequence = 1;\r\n\r\n    /** @type {Map<number, Callback>} */\r\n    this._callbacks = new Map();\r\n\r\n    this._listeners = new ListenerCollection();\r\n    this._listeners.add(currentWindow, 'unload', () => {\r\n      if (this._port) {\r\n        // Send \"close\" notification directly. This works in Chrome, Firefox and\r\n        // Safari >= 16.\r\n        sendCall(this._port, 'close');\r\n\r\n        // To work around a bug in Safari <= 15 which prevents sending messages\r\n        // while a window is unloading, try transferring the port to the parent frame\r\n        // and re-sending the \"close\" event from there.\r\n        if (\r\n          currentWindow !== currentWindow.parent &&\r\n          shouldUseSafariWorkaround(userAgent)\r\n        ) {\r\n          currentWindow.parent.postMessage(\r\n            { type: 'hypothesisPortClosed' },\r\n            '*',\r\n            [this._port]\r\n          );\r\n        }\r\n      }\r\n    });\r\n\r\n    /**\r\n     * Method and arguments of pending RPC calls made before a port was connected.\r\n     *\r\n     * @type {Array<[CallMethod, unknown[]]>}\r\n     */\r\n    this._pendingCalls = [];\r\n\r\n    this._receivedCloseEvent = false;\r\n  }\r\n\r\n  /**\r\n   * Register a method handler for incoming RPC requests.\r\n   *\r\n   * This can also be used to register a handler for the built-in \"connect\"\r\n   * and \"close\" events.\r\n   *\r\n   * All handlers must be registered before {@link connect} is invoked.\r\n   *\r\n   * @template {function} Handler\r\n   * @param {OnMethod|'close'|'connect'} method\r\n   * @param {Handler} handler\r\n   */\r\n  on(method, handler) {\r\n    if (this._port) {\r\n      throw new Error('Cannot add a method handler after a port is connected');\r\n    }\r\n    this._methods.set(method, /** @type {any} */ (handler));\r\n  }\r\n\r\n  /**\r\n   * Connect to a MessagePort and process any queued RPC requests.\r\n   *\r\n   * @param {MessagePort} port\r\n   */\r\n  connect(port) {\r\n    this._port = port;\r\n    this._listeners.add(port, 'message', event => this._handle(event));\r\n    port.start();\r\n    sendCall(port, 'connect');\r\n\r\n    for (let [method, args] of this._pendingCalls) {\r\n      this.call(method, ...args);\r\n    }\r\n    this._pendingCalls = [];\r\n  }\r\n\r\n  /**\r\n   * Disconnect the RPC channel and close the MessagePort.\r\n   */\r\n  destroy() {\r\n    if (this._port) {\r\n      sendCall(this._port, 'close');\r\n      this._port.close();\r\n    }\r\n    this._destroyed = true;\r\n    this._listeners.removeAll();\r\n  }\r\n\r\n  /**\r\n   * Send an RPC request via the connected port.\r\n   *\r\n   * If this client is not yet connected to a port, the call will be queued and\r\n   * sent when {@link connect} is called.\r\n   *\r\n   * If the final argument in `args` is a function, it is treated as a callback\r\n   * which is invoked with the response in the form of (error, result) arguments.\r\n   *\r\n   * @param {CallMethod} method\r\n   * @param {unknown[]} args\r\n   */\r\n  call(method, ...args) {\r\n    if (!this._port) {\r\n      this._pendingCalls.push([method, args]);\r\n    }\r\n\r\n    if (!this._port || this._destroyed) {\r\n      return;\r\n    }\r\n\r\n    const seq = this._sequence++;\r\n    const finalArg = args[args.length - 1];\r\n    if (isCallback(finalArg)) {\r\n      this._callbacks.set(seq, finalArg);\r\n      args = args.slice(0, -1);\r\n    }\r\n\r\n    sendCall(this._port, method, args, seq);\r\n  }\r\n\r\n  /**\r\n   * Validate message\r\n   *\r\n   * @param {MessageEvent} event\r\n   * @return {null|Message}\r\n   */\r\n  _parseMessage({ data }) {\r\n    if (!data || typeof data !== 'object') {\r\n      return null;\r\n    }\r\n    if (data.protocol !== PROTOCOL) {\r\n      return null;\r\n    }\r\n    if (data.version !== VERSION) {\r\n      return null;\r\n    }\r\n    if (!Array.isArray(data.arguments)) {\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @param {MessageEvent} event\r\n   */\r\n  _handle(event) {\r\n    const msg = this._parseMessage(event);\r\n    const port = this._port;\r\n\r\n    if (!msg || !port) {\r\n      return;\r\n    }\r\n\r\n    if ('method' in msg) {\r\n      // Only allow close event to fire once.\r\n      if (msg.method === 'close') {\r\n        if (this._receivedCloseEvent) {\r\n          return;\r\n        } else {\r\n          this._receivedCloseEvent = true;\r\n        }\r\n      }\r\n\r\n      const handler = this._methods.get(msg.method);\r\n      if (!handler) {\r\n        return;\r\n      }\r\n\r\n      /** @param {unknown[]} args */\r\n      const callback = (...args) => {\r\n        /** @type {ResponseMessage} */\r\n        const message = {\r\n          arguments: args,\r\n          protocol: PROTOCOL,\r\n          response: msg.sequence,\r\n          version: VERSION,\r\n        };\r\n\r\n        port.postMessage(message);\r\n      };\r\n      handler(...msg.arguments, callback);\r\n    } else if ('response' in msg) {\r\n      const cb = this._callbacks.get(msg.response);\r\n      this._callbacks.delete(msg.response);\r\n      if (cb) {\r\n        cb(...msg.arguments);\r\n      }\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Polyfill for `Object.hasOwn`.\r\n *\r\n * `hasOwn(someObject, property)` should be used instead of\r\n * `someObject.hasOwnProperty(name)`.\r\n *\r\n * @param {object} object\r\n * @param {string} property\r\n */\r\nexport function hasOwn(object, property) {\r\n  return Object.prototype.hasOwnProperty.call(object, property);\r\n}\r\n","/**\r\n * Return a parsed `js-hypothesis-config` object from the document, or `{}`.\r\n *\r\n * Find all `<script class=\"js-hypothesis-config\">` tags in the given document,\r\n * parse them as JSON, and return the parsed object.\r\n *\r\n * If there are no `js-hypothesis-config` tags in the document then return\r\n * `{}`.\r\n *\r\n * If there are multiple `js-hypothesis-config` tags in the document then merge\r\n * them into a single returned object (when multiple scripts contain the same\r\n * setting names, scripts further down in the document override those further\r\n * up).\r\n *\r\n * @param {Document|Element} document - The root element to search.\r\n */\r\nexport function parseJsonConfig(document) {\r\n  /** @type {Record<string, unknown>} */\r\n  const config = {};\r\n  const settingsElements = document.querySelectorAll(\r\n    'script.js-hypothesis-config'\r\n  );\r\n\r\n  for (let i = 0; i < settingsElements.length; i++) {\r\n    let settings;\r\n    try {\r\n      settings = JSON.parse(settingsElements[i].textContent || '');\r\n    } catch (err) {\r\n      console.warn(\r\n        'Could not parse settings from js-hypothesis-config tags',\r\n        err\r\n      );\r\n      settings = {};\r\n    }\r\n    Object.assign(config, settings);\r\n  }\r\n\r\n  return config;\r\n}\r\n","/**\r\n * Type conversion methods that coerce incoming configuration values to an\r\n * expected type or format that other parts of the UI may make assumptions\r\n * on. This is needed for incoming configuration values that are otherwise\r\n * not sanitized.\r\n *\r\n * Note that if the values passed are plain javascript values (such as ones\r\n * produced from JSON.parse), then these methods do not throw errors.\r\n */\r\n\r\n/**\r\n * Returns a boolean\r\n *\r\n * @param {any} value - initial value\r\n * @return {boolean}\r\n */\r\nexport function toBoolean(value) {\r\n  if (typeof value === 'string') {\r\n    if (value.trim().toLocaleLowerCase() === 'false') {\r\n      // \"false\", \"False\", \" false\", \"FALSE\" all return false\r\n      return false;\r\n    }\r\n  }\r\n  const numericalVal = Number(value);\r\n  if (!isNaN(numericalVal)) {\r\n    return Boolean(numericalVal);\r\n  }\r\n  // Any non numerical or falsely string should return true, otherwise return false\r\n  return typeof value === 'string';\r\n}\r\n\r\n/**\r\n * Returns either an integer or NaN\r\n *\r\n * @param {any} value - initial value\r\n * @return {number}\r\n */\r\nexport function toInteger(value) {\r\n  // Acts as a simple wrapper\r\n  return parseInt(value);\r\n}\r\n\r\n/**\r\n * Returns either the value if its an object or an empty object\r\n *\r\n * @param {any} value - initial value\r\n * @return {object}\r\n */\r\nexport function toObject(value) {\r\n  if (typeof value === 'object' && value !== null) {\r\n    return value;\r\n  }\r\n  // Don't attempt to fix the values, just ensure type correctness\r\n  return {};\r\n}\r\n\r\n/**\r\n * Returns the value as a string or an empty string if the\r\n * value undefined, null or otherwise falsely.\r\n *\r\n * @param {any} value - initial value\r\n * @return {string}\r\n */\r\nexport function toString(value) {\r\n  if (value && typeof value.toString === 'function') {\r\n    return value.toString();\r\n  }\r\n  return '';\r\n}\r\n\r\n/**\r\n * @template T\r\n * @typedef {import('preact').Ref<T>} Ref\r\n */\r\n\r\n/**\r\n * Helper for downcasting a ref to a more specific type, where that is safe\r\n * to do.\r\n *\r\n * This is mainly useful to cast a generic `Ref<HTMLElement>` to a more specific\r\n * element type (eg. `Ref<HTMLDivElement>`) for use with the `ref` prop of a JSX element.\r\n * Since Preact only writes to the `ref` prop, such a cast is safe.\r\n *\r\n * @template T\r\n * @template {T} U\r\n * @param {Ref<T>|undefined} ref\r\n * @return {Ref<U>|undefined}\r\n */\r\nexport function downcastRef(ref) {\r\n  return /** @type {Ref<U>|undefined} */ (ref);\r\n}\r\n","/**\r\n * Return the URL of a resource related to the Hypothesis client that has been stored in\r\n * the page via a `<link type=\"application/annotator+{type}\">` tag.\r\n *\r\n * These link tags are generally written to the page by the boot script, which may be executed\r\n * in a separate JavaScript realm (eg. in the browser extension), and thus can share information\r\n * with the annotator code via the DOM but not JS globals.\r\n *\r\n * @param {Window} window_\r\n * @param {string} rel - The `rel` attribute to match\r\n * @param {'javascript'|'html'} type - Type of resource that the link refers to\r\n * @throws {Error} - If there's no link with the `rel` indicated, or the first\r\n *   matching link has no `href`\r\n */\r\nexport function urlFromLinkTag(window_, rel, type) {\r\n  const link = /** @type {HTMLLinkElement} */ (\r\n    window_.document.querySelector(\r\n      `link[type=\"application/annotator+${type}\"][rel=\"${rel}\"]`\r\n    )\r\n  );\r\n\r\n  if (!link) {\r\n    throw new Error(\r\n      `No application/annotator+${type} (rel=\"${rel}\") link in the document`\r\n    );\r\n  }\r\n\r\n  if (!link.href) {\r\n    throw new Error(\r\n      `application/annotator+${type} (rel=\"${rel}\") link has no href`\r\n    );\r\n  }\r\n\r\n  return link.href;\r\n}\r\n","import { hasOwn } from '../../shared/has-own';\r\nimport { parseJsonConfig } from '../../boot/parse-json-config';\r\nimport { toBoolean } from '../../shared/type-coercions';\r\n\r\nimport { configFuncSettingsFrom } from './config-func-settings-from';\r\nimport { urlFromLinkTag } from './url-from-link-tag';\r\n\r\n/**\r\n * @typedef SettingsGetters\r\n * @prop {string|null} annotations\r\n * @prop {string|null} query\r\n * @prop {string|null} group\r\n * @prop {string} showHighlights\r\n * @prop {string} clientUrl\r\n * @prop {string} sidebarAppUrl\r\n * @prop {string} notebookAppUrl\r\n * @prop {(name: string) => unknown} hostPageSetting\r\n */\r\n\r\n/**\r\n * Discard a setting if it is not a string.\r\n *\r\n * @param {unknown} value\r\n */\r\nfunction checkIfString(value) {\r\n  return typeof value === 'string' ? value : null;\r\n}\r\n\r\n/**\r\n * @param {Window} window_\r\n * @return {SettingsGetters}\r\n */\r\nexport function settingsFrom(window_) {\r\n  // Prioritize the `window.hypothesisConfig` function over the JSON format\r\n  // Via uses `window.hypothesisConfig` and makes it non-configurable and non-writable.\r\n  // In addition, Via sets the `ignoreOtherConfiguration` option to prevent configuration merging.\r\n  const configFuncSettings = configFuncSettingsFrom(window_);\r\n\r\n  /** @type {Record<string, unknown>} */\r\n  let jsonConfigs;\r\n  if (toBoolean(configFuncSettings.ignoreOtherConfiguration)) {\r\n    jsonConfigs = {};\r\n  } else {\r\n    jsonConfigs = parseJsonConfig(window_.document);\r\n  }\r\n\r\n  /**\r\n   * Return the `#annotations:*` ID from the given URL's fragment.\r\n   *\r\n   * If the URL contains a `#annotations:<ANNOTATION_ID>` fragment then return\r\n   * the annotation ID extracted from the fragment. Otherwise return `null`.\r\n   *\r\n   * @return {string|null} - The extracted ID, or null.\r\n   */\r\n  function annotations() {\r\n    /** Return the annotations from the URL, or null. */\r\n    function annotationsFromURL() {\r\n      // Annotation IDs are url-safe-base64 identifiers\r\n      // See https://tools.ietf.org/html/rfc4648#page-7\r\n      const annotFragmentMatch = window_.location.href.match(\r\n        /#annotations:([A-Za-z0-9_-]+)$/\r\n      );\r\n      if (annotFragmentMatch) {\r\n        return annotFragmentMatch[1];\r\n      }\r\n      return null;\r\n    }\r\n\r\n    return checkIfString(jsonConfigs.annotations) || annotationsFromURL();\r\n  }\r\n\r\n  /**\r\n   * Return the `#annotations:group:*` ID from the given URL's fragment.\r\n   *\r\n   * If the URL contains a `#annotations:group:<GROUP_ID>` fragment then return\r\n   * the group ID extracted from the fragment. Otherwise return `null`.\r\n   *\r\n   * @return {string|null} - The extracted ID, or null.\r\n   */\r\n  function group() {\r\n    function groupFromURL() {\r\n      const groupFragmentMatch = window_.location.href.match(\r\n        /#annotations:group:([A-Za-z0-9_-]+)$/\r\n      );\r\n      if (groupFragmentMatch) {\r\n        return groupFragmentMatch[1];\r\n      }\r\n      return null;\r\n    }\r\n\r\n    return checkIfString(jsonConfigs.group) || groupFromURL();\r\n  }\r\n\r\n  function showHighlights() {\r\n    const value = hostPageSetting('showHighlights');\r\n\r\n    switch (value) {\r\n      case 'always':\r\n      case 'never':\r\n      case 'whenSidebarOpen':\r\n        return value;\r\n      case true:\r\n        return 'always';\r\n      case false:\r\n        return 'never';\r\n      default:\r\n        return 'always';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the config.query setting from the host page or from the URL.\r\n   *\r\n   * If the host page contains a js-hypothesis-config script containing a\r\n   * query setting then return that.\r\n   *\r\n   * Otherwise if the host page's URL has a `#annotations:query:*` (or\r\n   * `#annotations:q:*`) fragment then return the query value from that.\r\n   *\r\n   * Otherwise return null.\r\n   *\r\n   * @return {string|null} - The config.query setting, or null.\r\n   */\r\n  function query() {\r\n    /** Return the query from the URL, or null. */\r\n    function queryFromURL() {\r\n      const queryFragmentMatch = window_.location.href.match(\r\n        /#annotations:(query|q):(.+)$/i\r\n      );\r\n      if (queryFragmentMatch) {\r\n        try {\r\n          return decodeURIComponent(queryFragmentMatch[2]);\r\n        } catch (err) {\r\n          // URI Error should return the page unfiltered.\r\n        }\r\n      }\r\n      return null;\r\n    }\r\n\r\n    return checkIfString(jsonConfigs.query) || queryFromURL();\r\n  }\r\n\r\n  /**\r\n   * Returns the first setting value found from the respective sources in order.\r\n   *\r\n   *  1. window.hypothesisConfig()\r\n   *  2. <script class=\"js-hypothesis-config\">\r\n   *\r\n   * If the setting is not found in either source, then return undefined.\r\n   *\r\n   * @param {string} name - Unique name of the setting\r\n   */\r\n  function hostPageSetting(name) {\r\n    if (hasOwn(configFuncSettings, name)) {\r\n      return configFuncSettings[name];\r\n    }\r\n\r\n    if (hasOwn(jsonConfigs, name)) {\r\n      return jsonConfigs[name];\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  return {\r\n    get annotations() {\r\n      return annotations();\r\n    },\r\n    get clientUrl() {\r\n      return urlFromLinkTag(window_, 'hypothesis-client', 'javascript');\r\n    },\r\n    get group() {\r\n      return group();\r\n    },\r\n    get notebookAppUrl() {\r\n      return urlFromLinkTag(window_, 'notebook', 'html');\r\n    },\r\n    get showHighlights() {\r\n      return showHighlights();\r\n    },\r\n    get sidebarAppUrl() {\r\n      return urlFromLinkTag(window_, 'sidebar', 'html');\r\n    },\r\n    get query() {\r\n      return query();\r\n    },\r\n    hostPageSetting,\r\n  };\r\n}\r\n","import { hasOwn } from '../../shared/has-own';\r\n\r\n/**\r\n * @typedef HypothesisWindowProps\r\n * @prop {() => Record<string, unknown>} [hypothesisConfig] - Function that returns configuration\r\n *   for the Hypothesis client\r\n */\r\n\r\n/**\r\n * Return an object containing config settings from window.hypothesisConfig().\r\n *\r\n * Return an object containing config settings returned by the\r\n * window.hypothesisConfig() function provided by the host page:\r\n *\r\n *   {\r\n *     fooSetting: 'fooValue',\r\n *     barSetting: 'barValue',\r\n *     ...\r\n *   }\r\n *\r\n * If there's no window.hypothesisConfig() function then return {}.\r\n *\r\n * @param {Window & HypothesisWindowProps} window_ - The window to search for a hypothesisConfig() function\r\n * @return {Record<string, unknown>} - Any config settings returned by hypothesisConfig()\r\n */\r\nexport function configFuncSettingsFrom(window_) {\r\n  if (!hasOwn(window_, 'hypothesisConfig')) {\r\n    return {};\r\n  }\r\n\r\n  if (typeof window_.hypothesisConfig !== 'function') {\r\n    const docs =\r\n      'https://h.readthedocs.io/projects/client/en/latest/publishers/config/#window.hypothesisConfig';\r\n    console.warn('hypothesisConfig must be a function, see: ' + docs);\r\n    return {};\r\n  }\r\n\r\n  return window_.hypothesisConfig();\r\n}\r\n","import { isBrowserExtension } from './is-browser-extension';\r\nimport { settingsFrom } from './settings';\r\nimport { toBoolean } from '../../shared/type-coercions';\r\nimport { urlFromLinkTag } from './url-from-link-tag';\r\n\r\n/**\r\n * @typedef {import('./settings').SettingsGetters} SettingsGetters\r\n * @typedef {(settings: SettingsGetters, name: string) => any} ValueGetter\r\n *\r\n * @typedef ConfigDefinition\r\n * @prop {ValueGetter} getValue - Method to retrieve the value from the incoming source\r\n * @prop {boolean} allowInBrowserExt -\r\n *  Allow this setting to be read in the browser extension. If this is false\r\n *  and browser extension context is true, use `defaultValue` if provided otherwise\r\n *  ignore the config key\r\n * @prop {any} [defaultValue] - Sets a default if `getValue` returns undefined\r\n * @prop {(value: any) => any} [coerce] - Transform a value's type, value or both\r\n *\r\n * @typedef {Record<string, ConfigDefinition>} ConfigDefinitionMap\r\n */\r\n\r\n/**\r\n * Named subset of the Hypothesis client configuration that is relevant in\r\n * a particular context.\r\n *\r\n * @typedef {'sidebar'|'notebook'|'annotator'|'all'} Context\r\n */\r\n\r\n/**\r\n * Returns the configuration keys that are relevant to a particular context.\r\n *\r\n * @param {Context} context\r\n */\r\nfunction configurationKeys(context) {\r\n  const contexts = {\r\n    annotator: ['clientUrl', 'contentInfoBanner', 'subFrameIdentifier'],\r\n    sidebar: [\r\n      'appType',\r\n      'annotations',\r\n      'branding',\r\n      'enableExperimentalNewNoteButton',\r\n      'externalContainerSelector',\r\n      'focus',\r\n      'group',\r\n      'onLayoutChange',\r\n      'openSidebar',\r\n      'query',\r\n      'requestConfigFromFrame',\r\n      'services',\r\n      'showHighlights',\r\n      'sidebarAppUrl',\r\n      'theme',\r\n      'usernameUrl',\r\n    ],\r\n    notebook: [\r\n      'branding',\r\n      'group',\r\n      'notebookAppUrl',\r\n      'requestConfigFromFrame',\r\n      'services',\r\n      'theme',\r\n      'usernameUrl',\r\n    ],\r\n  };\r\n\r\n  switch (context) {\r\n    case 'annotator':\r\n      return contexts.annotator;\r\n    case 'sidebar':\r\n      return contexts.sidebar;\r\n    case 'notebook':\r\n      return contexts.notebook;\r\n    case 'all':\r\n      // Complete list of configuration keys used for testing.\r\n      return [...contexts.annotator, ...contexts.sidebar, ...contexts.notebook];\r\n    default:\r\n      throw new Error(`Invalid application context used: \"${context}\"`);\r\n  }\r\n}\r\n\r\n/** @type {ValueGetter} */\r\nfunction getHostPageSetting(settings, name) {\r\n  return settings.hostPageSetting(name);\r\n}\r\n\r\n/**\r\n * Definitions of configuration keys\r\n *\r\n * @type {ConfigDefinitionMap}\r\n */\r\nconst configDefinitions = {\r\n  annotations: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: settings => settings.annotations,\r\n  },\r\n  appType: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  branding: {\r\n    defaultValue: null,\r\n    allowInBrowserExt: false,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  // URL of the client's boot script. Used when injecting the client into\r\n  // child iframes.\r\n  clientUrl: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: settings => settings.clientUrl,\r\n  },\r\n  contentInfoBanner: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  enableExperimentalNewNoteButton: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  group: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: settings => settings.group,\r\n  },\r\n  focus: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  theme: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  usernameUrl: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  onLayoutChange: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  openSidebar: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: false,\r\n    coerce: toBoolean,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  query: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: settings => settings.query,\r\n  },\r\n  requestConfigFromFrame: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  services: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  showHighlights: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: 'always',\r\n    getValue: settings => settings.showHighlights,\r\n  },\r\n  notebookAppUrl: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: settings => settings.notebookAppUrl,\r\n  },\r\n  sidebarAppUrl: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: settings => settings.sidebarAppUrl,\r\n  },\r\n  // Sub-frame identifier given when a frame is being embedded into\r\n  // by a top level client\r\n  subFrameIdentifier: {\r\n    allowInBrowserExt: true,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n  externalContainerSelector: {\r\n    allowInBrowserExt: false,\r\n    defaultValue: null,\r\n    getValue: getHostPageSetting,\r\n  },\r\n};\r\n\r\n/**\r\n * Return the subset of Hypothesis client configuration that is relevant in\r\n * a particular context.\r\n *\r\n * See https://h.readthedocs.io/projects/client/en/latest/publishers/config/\r\n * for details of all available configuration and the different ways they\r\n * can be included on the page. In addition to the configuration provided by\r\n * the embedder, the boot script also passes some additional configuration\r\n * to the annotator, such as URLs of the various sub-applications and the\r\n * boot script itself.\r\n *\r\n * @param {Context} context\r\n */\r\nexport function getConfig(context, window_ = window) {\r\n  const settings = settingsFrom(window_);\r\n\r\n  /** @type {Record<string, unknown>} */\r\n  const config = {};\r\n\r\n  // Filter the config based on the application context as some config values\r\n  // may be inappropriate or erroneous for some applications.\r\n  for (let key of configurationKeys(context)) {\r\n    const configDef = configDefinitions[key];\r\n    const hasDefault = configDef.defaultValue !== undefined; // A default could be null\r\n    const isURLFromBrowserExtension = isBrowserExtension(\r\n      urlFromLinkTag(window_, 'sidebar', 'html')\r\n    );\r\n\r\n    // Only allow certain values in the browser extension context\r\n    if (!configDef.allowInBrowserExt && isURLFromBrowserExtension) {\r\n      // If the value is not allowed here, then set to the default if provided, otherwise ignore\r\n      // the key:value pair\r\n      if (hasDefault) {\r\n        config[key] = configDef.defaultValue;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    // Get the value from the configuration source\r\n    const value = configDef.getValue(settings, key);\r\n    if (value === undefined) {\r\n      // If there is no value (e.g. undefined), then set to the default if provided,\r\n      // otherwise ignore the config key:value pair\r\n      if (hasDefault) {\r\n        config[key] = configDef.defaultValue;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    // Finally, run the value through an optional coerce method\r\n    config[key] = configDef.coerce ? configDef.coerce(value) : value;\r\n  }\r\n\r\n  return config;\r\n}\r\n","/**\r\n * Return true if the client is from a browser extension.\r\n *\r\n * @param {string} url\r\n * @return {boolean} - Returns true if this instance of the Hypothesis client is one\r\n *   distributed in a browser extension, false if it's one embedded in a\r\n *   website.\r\n *\r\n */\r\nexport function isBrowserExtension(url) {\r\n  return !(url.startsWith('http://') || url.startsWith('https://'));\r\n}\r\n","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Annotate.js\";\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n// This file was auto-generated using scripts/generate-icons.js\n\n/**\n * Icon generated from annotate.svg\n *\n * @param {import('preact').JSX.SVGAttributes<SVGSVGElement>} props\n */\nexport default function AnnotateIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    viewBox: \"0 0 16 16\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      fill: \"currentColor\",\n      d: \"M15 0c.27 0 .505.099.703.297A.961.961 0 0 1 16 1v15l-4-3H1a.974.974 0 0 1-.703-.29A.953.953 0 0 1 0 12V1A.96.96 0 0 1 .29.29.966.966 0 0 1 1 0h14zM7 3l-.469.063c-.312.041-.656.187-1.031.437-.375.25-.719.646-1.031 1.188C4.156 5.229 4 6 4 7l.002.063.006.062a.896.896 0 0 1 .008.11l-.002.074-.006.066a1.447 1.447 0 0 0 .43 1.188C4.729 8.854 5.082 9 5.5 9c.417 0 .77-.146 1.063-.438C6.854 8.271 7 7.918 7 7.5c0-.417-.146-.77-.438-1.063A1.447 1.447 0 0 0 5.5 6a1.467 1.467 0 0 0-.422.062c.177-1.03.542-1.632 1.094-1.804L7 4V3zm5 0-.469.063c-.312.041-.656.187-1.031.437-.375.25-.719.646-1.031 1.188C9.156 5.229 9 6 9 7l.002.063.006.062a.896.896 0 0 1 .008.11l-.002.074-.006.066a1.447 1.447 0 0 0 .43 1.188c.291.291.645.437 1.062.437.417 0 .77-.146 1.063-.438.291-.291.437-.645.437-1.062 0-.417-.146-.77-.438-1.063A1.447 1.447 0 0 0 10.5 6a1.467 1.467 0 0 0-.422.062c.177-1.03.542-1.632 1.094-1.804L12 4V3z\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 17,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 10,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Annotate.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/CaretLeft.js\";\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n// This file was auto-generated using scripts/generate-icons.js\n\n/**\n * Icon generated from caret-left.svg\n *\n * @param {import('preact').JSX.SVGAttributes<SVGSVGElement>} props\n */\nexport default function CaretLeftIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    viewBox: \"0 0 16 16\",\n    \"aria-hidden\": \"true\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      \"fill-rule\": \"evenodd\",\n      fill: \"none\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 19,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"M10 12 6 8l4-4\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 20,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 18,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 10,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=CaretLeft.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/CaretRight.js\";\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n// This file was auto-generated using scripts/generate-icons.js\n\n/**\n * Icon generated from caret-right.svg\n *\n * @param {import('preact').JSX.SVGAttributes<SVGSVGElement>} props\n */\nexport default function CaretRightIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    viewBox: \"0 0 16 16\",\n    \"aria-hidden\": \"true\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      \"fill-rule\": \"evenodd\",\n      fill: \"none\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 19,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"m6 4 4 4-4 4\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 20,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 18,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 10,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=CaretRight.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Highlight.js\";\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n// This file was auto-generated using scripts/generate-icons.js\n\n/**\n * Icon generated from highlight.svg\n *\n * @param {import('preact').JSX.SVGAttributes<SVGSVGElement>} props\n */\nexport default function HighlightIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    viewBox: \"0 0 16 16\",\n    \"aria-hidden\": \"true\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      \"fill-rule\": \"evenodd\",\n      fill: \"none\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 19,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"M12 15H1h11zm-.5-6v2l-1 1v-2l1-1zm.5-7v6h-2V2h2zm0-1h-2 2zm0 8h-2 2z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 20,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 18,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 10,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Highlight.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/PointerDown.js\";\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n// This file was auto-generated using scripts/generate-icons.js\n\n/**\n * Icon generated from pointer-down.svg\n *\n * @param {import('preact').JSX.SVGAttributes<SVGSVGElement>} props\n */\nexport default function PointerDownIcon(props) {\n  return _jsxDEV(\"svg\", {\n    width: \"16\",\n    height: \"9\",\n    xmlns: \"http://www.w3.org/2000/svg\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      d: \"m15.5 0-7 8-8-8\",\n      stroke: \"currentColor\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 11,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 10,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=PointerDown.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/PointerUp.js\";\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n// This file was auto-generated using scripts/generate-icons.js\n\n/**\n * Icon generated from pointer-up.svg\n *\n * @param {import('preact').JSX.SVGAttributes<SVGSVGElement>} props\n */\nexport default function PointerUpIcon(props) {\n  return _jsxDEV(\"svg\", {\n    width: \"16\",\n    height: \"9\",\n    xmlns: \"http://www.w3.org/2000/svg\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      d: \"m.5 9 7-8 8 8\",\n      stroke: \"currentColor\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 11,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 10,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=PointerUp.js.map","import { createContext } from 'preact';\n/**\n * @typedef ScrollInfo\n * @prop {import('preact').RefObject<HTMLElement>} scrollRef\n */\n\nconst ScrollContext = createContext(\n/** @type {ScrollInfo} */\n{});\nexport default ScrollContext;\n//# sourceMappingURL=ScrollContext.js.map","import { createContext } from 'preact';\n/**\n * @typedef TableInfo\n * @prop {boolean} interactive - This table has click-able, focus-able rows\n * @prop {boolean} stickyHeader - This table has a sticky header\n * @prop {import('preact').RefObject<HTMLElement>} tableRef\n */\n\nconst TableContext = createContext(\n/** @type {TableInfo} */\n{});\nexport default TableContext;\n//# sourceMappingURL=TableContext.js.map","import { createContext } from 'preact';\n/**\n * @typedef TableSection\n * @prop {'head'|'body'|'footer'} section\n */\n\nconst TableSectionContext = createContext(\n/** @type {TableSection} */\n{});\nexport default TableSectionContext;\n//# sourceMappingURL=TableSectionContext.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/input/ButtonBase.js\";\nimport classNames from 'classnames';\nimport { downcastRef } from '../../util/typing';\n/**\n * Common props used for Button components.\n *\n * @typedef ButtonCommonProps\n * @prop {boolean} [expanded] - Is the element associated with this button\n *   expanded? (set `aria-expanded`)\n * @prop {never} [aria-expanded] - Use `expanded` prop instead\n * @prop {boolean} [pressed] - Is this button currently \"active?\" (set\n *   `aria-pressed` or `aria-selected` depending on button `role`)\n * @prop {never} [aria-pressed] - Use `pressed` prop instead\n * @prop {string} [title] - Button title; used for `aria-label` attribute\n * @prop {never} [aria-label] - Use `title` prop instead\n *\n * HTML attributes accepted by button components. This eliminates conflicting\n * `icon` and `size` attributes.\n *\n * @typedef {Omit<import('preact').JSX.HTMLAttributes<HTMLButtonElement>, 'icon'|'size'>} HTMLButtonAttributes\n *\n */\n\n/**\n * @typedef {import('../../types').BaseProps} BaseProps\n *\n * Base component for Button components. Applies common attributes.\n *\n * @param {BaseProps & ButtonCommonProps & HTMLButtonAttributes} props\n */\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n\nconst ButtonBaseNext = function ButtonBase({\n  elementRef,\n  children,\n  classes,\n  unstyled = false,\n  expanded,\n  pressed,\n  title,\n  role,\n  ...htmlAttributes\n}) {\n  const ariaProps = {\n    'aria-label': title\n  }; // aria-pressed and aria-expanded are not allowed for buttons with\n  // an aria role of `tab`. Instead, the aria-selected attribute is expected.\n\n  if (role === 'tab') {\n    ariaProps['aria-selected'] = pressed;\n  } else {\n    ariaProps['aria-pressed'] = pressed;\n    ariaProps['aria-expanded'] = expanded;\n  }\n\n  return _jsxDEV(\"button\", {\n    role: role !== null && role !== void 0 ? role : 'button',\n    ...ariaProps,\n    \"data-base-component\": \"ButtonBase\"\n    /* data-component will be overwritten unless this component is used directly */\n    ,\n    \"data-component\": \"ButtonBase\",\n    ...htmlAttributes,\n    className: classNames({\n      'focus-visible-ring rounded-sm': !unstyled,\n      'transition-colors': !unstyled,\n      // Set layout for button content\n      'whitespace-nowrap flex items-center': !unstyled\n    }, classes),\n    title: title,\n    ref: downcastRef(elementRef),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 58,\n    columnNumber: 5\n  }, this);\n};\n\nexport default ButtonBaseNext;\n//# sourceMappingURL=ButtonBase.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/input/InputGroup.js\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\n/**\n * @typedef {import('../../types').PresentationalProps} CommonProps\n * @typedef {import('preact').JSX.HTMLAttributes<HTMLElement>} HTMLAttributes\n */\n// These styles may be applied to input components to adapt them when in\n// an InputGroup\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nexport const inputGroupStyles = classnames( // All inputs within an InputGroup should have a border. Turn off border-radius\n'input-group:border input-group:rounded-none', // Restore border-radius on the leftmost and rightmost components in the group\n'input-group:first:rounded-l-sm input-group:last:rounded-r-sm', // \"Collapse\" borders between input components\n'input-group:border-l-0 input-group:first:border-l');\n/**\n * Render a container that lays out a group of input components\n *\n * @param {CommonProps & HTMLAttributes} props\n */\n\nconst InputGroupNext = function InputGroup({\n  children,\n  classes,\n  elementRef,\n  ...htmlAttributes\n}) {\n  return _jsxDEV(\"div\", { ...htmlAttributes,\n    ref: downcastRef(elementRef),\n    className: classnames( // Set the `.input-group` class so that children may\n    // use the `input-group:` variant in their styles\n    'input-group', 'flex items-stretch w-full justify-center', classes),\n    \"data-component\": \"InputGroup\",\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 34,\n    columnNumber: 5\n  }, this);\n};\n\nexport default InputGroupNext;\n//# sourceMappingURL=InputGroup.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/navigation/LinkBase.js\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\n/**\n * @typedef {import('../../types').BaseProps} BaseProps\n * @typedef {import('preact').JSX.HTMLAttributes<HTMLAnchorElement>} HTMLAnchorAttributes\n */\n\n/**\n * Base component for Link components. Applies common attributes and styles.\n *\n * @param {BaseProps & HTMLAnchorAttributes} props\n */\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n\nconst LinkBaseNext = function LinkBase({\n  children,\n  classes,\n  elementRef,\n  unstyled = false,\n  ...htmlAttributes\n}) {\n  return _jsxDEV(\"a\", {\n    \"data-base-component\": \"LinkBase\"\n    /* data-component will be overwritten unless this component is used directly */\n    ,\n    \"data-component\": \"LinkBase\",\n    ...htmlAttributes,\n    className: classnames({\n      'focus-visible-ring rounded-sm': !unstyled\n    }, classes),\n    rel: \"noopener noreferrer\",\n    ref: downcastRef(elementRef),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 24,\n    columnNumber: 5\n  }, this);\n};\n\nexport default LinkBaseNext;\n//# sourceMappingURL=LinkBase.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/navigation/Link.js\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport LinkBase from './LinkBase';\n/**\n * @typedef {import('../../types').PresentationalProps} CommonProps\n * @typedef {import('preact').JSX.HTMLAttributes<HTMLAnchorElement>} HTMLAnchorAttributes\n *\n * @typedef LinkProps\n * @prop {'always'|'hover'|'none'} [underline]\n * @prop {'brand'|'text-light'|'text'} [color='brand']\n */\n\n/**\n * Styled component for a link (`<a>` element).\n *\n * @param {CommonProps & LinkProps & HTMLAnchorAttributes} props\n */\n\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n\nconst LinkNext = function Link({\n  children,\n  classes,\n  elementRef,\n  underline = 'none',\n  color = 'brand',\n  ...htmlAttributes\n}) {\n  return _jsxDEV(LinkBase, { ...htmlAttributes,\n    classes: classnames( // NB: Base classes are applied by LinkBase\n    {\n      // color\n      'text-brand hover:text-brand-dark': color === 'brand',\n      // default\n      'text-color-text-light hover:text-brand': color === 'text-light',\n      'text-color-text hover:text-brand-dark': color === 'text'\n    }, {\n      // underline\n      'no-underline hover:no-underline': underline === 'none',\n      // default\n      'underline hover:underline': underline === 'always',\n      'no-underline hover:underline': underline === 'hover'\n    }, classes),\n    elementRef: downcastRef(elementRef),\n    \"data-component\": \"Link\",\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 32,\n    columnNumber: 5\n  }, this);\n};\n\nexport default LinkNext;\n//# sourceMappingURL=Link.js.map","import { useEffect } from 'preact/hooks';\r\n\r\n/**\r\n * Bit flags indicating modifiers required by a shortcut or pressed in a key event.\r\n *\r\n * @type {Record<string, number>}\r\n */\r\nconst modifiers = {\r\n  alt: 1,\r\n  ctrl: 2,\r\n  meta: 4,\r\n  shift: 8,\r\n};\r\n\r\n/**\r\n * Match a `shortcut` key sequence against a keydown event.\r\n *\r\n * A shortcut key sequence is a string of \"+\"-separated keyboard modifiers and\r\n * keys. The list may contain zero or more modifiers and must contain exactly\r\n * one non-modifier key. The key and modifier names are case-insensitive.\r\n * For example \"Ctrl+Enter\", \"shift+a\". Key names are matched against `KeyboardEvent.key`.\r\n *\r\n * @param {KeyboardEvent} event\r\n * @param {string} shortcut\r\n * @return {boolean}\r\n */\r\nexport function matchShortcut(event, shortcut) {\r\n  const parts = shortcut.split('+').map(p => p.toLowerCase());\r\n\r\n  let requiredModifiers = 0;\r\n  let requiredKey = null;\r\n\r\n  for (let part of parts) {\r\n    const modifierFlag = modifiers[part];\r\n    if (modifierFlag) {\r\n      requiredModifiers |= modifierFlag;\r\n    } else if (requiredKey === null) {\r\n      requiredKey = part;\r\n    } else {\r\n      throw new Error('Multiple non-modifier keys specified');\r\n    }\r\n  }\r\n\r\n  if (!requiredKey) {\r\n    throw new Error(`Invalid shortcut: ${shortcut}`);\r\n  }\r\n\r\n  const actualModifiers =\r\n    (event.ctrlKey ? modifiers.ctrl : 0) |\r\n    (event.metaKey ? modifiers.meta : 0) |\r\n    (event.altKey ? modifiers.alt : 0) |\r\n    (event.shiftKey ? modifiers.shift : 0);\r\n\r\n  return (\r\n    actualModifiers === requiredModifiers &&\r\n    event.key.toLowerCase() === requiredKey\r\n  );\r\n}\r\n\r\n/**\r\n * @typedef ShortcutOptions\r\n * @prop {HTMLElement} [rootElement] -\r\n *   Element on which the key event listener should be installed. Defaults to\r\n *   `document.body`.\r\n */\r\n\r\n/**\r\n * Install a shortcut key listener on the document.\r\n *\r\n * This can be used directly outside of a component. To use within a Preact\r\n * component, you probably want the `useShortcut` hook.\r\n *\r\n * @param {string} shortcut - Shortcut key sequence. See `matchShortcut`.\r\n * @param {(e: KeyboardEvent) => void} onPress - A function to call when the shortcut matches\r\n * @param {ShortcutOptions} options\r\n * @return {() => void} A function that removes the shortcut\r\n */\r\nexport function installShortcut(\r\n  shortcut,\r\n  onPress,\r\n  {\r\n    // We use `documentElement` as the root element rather than `document.body`\r\n    // which is used as a root element in some other places because the body\r\n    // element is not keyboard-focusable in XHTML documents in Safari/Chrome.\r\n    // See https://github.com/hypothesis/client/issues/4364.\r\n    rootElement = document.documentElement,\r\n  } = {}\r\n) {\r\n  /** @param {KeyboardEvent} event */\r\n  const onKeydown = event => {\r\n    if (matchShortcut(event, shortcut)) {\r\n      onPress(event);\r\n    }\r\n  };\r\n  rootElement.addEventListener('keydown', onKeydown);\r\n  return () => rootElement.removeEventListener('keydown', onKeydown);\r\n}\r\n\r\n/**\r\n * An effect hook that installs a shortcut using `installShortcut` and removes\r\n * it when the component is unmounted.\r\n *\r\n * This provides a convenient way to enable a document-level shortcut while\r\n * a component is mounted. This differs from adding an `onKeyDown` handler to\r\n * one of the component's DOM elements in that it doesn't require the component\r\n * to have focus.\r\n *\r\n * To conditionally disable the shortcut, set `shortcut` to `null`.\r\n *\r\n * @param {string|null} shortcut -\r\n *   A shortcut key sequence to match or `null` to disable. See `matchShortcut`.\r\n * @param {(e: KeyboardEvent) => void} onPress - A function to call when the shortcut matches\r\n * @param {ShortcutOptions} options\r\n */\r\nexport function useShortcut(shortcut, onPress, { rootElement } = {}) {\r\n  useEffect(() => {\r\n    if (!shortcut) {\r\n      return undefined;\r\n    }\r\n    return installShortcut(shortcut, onPress, { rootElement });\r\n  }, [shortcut, onPress, rootElement]);\r\n}\r\n","import classnames from 'classnames';\r\nimport {\r\n  AnnotateIcon,\r\n  ButtonBase,\r\n  HighlightIcon,\r\n  PointerDownIcon,\r\n  PointerUpIcon,\r\n} from '@hypothesis/frontend-shared/lib/next';\r\nimport type { IconComponent } from '@hypothesis/frontend-shared/lib/types';\r\n\r\nimport { useShortcut } from '../../shared/shortcut';\r\n\r\n/**\r\n * Render an inverted light-on-dark \"pill\" with the given `badgeCount`\r\n * (annotation count). This is rendered instead of an icon on the toolbar\r\n * button for \"show\"-ing associated annotations for the current selection.\r\n */\r\nfunction NumberIcon({ badgeCount }: { badgeCount: number }) {\r\n  return (\r\n    <span\r\n      className={classnames(\r\n        'rounded px-1 py-0.5',\r\n        // The background color is inherited from the current text color in\r\n        // the containing button and will vary depending on hover state.\r\n        'bg-current'\r\n      )}\r\n    >\r\n      <span className=\"font-bold text-color-text-inverted\">{badgeCount}</span>\r\n    </span>\r\n  );\r\n}\r\n\r\n/**\r\n * Render an arrow pointing up or down from the AdderToolbar. This arrow\r\n * should point roughly to the end of the user selection in the document.\r\n */\r\nfunction AdderToolbarArrow({\r\n  arrowDirection,\r\n}: {\r\n  arrowDirection: 'up' | 'down';\r\n}) {\r\n  return (\r\n    <div\r\n      className={classnames(\r\n        // Position horizontally center of the AdderToolbar\r\n        'absolute left-1/2 -translate-x-1/2 z-2',\r\n        'fill-white text-grey-3',\r\n        {\r\n          // Move the pointer to the top of the AdderToolbar\r\n          'top-0 -translate-y-full': arrowDirection === 'up',\r\n        }\r\n      )}\r\n    >\r\n      {arrowDirection === 'up' ? <PointerUpIcon /> : <PointerDownIcon />}\r\n    </div>\r\n  );\r\n}\r\n\r\ntype ToolbarButtonProps = {\r\n  badgeCount?: number;\r\n  icon?: IconComponent;\r\n  label: string;\r\n  onClick: () => void;\r\n  shortcut: string | null;\r\n};\r\n\r\nfunction ToolbarButton({\r\n  badgeCount,\r\n  icon: Icon,\r\n  label,\r\n  onClick,\r\n  shortcut,\r\n}: ToolbarButtonProps) {\r\n  useShortcut(shortcut, onClick);\r\n\r\n  const title = shortcut ? `${label} (${shortcut})` : label;\r\n\r\n  return (\r\n    <ButtonBase\r\n      classes={classnames(\r\n        'flex-col gap-y-1 py-2.5 px-2',\r\n        'text-annotator-sm leading-none',\r\n        // Default color when the toolbar is not hovered\r\n        'text-grey-7',\r\n        // When the parent .group element is hovered (but this element itself is\r\n        // not), dim this button's text. This has the effect of dimming inactive\r\n        // buttons.\r\n        'group-hover:text-grey-5',\r\n        // When the parent .group element is hovered AND this element is\r\n        // hovered, this is the \"active\" button. Intensify the text color, which\r\n        // will also darken any descendant Icon\r\n        'hover:group-hover:text-grey-9'\r\n      )}\r\n      onClick={onClick}\r\n      title={title}\r\n    >\r\n      {Icon && <Icon className=\"text-annotator-lg\" title={title} />}\r\n      {typeof badgeCount === 'number' && <NumberIcon badgeCount={badgeCount} />}\r\n      <span>{label}</span>\r\n    </ButtonBase>\r\n  );\r\n}\r\n\r\nexport type Command = 'annotate' | 'highlight' | 'show' | 'hide';\r\n\r\ntype AdderToolbarProps = {\r\n  /**\r\n   * Number of annotations associated with the selected text. If non-zero, a\r\n   * Show\" button is displayed to allow the user to see the annotations that\r\n   * correspond to the selection.\r\n   */\r\n  annotationCount?: number;\r\n  /**\r\n   * Whether the arrow pointing out of the toolbar towards the selected text\r\n   * should appear above the toolbar pointing up or below the toolbar pointing\r\n   * down.\r\n   */\r\n  arrowDirection: 'up' | 'down';\r\n  /** The toolbar is always rendered, but is not always visible. */\r\n  isVisible: boolean;\r\n  /** Called when a toolbar button is clicked */\r\n  onCommand: (c: Command) => void;\r\n};\r\n\r\n/**\r\n * The toolbar that is displayed above or below selected text in the document,\r\n * providing options to create annotations or highlights.\r\n *\r\n<<<<<<< HEAD:src/annotator/components/AdderToolbar.js\r\n * @param {AdderToolbarProps} props\r\n=======\r\n * The toolbar has nuanced styling for hover. The component structure is:\r\n *\r\n * <AdderToolbar>\r\n *   <div.group>\r\n *     <button.hover-group><AnnotateIcon />Annotate</button>\r\n *     <button.hover-group><HighlightIcon />Highlight</button>\r\n *     <div>[vertical separator]</div>\r\n *     <button.hover-group><span><NumberIcon /></span>[count]</button>\r\n *   </div.group>\r\n *   <AdderToolbarArrow />\r\n * </AdderToolbar>\r\n *\r\n * Behavior: When div.group is hovered, all descendant buttons and their\r\n * contents dim, except for the contents of the button that is directly hovered,\r\n * which are darkened. This is intended to make the hovered button stand out,\r\n * and the non-hovered buttons recede.\r\n *\r\n * This is achieved by:\r\n * - Setting the .group class on the div that contains the buttons. This allows\r\n *   buttons to style themselves based on the combination of the div.group's\r\n *   hover state and their own \"local\" hover state. `group` is available in\r\n *   Tailwind out of the box; see\r\n *   https://tailwindcss.com/docs/hover-focus-and-other-states#styling-based-on-parent-state\r\n * - The challenge is in getting the \"badge\" in NumberIcon to dim and darken its\r\n *   background appropriately. `hover-group-hover` is a custom tailwind variant\r\n *   that allows NumberIcon to style itself based on the hover states of\r\n *   both div.group AND its parent button.hover-group. We need to ensure this\r\n *   badge will darken when its parent button is hovered, even if it is not\r\n *   hovered directly.\r\n *\r\n>>>>>>> 544c8e5c6 (Convert `AdderToolbar` to TypeScript):src/annotator/components/AdderToolbar.tsx\r\n */\r\nexport default function AdderToolbar({\r\n  arrowDirection,\r\n  isVisible,\r\n  onCommand,\r\n  annotationCount = 0,\r\n}: AdderToolbarProps) {\r\n  // Since the selection toolbar is only shown when there is a selection\r\n  // of static text, we can use a plain key without any modifier as\r\n  // the shortcut. This avoids conflicts with browser/OS shortcuts.\r\n  const annotateShortcut = isVisible ? 'a' : null;\r\n  const highlightShortcut = isVisible ? 'h' : null;\r\n  const showShortcut = isVisible ? 's' : null;\r\n  const hideShortcut = isVisible ? 'Escape' : null;\r\n\r\n  // Add a shortcut to close the adder. Note, there is no button associated with this\r\n  // shortcut because any outside click will also hide the adder.\r\n  useShortcut(hideShortcut, () => onCommand('hide'));\r\n\r\n  // nb. The adder is hidden using the `visibility` property rather than `display`\r\n  // so that we can compute its size in order to position it before display.\r\n  return (\r\n    <div\r\n      className={classnames(\r\n        // Reset all inherited properties to their initial values. This prevents\r\n        // CSS property values from the host page being inherited by elements of\r\n        // the Adder, even when using Shadow DOM.\r\n        'all-initial',\r\n        // As we've reset all properties to initial values, we cannot rely on\r\n        // default border values from Tailwind and have to be explicit about all\r\n        // border attributes.\r\n        'border border-solid border-grey-3',\r\n        'absolute select-none bg-white rounded shadow-adder-toolbar',\r\n        // Start at a very low opacity as we're going to fade in in the animation\r\n        'opacity-5',\r\n        {\r\n          'animate-adder-pop-up': arrowDirection === 'up' && isVisible,\r\n          'animate-adder-pop-down': arrowDirection === 'down' && isVisible,\r\n        }\r\n      )}\r\n      data-component=\"AdderToolbar\"\r\n      dir=\"ltr\"\r\n      style={{\r\n        visibility: isVisible ? 'visible' : 'hidden',\r\n      }}\r\n    >\r\n      <div\r\n        className={classnames(\r\n          // This group is used to manage hover state styling for descendant\r\n          // buttons\r\n          'flex group'\r\n        )}\r\n      >\r\n        <ToolbarButton\r\n          icon={AnnotateIcon}\r\n          onClick={() => onCommand('annotate')}\r\n          label=\"Annotate\"\r\n          shortcut={annotateShortcut}\r\n        />\r\n        <ToolbarButton\r\n          icon={HighlightIcon}\r\n          onClick={() => onCommand('highlight')}\r\n          label=\"Highlight\"\r\n          shortcut={highlightShortcut}\r\n        />\r\n        {annotationCount > 0 && (\r\n          <>\r\n            <div\r\n              className={classnames(\r\n                // Style a vertical separator line\r\n                'm-1.5 border-r border-grey-4 border-solid'\r\n              )}\r\n            />\r\n            <ToolbarButton\r\n              badgeCount={annotationCount}\r\n              onClick={() => onCommand('show')}\r\n              label=\"Show\"\r\n              shortcut={showShortcut}\r\n            />\r\n          </>\r\n        )}\r\n      </div>\r\n      <AdderToolbarArrow arrowDirection={arrowDirection} />\r\n    </div>\r\n  );\r\n}\r\n","/**\r\n * Helper methods to identify browser versions and os types\r\n */\r\n\r\n/**\r\n * Returns true when the OS is Mac OS.\r\n *\r\n * @param _userAgent {string} - Test seam\r\n */\r\nexport const isMacOS = (_userAgent = window.navigator.userAgent) => {\r\n  return _userAgent.indexOf('Mac OS') >= 0;\r\n};\r\n\r\n/**\r\n * Returns true when device is iOS.\r\n * https://stackoverflow.com/a/9039885/14463679\r\n *\r\n * @param _navigator {{platform: string, userAgent: string}}\r\n * @param _ontouchend {boolean}\r\n */\r\nexport const isIOS = (\r\n  _navigator = window.navigator,\r\n  _ontouchend = 'ontouchend' in document\r\n) => {\r\n  return (\r\n    [\r\n      'iPad Simulator',\r\n      'iPhone Simulator',\r\n      'iPod Simulator',\r\n      'iPad',\r\n      'iPhone',\r\n      'iPod',\r\n    ].includes(_navigator.platform) ||\r\n    // iPad on iOS 13 detection\r\n    (_navigator.userAgent.includes('Mac') && _ontouchend)\r\n  );\r\n};\r\n\r\n/**\r\n * Returns true when the device is a touch device such\r\n * as android or iOS.\r\n * https://developer.mozilla.org/en-US/docs/Web/CSS/@media/pointer#browser_compatibility\r\n *\r\n * @param _window {Window} - Test seam\r\n */\r\nexport const isTouchDevice = (_window = window) => {\r\n  return _window.matchMedia('(pointer: coarse)').matches;\r\n};\r\n","/**\r\n * Load stylesheets for annotator UI components into the shadow DOM root.\r\n *\r\n * @param {ShadowRoot} shadowRoot\r\n */\r\nfunction loadStyles(shadowRoot) {\r\n  // Find the preloaded stylesheet added by the boot script.\r\n  const url = /** @type {HTMLLinkElement|undefined} */ (\r\n    document.querySelector(\r\n      'link[rel=\"preload\"][href*=\"/build/styles/annotator.css\"]'\r\n    )\r\n  )?.href;\r\n\r\n  if (!url) {\r\n    return;\r\n  }\r\n\r\n  const linkEl = document.createElement('link');\r\n  linkEl.rel = 'stylesheet';\r\n  linkEl.href = url;\r\n  shadowRoot.appendChild(linkEl);\r\n}\r\n\r\n/**\r\n * Create the shadow root for an annotator UI component and load the annotator\r\n * CSS styles into it.\r\n *\r\n * @param {HTMLElement} container - Container element to render the UI into\r\n * @return {ShadowRoot}\r\n */\r\nexport function createShadowRoot(container) {\r\n  const shadowRoot = container.attachShadow({ mode: 'open' });\r\n  loadStyles(shadowRoot);\r\n\r\n  // @ts-ignore The window doesn't know about the polyfill\r\n  // applyFocusVisiblePolyfill comes from the `focus-visible` package.\r\n  const applyFocusVisible = window.applyFocusVisiblePolyfill;\r\n  if (applyFocusVisible) {\r\n    applyFocusVisible(shadowRoot);\r\n  }\r\n\r\n  stopEventPropagation(shadowRoot);\r\n  return shadowRoot;\r\n}\r\n\r\n/**\r\n * Stop bubbling up of several events.\r\n *\r\n * This makes the host page a little bit less aware of the annotator activity.\r\n * It is still possible for the host page to manipulate the events on the capturing\r\n * face.\r\n *\r\n * Another benefit is that click and touchstart typically causes the sidebar to close.\r\n * By preventing the bubble up of these events, we don't have to individually stop\r\n * the propagation.\r\n *\r\n * @param {HTMLElement|ShadowRoot} element\r\n */\r\nfunction stopEventPropagation(element) {\r\n  element.addEventListener('mouseup', event => event.stopPropagation());\r\n  element.addEventListener('mousedown', event => event.stopPropagation());\r\n  element.addEventListener('touchstart', event => event.stopPropagation(), {\r\n    passive: true,\r\n  });\r\n}\r\n","import { render } from 'preact';\r\n\r\nimport AdderToolbar from './components/AdderToolbar';\r\nimport { isTouchDevice } from '../shared/user-agent';\r\nimport { createShadowRoot } from './util/shadow-root';\r\n\r\n/**\r\n *  @typedef {1} ArrowPointingDown\r\n * Show the adder above the selection with an arrow pointing down at the\r\n * selected text.\r\n */\r\nexport const ARROW_POINTING_DOWN = 1;\r\n\r\n/**\r\n *  @typedef {2} ArrowPointingUp\r\n * Show the adder above the selection with an arrow pointing up at the\r\n * selected text.\r\n */\r\nexport const ARROW_POINTING_UP = 2;\r\n\r\n/**\r\n *  @typedef {ArrowPointingDown|ArrowPointingUp} ArrowDirection\r\n * Show the adder above the selection with an arrow pointing up at the\r\n * selected text.\r\n */\r\n\r\n/**\r\n * @typedef Target\r\n * @prop {number} left - Offset from left edge of viewport.\r\n * @prop {number} top - Offset from top edge of viewport.\r\n * @prop {ArrowDirection} arrowDirection - Direction of the adder's arrow.\r\n */\r\n\r\n/** @param {number} pixels */\r\nfunction toPx(pixels) {\r\n  return pixels.toString() + 'px';\r\n}\r\n\r\nconst ARROW_HEIGHT = 10;\r\n\r\n// The preferred gap between the end of the text selection and the adder's\r\n// arrow position.\r\nconst ARROW_H_MARGIN = 20;\r\n\r\n/**\r\n * Return the closest ancestor of `el` which has been positioned.\r\n *\r\n * If no ancestor has been positioned, returns the root element.\r\n *\r\n * @param {Element} el\r\n * @return {Element}\r\n */\r\nfunction nearestPositionedAncestor(el) {\r\n  let parentEl = /** @type {Element} */ (el.parentElement);\r\n  while (parentEl.parentElement) {\r\n    if (getComputedStyle(parentEl).position !== 'static') {\r\n      break;\r\n    }\r\n    parentEl = parentEl.parentElement;\r\n  }\r\n  return parentEl;\r\n}\r\n\r\n/**\r\n * @typedef AdderOptions\r\n * @prop {() => void} onAnnotate - Callback invoked when \"Annotate\" button is clicked\r\n * @prop {() => void} onHighlight - Callback invoked when \"Highlight\" button is clicked\r\n * @prop {(tags: string[]) => void} onShowAnnotations -\r\n *   Callback invoked when  \"Show\" button is clicked\r\n *\r\n * @typedef {import('../types/annotator').Destroyable} Destroyable\r\n */\r\n\r\n/**\r\n * Container for the 'adder' toolbar which provides controls for the user to\r\n * annotate and highlight the selected text.\r\n *\r\n * The toolbar implementation is split between this class, which is\r\n * the container for the toolbar that positions it on the page and isolates\r\n * it from the page's styles using shadow DOM, and the `AdderToolbar` Preact\r\n * component which actually renders the toolbar.\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class Adder {\r\n  /**\r\n   * Create the toolbar's container and hide it.\r\n   *\r\n   * The adder is initially hidden.\r\n   *\r\n   * @param {HTMLElement} element - The DOM element into which the adder will be created\r\n   * @param {AdderOptions} options - Options object specifying `onAnnotate` and `onHighlight`\r\n   *        event handlers.\r\n   */\r\n  constructor(element, options) {\r\n    this._outerContainer = document.createElement('hypothesis-adder');\r\n    element.appendChild(this._outerContainer);\r\n    this._shadowRoot = createShadowRoot(this._outerContainer);\r\n\r\n    // Set initial style\r\n    Object.assign(this._outerContainer.style, {\r\n      // take position out of layout flow initially\r\n      position: 'absolute',\r\n      top: 0,\r\n      left: 0,\r\n    });\r\n\r\n    this._view = /** @type {Window} */ (element.ownerDocument.defaultView);\r\n\r\n    this._width = () => {\r\n      const firstChild = /** @type {Element} */ (this._shadowRoot.firstChild);\r\n      return firstChild.getBoundingClientRect().width;\r\n    };\r\n\r\n    this._height = () => {\r\n      const firstChild = /** @type {Element} */ (this._shadowRoot.firstChild);\r\n      return firstChild.getBoundingClientRect().height;\r\n    };\r\n\r\n    this._isVisible = false;\r\n\r\n    /** @type {'up'|'down'} */\r\n    this._arrowDirection = 'up';\r\n\r\n    this._onAnnotate = options.onAnnotate;\r\n    this._onHighlight = options.onHighlight;\r\n    this._onShowAnnotations = options.onShowAnnotations;\r\n\r\n    /**\r\n     * Annotation tags associated with the current selection.\r\n     *\r\n     * @type {string[]}\r\n     */\r\n    this._annotationsForSelection = [];\r\n\r\n    this._render();\r\n  }\r\n\r\n  get annotationsForSelection() {\r\n    return this._annotationsForSelection;\r\n  }\r\n\r\n  /**\r\n   * Set the annotation IDs associated with the current selection.\r\n   *\r\n   * Setting this to a non-empty list causes the \"Show\" button to appear in\r\n   * the toolbar. Clicking the \"Show\" button  triggers the `onShowAnnotations`\r\n   * callback passed to the constructor.\r\n   */\r\n  set annotationsForSelection(ids) {\r\n    this._annotationsForSelection = ids;\r\n    this._render();\r\n  }\r\n\r\n  /** Hide the adder */\r\n  hide() {\r\n    this._isVisible = false;\r\n    this._render();\r\n    // Reposition the outerContainer because it affects the responsiveness of host page\r\n    // https://github.com/hypothesis/client/issues/3193\r\n    Object.assign(this._outerContainer.style, {\r\n      top: 0,\r\n      left: 0,\r\n    });\r\n  }\r\n\r\n  destroy() {\r\n    render(null, this._shadowRoot); // First, unload the Preact component\r\n    this._outerContainer.remove();\r\n  }\r\n\r\n  /**\r\n   * Display the adder in the best position in order to target the\r\n   * selected text in `selectionRect`.\r\n   *\r\n   * @param {DOMRect} selectionRect - The rect of text to target, in viewport\r\n   *        coordinates.\r\n   * @param {boolean} isRTLselection - True if the selection was made\r\n   *        rigth-to-left, such that the focus point is mosty likely at the\r\n   *        top-left edge of `targetRect`.\r\n   */\r\n  show(selectionRect, isRTLselection) {\r\n    const { left, top, arrowDirection } = this._calculateTarget(\r\n      selectionRect,\r\n      isRTLselection\r\n    );\r\n    this._showAt(left, top);\r\n\r\n    this._isVisible = true;\r\n    this._arrowDirection = arrowDirection === ARROW_POINTING_UP ? 'up' : 'down';\r\n\r\n    this._render();\r\n  }\r\n\r\n  /**\r\n   *  Determine the best position for the Adder and its pointer-arrow.\r\n   * - Position the pointer-arrow near the end of the selection (where the user's\r\n   *   cursor/input is most likely to be)\r\n   * - Position the Adder to center horizontally on the pointer-arrow\r\n   * - Position the Adder below the selection (arrow pointing up) for LTR selections\r\n   *   and above (arrow down) for RTL selections\r\n   *\r\n   * @param {DOMRect} selectionRect - The rect of text to target, in viewport\r\n   *        coordinates.\r\n   * @param {boolean} isRTLselection - True if the selection was made\r\n   *        rigth-to-left, such that the focus point is mosty likely at the\r\n   *        top-left edge of `targetRect`.\r\n   * @return {Target}\r\n   */\r\n  _calculateTarget(selectionRect, isRTLselection) {\r\n    // Set the initial arrow direction based on whether the selection was made\r\n    // forwards/upwards or downwards/backwards.\r\n    /** @type {ArrowDirection} */ let arrowDirection;\r\n    if (isRTLselection && !isTouchDevice()) {\r\n      arrowDirection = ARROW_POINTING_DOWN;\r\n    } else {\r\n      // Render the adder below the selection for touch devices due to competing\r\n      // space with the native copy/paste bar that typical (not always) renders above\r\n      // the selection.\r\n      arrowDirection = ARROW_POINTING_UP;\r\n    }\r\n    let top;\r\n    let left;\r\n\r\n    // Position the adder such that the arrow it is above or below the selection\r\n    // and close to the end.\r\n    const hMargin = Math.min(ARROW_H_MARGIN, selectionRect.width);\r\n    const adderWidth = this._width();\r\n    // Render the adder a little lower on touch devices to provide room for the native\r\n    // selection handles so that the interactions with selection don't compete with the adder.\r\n    const touchScreenOffset = isTouchDevice() ? 10 : 0;\r\n    const adderHeight = this._height();\r\n    if (isRTLselection) {\r\n      left = selectionRect.left - adderWidth / 2 + hMargin;\r\n    } else {\r\n      left =\r\n        selectionRect.left + selectionRect.width - adderWidth / 2 - hMargin;\r\n    }\r\n\r\n    // Flip arrow direction if adder would appear above the top or below the\r\n    // bottom of the viewport.\r\n    if (\r\n      selectionRect.top - adderHeight < 0 &&\r\n      arrowDirection === ARROW_POINTING_DOWN\r\n    ) {\r\n      arrowDirection = ARROW_POINTING_UP;\r\n    } else if (selectionRect.top + adderHeight > this._view.innerHeight) {\r\n      arrowDirection = ARROW_POINTING_DOWN;\r\n    }\r\n\r\n    if (arrowDirection === ARROW_POINTING_UP) {\r\n      top =\r\n        selectionRect.top +\r\n        selectionRect.height +\r\n        ARROW_HEIGHT +\r\n        touchScreenOffset;\r\n    } else {\r\n      top = selectionRect.top - adderHeight - ARROW_HEIGHT;\r\n    }\r\n\r\n    // Constrain the adder to the viewport.\r\n    left = Math.max(left, 0);\r\n    left = Math.min(left, this._view.innerWidth - adderWidth);\r\n\r\n    top = Math.max(top, 0);\r\n    top = Math.min(top, this._view.innerHeight - adderHeight);\r\n\r\n    return { top, left, arrowDirection };\r\n  }\r\n\r\n  /**\r\n   * Find a Z index value that will cause the adder to appear on top of any\r\n   * content in the document when the adder is shown at (left, top).\r\n   *\r\n   * @param {number} left - Horizontal offset from left edge of viewport.\r\n   * @param {number} top - Vertical offset from top edge of viewport.\r\n   * @return {number} - greatest zIndex (default value of 1)\r\n   */\r\n  _findZindex(left, top) {\r\n    if (document.elementsFromPoint === undefined) {\r\n      // In case of not being able to use `document.elementsFromPoint`,\r\n      // default to the large arbitrary number (2^15)\r\n      return 32768;\r\n    }\r\n\r\n    const adderWidth = this._width();\r\n    const adderHeight = this._height();\r\n\r\n    // Find the Z index of all the elements in the screen for five positions\r\n    // around the adder (left-top, left-bottom, middle-center, right-top,\r\n    // right-bottom) and use the greatest.\r\n\r\n    // Unique elements so `getComputedStyle` is called the minimum amount of times.\r\n    const elements = new Set([\r\n      ...document.elementsFromPoint(left, top),\r\n      ...document.elementsFromPoint(left, top + adderHeight),\r\n      ...document.elementsFromPoint(\r\n        left + adderWidth / 2,\r\n        top + adderHeight / 2\r\n      ),\r\n      ...document.elementsFromPoint(left + adderWidth, top),\r\n      ...document.elementsFromPoint(left + adderWidth, top + adderHeight),\r\n    ]);\r\n\r\n    const zIndexes = [...elements]\r\n      .map(element => +getComputedStyle(element).zIndex)\r\n      .filter(Number.isInteger);\r\n\r\n    // Make sure the array contains at least one element,\r\n    // otherwise `Math.max(...[])` results in +Infinity\r\n    zIndexes.push(0);\r\n\r\n    return Math.max(...zIndexes) + 1;\r\n  }\r\n\r\n  /**\r\n   * Show the adder at the given position and with the arrow pointing in\r\n   * `arrowDirection`.\r\n   *\r\n   * @param {number} left - Horizontal offset from left edge of viewport.\r\n   * @param {number} top - Vertical offset from top edge of viewport.\r\n   */\r\n  _showAt(left, top) {\r\n    // Translate the (left, top) viewport coordinates into positions relative to\r\n    // the adder's nearest positioned ancestor (NPA).\r\n    //\r\n    // Typically the adder is a child of the `<body>` and the NPA is the root\r\n    // `<html>` element. However page styling may make the `<body>` positioned.\r\n    // See https://github.com/hypothesis/client/issues/487.\r\n    const positionedAncestor = nearestPositionedAncestor(this._outerContainer);\r\n    const parentRect = positionedAncestor.getBoundingClientRect();\r\n\r\n    const zIndex = this._findZindex(left, top);\r\n\r\n    Object.assign(this._outerContainer.style, {\r\n      left: toPx(left - parentRect.left),\r\n      top: toPx(top - parentRect.top),\r\n      zIndex,\r\n    });\r\n  }\r\n\r\n  _render() {\r\n    /** @param {import('./components/AdderToolbar').Command} command */\r\n    const handleCommand = command => {\r\n      switch (command) {\r\n        case 'annotate':\r\n          this._onAnnotate();\r\n          this.hide();\r\n          break;\r\n        case 'highlight':\r\n          this._onHighlight();\r\n          this.hide();\r\n          break;\r\n        case 'show':\r\n          this._onShowAnnotations(this.annotationsForSelection);\r\n          break;\r\n        case 'hide':\r\n          this.hide();\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    };\r\n\r\n    render(\r\n      <AdderToolbar\r\n        isVisible={this._isVisible}\r\n        arrowDirection={this._arrowDirection}\r\n        onCommand={handleCommand}\r\n        annotationCount={this.annotationsForSelection.length}\r\n      />,\r\n      this._shadowRoot\r\n    );\r\n  }\r\n}\r\n","/**\r\n * Return the combined length of text nodes contained in `node`.\r\n *\r\n * @param {Node} node\r\n */\r\nfunction nodeTextLength(node) {\r\n  switch (node.nodeType) {\r\n    case Node.ELEMENT_NODE:\r\n    case Node.TEXT_NODE:\r\n      // nb. `textContent` excludes text in comments and processing instructions\r\n      // when called on a parent element, so we don't need to subtract that here.\r\n\r\n      return /** @type {string} */ (node.textContent).length;\r\n    default:\r\n      return 0;\r\n  }\r\n}\r\n\r\n/**\r\n * Return the total length of the text of all previous siblings of `node`.\r\n *\r\n * @param {Node} node\r\n */\r\nfunction previousSiblingsTextLength(node) {\r\n  let sibling = node.previousSibling;\r\n  let length = 0;\r\n  while (sibling) {\r\n    length += nodeTextLength(sibling);\r\n    sibling = sibling.previousSibling;\r\n  }\r\n  return length;\r\n}\r\n\r\n/**\r\n * Resolve one or more character offsets within an element to (text node, position)\r\n * pairs.\r\n *\r\n * @param {Element} element\r\n * @param {number[]} offsets - Offsets, which must be sorted in ascending order\r\n * @return {{ node: Text, offset: number }[]}\r\n */\r\nfunction resolveOffsets(element, ...offsets) {\r\n  let nextOffset = offsets.shift();\r\n  const nodeIter = /** @type {Document} */ (\r\n    element.ownerDocument\r\n  ).createNodeIterator(element, NodeFilter.SHOW_TEXT);\r\n  const results = [];\r\n\r\n  let currentNode = nodeIter.nextNode();\r\n  let textNode;\r\n  let length = 0;\r\n\r\n  // Find the text node containing the `nextOffset`th character from the start\r\n  // of `element`.\r\n  while (nextOffset !== undefined && currentNode) {\r\n    textNode = /** @type {Text} */ (currentNode);\r\n    if (length + textNode.data.length > nextOffset) {\r\n      results.push({ node: textNode, offset: nextOffset - length });\r\n      nextOffset = offsets.shift();\r\n    } else {\r\n      currentNode = nodeIter.nextNode();\r\n      length += textNode.data.length;\r\n    }\r\n  }\r\n\r\n  // Boundary case.\r\n  while (nextOffset !== undefined && textNode && length === nextOffset) {\r\n    results.push({ node: textNode, offset: textNode.data.length });\r\n    nextOffset = offsets.shift();\r\n  }\r\n\r\n  if (nextOffset !== undefined) {\r\n    throw new RangeError('Offset exceeds text length');\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\nexport let RESOLVE_FORWARDS = 1;\r\nexport let RESOLVE_BACKWARDS = 2;\r\n\r\n/**\r\n * Represents an offset within the text content of an element.\r\n *\r\n * This position can be resolved to a specific descendant node in the current\r\n * DOM subtree of the element using the `resolve` method.\r\n */\r\nexport class TextPosition {\r\n  /**\r\n   * Construct a `TextPosition` that refers to the text position `offset` within\r\n   * the text content of `element`.\r\n   *\r\n   * @param {Element} element\r\n   * @param {number} offset\r\n   */\r\n  constructor(element, offset) {\r\n    if (offset < 0) {\r\n      throw new Error('Offset is invalid');\r\n    }\r\n\r\n    /** Element that `offset` is relative to. */\r\n    this.element = element;\r\n\r\n    /** Character offset from the start of the element's `textContent`. */\r\n    this.offset = offset;\r\n  }\r\n\r\n  /**\r\n   * Return a copy of this position with offset relative to a given ancestor\r\n   * element.\r\n   *\r\n   * @param {Element} parent - Ancestor of `this.element`\r\n   * @return {TextPosition}\r\n   */\r\n  relativeTo(parent) {\r\n    if (!parent.contains(this.element)) {\r\n      throw new Error('Parent is not an ancestor of current element');\r\n    }\r\n\r\n    let el = this.element;\r\n    let offset = this.offset;\r\n    while (el !== parent) {\r\n      offset += previousSiblingsTextLength(el);\r\n      el = /** @type {Element} */ (el.parentElement);\r\n    }\r\n\r\n    return new TextPosition(el, offset);\r\n  }\r\n\r\n  /**\r\n   * Resolve the position to a specific text node and offset within that node.\r\n   *\r\n   * Throws if `this.offset` exceeds the length of the element's text. In the\r\n   * case where the element has no text and `this.offset` is 0, the `direction`\r\n   * option determines what happens.\r\n   *\r\n   * Offsets at the boundary between two nodes are resolved to the start of the\r\n   * node that begins at the boundary.\r\n   *\r\n   * @param {object} [options]\r\n   *   @param {RESOLVE_FORWARDS|RESOLVE_BACKWARDS} [options.direction] -\r\n   *     Specifies in which direction to search for the nearest text node if\r\n   *     `this.offset` is `0` and `this.element` has no text. If not specified\r\n   *     an error is thrown.\r\n   * @return {{ node: Text, offset: number }}\r\n   * @throws {RangeError}\r\n   */\r\n  resolve(options = {}) {\r\n    try {\r\n      return resolveOffsets(this.element, this.offset)[0];\r\n    } catch (err) {\r\n      if (this.offset === 0 && options.direction !== undefined) {\r\n        const tw = document.createTreeWalker(\r\n          this.element.getRootNode(),\r\n          NodeFilter.SHOW_TEXT\r\n        );\r\n        tw.currentNode = this.element;\r\n        const forwards = options.direction === RESOLVE_FORWARDS;\r\n        const text = /** @type {Text|null} */ (\r\n          forwards ? tw.nextNode() : tw.previousNode()\r\n        );\r\n        if (!text) {\r\n          throw err;\r\n        }\r\n        return { node: text, offset: forwards ? 0 : text.data.length };\r\n      } else {\r\n        throw err;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Construct a `TextPosition` that refers to the `offset`th character within\r\n   * `node`.\r\n   *\r\n   * @param {Node} node\r\n   * @param {number} offset\r\n   * @return {TextPosition}\r\n   */\r\n  static fromCharOffset(node, offset) {\r\n    switch (node.nodeType) {\r\n      case Node.TEXT_NODE:\r\n        return TextPosition.fromPoint(node, offset);\r\n      case Node.ELEMENT_NODE:\r\n        return new TextPosition(/** @type {Element} */ (node), offset);\r\n      default:\r\n        throw new Error('Node is not an element or text node');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Construct a `TextPosition` representing the range start or end point (node, offset).\r\n   *\r\n   * @param {Node} node - Text or Element node\r\n   * @param {number} offset - Offset within the node.\r\n   * @return {TextPosition}\r\n   */\r\n  static fromPoint(node, offset) {\r\n    switch (node.nodeType) {\r\n      case Node.TEXT_NODE: {\r\n        if (offset < 0 || offset > /** @type {Text} */ (node).data.length) {\r\n          throw new Error('Text node offset is out of range');\r\n        }\r\n\r\n        if (!node.parentElement) {\r\n          throw new Error('Text node has no parent');\r\n        }\r\n\r\n        // Get the offset from the start of the parent element.\r\n        const textOffset = previousSiblingsTextLength(node) + offset;\r\n\r\n        return new TextPosition(node.parentElement, textOffset);\r\n      }\r\n      case Node.ELEMENT_NODE: {\r\n        if (offset < 0 || offset > node.childNodes.length) {\r\n          throw new Error('Child node offset is out of range');\r\n        }\r\n\r\n        // Get the text length before the `offset`th child of element.\r\n        let textOffset = 0;\r\n        for (let i = 0; i < offset; i++) {\r\n          textOffset += nodeTextLength(node.childNodes[i]);\r\n        }\r\n\r\n        return new TextPosition(/** @type {Element} */ (node), textOffset);\r\n      }\r\n      default:\r\n        throw new Error('Point is not in an element or text node');\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Represents a region of a document as a (start, end) pair of `TextPosition` points.\r\n *\r\n * Representing a range in this way allows for changes in the DOM content of the\r\n * range which don't affect its text content, without affecting the text content\r\n * of the range itself.\r\n */\r\nexport class TextRange {\r\n  /**\r\n   * Construct an immutable `TextRange` from a `start` and `end` point.\r\n   *\r\n   * @param {TextPosition} start\r\n   * @param {TextPosition} end\r\n   */\r\n  constructor(start, end) {\r\n    this.start = start;\r\n    this.end = end;\r\n  }\r\n\r\n  /**\r\n   * Return a copy of this range with start and end positions relative to a\r\n   * given ancestor. See `TextPosition.relativeTo`.\r\n   *\r\n   * @param {Element} element\r\n   */\r\n  relativeTo(element) {\r\n    return new TextRange(\r\n      this.start.relativeTo(element),\r\n      this.end.relativeTo(element)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Resolve the `TextRange` to a DOM range.\r\n   *\r\n   * The resulting DOM Range will always start and end in a `Text` node.\r\n   * Hence `TextRange.fromRange(range).toRange()` can be used to \"shrink\" a\r\n   * range to the text it contains.\r\n   *\r\n   * May throw if the `start` or `end` positions cannot be resolved to a range.\r\n   *\r\n   * @return {Range}\r\n   */\r\n  toRange() {\r\n    let start;\r\n    let end;\r\n\r\n    if (\r\n      this.start.element === this.end.element &&\r\n      this.start.offset <= this.end.offset\r\n    ) {\r\n      // Fast path for start and end points in same element.\r\n      [start, end] = resolveOffsets(\r\n        this.start.element,\r\n        this.start.offset,\r\n        this.end.offset\r\n      );\r\n    } else {\r\n      start = this.start.resolve({ direction: RESOLVE_FORWARDS });\r\n      end = this.end.resolve({ direction: RESOLVE_BACKWARDS });\r\n    }\r\n\r\n    const range = new Range();\r\n    range.setStart(start.node, start.offset);\r\n    range.setEnd(end.node, end.offset);\r\n    return range;\r\n  }\r\n\r\n  /**\r\n   * Convert an existing DOM `Range` to a `TextRange`\r\n   *\r\n   * @param {Range} range\r\n   * @return {TextRange}\r\n   */\r\n  static fromRange(range) {\r\n    const start = TextPosition.fromPoint(\r\n      range.startContainer,\r\n      range.startOffset\r\n    );\r\n    const end = TextPosition.fromPoint(range.endContainer, range.endOffset);\r\n    return new TextRange(start, end);\r\n  }\r\n\r\n  /**\r\n   * Return a `TextRange` from the `start`th to `end`th characters in `root`.\r\n   *\r\n   * @param {Element} root\r\n   * @param {number} start\r\n   * @param {number} end\r\n   */\r\n  static fromOffsets(root, start, end) {\r\n    return new TextRange(\r\n      new TextPosition(root, start),\r\n      new TextPosition(root, end)\r\n    );\r\n  }\r\n}\r\n","/**\r\n * CSS selector that will match the placeholder within a page/tile container.\r\n */\r\nconst placeholderSelector = '.annotator-placeholder';\r\n\r\n/**\r\n * Create or return a placeholder element for anchoring.\r\n *\r\n * In document viewers such as PDF.js which only render a subset of long\r\n * documents at a time, it may not be possible to anchor annotations to the\r\n * actual text in pages which are off-screen. For these non-rendered pages,\r\n * a \"placeholder\" element is created in the approximate X/Y location (eg.\r\n * middle of the page) where the content will appear. Any highlights for that\r\n * page are then rendered inside the placeholder.\r\n *\r\n * When the viewport is scrolled to the non-rendered page, the placeholder\r\n * is removed and annotations are re-anchored to the real content.\r\n *\r\n * @param {HTMLElement} container - The container element for the page or tile\r\n *   which is not rendered.\r\n */\r\nexport function createPlaceholder(container) {\r\n  let placeholder = container.querySelector(placeholderSelector);\r\n  if (placeholder) {\r\n    return placeholder;\r\n  }\r\n  placeholder = document.createElement('span');\r\n  placeholder.classList.add('annotator-placeholder');\r\n  placeholder.textContent = 'Loading annotations...';\r\n  container.appendChild(placeholder);\r\n  return placeholder;\r\n}\r\n\r\n/**\r\n * Return true if a page/tile container has a placeholder.\r\n *\r\n * @param {HTMLElement} container\r\n */\r\nexport function hasPlaceholder(container) {\r\n  return container.querySelector(placeholderSelector) !== null;\r\n}\r\n\r\n/**\r\n * Remove the placeholder element in `container`, if present.\r\n *\r\n * @param {HTMLElement} container\r\n */\r\nexport function removePlaceholder(container) {\r\n  container.querySelector(placeholderSelector)?.remove();\r\n}\r\n\r\n/**\r\n * Return true if `node` is inside a placeholder element created with `createPlaceholder`.\r\n *\r\n * This is typically used to test if a highlight element associated with an\r\n * anchor is inside a placeholder.\r\n *\r\n * @param {Node} node\r\n */\r\nexport function isInPlaceholder(node) {\r\n  if (!node.parentElement) {\r\n    return false;\r\n  }\r\n  return node.parentElement.closest(placeholderSelector) !== null;\r\n}\r\n","/**\r\n * Returns true if the start point of a selection occurs after the end point,\r\n * in document order.\r\n *\r\n * @param {Selection} selection\r\n */\r\nexport function isSelectionBackwards(selection) {\r\n  if (selection.focusNode === selection.anchorNode) {\r\n    return selection.focusOffset < selection.anchorOffset;\r\n  }\r\n\r\n  const range = selection.getRangeAt(0);\r\n  // Does not work correctly on iOS when selecting nodes backwards.\r\n  // https://bugs.webkit.org/show_bug.cgi?id=220523\r\n  return range.startContainer === selection.focusNode;\r\n}\r\n\r\n/**\r\n * Returns true if any part of `node` lies within `range`.\r\n *\r\n * @param {Range} range\r\n * @param {Node} node\r\n */\r\nexport function isNodeInRange(range, node) {\r\n  try {\r\n    const length = node.nodeValue?.length ?? node.childNodes.length;\r\n    return (\r\n      // Check start of node is before end of range.\r\n      range.comparePoint(node, 0) <= 0 &&\r\n      // Check end of node is after start of range.\r\n      range.comparePoint(node, length) >= 0\r\n    );\r\n  } catch (e) {\r\n    // `comparePoint` may fail if the `range` and `node` do not share a common\r\n    // ancestor or `node` is a doctype.\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Iterate over all Node(s) which overlap `range` in document order and invoke\r\n * `callback` for each of them.\r\n *\r\n * @param {Range} range\r\n * @param {(n: Node) => void} callback\r\n */\r\nexport function forEachNodeInRange(range, callback) {\r\n  const root = range.commonAncestorContainer;\r\n  const nodeIter = /** @type {Document} */ (\r\n    root.ownerDocument\r\n  ).createNodeIterator(root, NodeFilter.SHOW_ALL);\r\n\r\n  let currentNode;\r\n  while ((currentNode = nodeIter.nextNode())) {\r\n    if (isNodeInRange(range, currentNode)) {\r\n      callback(currentNode);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the bounding rectangles of non-whitespace text nodes in `range`.\r\n *\r\n * @param {Range} range\r\n * @return {Array<DOMRect>} Array of bounding rects in viewport coordinates.\r\n */\r\nexport function getTextBoundingBoxes(range) {\r\n  const whitespaceOnly = /^\\s*$/;\r\n  const textNodes = /** @type {Text[]} */ ([]);\r\n  forEachNodeInRange(range, node => {\r\n    if (\r\n      node.nodeType === Node.TEXT_NODE &&\r\n      !(/** @type {string} */ (node.textContent).match(whitespaceOnly))\r\n    ) {\r\n      textNodes.push(/** @type {Text} */ (node));\r\n    }\r\n  });\r\n\r\n  /** @type {DOMRect[]} */\r\n  let rects = [];\r\n  textNodes.forEach(node => {\r\n    const nodeRange = node.ownerDocument.createRange();\r\n    nodeRange.selectNodeContents(node);\r\n    if (node === range.startContainer) {\r\n      nodeRange.setStart(node, range.startOffset);\r\n    }\r\n    if (node === range.endContainer) {\r\n      nodeRange.setEnd(node, range.endOffset);\r\n    }\r\n    if (nodeRange.collapsed) {\r\n      // If the range ends at the start of this text node or starts at the end\r\n      // of this node then do not include it.\r\n      return;\r\n    }\r\n\r\n    // Measure the range and translate from viewport to document coordinates\r\n    const viewportRects = Array.from(nodeRange.getClientRects());\r\n    nodeRange.detach();\r\n    rects = rects.concat(viewportRects);\r\n  });\r\n  return rects;\r\n}\r\n\r\n/**\r\n * Returns the rectangle, in viewport coordinates, for the line of text\r\n * containing the focus point of a Selection.\r\n *\r\n * Returns null if the selection is empty.\r\n *\r\n * @param {Selection} selection\r\n * @return {DOMRect|null}\r\n */\r\nexport function selectionFocusRect(selection) {\r\n  if (selection.isCollapsed) {\r\n    return null;\r\n  }\r\n  const textBoxes = getTextBoundingBoxes(selection.getRangeAt(0));\r\n  if (textBoxes.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (isSelectionBackwards(selection)) {\r\n    return textBoxes[0];\r\n  } else {\r\n    return textBoxes[textBoxes.length - 1];\r\n  }\r\n}\r\n\r\n/**\r\n * Retrieve a set of items associated with nodes in a given range.\r\n *\r\n * An `item` can be any data that the caller wishes to compute from or associate\r\n * with a node. Only unique items, as determined by `Object.is`, are returned.\r\n *\r\n * @template T\r\n * @param {Range} range\r\n * @param {(n: Node) => T} itemForNode - Callback returning the item for a given node\r\n * @return {NonNullable<T>[]} items\r\n */\r\nexport function itemsForRange(range, itemForNode) {\r\n  /** @type {Set<Node>} */\r\n  const checkedNodes = new Set();\r\n  /** @type {Set<NonNullable<T>>} */\r\n  const items = new Set();\r\n\r\n  forEachNodeInRange(range, node => {\r\n    /** @type {Node|null} */\r\n    let current = node;\r\n    while (current) {\r\n      if (checkedNodes.has(current)) {\r\n        break;\r\n      }\r\n      checkedNodes.add(current);\r\n\r\n      const item = /** @type {NonNullable<T>|null|undefined} */ (\r\n        itemForNode(current)\r\n      );\r\n      if (item !== null && item !== undefined) {\r\n        items.add(item);\r\n      }\r\n\r\n      current = current.parentNode;\r\n    }\r\n  });\r\n\r\n  return [...items];\r\n}\r\n","import { isInPlaceholder } from './anchoring/placeholder';\r\nimport { isNodeInRange } from './range-util';\r\n\r\nconst SVG_NAMESPACE = 'http://www.w3.org/2000/svg';\r\n\r\n/**\r\n * Return the canvas element underneath a highlight element in a PDF page's\r\n * text layer.\r\n *\r\n * Returns `null` if the highlight is not above a PDF canvas.\r\n *\r\n * @param {HTMLElement} highlightEl -\r\n *   A `<hypothesis-highlight>` element in the page's text layer\r\n * @return {HTMLCanvasElement|null}\r\n */\r\nfunction getPDFCanvas(highlightEl) {\r\n  // This code assumes that PDF.js renders pages with a structure like:\r\n  //\r\n  // <div class=\"page\">\r\n  //   <div class=\"canvasWrapper\">\r\n  //     <canvas></canvas> <!-- The rendered PDF page -->\r\n  //   </div>\r\n  //   <div class=\"textLayer\">\r\n  //      <!-- Transparent text layer with text spans used to enable text selection -->\r\n  //   </div>\r\n  // </div>\r\n  //\r\n  // It also assumes that the `highlightEl` element is somewhere under\r\n  // the `.textLayer` div.\r\n\r\n  const pageEl = highlightEl.closest('.page');\r\n  if (!pageEl) {\r\n    return null;\r\n  }\r\n\r\n  const canvasEl = pageEl.querySelector('.canvasWrapper > canvas');\r\n  if (!canvasEl) {\r\n    return null;\r\n  }\r\n\r\n  return /** @type {HTMLCanvasElement} */ (canvasEl);\r\n}\r\n\r\n/**\r\n * Draw highlights in an SVG layer overlaid on top of a PDF.js canvas.\r\n *\r\n * The created SVG elements are stored in the `svgHighlight` property of\r\n * each `HighlightElement`.\r\n *\r\n * @param {HighlightElement[]} highlightEls -\r\n *   An element that wraps the highlighted text in the transparent text layer\r\n *   above the PDF.\r\n */\r\nfunction drawHighlightsAbovePDFCanvas(highlightEls) {\r\n  if (highlightEls.length === 0) {\r\n    return;\r\n  }\r\n\r\n  // Get the <canvas> for the PDF page containing the highlight. We assume all\r\n  // the highlights are on the same page.\r\n  const canvasEl = getPDFCanvas(highlightEls[0]);\r\n  if (!canvasEl || !canvasEl.parentElement) {\r\n    return;\r\n  }\r\n\r\n  /** @type {SVGElement|null} */\r\n  let svgHighlightLayer = canvasEl.parentElement.querySelector(\r\n    '.hypothesis-highlight-layer'\r\n  );\r\n\r\n  if (!svgHighlightLayer) {\r\n    // Create SVG layer. This must be in the same stacking context as\r\n    // the canvas so that CSS `mix-blend-mode` can be used to control how SVG\r\n    // content blends with the canvas below.\r\n    svgHighlightLayer = document.createElementNS(SVG_NAMESPACE, 'svg');\r\n    svgHighlightLayer.setAttribute('class', 'hypothesis-highlight-layer');\r\n    canvasEl.parentElement.appendChild(svgHighlightLayer);\r\n\r\n    // Overlay SVG layer above canvas.\r\n    canvasEl.parentElement.style.position = 'relative';\r\n\r\n    const svgStyle = svgHighlightLayer.style;\r\n    svgStyle.position = 'absolute';\r\n    svgStyle.left = '0';\r\n    svgStyle.top = '0';\r\n    svgStyle.width = '100%';\r\n    svgStyle.height = '100%';\r\n\r\n    // Use multiply blending so that highlights drawn on top of text darken it\r\n    // rather than making it lighter. This improves contrast and thus readability\r\n    // of highlighted text, especially for overlapping highlights.\r\n    //\r\n    // This choice optimizes for the common case of dark text on a light background.\r\n    svgStyle.mixBlendMode = 'multiply';\r\n  }\r\n\r\n  const canvasRect = canvasEl.getBoundingClientRect();\r\n  const highlightRects = highlightEls.map(highlightEl => {\r\n    const highlightRect = highlightEl.getBoundingClientRect();\r\n\r\n    // Create SVG element for the current highlight element.\r\n    const rect = document.createElementNS(SVG_NAMESPACE, 'rect');\r\n    rect.setAttribute('x', (highlightRect.left - canvasRect.left).toString());\r\n    rect.setAttribute('y', (highlightRect.top - canvasRect.top).toString());\r\n    rect.setAttribute('width', highlightRect.width.toString());\r\n    rect.setAttribute('height', highlightRect.height.toString());\r\n    rect.setAttribute('class', 'hypothesis-svg-highlight');\r\n\r\n    // Make the highlight in the text layer transparent.\r\n    highlightEl.classList.add('is-transparent');\r\n\r\n    // Associate SVG element with highlight for use by `removeHighlights`.\r\n    highlightEl.svgHighlight = rect;\r\n\r\n    return rect;\r\n  });\r\n\r\n  svgHighlightLayer.append(...highlightRects);\r\n}\r\n\r\n/**\r\n * Additional properties added to text highlight HTML elements.\r\n *\r\n * @typedef HighlightProps\r\n * @prop {SVGElement} [svgHighlight]\r\n */\r\n\r\n/**\r\n * @typedef {HTMLElement & HighlightProps} HighlightElement\r\n */\r\n\r\n/**\r\n * Return text nodes which are entirely inside `range`.\r\n *\r\n * If a range starts or ends part-way through a text node, the node is split\r\n * and the part inside the range is returned.\r\n *\r\n * @param {Range} range\r\n * @return {Text[]}\r\n */\r\nfunction wholeTextNodesInRange(range) {\r\n  if (range.collapsed) {\r\n    // Exit early for an empty range to avoid an edge case that breaks the algorithm\r\n    // below. Splitting a text node at the start of an empty range can leave the\r\n    // range ending in the left part rather than the right part.\r\n    return [];\r\n  }\r\n\r\n  /** @type {Node|null} */\r\n  let root = range.commonAncestorContainer;\r\n  if (root.nodeType !== Node.ELEMENT_NODE) {\r\n    // If the common ancestor is not an element, set it to the parent element to\r\n    // ensure that the loop below visits any text nodes generated by splitting\r\n    // the common ancestor.\r\n    //\r\n    // Note that `parentElement` may be `null`.\r\n    root = root.parentElement;\r\n  }\r\n  if (!root) {\r\n    // If there is no root element then we won't be able to insert highlights,\r\n    // so exit here.\r\n    return [];\r\n  }\r\n\r\n  const textNodes = [];\r\n  const nodeIter = /** @type {Document} */ (\r\n    root.ownerDocument\r\n  ).createNodeIterator(\r\n    root,\r\n    NodeFilter.SHOW_TEXT // Only return `Text` nodes.\r\n  );\r\n  let node;\r\n  while ((node = nodeIter.nextNode())) {\r\n    if (!isNodeInRange(range, node)) {\r\n      continue;\r\n    }\r\n    let text = /** @type {Text} */ (node);\r\n\r\n    if (text === range.startContainer && range.startOffset > 0) {\r\n      // Split `text` where the range starts. The split will create a new `Text`\r\n      // node which will be in the range and will be visited in the next loop iteration.\r\n      text.splitText(range.startOffset);\r\n      continue;\r\n    }\r\n\r\n    if (text === range.endContainer && range.endOffset < text.data.length) {\r\n      // Split `text` where the range ends, leaving it as the part in the range.\r\n      text.splitText(range.endOffset);\r\n    }\r\n\r\n    textNodes.push(text);\r\n  }\r\n\r\n  return textNodes;\r\n}\r\n\r\n/**\r\n * Wraps the DOM Nodes within the provided range with a highlight\r\n * element of the specified class and returns the highlight Elements.\r\n *\r\n * @param {Range} range - Range to be highlighted\r\n * @param {string} cssClass - A CSS class to use for the highlight\r\n * @return {HighlightElement[]} - Elements wrapping text in `normedRange` to add a highlight effect\r\n */\r\nexport function highlightRange(range, cssClass = 'hypothesis-highlight') {\r\n  const textNodes = wholeTextNodesInRange(range);\r\n\r\n  // Check if this range refers to a placeholder for not-yet-rendered content in\r\n  // a PDF. These highlights should be invisible.\r\n  const inPlaceholder = textNodes.length > 0 && isInPlaceholder(textNodes[0]);\r\n\r\n  // Group text nodes into spans of adjacent nodes. If a group of text nodes are\r\n  // adjacent, we only need to create one highlight element for the group.\r\n  let textNodeSpans = /** @type {Text[][]} */ ([]);\r\n  let prevNode = /** @type {Node|null} */ (null);\r\n  let currentSpan = null;\r\n\r\n  textNodes.forEach(node => {\r\n    if (prevNode && prevNode.nextSibling === node) {\r\n      currentSpan.push(node);\r\n    } else {\r\n      currentSpan = [node];\r\n      textNodeSpans.push(currentSpan);\r\n    }\r\n    prevNode = node;\r\n  });\r\n\r\n  // Filter out text node spans that consist only of white space. This avoids\r\n  // inserting highlight elements in places that can only contain a restricted\r\n  // subset of nodes such as table rows and lists.\r\n  const whitespace = /^\\s*$/;\r\n  textNodeSpans = textNodeSpans.filter(span =>\r\n    // Check for at least one text node with non-space content.\r\n    span.some(node => !whitespace.test(node.data))\r\n  );\r\n\r\n  // Wrap each text node span with a `<hypothesis-highlight>` element.\r\n  const highlights = /** @type {HighlightElement[]} */ ([]);\r\n  textNodeSpans.forEach(nodes => {\r\n    // A custom element name is used here rather than `<span>` to reduce the\r\n    // likelihood of highlights being hidden by page styling.\r\n\r\n    /** @type {HighlightElement} */\r\n    const highlightEl = document.createElement('hypothesis-highlight');\r\n    highlightEl.className = cssClass;\r\n\r\n    const parent = /** @type {Node} */ (nodes[0].parentNode);\r\n    parent.replaceChild(highlightEl, nodes[0]);\r\n    nodes.forEach(node => highlightEl.appendChild(node));\r\n\r\n    highlights.push(highlightEl);\r\n  });\r\n\r\n  // For PDF highlights, create the highlight effect by using an SVG placed\r\n  // above the page's canvas rather than CSS `background-color` on the highlight\r\n  // element. This enables more control over blending of the highlight with the\r\n  // content below.\r\n  //\r\n  // Drawing these SVG highlights involves measuring the `<hypothesis-highlight>`\r\n  // elements, so we create them only after those elements have all been created\r\n  // to reduce the number of forced reflows. We also skip creating them for\r\n  // unrendered pages for performance reasons.\r\n  if (!inPlaceholder) {\r\n    drawHighlightsAbovePDFCanvas(highlights);\r\n  }\r\n\r\n  return highlights;\r\n}\r\n\r\n/**\r\n * Replace a child `node` with `replacements`.\r\n *\r\n * nb. This is like `ChildNode.replaceWith` but it works in older browsers.\r\n *\r\n * @param {ChildNode} node\r\n * @param {Node[]} replacements\r\n */\r\nfunction replaceWith(node, replacements) {\r\n  const parent = /** @type {Node} */ (node.parentNode);\r\n  replacements.forEach(r => parent.insertBefore(r, node));\r\n  node.remove();\r\n}\r\n\r\n/**\r\n * Remove all highlights under a given root element.\r\n *\r\n * @param {HTMLElement} root\r\n */\r\nexport function removeAllHighlights(root) {\r\n  const highlights = Array.from(root.querySelectorAll('hypothesis-highlight'));\r\n  removeHighlights(/** @type {HighlightElement[]} */ (highlights));\r\n}\r\n\r\n/**\r\n * Remove highlights from a range previously highlighted with `highlightRange`.\r\n *\r\n * @param {HighlightElement[]} highlights - The highlight elements returned by `highlightRange`\r\n */\r\nexport function removeHighlights(highlights) {\r\n  for (let h of highlights) {\r\n    if (h.parentNode) {\r\n      const children = Array.from(h.childNodes);\r\n      replaceWith(h, children);\r\n    }\r\n\r\n    if (h.svgHighlight) {\r\n      h.svgHighlight.remove();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Set whether the given highlight elements should appear \"focused\".\r\n *\r\n * A highlight can be displayed in a different (\"focused\") style to indicate\r\n * that it is current in some other context - for example the user has selected\r\n * the corresponding annotation in the sidebar.\r\n *\r\n * @param {HighlightElement[]} highlights\r\n * @param {boolean} focused\r\n */\r\nexport function setHighlightsFocused(highlights, focused) {\r\n  highlights.forEach(h => {\r\n    // In PDFs the visible highlight is created by an SVG element, so the focused\r\n    // effect is applied to that. In other documents the effect is applied to the\r\n    // `<hypothesis-highlight>` element.\r\n    if (h.svgHighlight) {\r\n      h.svgHighlight.classList.toggle('is-focused', focused);\r\n\r\n      // Ensure that focused highlights are drawn above un-focused highlights\r\n      // on the same page.\r\n      //\r\n      // SVG elements are rendered in document order so to achieve this we need\r\n      // to move the element to be the last child of its parent.\r\n      if (focused) {\r\n        const parent = /** @type {SVGElement} */ (h.svgHighlight.parentNode);\r\n        parent.append(h.svgHighlight);\r\n      }\r\n    } else {\r\n      h.classList.toggle('hypothesis-highlight-focused', focused);\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Set whether highlights under the given root element should be visible.\r\n *\r\n * @param {HTMLElement} root\r\n * @param {boolean} visible\r\n */\r\nexport function setHighlightsVisible(root, visible) {\r\n  const showHighlightsClass = 'hypothesis-highlights-always-on';\r\n  root.classList.toggle(showHighlightsClass, visible);\r\n}\r\n\r\n/**\r\n * Get the highlight elements that contain the given node.\r\n *\r\n * @param {Node} node\r\n * @return {HighlightElement[]}\r\n */\r\nexport function getHighlightsContainingNode(node) {\r\n  let el =\r\n    node.nodeType === Node.ELEMENT_NODE\r\n      ? /** @type {Element} */ (node)\r\n      : node.parentElement;\r\n\r\n  const highlights = [];\r\n\r\n  while (el) {\r\n    if (el.classList.contains('hypothesis-highlight')) {\r\n      highlights.push(/** @type {HighlightElement} */ (el));\r\n    }\r\n    el = el.parentElement;\r\n  }\r\n\r\n  return highlights;\r\n}\r\n\r\n/**\r\n * Subset of `DOMRect` interface.\r\n *\r\n * @typedef Rect\r\n * @prop {number} top\r\n * @prop {number} left\r\n * @prop {number} bottom\r\n * @prop {number} right\r\n */\r\n\r\n/**\r\n * Get the bounding client rectangle of a collection in viewport coordinates.\r\n * Unfortunately, Chrome has issues ([1]) with Range.getBoundingClient rect or we\r\n * could just use that.\r\n *\r\n * [1] https://bugs.chromium.org/p/chromium/issues/detail?id=324437\r\n *\r\n * @param {HTMLElement[]} collection\r\n * @return {Rect}\r\n */\r\nexport function getBoundingClientRect(collection) {\r\n  // Reduce the client rectangles of the highlights to a bounding box\r\n  const rects = collection.map(\r\n    n => /** @type {Rect} */ (n.getBoundingClientRect())\r\n  );\r\n  return rects.reduce((acc, r) => ({\r\n    top: Math.min(acc.top, r.top),\r\n    left: Math.min(acc.left, r.left),\r\n    bottom: Math.max(acc.bottom, r.bottom),\r\n    right: Math.max(acc.right, r.right),\r\n  }));\r\n}\r\n","import { ListenerCollection } from '../shared/listener-collection';\r\n\r\nimport { computeAnchorPositions } from './util/buckets';\r\n\r\n/**\r\n * @typedef {import('../shared/messaging').PortRPC<HostToGuestEvent, GuestToHostEvent>} HostRPC\r\n * @typedef {import('../types/annotator').Anchor} Anchor\r\n * @typedef {import('../types/annotator').AnchorPosition} AnchorPosition\r\n * @typedef {import('../types/annotator').Destroyable} Destroyable\r\n * @typedef {import('../types/port-rpc-events').HostToGuestEvent} HostToGuestEvent\r\n * @typedef {import('../types/port-rpc-events').GuestToHostEvent} GuestToHostEvent\r\n */\r\n\r\n/**\r\n * Communicate to the host frame when:\r\n *\r\n * 1. The set of anchors has been changed (due to annotations being added or removed)\r\n * 2. The position of anchors relative to the viewport of the guest has changed\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class BucketBarClient {\r\n  /**\r\n   * @param {object} options\r\n   *   @param {Element} options.contentContainer - The scrollable container element for the\r\n   *     document content. All of the highlights that the bucket bar's buckets point\r\n   *     at should be contained within this element.\r\n   *   @param {HostRPC} options.hostRPC\r\n   */\r\n  constructor({ contentContainer, hostRPC }) {\r\n    this._hostRPC = hostRPC;\r\n    this._updatePending = false;\r\n    /** @type {Anchor[]} */\r\n    this._anchors = [];\r\n    this._listeners = new ListenerCollection();\r\n\r\n    this._listeners.add(window, 'resize', () => this.update());\r\n    this._listeners.add(window, 'scroll', () => this.update());\r\n    this._listeners.add(contentContainer, 'scroll', () => this.update());\r\n  }\r\n\r\n  destroy() {\r\n    this._listeners.removeAll();\r\n  }\r\n\r\n  /**\r\n   * Notifies the BucketBar in the host frame when:\r\n   * 1. The set of anchors has been changed (due to annotations being added or removed)\r\n   * 2. The position of anchors relative to the viewport of the guest has changed\r\n   *\r\n   * Updates are debounced to reduce the overhead of gathering and sending anchor\r\n   * position data across frames.\r\n   *\r\n   * @param {Anchor[]} [anchors] - pass this option when anchors are added or\r\n   *   deleted\r\n   */\r\n  update(anchors) {\r\n    if (anchors) {\r\n      this._anchors = anchors;\r\n    }\r\n\r\n    if (this._updatePending) {\r\n      return;\r\n    }\r\n\r\n    this._updatePending = true;\r\n    requestAnimationFrame(() => {\r\n      const positions = computeAnchorPositions(this._anchors);\r\n      this._hostRPC.call('anchorsChanged', positions);\r\n      this._updatePending = false;\r\n    });\r\n  }\r\n}\r\n","import { getBoundingClientRect } from '../highlighter';\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').Anchor} Anchor\r\n * @typedef {import('../../types/annotator').AnchorPosition} AnchorPosition\r\n */\r\n\r\n/**\r\n * @typedef Bucket\r\n * @prop {Set<string>} tags - The annotation tags in this bucket\r\n * @prop {number} position - The vertical pixel offset where this bucket should\r\n *   appear in the bucket bar\r\n */\r\n\r\n/**\r\n * @typedef BucketSet\r\n * @prop {Bucket} above - A single bucket containing all the annotation\r\n *   tags whose anchors are offscreen upwards\r\n * @prop {Bucket} below - A single bucket containing all the annotation\r\n *   tags which anchors are offscreen downwards\r\n * @prop {Bucket[]} buckets - On-screen buckets\r\n */\r\n\r\n/**\r\n * @typedef WorkingBucket\r\n * @prop {Set<string>} tags - The annotation tags in this bucket\r\n * @prop {number} position - The computed position (offset) for this bucket,\r\n *   based on the current anchors. This is centered between `top` and `bottom`\r\n * @prop {number} top - The uppermost (lowest) vertical offset for the anchors\r\n *   in this bucket — the lowest `top` position value, akin to the top offset of\r\n *   a theoretical box drawn around all of the anchor highlights in this bucket\r\n * @prop {number} bottom - The bottommost (highest) vertical offset for the\r\n *   anchors in this bucket — the highest `top` position value, akin to the\r\n *   bottom of a theoretical box drawn around all of the anchor highlights in\r\n *   this bucket\r\n */\r\n\r\n// Only anchors with top offsets between `BUCKET_TOP_THRESHOLD` and\r\n// `window.innerHeight - BUCKET_BOTTOM_THRESHOLD` are considered \"on-screen\"\r\n// and will be bucketed. This is to account for bucket-bar tool buttons (top\r\n// and the height of the bottom navigation bucket (bottom)\r\nconst BUCKET_TOP_THRESHOLD = 137;\r\nconst BUCKET_BOTTOM_THRESHOLD = 22;\r\n// Generated buckets of annotation anchor highlights should be spaced by\r\n// at least this amount, in pixels\r\nconst BUCKET_GAP_SIZE = 60;\r\n\r\n/**\r\n * Find the closest valid anchor in `anchors` that is offscreen in the direction\r\n * indicated.\r\n *\r\n * @param {Anchor[]} anchors\r\n * @param {'up'|'down'} direction\r\n * @return {Anchor|null} - The closest anchor or `null` if no valid anchor found\r\n */\r\nexport function findClosestOffscreenAnchor(anchors, direction) {\r\n  let closestAnchor = null;\r\n  let closestTop = 0;\r\n\r\n  for (let anchor of anchors) {\r\n    if (!anchor.highlights?.length) {\r\n      continue;\r\n    }\r\n\r\n    const top = getBoundingClientRect(anchor.highlights).top;\r\n\r\n    // Verify that the anchor is offscreen in the direction we're headed\r\n    if (direction === 'up' && top >= BUCKET_TOP_THRESHOLD) {\r\n      // We're headed up but the anchor is already below the\r\n      // visible top of the bucket bar: it's not our guy\r\n      continue;\r\n    } else if (\r\n      direction === 'down' &&\r\n      top <= window.innerHeight - BUCKET_BOTTOM_THRESHOLD\r\n    ) {\r\n      // We're headed down but this anchor is already above\r\n      // the usable bottom of the screen: it's not our guy\r\n      continue;\r\n    }\r\n\r\n    if (\r\n      !closestAnchor ||\r\n      (direction === 'up' && top > closestTop) ||\r\n      (direction === 'down' && top < closestTop)\r\n    ) {\r\n      // This anchor is either:\r\n      // - The first anchor we've encountered off-screen in the direction\r\n      //   we're headed, or\r\n      // - Closer to the screen than the previous `closestAnchor`\r\n      closestAnchor = anchor;\r\n      closestTop = top;\r\n    }\r\n  }\r\n\r\n  return closestAnchor;\r\n}\r\n\r\n/**\r\n * Compute the top and bottom positions for the set of anchors' highlights, sorted\r\n * vertically, from top to bottom.\r\n *\r\n * @param {Anchor[]} anchors\r\n * @return {AnchorPosition[]}\r\n */\r\nexport function computeAnchorPositions(anchors) {\r\n  /** @type {AnchorPosition[]} */\r\n  const positions = [];\r\n\r\n  anchors.forEach(({ annotation, highlights }) => {\r\n    if (!highlights?.length) {\r\n      return;\r\n    }\r\n\r\n    const { top, bottom } = getBoundingClientRect(highlights);\r\n\r\n    if (top >= bottom) {\r\n      // Empty rect. The highlights may be disconnected from the document or hidden.\r\n      return;\r\n    }\r\n\r\n    positions.push({\r\n      tag: annotation.$tag,\r\n      top,\r\n      bottom,\r\n    });\r\n  });\r\n\r\n  // Sort anchors vertically from top to bottom\r\n  positions.sort((anchor1, anchor2) => anchor1.top - anchor2.top);\r\n\r\n  return positions;\r\n}\r\n\r\n/**\r\n * Compute buckets\r\n *\r\n * @param {AnchorPosition[]} anchorPositions\r\n * @return {BucketSet}\r\n */\r\nexport function computeBuckets(anchorPositions) {\r\n  /** @type {Set<string>} */\r\n  const aboveTags = new Set();\r\n  /** @type {Set<string>} */\r\n  const belowTags = new Set();\r\n  /** @type {Bucket[]} */\r\n  const buckets = [];\r\n\r\n  // Hold current working anchors and positions as we build each bucket\r\n  /** @type {WorkingBucket|null} */\r\n  let currentBucket = null;\r\n\r\n  /**\r\n   * Create a new working bucket based on the provided `AnchorPosition`\r\n   *\r\n   * @param {AnchorPosition} anchorPosition\r\n   * @return {WorkingBucket}\r\n   */\r\n  function newBucket({ bottom, tag, top }) {\r\n    const anchorHeight = bottom - top;\r\n    const bucketPosition = top + anchorHeight / 2;\r\n    return {\r\n      bottom,\r\n      position: bucketPosition,\r\n      tags: new Set([tag]),\r\n      top,\r\n    };\r\n  }\r\n\r\n  // Build buckets from position information\r\n  anchorPositions.forEach(aPos => {\r\n    if (aPos.top < BUCKET_TOP_THRESHOLD) {\r\n      aboveTags.add(aPos.tag);\r\n      return;\r\n    } else if (aPos.top > window.innerHeight - BUCKET_BOTTOM_THRESHOLD) {\r\n      belowTags.add(aPos.tag);\r\n      return;\r\n    }\r\n\r\n    if (!currentBucket) {\r\n      // We've encountered our first on-screen anchor position:\r\n      // We'll need a bucket!\r\n      currentBucket = newBucket(aPos);\r\n      return;\r\n    }\r\n    // We want to contain overlapping highlights and those near each other\r\n    // within a shared bucket\r\n    const isContainedWithin =\r\n      aPos.top > currentBucket.top && aPos.bottom < currentBucket.bottom;\r\n\r\n    // The new anchor's position is far enough below the bottom of the current\r\n    // bucket to justify starting a new bucket\r\n    const isLargeGap = aPos.top - currentBucket.bottom > BUCKET_GAP_SIZE;\r\n\r\n    if (isLargeGap && !isContainedWithin) {\r\n      // We need to start a new bucket; push the working bucket and create\r\n      // a new bucket\r\n      buckets.push(currentBucket);\r\n      currentBucket = newBucket(aPos);\r\n    } else {\r\n      // We'll add this anchor to the current working bucket and update\r\n      // offset properties accordingly.\r\n      // We can be confident that `aPos.top` is >= `currentBucket.top` because\r\n      // AnchorPositions are sorted by their `top` offset — meaning that\r\n      // `currentBucket.top` still accurately represents the `top` offset of\r\n      // the virtual rectangle enclosing all anchors in this bucket. But\r\n      // let's check to see if the bottom is larger/lower:\r\n      const updatedBottom =\r\n        aPos.bottom > currentBucket.bottom ? aPos.bottom : currentBucket.bottom;\r\n      const updatedHeight = updatedBottom - currentBucket.top;\r\n\r\n      currentBucket.tags.add(aPos.tag);\r\n      currentBucket.bottom = updatedBottom;\r\n      currentBucket.position = currentBucket.top + updatedHeight / 2;\r\n    }\r\n  });\r\n\r\n  if (currentBucket) {\r\n    buckets.push(currentBucket);\r\n  }\r\n\r\n  // Add an upper \"navigation\" bucket with offscreen-above anchors\r\n  const above = {\r\n    tags: aboveTags,\r\n    position: BUCKET_TOP_THRESHOLD,\r\n  };\r\n\r\n  // Add a lower \"navigation\" bucket with offscreen-below anchors\r\n  const below = {\r\n    tags: belowTags,\r\n    position: window.innerHeight - BUCKET_BOTTOM_THRESHOLD,\r\n  };\r\n\r\n  return {\r\n    above,\r\n    below,\r\n    buckets,\r\n  };\r\n}\r\n","/** @type {Set<string>} */\r\nlet shownWarnings = new Set();\r\n\r\n/**\r\n * Log a warning if it has not already been reported.\r\n *\r\n * This is useful to avoid spamming the console if a warning is emitted in a\r\n * context that may be called frequently.\r\n *\r\n * @param {...unknown} args -\r\n *   Arguments to forward to `console.warn`. The arguments `toString()` values\r\n *   are concatenated into a string key which is used to determine if the warning\r\n *   has been logged before.\r\n */\r\nexport function warnOnce(...args) {\r\n  const key = args.join();\r\n  if (shownWarnings.has(key)) {\r\n    return;\r\n  }\r\n  console.warn(...args);\r\n  shownWarnings.add(key);\r\n}\r\n\r\nwarnOnce.reset = () => {\r\n  shownWarnings.clear();\r\n};\r\n","import { TinyEmitter } from 'tiny-emitter';\r\n\r\nimport { warnOnce } from '../shared/warn-once';\r\n\r\n/**\r\n * @typedef {import('../types/annotator').FeatureFlags} IFeatureFlags\r\n */\r\n\r\n/**\r\n * List of feature flags that annotator code tests for.\r\n *\r\n * @type {string[]}\r\n */\r\nconst annotatorFlags = ['html_side_by_side'];\r\n\r\n/**\r\n * An observable container of feature flags.\r\n *\r\n * @implements {IFeatureFlags}\r\n */\r\nexport class FeatureFlags extends TinyEmitter {\r\n  /**\r\n   * @param {string[]} knownFlags - Test seam. This is a list of known flags\r\n   *   used to catch mistakes where code checks for an obsolete feature flag.\r\n   */\r\n  constructor(knownFlags = annotatorFlags) {\r\n    super();\r\n\r\n    /**\r\n     * Map of flag name to enabled state.\r\n     *\r\n     * @type {Map<string, boolean>}\r\n     */\r\n    this._flags = new Map();\r\n    this._knownFlags = knownFlags;\r\n  }\r\n\r\n  /**\r\n   * Update the stored flags and notify observers via a \"flagsChanged\" event.\r\n   *\r\n   * @param {Record<string, boolean>} flags\r\n   */\r\n  update(flags) {\r\n    this._flags.clear();\r\n    for (let [flag, on] of Object.entries(flags)) {\r\n      this._flags.set(flag, on);\r\n    }\r\n    this.emit('flagsChanged');\r\n  }\r\n\r\n  /**\r\n   * Test if a feature flag is enabled.\r\n   *\r\n   * This will return false if the feature flags have not yet been received from\r\n   * the backend. Code that uses a feature flag should handle subsequent changes\r\n   * to the flag's state by listening for the \"flagsChanged\" event.\r\n   *\r\n   * @param {string} flag\r\n   * @return {boolean}\r\n   */\r\n  flagEnabled(flag) {\r\n    if (!this._knownFlags.includes(flag)) {\r\n      warnOnce('Looked up unknown feature', flag);\r\n      return false;\r\n    }\r\n    return this._flags.get(flag) ?? false;\r\n  }\r\n\r\n  /**\r\n   * Return the state of all feature flags.\r\n   *\r\n   * To test whether an individual flag is enabled, use {@link flagEnabled}\r\n   * instead.\r\n   */\r\n  allFlags() {\r\n    return Object.fromEntries(this._flags);\r\n  }\r\n}\r\n","/**\n * Implementation of Myers' online approximate string matching algorithm [1],\n * with additional optimizations suggested by [2].\n *\n * This has O((k/w) * n) expected-time where `n` is the length of the\n * text, `k` is the maximum number of errors allowed (always <= the pattern\n * length) and `w` is the word size. Because JS only supports bitwise operations\n * on 32 bit integers, `w` is 32.\n *\n * As far as I am aware, there aren't any online algorithms which are\n * significantly better for a wide range of input parameters. The problem can be\n * solved faster using \"filter then verify\" approaches which first filter out\n * regions of the text that cannot match using a \"cheap\" check and then verify\n * the remaining potential matches. The verify step requires an algorithm such\n * as this one however.\n *\n * The algorithm's approach is essentially to optimize the classic dynamic\n * programming solution to the problem by computing columns of the matrix in\n * word-sized chunks (ie. dealing with 32 chars of the pattern at a time) and\n * avoiding calculating regions of the matrix where the minimum error count is\n * guaranteed to exceed the input threshold.\n *\n * The paper consists of two parts, the first describes the core algorithm for\n * matching patterns <= the size of a word (implemented by `advanceBlock` here).\n * The second uses the core algorithm as part of a larger block-based algorithm\n * to handle longer patterns.\n *\n * [1] G. Myers, “A Fast Bit-Vector Algorithm for Approximate String Matching\n * Based on Dynamic Programming,” vol. 46, no. 3, pp. 395–415, 1999.\n *\n * [2] Šošić, M. (2014). An simd dynamic programming c/c++ library (Doctoral\n * dissertation, Fakultet Elektrotehnike i računarstva, Sveučilište u Zagrebu).\n */\nfunction reverse(s) {\n    return s.split(\"\").reverse().join(\"\");\n}\n/**\n * Given the ends of approximate matches for `pattern` in `text`, find\n * the start of the matches.\n *\n * @param findEndFn - Function for finding the end of matches in\n * text.\n * @return Matches with the `start` property set.\n */\nfunction findMatchStarts(text, pattern, matches) {\n    const patRev = reverse(pattern);\n    return matches.map((m) => {\n        // Find start of each match by reversing the pattern and matching segment\n        // of text and searching for an approx match with the same number of\n        // errors.\n        const minStart = Math.max(0, m.end - pattern.length - m.errors);\n        const textRev = reverse(text.slice(minStart, m.end));\n        // If there are multiple possible start points, choose the one that\n        // maximizes the length of the match.\n        const start = findMatchEnds(textRev, patRev, m.errors).reduce((min, rm) => {\n            if (m.end - rm.end < min) {\n                return m.end - rm.end;\n            }\n            return min;\n        }, m.end);\n        return {\n            start,\n            end: m.end,\n            errors: m.errors,\n        };\n    });\n}\n/**\n * Return 1 if a number is non-zero or zero otherwise, without using\n * conditional operators.\n *\n * This should get inlined into `advanceBlock` below by the JIT.\n *\n * Adapted from https://stackoverflow.com/a/3912218/434243\n */\nfunction oneIfNotZero(n) {\n    return ((n | -n) >> 31) & 1;\n}\n/**\n * Block calculation step of the algorithm.\n *\n * From Fig 8. on p. 408 of [1], additionally optimized to replace conditional\n * checks with bitwise operations as per Section 4.2.3 of [2].\n *\n * @param ctx - The pattern context object\n * @param peq - The `peq` array for the current character (`ctx.peq.get(ch)`)\n * @param b - The block level\n * @param hIn - Horizontal input delta ∈ {1,0,-1}\n * @return Horizontal output delta ∈ {1,0,-1}\n */\nfunction advanceBlock(ctx, peq, b, hIn) {\n    let pV = ctx.P[b];\n    let mV = ctx.M[b];\n    const hInIsNegative = hIn >>> 31; // 1 if hIn < 0 or 0 otherwise.\n    const eq = peq[b] | hInIsNegative;\n    // Step 1: Compute horizontal deltas.\n    const xV = eq | mV;\n    const xH = (((eq & pV) + pV) ^ pV) | eq;\n    let pH = mV | ~(xH | pV);\n    let mH = pV & xH;\n    // Step 2: Update score (value of last row of this block).\n    const hOut = oneIfNotZero(pH & ctx.lastRowMask[b]) -\n        oneIfNotZero(mH & ctx.lastRowMask[b]);\n    // Step 3: Update vertical deltas for use when processing next char.\n    pH <<= 1;\n    mH <<= 1;\n    mH |= hInIsNegative;\n    pH |= oneIfNotZero(hIn) - hInIsNegative; // set pH[0] if hIn > 0\n    pV = mH | ~(xV | pH);\n    mV = pH & xV;\n    ctx.P[b] = pV;\n    ctx.M[b] = mV;\n    return hOut;\n}\n/**\n * Find the ends and error counts for matches of `pattern` in `text`.\n *\n * Only the matches with the lowest error count are reported. Other matches\n * with error counts <= maxErrors are discarded.\n *\n * This is the block-based search algorithm from Fig. 9 on p.410 of [1].\n */\nfunction findMatchEnds(text, pattern, maxErrors) {\n    if (pattern.length === 0) {\n        return [];\n    }\n    // Clamp error count so we can rely on the `maxErrors` and `pattern.length`\n    // rows being in the same block below.\n    maxErrors = Math.min(maxErrors, pattern.length);\n    const matches = [];\n    // Word size.\n    const w = 32;\n    // Index of maximum block level.\n    const bMax = Math.ceil(pattern.length / w) - 1;\n    // Context used across block calculations.\n    const ctx = {\n        P: new Uint32Array(bMax + 1),\n        M: new Uint32Array(bMax + 1),\n        lastRowMask: new Uint32Array(bMax + 1),\n    };\n    ctx.lastRowMask.fill(1 << 31);\n    ctx.lastRowMask[bMax] = 1 << (pattern.length - 1) % w;\n    // Dummy \"peq\" array for chars in the text which do not occur in the pattern.\n    const emptyPeq = new Uint32Array(bMax + 1);\n    // Map of UTF-16 character code to bit vector indicating positions in the\n    // pattern that equal that character.\n    const peq = new Map();\n    // Version of `peq` that only stores mappings for small characters. This\n    // allows faster lookups when iterating through the text because a simple\n    // array lookup can be done instead of a hash table lookup.\n    const asciiPeq = [];\n    for (let i = 0; i < 256; i++) {\n        asciiPeq.push(emptyPeq);\n    }\n    // Calculate `ctx.peq` - a map of character values to bitmasks indicating\n    // positions of that character within the pattern, where each bit represents\n    // a position in the pattern.\n    for (let c = 0; c < pattern.length; c += 1) {\n        const val = pattern.charCodeAt(c);\n        if (peq.has(val)) {\n            // Duplicate char in pattern.\n            continue;\n        }\n        const charPeq = new Uint32Array(bMax + 1);\n        peq.set(val, charPeq);\n        if (val < asciiPeq.length) {\n            asciiPeq[val] = charPeq;\n        }\n        for (let b = 0; b <= bMax; b += 1) {\n            charPeq[b] = 0;\n            // Set all the bits where the pattern matches the current char (ch).\n            // For indexes beyond the end of the pattern, always set the bit as if the\n            // pattern contained a wildcard char in that position.\n            for (let r = 0; r < w; r += 1) {\n                const idx = b * w + r;\n                if (idx >= pattern.length) {\n                    continue;\n                }\n                const match = pattern.charCodeAt(idx) === val;\n                if (match) {\n                    charPeq[b] |= 1 << r;\n                }\n            }\n        }\n    }\n    // Index of last-active block level in the column.\n    let y = Math.max(0, Math.ceil(maxErrors / w) - 1);\n    // Initialize maximum error count at bottom of each block.\n    const score = new Uint32Array(bMax + 1);\n    for (let b = 0; b <= y; b += 1) {\n        score[b] = (b + 1) * w;\n    }\n    score[bMax] = pattern.length;\n    // Initialize vertical deltas for each block.\n    for (let b = 0; b <= y; b += 1) {\n        ctx.P[b] = ~0;\n        ctx.M[b] = 0;\n    }\n    // Process each char of the text, computing the error count for `w` chars of\n    // the pattern at a time.\n    for (let j = 0; j < text.length; j += 1) {\n        // Lookup the bitmask representing the positions of the current char from\n        // the text within the pattern.\n        const charCode = text.charCodeAt(j);\n        let charPeq;\n        if (charCode < asciiPeq.length) {\n            // Fast array lookup.\n            charPeq = asciiPeq[charCode];\n        }\n        else {\n            // Slower hash table lookup.\n            charPeq = peq.get(charCode);\n            if (typeof charPeq === \"undefined\") {\n                charPeq = emptyPeq;\n            }\n        }\n        // Calculate error count for blocks that we definitely have to process for\n        // this column.\n        let carry = 0;\n        for (let b = 0; b <= y; b += 1) {\n            carry = advanceBlock(ctx, charPeq, b, carry);\n            score[b] += carry;\n        }\n        // Check if we also need to compute an additional block, or if we can reduce\n        // the number of blocks processed for the next column.\n        if (score[y] - carry <= maxErrors &&\n            y < bMax &&\n            (charPeq[y + 1] & 1 || carry < 0)) {\n            // Error count for bottom block is under threshold, increase the number of\n            // blocks processed for this column & next by 1.\n            y += 1;\n            ctx.P[y] = ~0;\n            ctx.M[y] = 0;\n            let maxBlockScore;\n            if (y === bMax) {\n                const remainder = pattern.length % w;\n                maxBlockScore = remainder === 0 ? w : remainder;\n            }\n            else {\n                maxBlockScore = w;\n            }\n            score[y] =\n                score[y - 1] +\n                    maxBlockScore -\n                    carry +\n                    advanceBlock(ctx, charPeq, y, carry);\n        }\n        else {\n            // Error count for bottom block exceeds threshold, reduce the number of\n            // blocks processed for the next column.\n            while (y > 0 && score[y] >= maxErrors + w) {\n                y -= 1;\n            }\n        }\n        // If error count is under threshold, report a match.\n        if (y === bMax && score[y] <= maxErrors) {\n            if (score[y] < maxErrors) {\n                // Discard any earlier, worse matches.\n                matches.splice(0, matches.length);\n            }\n            matches.push({\n                start: -1,\n                end: j + 1,\n                errors: score[y],\n            });\n            // Because `search` only reports the matches with the lowest error count,\n            // we can \"ratchet down\" the max error threshold whenever a match is\n            // encountered and thereby save a small amount of work for the remainder\n            // of the text.\n            maxErrors = score[y];\n        }\n    }\n    return matches;\n}\n/**\n * Search for matches for `pattern` in `text` allowing up to `maxErrors` errors.\n *\n * Returns the start, and end positions and error counts for each lowest-cost\n * match. Only the \"best\" matches are returned.\n */\nexport default function search(text, pattern, maxErrors) {\n    const matches = findMatchEnds(text, pattern, maxErrors);\n    return findMatchStarts(text, pattern, matches);\n}\n","import approxSearch from 'approx-string-match';\r\n\r\n/**\r\n * @typedef {import('approx-string-match').Match} StringMatch\r\n */\r\n\r\n/**\r\n * @typedef Match\r\n * @prop {number} start - Start offset of match in text\r\n * @prop {number} end - End offset of match in text\r\n * @prop {number} score -\r\n *   Score for the match between 0 and 1.0, where 1.0 indicates a perfect match\r\n *   for the quote and context.\r\n */\r\n\r\n/**\r\n * Find the best approximate matches for `str` in `text` allowing up to `maxErrors` errors.\r\n *\r\n * @param {string} text\r\n * @param {string} str\r\n * @param {number} maxErrors\r\n * @return {StringMatch[]}\r\n */\r\nfunction search(text, str, maxErrors) {\r\n  // Do a fast search for exact matches. The `approx-string-match` library\r\n  // doesn't currently incorporate this optimization itself.\r\n  let matchPos = 0;\r\n  let exactMatches = [];\r\n  while (matchPos !== -1) {\r\n    matchPos = text.indexOf(str, matchPos);\r\n    if (matchPos !== -1) {\r\n      exactMatches.push({\r\n        start: matchPos,\r\n        end: matchPos + str.length,\r\n        errors: 0,\r\n      });\r\n      matchPos += 1;\r\n    }\r\n  }\r\n  if (exactMatches.length > 0) {\r\n    return exactMatches;\r\n  }\r\n\r\n  // If there are no exact matches, do a more expensive search for matches\r\n  // with errors.\r\n  return approxSearch(text, str, maxErrors);\r\n}\r\n\r\n/**\r\n * Compute a score between 0 and 1.0 for the similarity between `text` and `str`.\r\n *\r\n * @param {string} text\r\n * @param {string} str\r\n */\r\nfunction textMatchScore(text, str) {\r\n  // `search` will return no matches if either the text or pattern is empty,\r\n  // otherwise it will return at least one match if the max allowed error count\r\n  // is at least `str.length`.\r\n  if (str.length === 0 || text.length === 0) {\r\n    return 0.0;\r\n  }\r\n\r\n  const matches = search(text, str, str.length);\r\n\r\n  // prettier-ignore\r\n  return 1 - (matches[0].errors / str.length);\r\n}\r\n\r\n/**\r\n * Find the best approximate match for `quote` in `text`.\r\n *\r\n * Returns `null` if no match exceeding the minimum quality threshold was found.\r\n *\r\n * @param {string} text - Document text to search\r\n * @param {string} quote - String to find within `text`\r\n * @param {object} context -\r\n *   Context in which the quote originally appeared. This is used to choose the\r\n *   best match.\r\n *   @param {string} [context.prefix] - Expected text before the quote\r\n *   @param {string} [context.suffix] - Expected text after the quote\r\n *   @param {number} [context.hint] - Expected offset of match within text\r\n * @return {Match|null}\r\n */\r\nexport function matchQuote(text, quote, context = {}) {\r\n  if (quote.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  // Choose the maximum number of errors to allow for the initial search.\r\n  // This choice involves a tradeoff between:\r\n  //\r\n  //  - Recall (proportion of \"good\" matches found)\r\n  //  - Precision (proportion of matches found which are \"good\")\r\n  //  - Cost of the initial search and of processing the candidate matches [1]\r\n  //\r\n  // [1] Specifically, the expected-time complexity of the initial search is\r\n  //     `O((maxErrors / 32) * text.length)`. See `approx-string-match` docs.\r\n  const maxErrors = Math.min(256, quote.length / 2);\r\n\r\n  // Find closest matches for `quote` in `text` based on edit distance.\r\n  const matches = search(text, quote, maxErrors);\r\n\r\n  if (matches.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Compute a score between 0 and 1.0 for a match candidate.\r\n   *\r\n   * @param {StringMatch} match\r\n   */\r\n  const scoreMatch = match => {\r\n    const quoteWeight = 50; // Similarity of matched text to quote.\r\n    const prefixWeight = 20; // Similarity of text before matched text to `context.prefix`.\r\n    const suffixWeight = 20; // Similarity of text after matched text to `context.suffix`.\r\n    const posWeight = 2; // Proximity to expected location. Used as a tie-breaker.\r\n\r\n    const quoteScore = 1 - match.errors / quote.length;\r\n\r\n    const prefixScore = context.prefix\r\n      ? textMatchScore(\r\n          text.slice(\r\n            Math.max(0, match.start - context.prefix.length),\r\n            match.start\r\n          ),\r\n          context.prefix\r\n        )\r\n      : 1.0;\r\n    const suffixScore = context.suffix\r\n      ? textMatchScore(\r\n          text.slice(match.end, match.end + context.suffix.length),\r\n          context.suffix\r\n        )\r\n      : 1.0;\r\n\r\n    let posScore = 1.0;\r\n    if (typeof context.hint === 'number') {\r\n      const offset = Math.abs(match.start - context.hint);\r\n      posScore = 1.0 - offset / text.length;\r\n    }\r\n\r\n    const rawScore =\r\n      quoteWeight * quoteScore +\r\n      prefixWeight * prefixScore +\r\n      suffixWeight * suffixScore +\r\n      posWeight * posScore;\r\n    const maxScore = quoteWeight + prefixWeight + suffixWeight + posWeight;\r\n    const normalizedScore = rawScore / maxScore;\r\n\r\n    return normalizedScore;\r\n  };\r\n\r\n  // Rank matches based on similarity of actual and expected surrounding text\r\n  // and actual/expected offset in the document text.\r\n  const scoredMatches = matches.map(m => ({\r\n    start: m.start,\r\n    end: m.end,\r\n    score: scoreMatch(m),\r\n  }));\r\n\r\n  // Choose match with highest score.\r\n  scoredMatches.sort((a, b) => b.score - a.score);\r\n  return scoredMatches[0];\r\n}\r\n","/**\r\n * Get the node name for use in generating an xpath expression.\r\n *\r\n * @param {Node} node\r\n */\r\nfunction getNodeName(node) {\r\n  const nodeName = node.nodeName.toLowerCase();\r\n  let result = nodeName;\r\n  if (nodeName === '#text') {\r\n    result = 'text()';\r\n  }\r\n  return result;\r\n}\r\n\r\n/**\r\n * Get the index of the node as it appears in its parent's child list\r\n *\r\n * @param {Node} node\r\n */\r\nfunction getNodePosition(node) {\r\n  let pos = 0;\r\n  /** @type {Node|null} */\r\n  let tmp = node;\r\n  while (tmp) {\r\n    if (tmp.nodeName === node.nodeName) {\r\n      pos += 1;\r\n    }\r\n    tmp = tmp.previousSibling;\r\n  }\r\n  return pos;\r\n}\r\n\r\n/** @param {Node} node */\r\nfunction getPathSegment(node) {\r\n  const name = getNodeName(node);\r\n  const pos = getNodePosition(node);\r\n  return `${name}[${pos}]`;\r\n}\r\n\r\n/**\r\n * A simple XPath generator which can generate XPaths of the form\r\n * /tag[index]/tag[index].\r\n *\r\n * @param {Node} node - The node to generate a path to\r\n * @param {Node} root - Root node to which the returned path is relative\r\n */\r\nexport function xpathFromNode(node, root) {\r\n  let xpath = '';\r\n\r\n  /** @type {Node|null} */\r\n  let elem = node;\r\n  while (elem !== root) {\r\n    if (!elem) {\r\n      throw new Error('Node is not a descendant of root');\r\n    }\r\n    xpath = getPathSegment(elem) + '/' + xpath;\r\n    elem = elem.parentNode;\r\n  }\r\n  xpath = '/' + xpath;\r\n  xpath = xpath.replace(/\\/$/, ''); // Remove trailing slash\r\n\r\n  return xpath;\r\n}\r\n\r\n/**\r\n * Return the `index`'th immediate child of `element` whose tag name is\r\n * `nodeName` (case insensitive).\r\n *\r\n * @param {Element} element\r\n * @param {string} nodeName\r\n * @param {number} index\r\n */\r\nfunction nthChildOfType(element, nodeName, index) {\r\n  nodeName = nodeName.toUpperCase();\r\n\r\n  let matchIndex = -1;\r\n  for (let i = 0; i < element.children.length; i++) {\r\n    const child = element.children[i];\r\n    if (child.nodeName.toUpperCase() === nodeName) {\r\n      ++matchIndex;\r\n      if (matchIndex === index) {\r\n        return child;\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Evaluate a _simple XPath_ relative to a `root` element and return the\r\n * matching element.\r\n *\r\n * A _simple XPath_ is a sequence of one or more `/tagName[index]` strings.\r\n *\r\n * Unlike `document.evaluate` this function:\r\n *\r\n *  - Only supports simple XPaths\r\n *  - Is not affected by the document's _type_ (HTML or XML/XHTML)\r\n *  - Ignores element namespaces when matching element names in the XPath against\r\n *    elements in the DOM tree\r\n *  - Is case insensitive for all elements, not just HTML elements\r\n *\r\n * The matching element is returned or `null` if no such element is found.\r\n * An error is thrown if `xpath` is not a simple XPath.\r\n *\r\n * @param {string} xpath\r\n * @param {Element} root\r\n * @return {Element|null}\r\n */\r\nfunction evaluateSimpleXPath(xpath, root) {\r\n  const isSimpleXPath =\r\n    xpath.match(/^(\\/[A-Za-z0-9-]+(\\[[0-9]+\\])?)+$/) !== null;\r\n  if (!isSimpleXPath) {\r\n    throw new Error('Expression is not a simple XPath');\r\n  }\r\n\r\n  const segments = xpath.split('/');\r\n  let element = root;\r\n\r\n  // Remove leading empty segment. The regex above validates that the XPath\r\n  // has at least two segments, with the first being empty and the others non-empty.\r\n  segments.shift();\r\n\r\n  for (let segment of segments) {\r\n    let elementName;\r\n    let elementIndex;\r\n\r\n    const separatorPos = segment.indexOf('[');\r\n    if (separatorPos !== -1) {\r\n      elementName = segment.slice(0, separatorPos);\r\n\r\n      const indexStr = segment.slice(separatorPos + 1, segment.indexOf(']'));\r\n      elementIndex = parseInt(indexStr) - 1;\r\n      if (elementIndex < 0) {\r\n        return null;\r\n      }\r\n    } else {\r\n      elementName = segment;\r\n      elementIndex = 0;\r\n    }\r\n\r\n    const child = nthChildOfType(element, elementName, elementIndex);\r\n    if (!child) {\r\n      return null;\r\n    }\r\n\r\n    element = child;\r\n  }\r\n\r\n  return element;\r\n}\r\n\r\n/**\r\n * Finds an element node using an XPath relative to `root`\r\n *\r\n * Example:\r\n *   node = nodeFromXPath('/main/article[1]/p[3]', document.body)\r\n *\r\n * @param {string} xpath\r\n * @param {Element} [root]\r\n * @return {Node|null}\r\n */\r\nexport function nodeFromXPath(xpath, root = document.body) {\r\n  try {\r\n    return evaluateSimpleXPath(xpath, root);\r\n  } catch (err) {\r\n    return document.evaluate(\r\n      '.' + xpath,\r\n      root,\r\n\r\n      // nb. The `namespaceResolver` and `result` arguments are optional in the spec\r\n      // but required in Edge Legacy.\r\n      null /* namespaceResolver */,\r\n      XPathResult.FIRST_ORDERED_NODE_TYPE,\r\n      null /* result */\r\n    ).singleNodeValue;\r\n  }\r\n}\r\n","/**\r\n * This module exports a set of classes for converting between DOM `Range`\r\n * objects and different types of selectors. It is mostly a thin wrapper around a\r\n * set of anchoring libraries. It serves two main purposes:\r\n *\r\n *  1. Providing a consistent interface across different types of anchors.\r\n *  2. Insulating the rest of the code from API changes in the underlying anchoring\r\n *     libraries.\r\n */\r\n\r\nimport { matchQuote } from './match-quote';\r\nimport { TextRange, TextPosition } from './text-range';\r\nimport { nodeFromXPath, xpathFromNode } from './xpath';\r\n\r\n/**\r\n * @typedef {import('../../types/api').RangeSelector} RangeSelector\r\n * @typedef {import('../../types/api').TextPositionSelector} TextPositionSelector\r\n * @typedef {import('../../types/api').TextQuoteSelector} TextQuoteSelector\r\n */\r\n\r\n/**\r\n * Converts between `RangeSelector` selectors and `Range` objects.\r\n */\r\nexport class RangeAnchor {\r\n  /**\r\n   * @param {Node} root - A root element from which to anchor.\r\n   * @param {Range} range -  A range describing the anchor.\r\n   */\r\n  constructor(root, range) {\r\n    this.root = root;\r\n    this.range = range;\r\n  }\r\n\r\n  /**\r\n   * @param {Node} root -  A root element from which to anchor.\r\n   * @param {Range} range -  A range describing the anchor.\r\n   */\r\n  static fromRange(root, range) {\r\n    return new RangeAnchor(root, range);\r\n  }\r\n\r\n  /**\r\n   * Create an anchor from a serialized `RangeSelector` selector.\r\n   *\r\n   * @param {Element} root -  A root element from which to anchor.\r\n   * @param {RangeSelector} selector\r\n   */\r\n  static fromSelector(root, selector) {\r\n    const startContainer = nodeFromXPath(selector.startContainer, root);\r\n    if (!startContainer) {\r\n      throw new Error('Failed to resolve startContainer XPath');\r\n    }\r\n\r\n    const endContainer = nodeFromXPath(selector.endContainer, root);\r\n    if (!endContainer) {\r\n      throw new Error('Failed to resolve endContainer XPath');\r\n    }\r\n\r\n    const startPos = TextPosition.fromCharOffset(\r\n      startContainer,\r\n      selector.startOffset\r\n    );\r\n    const endPos = TextPosition.fromCharOffset(\r\n      endContainer,\r\n      selector.endOffset\r\n    );\r\n\r\n    const range = new TextRange(startPos, endPos).toRange();\r\n    return new RangeAnchor(root, range);\r\n  }\r\n\r\n  toRange() {\r\n    return this.range;\r\n  }\r\n\r\n  /**\r\n   * @return {RangeSelector}\r\n   */\r\n  toSelector() {\r\n    // \"Shrink\" the range so that it tightly wraps its text. This ensures more\r\n    // predictable output for a given text selection.\r\n    const normalizedRange = TextRange.fromRange(this.range).toRange();\r\n\r\n    const textRange = TextRange.fromRange(normalizedRange);\r\n    const startContainer = xpathFromNode(textRange.start.element, this.root);\r\n    const endContainer = xpathFromNode(textRange.end.element, this.root);\r\n\r\n    return {\r\n      type: 'RangeSelector',\r\n      startContainer,\r\n      startOffset: textRange.start.offset,\r\n      endContainer,\r\n      endOffset: textRange.end.offset,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Converts between `TextPositionSelector` selectors and `Range` objects.\r\n */\r\nexport class TextPositionAnchor {\r\n  /**\r\n   * @param {Element} root\r\n   * @param {number} start\r\n   * @param {number} end\r\n   */\r\n  constructor(root, start, end) {\r\n    this.root = root;\r\n    this.start = start;\r\n    this.end = end;\r\n  }\r\n\r\n  /**\r\n   * @param {Element} root\r\n   * @param {Range} range\r\n   */\r\n  static fromRange(root, range) {\r\n    const textRange = TextRange.fromRange(range).relativeTo(root);\r\n    return new TextPositionAnchor(\r\n      root,\r\n      textRange.start.offset,\r\n      textRange.end.offset\r\n    );\r\n  }\r\n  /**\r\n   * @param {Element} root\r\n   * @param {TextPositionSelector} selector\r\n   */\r\n  static fromSelector(root, selector) {\r\n    return new TextPositionAnchor(root, selector.start, selector.end);\r\n  }\r\n\r\n  /**\r\n   * @return {TextPositionSelector}\r\n   */\r\n  toSelector() {\r\n    return {\r\n      type: 'TextPositionSelector',\r\n      start: this.start,\r\n      end: this.end,\r\n    };\r\n  }\r\n\r\n  toRange() {\r\n    return TextRange.fromOffsets(this.root, this.start, this.end).toRange();\r\n  }\r\n}\r\n\r\n/**\r\n * @typedef QuoteMatchOptions\r\n * @prop {number} [hint] - Expected position of match in text. See `matchQuote`.\r\n */\r\n\r\n/**\r\n * Converts between `TextQuoteSelector` selectors and `Range` objects.\r\n */\r\nexport class TextQuoteAnchor {\r\n  /**\r\n   * @param {Element} root - A root element from which to anchor.\r\n   * @param {string} exact\r\n   * @param {object} context\r\n   *   @param {string} [context.prefix]\r\n   *   @param {string} [context.suffix]\r\n   */\r\n  constructor(root, exact, context = {}) {\r\n    this.root = root;\r\n    this.exact = exact;\r\n    this.context = context;\r\n  }\r\n\r\n  /**\r\n   * Create a `TextQuoteAnchor` from a range.\r\n   *\r\n   * Will throw if `range` does not contain any text nodes.\r\n   *\r\n   * @param {Element} root\r\n   * @param {Range} range\r\n   */\r\n  static fromRange(root, range) {\r\n    const text = /** @type {string} */ (root.textContent);\r\n    const textRange = TextRange.fromRange(range).relativeTo(root);\r\n\r\n    const start = textRange.start.offset;\r\n    const end = textRange.end.offset;\r\n\r\n    // Number of characters around the quote to capture as context. We currently\r\n    // always use a fixed amount, but it would be better if this code was aware\r\n    // of logical boundaries in the document (paragraph, article etc.) to avoid\r\n    // capturing text unrelated to the quote.\r\n    //\r\n    // In regular prose the ideal content would often be the surrounding sentence.\r\n    // This is a natural unit of meaning which enables displaying quotes in\r\n    // context even when the document is not available. We could use `Intl.Segmenter`\r\n    // for this when available.\r\n    const contextLen = 32;\r\n\r\n    return new TextQuoteAnchor(root, text.slice(start, end), {\r\n      prefix: text.slice(Math.max(0, start - contextLen), start),\r\n      suffix: text.slice(end, Math.min(text.length, end + contextLen)),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {Element} root\r\n   * @param {TextQuoteSelector} selector\r\n   */\r\n  static fromSelector(root, selector) {\r\n    const { prefix, suffix } = selector;\r\n    return new TextQuoteAnchor(root, selector.exact, { prefix, suffix });\r\n  }\r\n\r\n  /**\r\n   * @return {TextQuoteSelector}\r\n   */\r\n  toSelector() {\r\n    return {\r\n      type: 'TextQuoteSelector',\r\n      exact: this.exact,\r\n      prefix: this.context.prefix,\r\n      suffix: this.context.suffix,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * @param {QuoteMatchOptions} [options]\r\n   */\r\n  toRange(options = {}) {\r\n    return this.toPositionAnchor(options).toRange();\r\n  }\r\n\r\n  /**\r\n   * @param {QuoteMatchOptions} [options]\r\n   */\r\n  toPositionAnchor(options = {}) {\r\n    const text = /** @type {string} */ (this.root.textContent);\r\n    const match = matchQuote(text, this.exact, {\r\n      ...this.context,\r\n      hint: options.hint,\r\n    });\r\n    if (!match) {\r\n      throw new Error('Quote not found');\r\n    }\r\n    return new TextPositionAnchor(this.root, match.start, match.end);\r\n  }\r\n}\r\n","import { RangeAnchor, TextPositionAnchor, TextQuoteAnchor } from './types';\r\n\r\n/**\r\n * @typedef {import('../../types/api').RangeSelector} RangeSelector\r\n * @typedef {import('../../types/api').Selector} Selector\r\n * @typedef {import('../../types/api').TextPositionSelector} TextPositionSelector\r\n * @typedef {import('../../types/api').TextQuoteSelector} TextQuoteSelector\r\n */\r\n\r\n/**\r\n * @param {RangeAnchor|TextPositionAnchor|TextQuoteAnchor} anchor\r\n * @param {object} [options]\r\n *  @param {number} [options.hint]\r\n */\r\nasync function querySelector(anchor, options = {}) {\r\n  return anchor.toRange(options);\r\n}\r\n\r\n/**\r\n * Anchor a set of selectors.\r\n *\r\n * This function converts a set of selectors into a document range.\r\n * It encapsulates the core anchoring algorithm, using the selectors alone or\r\n * in combination to establish the best anchor within the document.\r\n *\r\n * @param {Element} root - The root element of the anchoring context.\r\n * @param {Selector[]} selectors - The selectors to try.\r\n * @param {object} [options]\r\n *   @param {number} [options.hint]\r\n */\r\nexport function anchor(root, selectors, options = {}) {\r\n  let position = /** @type {TextPositionSelector|null} */ (null);\r\n  let quote = /** @type {TextQuoteSelector|null} */ (null);\r\n  let range = /** @type {RangeSelector|null} */ (null);\r\n\r\n  // Collect all the selectors\r\n  for (let selector of selectors) {\r\n    switch (selector.type) {\r\n      case 'TextPositionSelector':\r\n        position = selector;\r\n        options.hint = position.start; // TextQuoteAnchor hint\r\n        break;\r\n      case 'TextQuoteSelector':\r\n        quote = selector;\r\n        break;\r\n      case 'RangeSelector':\r\n        range = selector;\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Assert the quote matches the stored quote, if applicable\r\n   * @param {Range} range\r\n   */\r\n  const maybeAssertQuote = range => {\r\n    if (quote?.exact && range.toString() !== quote.exact) {\r\n      throw new Error('quote mismatch');\r\n    } else {\r\n      return range;\r\n    }\r\n  };\r\n\r\n  // From a default of failure, we build up catch clauses to try selectors in\r\n  // order, from simple to complex.\r\n  /** @type {Promise<Range>} */\r\n  let promise = Promise.reject('unable to anchor');\r\n\r\n  if (range) {\r\n    // Const binding assures TS that it won't be re-assigned when callback runs.\r\n    const range_ = range;\r\n    promise = promise.catch(() => {\r\n      let anchor = RangeAnchor.fromSelector(root, range_);\r\n      return querySelector(anchor, options).then(maybeAssertQuote);\r\n    });\r\n  }\r\n\r\n  if (position) {\r\n    const position_ = position;\r\n    promise = promise.catch(() => {\r\n      let anchor = TextPositionAnchor.fromSelector(root, position_);\r\n      return querySelector(anchor, options).then(maybeAssertQuote);\r\n    });\r\n  }\r\n\r\n  if (quote) {\r\n    const quote_ = quote;\r\n    promise = promise.catch(() => {\r\n      let anchor = TextQuoteAnchor.fromSelector(root, quote_);\r\n      return querySelector(anchor, options);\r\n    });\r\n  }\r\n\r\n  return promise;\r\n}\r\n\r\n/**\r\n * @param {Element} root\r\n * @param {Range} range\r\n */\r\nexport function describe(root, range) {\r\n  const types = [RangeAnchor, TextPositionAnchor, TextQuoteAnchor];\r\n  const result = [];\r\n  for (let type of types) {\r\n    try {\r\n      const anchor = type.fromRange(root, range);\r\n      result.push(anchor.toSelector());\r\n    } catch (error) {\r\n      continue;\r\n    }\r\n  }\r\n  return result;\r\n}\r\n","/**\r\n * Return a normalized version of a URI.\r\n *\r\n * This makes it absolute and strips the fragment identifier.\r\n *\r\n * @param {string} uri - Relative or absolute URL\r\n * @param {string} [base] - Base URL to resolve relative to. Defaults to\r\n *   the document's base URL.\r\n */\r\nexport function normalizeURI(uri, base = document.baseURI) {\r\n  const absUrl = new URL(uri, base).href;\r\n\r\n  // Remove the fragment identifier.\r\n  // This is done on the serialized URL rather than modifying `url.hash` due to\r\n  // a bug in Safari.\r\n  // See https://github.com/hypothesis/h/issues/3471#issuecomment-226713750\r\n  return absUrl.toString().replace(/#.*/, '');\r\n}\r\n","/*\r\n ** Adapted from:\r\n ** https://github.com/openannotation/annotator/blob/v1.2.x/src/plugin/document.coffee\r\n **\r\n ** Annotator v1.2.10\r\n ** https://github.com/openannotation/annotator\r\n **\r\n ** Copyright 2015, the Annotator project contributors.\r\n ** Dual licensed under the MIT and GPLv3 licenses.\r\n ** https://github.com/openannotation/annotator/blob/master/LICENSE\r\n */\r\n\r\n/**\r\n * nb. The `DocumentMetadata` type is renamed to avoid a conflict with the\r\n * `DocumentMetadata` class below.\r\n *\r\n * @typedef {import('../../types/annotator').DocumentMetadata} Metadata\r\n */\r\n\r\nimport { normalizeURI } from '../util/url';\r\n\r\n/**\r\n * @typedef Link\r\n * @prop {string} link.href\r\n * @prop {string} [link.rel]\r\n * @prop {string} [link.type]\r\n */\r\n\r\n/**\r\n * Extension of the `Metadata` type with non-optional fields for `dc`, `eprints` etc.\r\n *\r\n * @typedef HTMLDocumentMetadata\r\n * @prop {string} title\r\n * @prop {Link[]} link\r\n * @prop {Record<string, string[]>} dc\r\n * @prop {Record<string, string[]>} eprints\r\n * @prop {Record<string, string[]>} facebook\r\n * @prop {Record<string, string[]>} highwire\r\n * @prop {Record<string, string[]>} prism\r\n * @prop {Record<string, string[]>} twitter\r\n * @prop {string} [favicon]\r\n * @prop {string} [documentFingerprint]\r\n */\r\n\r\n/**\r\n * HTMLMetadata reads metadata/links from the current HTML document.\r\n */\r\nexport class HTMLMetadata {\r\n  /**\r\n   * @param {object} [options]\r\n   *   @param {Document} [options.document]\r\n   */\r\n  constructor(options = {}) {\r\n    this.document = options.document || document;\r\n  }\r\n\r\n  /**\r\n   * Returns the primary URI for the document being annotated\r\n   *\r\n   * @return {string}\r\n   */\r\n  uri() {\r\n    let uri = decodeURIComponent(this._getDocumentHref());\r\n\r\n    // Use the `link[rel=canonical]` element's href as the URL if present.\r\n    const links = this._getLinks();\r\n    for (let link of links) {\r\n      if (link.rel === 'canonical') {\r\n        uri = link.href;\r\n      }\r\n    }\r\n\r\n    return uri;\r\n  }\r\n\r\n  /**\r\n   * Return metadata for the current page.\r\n   *\r\n   * @return {HTMLDocumentMetadata}\r\n   */\r\n  getDocumentMetadata() {\r\n    /** @type {HTMLDocumentMetadata} */\r\n    const metadata = {\r\n      title: document.title,\r\n      link: [],\r\n\r\n      dc: this._getMetaTags('name', 'dc.'),\r\n      eprints: this._getMetaTags('name', 'eprints.'),\r\n      facebook: this._getMetaTags('property', 'og:'),\r\n      highwire: this._getMetaTags('name', 'citation_'),\r\n      prism: this._getMetaTags('name', 'prism.'),\r\n      twitter: this._getMetaTags('name', 'twitter:'),\r\n    };\r\n\r\n    const favicon = this._getFavicon();\r\n    if (favicon) {\r\n      metadata.favicon = favicon;\r\n    }\r\n\r\n    metadata.title = this._getTitle(metadata);\r\n    metadata.link = this._getLinks(metadata);\r\n\r\n    const dcLink = metadata.link.find(link => link.href.startsWith('urn:x-dc'));\r\n    if (dcLink) {\r\n      metadata.documentFingerprint = dcLink.href;\r\n    }\r\n\r\n    return metadata;\r\n  }\r\n\r\n  /**\r\n   * Return an array of all the `content` values of `<meta>` tags on the page\r\n   * where the value of the attribute begins with `<prefix>`.\r\n   *\r\n   * @param {string} attribute\r\n   * @param {string} prefix - it is interpreted as a regex\r\n   * @return {Record<string,string[]>}\r\n   */\r\n  _getMetaTags(attribute, prefix) {\r\n    /** @type {Record<string,string[]>} */\r\n    const tags = {};\r\n    for (let meta of Array.from(this.document.querySelectorAll('meta'))) {\r\n      const name = meta.getAttribute(attribute);\r\n      const { content } = meta;\r\n      if (name && content) {\r\n        const match = name.match(RegExp(`^${prefix}(.+)$`, 'i'));\r\n        if (match) {\r\n          const key = match[1].toLowerCase();\r\n          if (tags[key]) {\r\n            tags[key].push(content);\r\n          } else {\r\n            tags[key] = [content];\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return tags;\r\n  }\r\n\r\n  /** @param {HTMLDocumentMetadata} metadata */\r\n  _getTitle(metadata) {\r\n    if (metadata.highwire.title) {\r\n      return metadata.highwire.title[0];\r\n    } else if (metadata.eprints.title) {\r\n      return metadata.eprints.title[0];\r\n    } else if (metadata.prism.title) {\r\n      return metadata.prism.title[0];\r\n    } else if (metadata.facebook.title) {\r\n      return metadata.facebook.title[0];\r\n    } else if (metadata.twitter.title) {\r\n      return metadata.twitter.title[0];\r\n    } else if (metadata.dc.title) {\r\n      return metadata.dc.title[0];\r\n    } else {\r\n      return this.document.title;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get document URIs from `<link>` and `<meta>` elements on the page.\r\n   *\r\n   * @param {Pick<HTMLDocumentMetadata, 'highwire'|'dc'>} [metadata] -\r\n   *   Dublin Core and Highwire metadata parsed from `<meta>` tags.\r\n   * @return {Link[]}\r\n   */\r\n  _getLinks(metadata = { dc: {}, highwire: {} }) {\r\n    /** @type {Link[]} */\r\n    const links = [{ href: this._getDocumentHref() }];\r\n\r\n    // Extract links from `<link>` tags with certain `rel` values.\r\n    const linkElements = Array.from(this.document.querySelectorAll('link'));\r\n    for (let link of linkElements) {\r\n      if (\r\n        !['alternate', 'canonical', 'bookmark', 'shortlink'].includes(link.rel)\r\n      ) {\r\n        continue;\r\n      }\r\n\r\n      if (link.rel === 'alternate') {\r\n        // Ignore RSS feed links.\r\n        if (link.type && link.type.match(/^application\\/(rss|atom)\\+xml/)) {\r\n          continue;\r\n        }\r\n        // Ignore alternate languages.\r\n        if (link.hreflang) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      try {\r\n        const href = this._absoluteUrl(link.href);\r\n        links.push({ href, rel: link.rel, type: link.type });\r\n      } catch (e) {\r\n        // Ignore URIs which cannot be parsed.\r\n      }\r\n    }\r\n\r\n    // Look for links in scholar metadata\r\n    for (let name of Object.keys(metadata.highwire)) {\r\n      const values = metadata.highwire[name];\r\n      if (name === 'pdf_url') {\r\n        for (let url of values) {\r\n          try {\r\n            links.push({\r\n              href: this._absoluteUrl(url),\r\n              type: 'application/pdf',\r\n            });\r\n          } catch (e) {\r\n            // Ignore URIs which cannot be parsed.\r\n          }\r\n        }\r\n      }\r\n\r\n      // Kind of a hack to express DOI identifiers as links but it's a\r\n      // convenient place to look them up later, and somewhat sane since\r\n      // they don't have a type.\r\n      if (name === 'doi') {\r\n        for (let doi of values) {\r\n          if (doi.slice(0, 4) !== 'doi:') {\r\n            doi = `doi:${doi}`;\r\n          }\r\n          links.push({ href: doi });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Look for links in Dublin Core data\r\n    for (let name of Object.keys(metadata.dc)) {\r\n      const values = metadata.dc[name];\r\n      if (name === 'identifier') {\r\n        for (let id of values) {\r\n          if (id.slice(0, 4) === 'doi:') {\r\n            links.push({ href: id });\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Look for a link to identify the resource in Dublin Core metadata\r\n    const dcRelationValues = metadata.dc['relation.ispartof'];\r\n    const dcIdentifierValues = metadata.dc.identifier;\r\n    if (dcRelationValues && dcIdentifierValues) {\r\n      const dcUrnRelationComponent =\r\n        dcRelationValues[dcRelationValues.length - 1];\r\n      const dcUrnIdentifierComponent =\r\n        dcIdentifierValues[dcIdentifierValues.length - 1];\r\n      const dcUrn =\r\n        'urn:x-dc:' +\r\n        encodeURIComponent(dcUrnRelationComponent) +\r\n        '/' +\r\n        encodeURIComponent(dcUrnIdentifierComponent);\r\n      links.push({ href: dcUrn });\r\n    }\r\n\r\n    return links;\r\n  }\r\n\r\n  _getFavicon() {\r\n    let favicon = null;\r\n    for (let link of Array.from(this.document.querySelectorAll('link'))) {\r\n      if (['shortcut icon', 'icon'].includes(link.rel)) {\r\n        try {\r\n          favicon = this._absoluteUrl(link.href);\r\n        } catch (e) {\r\n          // Ignore URIs which cannot be parsed.\r\n        }\r\n      }\r\n    }\r\n    return favicon;\r\n  }\r\n\r\n  /**\r\n   * Convert a possibly relative URI to an absolute one. This will throw an\r\n   * exception if the URL cannot be parsed.\r\n   *\r\n   * @param {string} url\r\n   */\r\n  _absoluteUrl(url) {\r\n    return normalizeURI(url, this.document.baseURI);\r\n  }\r\n\r\n  // Get the true URI record when it's masked via a different protocol.\r\n  // This happens when an href is set with a uri using the 'blob:' protocol\r\n  // but the document can set a different uri through a <base> tag.\r\n  _getDocumentHref() {\r\n    const { href } = this.document.location;\r\n    const allowedSchemes = ['http:', 'https:', 'file:'];\r\n\r\n    // Use the current document location if it has a recognized scheme.\r\n    const scheme = new URL(href).protocol;\r\n    if (allowedSchemes.includes(scheme)) {\r\n      return href;\r\n    }\r\n\r\n    // Otherwise, try using the location specified by the <base> element.\r\n    if (\r\n      this.document.baseURI &&\r\n      allowedSchemes.includes(new URL(this.document.baseURI).protocol)\r\n    ) {\r\n      return this.document.baseURI;\r\n    }\r\n\r\n    // Fall back to returning the document URI, even though the scheme is not\r\n    // in the allowed list.\r\n    return href;\r\n  }\r\n}\r\n","/**\r\n * Return the intersection of two rects.\r\n *\r\n * @param {DOMRect} rectA\r\n * @param {DOMRect} rectB\r\n */\r\nexport function intersectRects(rectA, rectB) {\r\n  const left = Math.max(rectA.left, rectB.left);\r\n  const right = Math.min(rectA.right, rectB.right);\r\n  const top = Math.max(rectA.top, rectB.top);\r\n  const bottom = Math.min(rectA.bottom, rectB.bottom);\r\n  return new DOMRect(left, top, right - left, bottom - top);\r\n}\r\n\r\n/**\r\n * Return `true` if a rect is _empty_.\r\n *\r\n * An empty rect is defined as one with zero or negative width/height, eg.\r\n * as returned by `new DOMRect()` or `Element.getBoundingClientRect()` for a\r\n * hidden element.\r\n *\r\n * @param {DOMRect} rect\r\n */\r\nexport function rectIsEmpty(rect) {\r\n  return rect.width <= 0 || rect.height <= 0;\r\n}\r\n\r\n/**\r\n * Return true if the 1D lines a-b and c-d overlap (ie. the length of their\r\n * intersection is non-zero).\r\n *\r\n * For example, the following lines overlap:\r\n *\r\n *   a----b\r\n *      c------d\r\n *\r\n * The inputs must be normalized such that b >= a and d >= c.\r\n *\r\n * @param {number} a\r\n * @param {number} b\r\n * @param {number} c\r\n * @param {number} d\r\n */\r\nfunction linesOverlap(a, b, c, d) {\r\n  const maxStart = Math.max(a, c);\r\n  const minEnd = Math.min(b, d);\r\n  return maxStart < minEnd;\r\n}\r\n\r\n/**\r\n * Return true if the intersection of `rectB` and `rectA` is non-empty.\r\n *\r\n * @param {DOMRect} rectA\r\n * @param {DOMRect} rectB\r\n */\r\nexport function rectIntersects(rectA, rectB) {\r\n  if (rectIsEmpty(rectA) || rectIsEmpty(rectB)) {\r\n    return false;\r\n  }\r\n\r\n  return (\r\n    linesOverlap(rectA.left, rectA.right, rectB.left, rectB.right) &&\r\n    linesOverlap(rectA.top, rectA.bottom, rectB.top, rectB.bottom)\r\n  );\r\n}\r\n\r\n/**\r\n * Return true if `rectB` is fully contained within `rectA`\r\n *\r\n * @param {DOMRect} rectA\r\n * @param {DOMRect} rectB\r\n */\r\nexport function rectContains(rectA, rectB) {\r\n  if (rectIsEmpty(rectA) || rectIsEmpty(rectB)) {\r\n    return false;\r\n  }\r\n\r\n  return (\r\n    rectB.left >= rectA.left &&\r\n    rectB.right <= rectA.right &&\r\n    rectB.top >= rectA.top &&\r\n    rectB.bottom <= rectA.bottom\r\n  );\r\n}\r\n\r\n/**\r\n * Return true if two rects overlap vertically.\r\n *\r\n * @param {DOMRect} a\r\n * @param {DOMRect} b\r\n */\r\nexport function rectsOverlapVertically(a, b) {\r\n  return linesOverlap(a.top, a.bottom, b.top, b.bottom);\r\n}\r\n\r\n/**\r\n * Return true if two rects overlap horizontally.\r\n *\r\n * @param {DOMRect} a\r\n * @param {DOMRect} b\r\n */\r\nexport function rectsOverlapHorizontally(a, b) {\r\n  return linesOverlap(a.left, a.right, b.left, b.right);\r\n}\r\n\r\n/**\r\n * Return the union of two rects.\r\n *\r\n * The union of an empty rect (see {@link rectIsEmpty}) with a non-empty rect is\r\n * defined to be the non-empty rect. The union of two empty rects is an empty\r\n * rect.\r\n *\r\n * @param {DOMRect} a\r\n * @param {DOMRect} b\r\n */\r\nexport function unionRects(a, b) {\r\n  if (rectIsEmpty(a)) {\r\n    return b;\r\n  } else if (rectIsEmpty(b)) {\r\n    return a;\r\n  }\r\n\r\n  const left = Math.min(a.left, b.left);\r\n  const top = Math.min(a.top, b.top);\r\n  const right = Math.max(a.right, b.right);\r\n  const bottom = Math.max(a.bottom, b.bottom);\r\n\r\n  return new DOMRect(left, top, right - left, bottom - top);\r\n}\r\n\r\n/**\r\n * Return the point at the center of a rect.\r\n *\r\n * @param {DOMRect} rect\r\n */\r\nexport function rectCenter(rect) {\r\n  return new DOMPoint(\r\n    (rect.left + rect.right) / 2,\r\n    (rect.top + rect.bottom) / 2\r\n  );\r\n}\r\n","import { rectContains, rectIntersects } from '../util/geometry';\r\n\r\n/**\r\n * CSS selectors used to find elements that are considered potentially part\r\n * of the main content of a page.\r\n */\r\nconst contentSelectors = [\r\n  'p',\r\n\r\n  // Paragraphs in VitalSource \"Great Book\" format ebooks.\r\n  '.para',\r\n];\r\n\r\n/**\r\n * Attempt to guess the region of the page that contains the main content.\r\n *\r\n * @param {Element} root\r\n * @return {{ left: number, right: number }|null} -\r\n *   The left/right content margins or `null` if they could not be determined\r\n */\r\nexport function guessMainContentArea(root) {\r\n  // Maps of (margin X coord, votes) for margin positions.\r\n\r\n  /** @type {Map<number,number>} */\r\n  const leftMarginVotes = new Map();\r\n\r\n  /** @type {Map<number,number>} */\r\n  const rightMarginVotes = new Map();\r\n\r\n  // Gather data about the paragraphs of text in the document.\r\n  //\r\n  // In future we might want to expand this to consider other text containers,\r\n  // since some pages, especially eg. in ebooks, may not have any paragraphs\r\n  // (eg. instead they may only contain tables or lists or headings).\r\n  const contentSelector = contentSelectors.join(',');\r\n  const paragraphs = Array.from(root.querySelectorAll(contentSelector))\r\n    .map(p => {\r\n      // Gather some data about them.\r\n      const rect = p.getBoundingClientRect();\r\n      const textLength = /** @type {string} */ (p.textContent).length;\r\n      return { rect, textLength };\r\n    })\r\n    .filter(({ rect }) => {\r\n      // Filter out hidden paragraphs\r\n      return rect.width > 0 && rect.height > 0;\r\n    })\r\n    // Select the paragraphs containing the most text.\r\n    .sort((a, b) => b.textLength - a.textLength)\r\n    .slice(0, 15);\r\n\r\n  // Let these paragraphs \"vote\" for what the left and right margins of the\r\n  // main content area in the document are.\r\n  paragraphs.forEach(({ rect }) => {\r\n    let leftVotes = leftMarginVotes.get(rect.left) ?? 0;\r\n    leftVotes += 1;\r\n    leftMarginVotes.set(rect.left, leftVotes);\r\n\r\n    let rightVotes = rightMarginVotes.get(rect.right) ?? 0;\r\n    rightVotes += 1;\r\n    rightMarginVotes.set(rect.right, rightVotes);\r\n  });\r\n\r\n  // Find the margin values with the most votes.\r\n  if (leftMarginVotes.size === 0 || rightMarginVotes.size === 0) {\r\n    return null;\r\n  }\r\n\r\n  const leftMargin = [...leftMarginVotes.entries()].sort((a, b) => b[1] - a[1]);\r\n  const rightMargin = [...rightMarginVotes.entries()].sort(\r\n    (a, b) => b[1] - a[1]\r\n  );\r\n\r\n  const [leftPos] = leftMargin[0];\r\n  const [rightPos] = rightMargin[0];\r\n\r\n  return { left: leftPos, right: rightPos };\r\n}\r\n\r\n/** @type {Range} */\r\nlet textRectRange;\r\n\r\n/**\r\n * Return the viewport-relative rect occupied by part of a text node.\r\n *\r\n * @param {Text} text\r\n * @param {number} start\r\n * @param {number} end\r\n */\r\nfunction textRect(text, start = 0, end = text.data.length) {\r\n  if (!textRectRange) {\r\n    // Allocate a range only on the first call to avoid the overhead of\r\n    // constructing and maintaining a large number of live ranges.\r\n    textRectRange = document.createRange();\r\n  }\r\n  textRectRange.setStart(text, start);\r\n  textRectRange.setEnd(text, end);\r\n  return textRectRange.getBoundingClientRect();\r\n}\r\n\r\n/** @param {Element} element */\r\nfunction hasFixedPosition(element) {\r\n  switch (getComputedStyle(element).position) {\r\n    case 'fixed':\r\n    case 'sticky':\r\n      return true;\r\n    default:\r\n      return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Return the bounding rect that contains the element's content. Unlike\r\n * `Element.getBoundingClientRect`, this includes content which overflows\r\n * the element's specified size.\r\n *\r\n * @param {Element} element\r\n */\r\nfunction elementContentRect(element) {\r\n  const rect = element.getBoundingClientRect();\r\n  rect.x -= element.scrollLeft;\r\n  rect.y -= element.scrollTop;\r\n  rect.height = Math.max(rect.height, element.scrollHeight);\r\n  rect.width = Math.max(rect.width, element.scrollWidth);\r\n  return rect;\r\n}\r\n\r\n/**\r\n * Yield all the text node descendants of `root` that intersect `rect`.\r\n *\r\n * @param {Element} root\r\n * @param {DOMRect} rect\r\n * @param {(el: Element) => boolean} shouldVisit - Optional filter that determines\r\n *   whether to visit a subtree\r\n * @return {Generator<Text>}\r\n */\r\nfunction* textNodesInRect(root, rect, shouldVisit = () => true) {\r\n  /** @type {Node|null} */\r\n  let node = root.firstChild;\r\n  while (node) {\r\n    if (node.nodeType === Node.ELEMENT_NODE) {\r\n      const element = /** @type {Element} */ (node);\r\n      const contentIntersectsRect = rectIntersects(\r\n        elementContentRect(element),\r\n        rect\r\n      );\r\n\r\n      // Only examine subtrees which are visible.\r\n      if (shouldVisit(element) && contentIntersectsRect) {\r\n        yield* textNodesInRect(element, rect, shouldVisit);\r\n      }\r\n    } else if (node.nodeType === Node.TEXT_NODE) {\r\n      const text = /** @type {Text} */ (node);\r\n\r\n      // Skip over text nodes which are entirely outside the viewport or empty.\r\n      if (rectIntersects(textRect(text), rect)) {\r\n        yield text;\r\n      }\r\n    }\r\n    node = node.nextSibling;\r\n  }\r\n}\r\n\r\n/**\r\n * Find content within an element to use as an anchor when applying a layout\r\n * change to the document.\r\n *\r\n * @param {Element} root\r\n * @param {DOMRect} viewport\r\n * @return {Range|null} - Range to use as an anchor or `null` if a suitable\r\n *   range could not be found\r\n */\r\nfunction getScrollAnchor(root, viewport) {\r\n  // Range representing the content whose position within the viewport we will\r\n  // try to maintain after running the callback.\r\n  let anchorRange = /** @type {Range|null} */ (null);\r\n\r\n  // Find the first word (non-whitespace substring of a text node) that is fully\r\n  // visible in the viewport.\r\n\r\n  // Text inside fixed-position elements is ignored because its position won't\r\n  // be affected by a layout change and so it makes a poor scroll anchor.\r\n  /** @param {Element} el */\r\n  const shouldVisit = el => !hasFixedPosition(el);\r\n\r\n  textNodeLoop: for (let textNode of textNodesInRect(\r\n    root,\r\n    viewport,\r\n    shouldVisit\r\n  )) {\r\n    let textLen = 0;\r\n\r\n    // Visit all the non-whitespace substrings of the text node.\r\n    for (let word of textNode.data.split(/\\b/)) {\r\n      if (/\\S/.test(word)) {\r\n        const start = textLen;\r\n        const end = textLen + word.length;\r\n        const wordBox = textRect(textNode, start, end);\r\n        if (rectContains(viewport, wordBox)) {\r\n          anchorRange = document.createRange();\r\n          anchorRange.setStart(textNode, start);\r\n          anchorRange.setEnd(textNode, end);\r\n          break textNodeLoop;\r\n        }\r\n      }\r\n\r\n      textLen += word.length;\r\n    }\r\n  }\r\n\r\n  return anchorRange;\r\n}\r\n\r\n/**\r\n * Apply a layout change to the document and preserve the scroll position.\r\n *\r\n * This utility selects part of the content in the viewport as an _anchor_\r\n * and tries to preserve the position of this content within the viewport\r\n * after the callback is invoked.\r\n *\r\n * @param {() => void} callback - Callback that will apply the layout change\r\n * @param {Element} [scrollRoot]\r\n * @param {DOMRect} [viewport] - Area to consider \"in the viewport\". Defaults to\r\n *   the viewport of the current window.\r\n * @return {number} - Amount by which the scroll position was adjusted to keep\r\n *   the anchored content in view\r\n */\r\nexport function preserveScrollPosition(\r\n  callback,\r\n  /* istanbul ignore next */\r\n  scrollRoot = document.documentElement,\r\n  /* istanbul ignore next */\r\n  viewport = new DOMRect(0, 0, window.innerWidth, window.innerHeight)\r\n) {\r\n  const anchor = getScrollAnchor(scrollRoot, viewport);\r\n  if (!anchor) {\r\n    callback();\r\n    return 0;\r\n  }\r\n\r\n  const anchorTop = anchor.getBoundingClientRect().top;\r\n  callback();\r\n  const newAnchorTop = anchor.getBoundingClientRect().top;\r\n\r\n  // Determine how far we scrolled as a result of the layout change.\r\n  // This will be positive if the anchor element moved down or negative if it moved up.\r\n  const scrollDelta = newAnchorTop - anchorTop;\r\n  scrollRoot.scrollTop += scrollDelta;\r\n\r\n  return scrollDelta;\r\n}\r\n","import { ListenerCollection } from '../../shared/listener-collection';\r\n\r\n/**\r\n * Monkey-patch an object to observe calls to a method.\r\n *\r\n * The `handler` is not invoked if the observed method throws.\r\n *\r\n * @template {any} T\r\n * @param {T} object\r\n * @param {keyof T} method\r\n * @param {(...args: unknown[]) => void} handler - Handler that is invoked\r\n *   after the monitored method has been called.\r\n * @return {() => void} Callback that removes the observer and restores `object[method]`.\r\n */\r\nfunction observeCalls(object, method, handler) {\r\n  const origHandler = object[method];\r\n\r\n  /* istanbul ignore next */\r\n  if (typeof origHandler !== 'function') {\r\n    throw new Error('Can only intercept functions');\r\n  }\r\n\r\n  /** @param {unknown[]} args */\r\n  const wrapper = (...args) => {\r\n    const result = origHandler.call(object, ...args);\r\n    handler(...args);\r\n    return result;\r\n  };\r\n  object[method] = /** @type {any} */ (wrapper);\r\n\r\n  return () => {\r\n    object[method] = origHandler;\r\n  };\r\n}\r\n\r\n/** @param {string} url */\r\nfunction stripFragment(url) {\r\n  return url.replace(/#.*/, '');\r\n}\r\n\r\n/**\r\n * Utility for detecting client-side navigations of an HTML document.\r\n *\r\n * This uses the Navigation API [1] if available, or falls back to\r\n * monkey-patching the History API [2] otherwise.\r\n *\r\n * Only navigations which change the path or query params are reported. URL\r\n * updates which change only the hash fragment are assumed to be navigations to\r\n * different parts of the same logical document. Also Hypothesis in general\r\n * ignores the hash fragment when comparing URLs.\r\n *\r\n * [1] https://wicg.github.io/navigation-api/\r\n * [2] https://developer.mozilla.org/en-US/docs/Web/API/History\r\n */\r\nexport class NavigationObserver {\r\n  /**\r\n   * Begin observing navigation changes.\r\n   *\r\n   * @param {(url: string) => void} onNavigate - Callback invoked when a navigation\r\n   *   occurs. The callback is fired after the navigation has completed and the\r\n   *   new URL is reflected in `location.href`.\r\n   * @param {() => string} getLocation - Test seam that returns the current URL\r\n   */\r\n  constructor(\r\n    onNavigate,\r\n    /* istanbul ignore next - default overridden in tests */\r\n    getLocation = () => location.href\r\n  ) {\r\n    this._listeners = new ListenerCollection();\r\n\r\n    let lastURL = getLocation();\r\n    const checkForURLChange = (newURL = getLocation()) => {\r\n      if (stripFragment(lastURL) !== stripFragment(newURL)) {\r\n        lastURL = newURL;\r\n        onNavigate(newURL);\r\n      }\r\n    };\r\n\r\n    // @ts-expect-error - TS is missing Navigation API types.\r\n    const navigation = window.navigation;\r\n    if (navigation) {\r\n      this._listeners.add(navigation, 'navigatesuccess', () =>\r\n        checkForURLChange()\r\n      );\r\n    } else {\r\n      const unpatchers = [\r\n        observeCalls(window.history, 'pushState', () => checkForURLChange()),\r\n        observeCalls(window.history, 'replaceState', () => checkForURLChange()),\r\n      ];\r\n      this._unpatchHistory = () => unpatchers.forEach(cleanup => cleanup());\r\n      this._listeners.add(window, 'popstate', () => checkForURLChange());\r\n    }\r\n  }\r\n\r\n  /** Stop observing navigation changes. */\r\n  disconnect() {\r\n    this._unpatchHistory?.();\r\n    this._listeners.removeAll();\r\n  }\r\n}\r\n","var COMPLETE = 'complete',\r\n    CANCELED = 'canceled';\r\n\r\nfunction raf(task){\r\n    if('requestAnimationFrame' in window){\r\n        return window.requestAnimationFrame(task);\r\n    }\r\n\r\n    setTimeout(task, 16);\r\n}\r\n\r\nfunction setElementScroll(element, x, y){\r\n    Math.max(0, x);\r\n    Math.max(0, y);\r\n\r\n    if(element.self === element){\r\n        element.scrollTo(x, y);\r\n    }else{\r\n        element.scrollLeft = x;\r\n        element.scrollTop = y;\r\n    }\r\n}\r\n\r\nfunction getTargetScrollLocation(scrollSettings, parent){\r\n    var align = scrollSettings.align,\r\n        target = scrollSettings.target,\r\n        targetPosition = target.getBoundingClientRect(),\r\n        parentPosition,\r\n        x,\r\n        y,\r\n        differenceX,\r\n        differenceY,\r\n        targetWidth,\r\n        targetHeight,\r\n        leftAlign = align && align.left != null ? align.left : 0.5,\r\n        topAlign = align && align.top != null ? align.top : 0.5,\r\n        leftOffset = align && align.leftOffset != null ? align.leftOffset : 0,\r\n        topOffset = align && align.topOffset != null ? align.topOffset : 0,\r\n        leftScalar = leftAlign,\r\n        topScalar = topAlign;\r\n\r\n    if(scrollSettings.isWindow(parent)){\r\n        targetWidth = Math.min(targetPosition.width, parent.innerWidth);\r\n        targetHeight = Math.min(targetPosition.height, parent.innerHeight);\r\n        x = targetPosition.left + parent.pageXOffset - parent.innerWidth * leftScalar + targetWidth * leftScalar;\r\n        y = targetPosition.top + parent.pageYOffset - parent.innerHeight * topScalar + targetHeight * topScalar;\r\n        x -= leftOffset;\r\n        y -= topOffset;\r\n        x = scrollSettings.align.lockX ? parent.pageXOffset : x;\r\n        y = scrollSettings.align.lockY ? parent.pageYOffset : y;\r\n        differenceX = x - parent.pageXOffset;\r\n        differenceY = y - parent.pageYOffset;\r\n    }else{\r\n        targetWidth = targetPosition.width;\r\n        targetHeight = targetPosition.height;\r\n        parentPosition = parent.getBoundingClientRect();\r\n        var offsetLeft = targetPosition.left - (parentPosition.left - parent.scrollLeft);\r\n        var offsetTop = targetPosition.top - (parentPosition.top - parent.scrollTop);\r\n        x = offsetLeft + (targetWidth * leftScalar) - parent.clientWidth * leftScalar;\r\n        y = offsetTop + (targetHeight * topScalar) - parent.clientHeight * topScalar;\r\n        x -= leftOffset;\r\n        y -= topOffset;\r\n        x = Math.max(Math.min(x, parent.scrollWidth - parent.clientWidth), 0);\r\n        y = Math.max(Math.min(y, parent.scrollHeight - parent.clientHeight), 0);\r\n        x = scrollSettings.align.lockX ? parent.scrollLeft : x;\r\n        y = scrollSettings.align.lockY ? parent.scrollTop : y;\r\n        differenceX = x - parent.scrollLeft;\r\n        differenceY = y - parent.scrollTop;\r\n    }\r\n\r\n    return {\r\n        x: x,\r\n        y: y,\r\n        differenceX: differenceX,\r\n        differenceY: differenceY\r\n    };\r\n}\r\n\r\nfunction animate(parent){\r\n    var scrollSettings = parent._scrollSettings;\r\n\r\n    if(!scrollSettings){\r\n        return;\r\n    }\r\n\r\n    var maxSynchronousAlignments = scrollSettings.maxSynchronousAlignments;\r\n\r\n    var location = getTargetScrollLocation(scrollSettings, parent),\r\n        time = Date.now() - scrollSettings.startTime,\r\n        timeValue = Math.min(1 / scrollSettings.time * time, 1);\r\n\r\n    if(scrollSettings.endIterations >= maxSynchronousAlignments){\r\n        setElementScroll(parent, location.x, location.y);\r\n        parent._scrollSettings = null;\r\n        return scrollSettings.end(COMPLETE);\r\n    }\r\n\r\n    var easeValue = 1 - scrollSettings.ease(timeValue);\r\n\r\n    setElementScroll(parent,\r\n        location.x - location.differenceX * easeValue,\r\n        location.y - location.differenceY * easeValue\r\n    );\r\n\r\n    if(time >= scrollSettings.time){\r\n        scrollSettings.endIterations++;\r\n        // Align ancestor synchronously\r\n        scrollSettings.scrollAncestor && animate(scrollSettings.scrollAncestor);\r\n        animate(parent);\r\n        return;\r\n    }\r\n\r\n    raf(animate.bind(null, parent));\r\n}\r\n\r\nfunction defaultIsWindow(target){\r\n    return target.self === target\r\n}\r\n\r\nfunction transitionScrollTo(target, parent, settings, scrollAncestor, callback){\r\n    var idle = !parent._scrollSettings,\r\n        lastSettings = parent._scrollSettings,\r\n        now = Date.now(),\r\n        cancelHandler,\r\n        passiveOptions = { passive: true };\r\n\r\n    if(lastSettings){\r\n        lastSettings.end(CANCELED);\r\n    }\r\n\r\n    function end(endType){\r\n        parent._scrollSettings = null;\r\n\r\n        if(parent.parentElement && parent.parentElement._scrollSettings){\r\n            parent.parentElement._scrollSettings.end(endType);\r\n        }\r\n\r\n        if(settings.debug){\r\n            console.log('Scrolling ended with type', endType, 'for', parent)\r\n        }\r\n\r\n        callback(endType);\r\n        if(cancelHandler){\r\n            parent.removeEventListener('touchstart', cancelHandler, passiveOptions);\r\n            parent.removeEventListener('wheel', cancelHandler, passiveOptions);\r\n        }\r\n    }\r\n\r\n    var maxSynchronousAlignments = settings.maxSynchronousAlignments;\r\n\r\n    if(maxSynchronousAlignments == null){\r\n        maxSynchronousAlignments = 3;\r\n    }\r\n\r\n    parent._scrollSettings = {\r\n        startTime: now,\r\n        endIterations: 0,\r\n        target: target,\r\n        time: settings.time,\r\n        ease: settings.ease,\r\n        align: settings.align,\r\n        isWindow: settings.isWindow || defaultIsWindow,\r\n        maxSynchronousAlignments: maxSynchronousAlignments,\r\n        end: end,\r\n        scrollAncestor\r\n    };\r\n\r\n    if(!('cancellable' in settings) || settings.cancellable){\r\n        cancelHandler = end.bind(null, CANCELED);\r\n        parent.addEventListener('touchstart', cancelHandler, passiveOptions);\r\n        parent.addEventListener('wheel', cancelHandler, passiveOptions);\r\n    }\r\n\r\n    if(idle){\r\n        animate(parent);\r\n    }\r\n\r\n    return cancelHandler\r\n}\r\n\r\nfunction defaultIsScrollable(element){\r\n    return (\r\n        'pageXOffset' in element ||\r\n        (\r\n            element.scrollHeight !== element.clientHeight ||\r\n            element.scrollWidth !== element.clientWidth\r\n        ) &&\r\n        getComputedStyle(element).overflow !== 'hidden'\r\n    );\r\n}\r\n\r\nfunction defaultValidTarget(){\r\n    return true;\r\n}\r\n\r\nfunction findParentElement(el){\r\n    if (el.assignedSlot) {\r\n        return findParentElement(el.assignedSlot);\r\n    }\r\n\r\n    if (el.parentElement) {\r\n        if(el.parentElement.tagName === 'BODY'){\r\n            return el.parentElement.ownerDocument.defaultView || el.parentElement.ownerDocument.ownerWindow;\r\n        }\r\n        return el.parentElement;\r\n    }\r\n\r\n    if (el.getRootNode){\r\n        var parent = el.getRootNode()\r\n        if(parent.nodeType === 11) {\r\n            return parent.host;\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports = function(target, settings, callback){\r\n    if(!target){\r\n        return;\r\n    }\r\n\r\n    if(typeof settings === 'function'){\r\n        callback = settings;\r\n        settings = null;\r\n    }\r\n\r\n    if(!settings){\r\n        settings = {};\r\n    }\r\n\r\n    settings.time = isNaN(settings.time) ? 1000 : settings.time;\r\n    settings.ease = settings.ease || function(v){return 1 - Math.pow(1 - v, v / 2);};\r\n    settings.align = settings.align || {};\r\n\r\n    var parent = findParentElement(target),\r\n        parents = 1;\r\n\r\n    function done(endType){\r\n        parents--;\r\n        if(!parents){\r\n            callback && callback(endType);\r\n        }\r\n    }\r\n\r\n    var validTarget = settings.validTarget || defaultValidTarget;\r\n    var isScrollable = settings.isScrollable;\r\n\r\n    if(settings.debug){\r\n        console.log('About to scroll to', target)\r\n\r\n        if(!parent){\r\n            console.error('Target did not have a parent, is it mounted in the DOM?')\r\n        }\r\n    }\r\n\r\n    var scrollingElements = [];\r\n\r\n    while(parent){\r\n        if(settings.debug){\r\n            console.log('Scrolling parent node', parent)\r\n        }\r\n\r\n        if(validTarget(parent, parents) && (isScrollable ? isScrollable(parent, defaultIsScrollable) : defaultIsScrollable(parent))){\r\n            parents++;\r\n            scrollingElements.push(parent);\r\n        }\r\n\r\n        parent = findParentElement(parent);\r\n\r\n        if(!parent){\r\n            done(COMPLETE)\r\n            break;\r\n        }\r\n    }\r\n\r\n    return scrollingElements.reduce((cancel, parent, index) => transitionScrollTo(target, parent, settings, scrollingElements[index + 1], done), null);\r\n};\r\n","import scrollIntoView from 'scroll-into-view';\r\n\r\n/**\r\n * Return a promise that resolves on the next animation frame.\r\n */\r\nfunction nextAnimationFrame() {\r\n  return new Promise(resolve => {\r\n    requestAnimationFrame(resolve);\r\n  });\r\n}\r\n\r\n/**\r\n * Linearly interpolate between two values.\r\n *\r\n * @param {number} a\r\n * @param {number} b\r\n * @param {number} fraction - Value in [0, 1]\r\n */\r\nfunction interpolate(a, b, fraction) {\r\n  return a + fraction * (b - a);\r\n}\r\n\r\n/**\r\n * Return the offset of `element` from the top of a positioned ancestor `parent`.\r\n *\r\n * @param {HTMLElement} element\r\n * @param {HTMLElement} parent - Positioned ancestor of `element`\r\n * @return {number}\r\n */\r\nexport function offsetRelativeTo(element, parent) {\r\n  let offset = 0;\r\n  while (element !== parent && parent.contains(element)) {\r\n    offset += element.offsetTop;\r\n    element = /** @type {HTMLElement} */ (element.offsetParent);\r\n  }\r\n  return offset;\r\n}\r\n\r\n/**\r\n * Scroll `element` until its `scrollTop` offset reaches a target value.\r\n *\r\n * @param {Element} element - Container element to scroll\r\n * @param {number} offset - Target value for the scroll offset\r\n * @param {object} options\r\n *   @param {number} [options.maxDuration]\r\n * @return {Promise<void>} - A promise that resolves once the scroll animation\r\n *   is complete\r\n */\r\nexport async function scrollElement(\r\n  element,\r\n  offset,\r\n  /* istanbul ignore next - defaults are overridden in tests */\r\n  { maxDuration = 500 } = {}\r\n) {\r\n  const startOffset = element.scrollTop;\r\n  const endOffset = offset;\r\n  const scrollStart = Date.now();\r\n\r\n  // Choose a scroll duration proportional to the scroll distance, but capped\r\n  // to avoid it being too slow.\r\n  const pixelsPerMs = 3;\r\n  const scrollDuration = Math.min(\r\n    Math.abs(endOffset - startOffset) / pixelsPerMs,\r\n    maxDuration\r\n  );\r\n\r\n  let scrollFraction = 0.0;\r\n  while (scrollFraction < 1.0) {\r\n    await nextAnimationFrame();\r\n    scrollFraction = Math.min(1.0, (Date.now() - scrollStart) / scrollDuration);\r\n    element.scrollTop = interpolate(startOffset, endOffset, scrollFraction);\r\n  }\r\n}\r\n\r\n/**\r\n * Smoothly scroll an element into view.\r\n *\r\n * @param {HTMLElement} element\r\n * @param {object} options\r\n *   @param {number} [options.maxDuration]\r\n */\r\nexport async function scrollElementIntoView(\r\n  element,\r\n  /* istanbul ignore next - defaults are overridden in tests */\r\n  { maxDuration = 500 } = {}\r\n) {\r\n  // Make the body's `tagName` return an upper-case string in XHTML documents\r\n  // like it does in HTML documents. This is a workaround for\r\n  // `scrollIntoView`'s detection of the <body> element. See\r\n  // https://github.com/KoryNunn/scroll-into-view/issues/101.\r\n  const body = element.closest('body');\r\n  if (body && body.tagName !== 'BODY') {\r\n    Object.defineProperty(body, 'tagName', {\r\n      value: 'BODY',\r\n      configurable: true,\r\n    });\r\n  }\r\n\r\n  await new Promise(resolve =>\r\n    scrollIntoView(element, { time: maxDuration }, resolve)\r\n  );\r\n}\r\n","import { TinyEmitter } from 'tiny-emitter';\r\n\r\nimport { anchor, describe } from '../anchoring/html';\r\n\r\nimport { HTMLMetadata } from './html-metadata';\r\nimport {\r\n  guessMainContentArea,\r\n  preserveScrollPosition,\r\n} from './html-side-by-side';\r\nimport { NavigationObserver } from '../util/navigation-observer';\r\nimport { scrollElementIntoView } from '../util/scroll';\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').Anchor} Anchor\r\n * @typedef {import('../../types/annotator').Annotator} Annotator\r\n * @typedef {import('../../types/annotator').FeatureFlags} FeatureFlags\r\n * @typedef {import('../../types/annotator').Integration} Integration\r\n * @typedef {import('../../types/annotator').SidebarLayout} SidebarLayout\r\n */\r\n\r\n// When activating side-by-side mode, make sure there is at least this amount\r\n// of space (in pixels) left for the document's content. Any narrower and the\r\n// content line lengths and scale are too short to be readable.\r\nconst MIN_HTML_WIDTH = 480;\r\n\r\n/**\r\n * Document type integration for ordinary web pages.\r\n *\r\n * This integration is used for web pages and applications that are not handled\r\n * by a more specific integration (eg. for PDFs).\r\n *\r\n * @implements {Integration}\r\n */\r\nexport class HTMLIntegration extends TinyEmitter {\r\n  /**\r\n   * @param {object} options\r\n   *   @param {FeatureFlags} options.features\r\n   *   @param {HTMLElement} [options.container]\r\n   */\r\n  constructor({ features, container = document.body }) {\r\n    super();\r\n\r\n    this.features = features;\r\n    this.container = container;\r\n    this.anchor = anchor;\r\n    this.describe = describe;\r\n\r\n    this._htmlMeta = new HTMLMetadata();\r\n    this._prevURI = this._htmlMeta.uri();\r\n\r\n    /** Whether to attempt to resize the document to fit alongside sidebar. */\r\n    this._sideBySideEnabled = this.features.flagEnabled('html_side_by_side');\r\n\r\n    /**\r\n     * Whether the document is currently being resized to fit alongside an\r\n     * open sidebar.\r\n     */\r\n    this._sideBySideActive = false;\r\n\r\n    /** @type {SidebarLayout|null} */\r\n    this._lastLayout = null;\r\n\r\n    // Watch for changes to `location.href`.\r\n    this._navObserver = new NavigationObserver(() => this._checkForURIChange());\r\n\r\n    // Watch for potential changes to location information in `<head>`, eg.\r\n    // `<link rel=canonical>`.\r\n    this._metaObserver = new MutationObserver(() => this._checkForURIChange());\r\n    this._metaObserver.observe(document.head, {\r\n      childList: true,\r\n      subtree: true,\r\n      attributes: true,\r\n\r\n      attributeFilter: [\r\n        // Keys and values of <link> elements\r\n        'rel',\r\n        'href',\r\n\r\n        // Keys and values of <meta> elements\r\n        'name',\r\n        'content',\r\n      ],\r\n    });\r\n\r\n    this._flagsChanged = () => {\r\n      const sideBySide = features.flagEnabled('html_side_by_side');\r\n      if (sideBySide !== this._sideBySideEnabled) {\r\n        this._sideBySideEnabled = sideBySide;\r\n\r\n        // `fitSideBySide` is normally called by Guest when the sidebar layout\r\n        // changes. When the feature flag changes, we need to re-run the method.\r\n        if (this._lastLayout) {\r\n          this.fitSideBySide(this._lastLayout);\r\n        }\r\n      }\r\n    };\r\n    this.features.on('flagsChanged', this._flagsChanged);\r\n  }\r\n\r\n  _checkForURIChange() {\r\n    const currentURI = this._htmlMeta.uri();\r\n    if (currentURI !== this._prevURI) {\r\n      this._prevURI = currentURI;\r\n      this.emit('uriChanged', currentURI);\r\n    }\r\n  }\r\n\r\n  canAnnotate() {\r\n    return true;\r\n  }\r\n\r\n  destroy() {\r\n    this._navObserver.disconnect();\r\n    this._metaObserver.disconnect();\r\n    this.features.off('flagsChanged', this._flagsChanged);\r\n  }\r\n\r\n  contentContainer() {\r\n    return this.container;\r\n  }\r\n\r\n  /**\r\n   * @param {SidebarLayout} layout\r\n   */\r\n  fitSideBySide(layout) {\r\n    this._lastLayout = layout;\r\n\r\n    const maximumWidthToFit = window.innerWidth - layout.width;\r\n    const active =\r\n      this._sideBySideEnabled &&\r\n      layout.expanded &&\r\n      maximumWidthToFit >= MIN_HTML_WIDTH;\r\n\r\n    if (active) {\r\n      // nb. We call `_activateSideBySide` regardless of whether side-by-side\r\n      // is already active because the sidebar width might be different.\r\n      this._activateSideBySide(layout.width);\r\n    } else if (this._sideBySideActive) {\r\n      this._deactivateSideBySide();\r\n    }\r\n    this._sideBySideActive = active;\r\n    return active;\r\n  }\r\n\r\n  /**\r\n   * Resize the document content after side-by-side mode is activated.\r\n   *\r\n   * @param {number} sidebarWidth\r\n   */\r\n  _activateSideBySide(sidebarWidth) {\r\n    // When side-by-side mode is activated, what we want to achieve is that the\r\n    // main content of the page is fully visible alongside the sidebar, with\r\n    // as much space given to the main content as possible. A challenge is that\r\n    // we don't know how the page will respond to reducing the width of the body.\r\n    //\r\n    // - The content might have margins which automatically get reduced as the\r\n    //   available width is reduced. For example a blog post with a fixed-width\r\n    //   article in the middle and `margin: auto` for both margins.\r\n    //\r\n    //   In this scenario we'd want to reduce the document width by the full\r\n    //   width of the sidebar.\r\n    //\r\n    // - There might be sidebars to the left and/or right of the main content\r\n    //   which cause the main content to be squashed when the width is reduced.\r\n    //   For example a news website with a column of ads on the right.\r\n    //\r\n    //   In this scenario we'd want to not reduce the document width or reduce\r\n    //   it by a smaller amount and let the Hypothesis sidebar cover up the\r\n    //   document's sidebar, leaving as much space as possible to the content.\r\n    //\r\n    // Therefore what we do is to initially reduce the width of the document by\r\n    // the full width of the sidebar, then we use heuristics to analyze the\r\n    // resulting page layout and determine whether there is significant \"free space\"\r\n    // (ie. anything that is not the main content of the document, such as ads or\r\n    // links to related stories) to the right of the main content. If there is,\r\n    // we make the document wider again to allow more space for the main content.\r\n    //\r\n    // These heuristics assume a typical \"article\" page with one central block\r\n    // of content. If we can't find the \"main content\" then we just assume that\r\n    // everything on the page is potentially content that the user might want\r\n    // to annotate and so try to keep it all visible.\r\n\r\n    // nb. 12px padding is a multiple of the 4px grid unit in our design system.\r\n    const padding = 12;\r\n    const rightMargin = sidebarWidth + padding;\r\n\r\n    /** @param {HTMLElement} element */\r\n    const computeLeftMargin = element =>\r\n      parseInt(window.getComputedStyle(element).marginLeft, 10);\r\n\r\n    preserveScrollPosition(() => {\r\n      // nb. Adjusting the body size this way relies on the page not setting a\r\n      // width on the body. For sites that do this won't work.\r\n\r\n      // Remove any margins we've previously set\r\n      document.body.style.marginLeft = '';\r\n      document.body.style.marginRight = '';\r\n\r\n      // Keep track of what left margin would be naturally without right margin set\r\n      const beforeBodyLeft = computeLeftMargin(document.body);\r\n\r\n      document.body.style.marginRight = `${rightMargin}px`;\r\n\r\n      const contentArea = guessMainContentArea(document.body);\r\n      if (contentArea) {\r\n        // Check if we can give the main content more space by letting the\r\n        // sidebar overlap stuff in the document to the right of the main content.\r\n        const freeSpace = Math.max(\r\n          0,\r\n          window.innerWidth - rightMargin - contentArea.right\r\n        );\r\n        if (freeSpace > 0) {\r\n          const adjustedMargin = Math.max(0, rightMargin - freeSpace);\r\n          document.body.style.marginRight = `${adjustedMargin}px`;\r\n        }\r\n\r\n        // Changes to right margin can affect left margin in cases where body\r\n        // has `margin:auto`. It's OK to move the body to the left to make\r\n        // space, but avoid moving it to the right.\r\n        // See https://github.com/hypothesis/client/issues/4280\r\n        const afterBodyLeft = computeLeftMargin(document.body);\r\n        if (afterBodyLeft > beforeBodyLeft) {\r\n          document.body.style.marginLeft = `${beforeBodyLeft}px`;\r\n        }\r\n\r\n        // If the main content appears to be right up against the edge of the\r\n        // window, add padding for readability.\r\n        if (contentArea.left < padding) {\r\n          document.body.style.marginLeft = `${padding}px`;\r\n        }\r\n      } else {\r\n        document.body.style.marginLeft = '';\r\n        document.body.style.marginRight = '';\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Undo the effects of `activateSideBySide`.\r\n   */\r\n  _deactivateSideBySide() {\r\n    preserveScrollPosition(() => {\r\n      document.body.style.marginLeft = '';\r\n      document.body.style.marginRight = '';\r\n    });\r\n  }\r\n\r\n  async getMetadata() {\r\n    return this._htmlMeta.getDocumentMetadata();\r\n  }\r\n\r\n  async uri() {\r\n    return this._htmlMeta.uri();\r\n  }\r\n\r\n  /**\r\n   * @param {Anchor} anchor\r\n   */\r\n  async scrollToAnchor(anchor) {\r\n    const highlight = anchor.highlights?.[0];\r\n    if (!highlight) {\r\n      return;\r\n    }\r\n    await scrollElementIntoView(highlight);\r\n  }\r\n}\r\n","/**\n * lodash (Custom Build) <https://lodash.com/>\n * Build: `lodash modularize exports=\"npm\" -o ./`\n * Copyright jQuery Foundation and other contributors <https://jquery.org/>\n * Released under MIT license <https://lodash.com/license>\n * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>\n * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors\n */\n\n/** Used as the `TypeError` message for \"Functions\" methods. */\nvar FUNC_ERROR_TEXT = 'Expected a function';\n\n/** Used as references for various `Number` constants. */\nvar NAN = 0 / 0;\n\n/** `Object#toString` result references. */\nvar symbolTag = '[object Symbol]';\n\n/** Used to match leading and trailing whitespace. */\nvar reTrim = /^\\s+|\\s+$/g;\n\n/** Used to detect bad signed hexadecimal string values. */\nvar reIsBadHex = /^[-+]0x[0-9a-f]+$/i;\n\n/** Used to detect binary string values. */\nvar reIsBinary = /^0b[01]+$/i;\n\n/** Used to detect octal string values. */\nvar reIsOctal = /^0o[0-7]+$/i;\n\n/** Built-in method references without a dependency on `root`. */\nvar freeParseInt = parseInt;\n\n/** Detect free variable `global` from Node.js. */\nvar freeGlobal = typeof global == 'object' && global && global.Object === Object && global;\n\n/** Detect free variable `self`. */\nvar freeSelf = typeof self == 'object' && self && self.Object === Object && self;\n\n/** Used as a reference to the global object. */\nvar root = freeGlobal || freeSelf || Function('return this')();\n\n/** Used for built-in method references. */\nvar objectProto = Object.prototype;\n\n/**\n * Used to resolve the\n * [`toStringTag`](http://ecma-international.org/ecma-262/7.0/#sec-object.prototype.tostring)\n * of values.\n */\nvar objectToString = objectProto.toString;\n\n/* Built-in method references for those with the same name as other `lodash` methods. */\nvar nativeMax = Math.max,\n    nativeMin = Math.min;\n\n/**\n * Gets the timestamp of the number of milliseconds that have elapsed since\n * the Unix epoch (1 January 1970 00:00:00 UTC).\n *\n * @static\n * @memberOf _\n * @since 2.4.0\n * @category Date\n * @returns {number} Returns the timestamp.\n * @example\n *\n * _.defer(function(stamp) {\n *   console.log(_.now() - stamp);\n * }, _.now());\n * // => Logs the number of milliseconds it took for the deferred invocation.\n */\nvar now = function() {\n  return root.Date.now();\n};\n\n/**\n * Creates a debounced function that delays invoking `func` until after `wait`\n * milliseconds have elapsed since the last time the debounced function was\n * invoked. The debounced function comes with a `cancel` method to cancel\n * delayed `func` invocations and a `flush` method to immediately invoke them.\n * Provide `options` to indicate whether `func` should be invoked on the\n * leading and/or trailing edge of the `wait` timeout. The `func` is invoked\n * with the last arguments provided to the debounced function. Subsequent\n * calls to the debounced function return the result of the last `func`\n * invocation.\n *\n * **Note:** If `leading` and `trailing` options are `true`, `func` is\n * invoked on the trailing edge of the timeout only if the debounced function\n * is invoked more than once during the `wait` timeout.\n *\n * If `wait` is `0` and `leading` is `false`, `func` invocation is deferred\n * until to the next tick, similar to `setTimeout` with a timeout of `0`.\n *\n * See [David Corbacho's article](https://css-tricks.com/debouncing-throttling-explained-examples/)\n * for details over the differences between `_.debounce` and `_.throttle`.\n *\n * @static\n * @memberOf _\n * @since 0.1.0\n * @category Function\n * @param {Function} func The function to debounce.\n * @param {number} [wait=0] The number of milliseconds to delay.\n * @param {Object} [options={}] The options object.\n * @param {boolean} [options.leading=false]\n *  Specify invoking on the leading edge of the timeout.\n * @param {number} [options.maxWait]\n *  The maximum time `func` is allowed to be delayed before it's invoked.\n * @param {boolean} [options.trailing=true]\n *  Specify invoking on the trailing edge of the timeout.\n * @returns {Function} Returns the new debounced function.\n * @example\n *\n * // Avoid costly calculations while the window size is in flux.\n * jQuery(window).on('resize', _.debounce(calculateLayout, 150));\n *\n * // Invoke `sendMail` when clicked, debouncing subsequent calls.\n * jQuery(element).on('click', _.debounce(sendMail, 300, {\n *   'leading': true,\n *   'trailing': false\n * }));\n *\n * // Ensure `batchLog` is invoked once after 1 second of debounced calls.\n * var debounced = _.debounce(batchLog, 250, { 'maxWait': 1000 });\n * var source = new EventSource('/stream');\n * jQuery(source).on('message', debounced);\n *\n * // Cancel the trailing debounced invocation.\n * jQuery(window).on('popstate', debounced.cancel);\n */\nfunction debounce(func, wait, options) {\n  var lastArgs,\n      lastThis,\n      maxWait,\n      result,\n      timerId,\n      lastCallTime,\n      lastInvokeTime = 0,\n      leading = false,\n      maxing = false,\n      trailing = true;\n\n  if (typeof func != 'function') {\n    throw new TypeError(FUNC_ERROR_TEXT);\n  }\n  wait = toNumber(wait) || 0;\n  if (isObject(options)) {\n    leading = !!options.leading;\n    maxing = 'maxWait' in options;\n    maxWait = maxing ? nativeMax(toNumber(options.maxWait) || 0, wait) : maxWait;\n    trailing = 'trailing' in options ? !!options.trailing : trailing;\n  }\n\n  function invokeFunc(time) {\n    var args = lastArgs,\n        thisArg = lastThis;\n\n    lastArgs = lastThis = undefined;\n    lastInvokeTime = time;\n    result = func.apply(thisArg, args);\n    return result;\n  }\n\n  function leadingEdge(time) {\n    // Reset any `maxWait` timer.\n    lastInvokeTime = time;\n    // Start the timer for the trailing edge.\n    timerId = setTimeout(timerExpired, wait);\n    // Invoke the leading edge.\n    return leading ? invokeFunc(time) : result;\n  }\n\n  function remainingWait(time) {\n    var timeSinceLastCall = time - lastCallTime,\n        timeSinceLastInvoke = time - lastInvokeTime,\n        result = wait - timeSinceLastCall;\n\n    return maxing ? nativeMin(result, maxWait - timeSinceLastInvoke) : result;\n  }\n\n  function shouldInvoke(time) {\n    var timeSinceLastCall = time - lastCallTime,\n        timeSinceLastInvoke = time - lastInvokeTime;\n\n    // Either this is the first call, activity has stopped and we're at the\n    // trailing edge, the system time has gone backwards and we're treating\n    // it as the trailing edge, or we've hit the `maxWait` limit.\n    return (lastCallTime === undefined || (timeSinceLastCall >= wait) ||\n      (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait));\n  }\n\n  function timerExpired() {\n    var time = now();\n    if (shouldInvoke(time)) {\n      return trailingEdge(time);\n    }\n    // Restart the timer.\n    timerId = setTimeout(timerExpired, remainingWait(time));\n  }\n\n  function trailingEdge(time) {\n    timerId = undefined;\n\n    // Only invoke if we have `lastArgs` which means `func` has been\n    // debounced at least once.\n    if (trailing && lastArgs) {\n      return invokeFunc(time);\n    }\n    lastArgs = lastThis = undefined;\n    return result;\n  }\n\n  function cancel() {\n    if (timerId !== undefined) {\n      clearTimeout(timerId);\n    }\n    lastInvokeTime = 0;\n    lastArgs = lastCallTime = lastThis = timerId = undefined;\n  }\n\n  function flush() {\n    return timerId === undefined ? result : trailingEdge(now());\n  }\n\n  function debounced() {\n    var time = now(),\n        isInvoking = shouldInvoke(time);\n\n    lastArgs = arguments;\n    lastThis = this;\n    lastCallTime = time;\n\n    if (isInvoking) {\n      if (timerId === undefined) {\n        return leadingEdge(lastCallTime);\n      }\n      if (maxing) {\n        // Handle invocations in a tight loop.\n        timerId = setTimeout(timerExpired, wait);\n        return invokeFunc(lastCallTime);\n      }\n    }\n    if (timerId === undefined) {\n      timerId = setTimeout(timerExpired, wait);\n    }\n    return result;\n  }\n  debounced.cancel = cancel;\n  debounced.flush = flush;\n  return debounced;\n}\n\n/**\n * Checks if `value` is the\n * [language type](http://www.ecma-international.org/ecma-262/7.0/#sec-ecmascript-language-types)\n * of `Object`. (e.g. arrays, functions, objects, regexes, `new Number(0)`, and `new String('')`)\n *\n * @static\n * @memberOf _\n * @since 0.1.0\n * @category Lang\n * @param {*} value The value to check.\n * @returns {boolean} Returns `true` if `value` is an object, else `false`.\n * @example\n *\n * _.isObject({});\n * // => true\n *\n * _.isObject([1, 2, 3]);\n * // => true\n *\n * _.isObject(_.noop);\n * // => true\n *\n * _.isObject(null);\n * // => false\n */\nfunction isObject(value) {\n  var type = typeof value;\n  return !!value && (type == 'object' || type == 'function');\n}\n\n/**\n * Checks if `value` is object-like. A value is object-like if it's not `null`\n * and has a `typeof` result of \"object\".\n *\n * @static\n * @memberOf _\n * @since 4.0.0\n * @category Lang\n * @param {*} value The value to check.\n * @returns {boolean} Returns `true` if `value` is object-like, else `false`.\n * @example\n *\n * _.isObjectLike({});\n * // => true\n *\n * _.isObjectLike([1, 2, 3]);\n * // => true\n *\n * _.isObjectLike(_.noop);\n * // => false\n *\n * _.isObjectLike(null);\n * // => false\n */\nfunction isObjectLike(value) {\n  return !!value && typeof value == 'object';\n}\n\n/**\n * Checks if `value` is classified as a `Symbol` primitive or object.\n *\n * @static\n * @memberOf _\n * @since 4.0.0\n * @category Lang\n * @param {*} value The value to check.\n * @returns {boolean} Returns `true` if `value` is a symbol, else `false`.\n * @example\n *\n * _.isSymbol(Symbol.iterator);\n * // => true\n *\n * _.isSymbol('abc');\n * // => false\n */\nfunction isSymbol(value) {\n  return typeof value == 'symbol' ||\n    (isObjectLike(value) && objectToString.call(value) == symbolTag);\n}\n\n/**\n * Converts `value` to a number.\n *\n * @static\n * @memberOf _\n * @since 4.0.0\n * @category Lang\n * @param {*} value The value to process.\n * @returns {number} Returns the number.\n * @example\n *\n * _.toNumber(3.2);\n * // => 3.2\n *\n * _.toNumber(Number.MIN_VALUE);\n * // => 5e-324\n *\n * _.toNumber(Infinity);\n * // => Infinity\n *\n * _.toNumber('3.2');\n * // => 3.2\n */\nfunction toNumber(value) {\n  if (typeof value == 'number') {\n    return value;\n  }\n  if (isSymbol(value)) {\n    return NAN;\n  }\n  if (isObject(value)) {\n    var other = typeof value.valueOf == 'function' ? value.valueOf() : value;\n    value = isObject(other) ? (other + '') : other;\n  }\n  if (typeof value != 'string') {\n    return value === 0 ? value : +value;\n  }\n  value = value.replace(reTrim, '');\n  var isBinary = reIsBinary.test(value);\n  return (isBinary || reIsOctal.test(value))\n    ? freeParseInt(value.slice(2), isBinary ? 2 : 8)\n    : (reIsBadHex.test(value) ? NAN : +value);\n}\n\nmodule.exports = debounce;\n","/**\r\n * Find the smallest offset in `str` which contains at least `count` chars\r\n * that match `filter` before it.\r\n *\r\n * @param {string} str\r\n * @param {number} count\r\n * @param {(char: string) => boolean} filter\r\n * @param {number} [startPos]\r\n */\r\nfunction advance(str, count, filter, startPos = 0) {\r\n  let pos = startPos;\r\n  while (pos < str.length && count > 0) {\r\n    if (filter(str[pos])) {\r\n      --count;\r\n    }\r\n    ++pos;\r\n  }\r\n  return pos;\r\n}\r\n\r\n/**\r\n * Count characters which match `filter` in `str`.\r\n *\r\n * @param {string} str\r\n * @param {(char: string) => boolean} filter\r\n * @param {number} startPos\r\n * @param {number} endPos\r\n */\r\nfunction countChars(str, filter, startPos, endPos) {\r\n  let count = 0;\r\n  for (let pos = startPos; pos < endPos; pos++) {\r\n    if (filter(str[pos])) {\r\n      ++count;\r\n    }\r\n  }\r\n  return count;\r\n}\r\n\r\n/**\r\n * Translate a (start, end) pair of offsets for an \"input\" string into\r\n * corresponding offsets in an \"output\" string.\r\n *\r\n * Positions in the input and output strings are related by counting\r\n * the number of \"important\" characters before them, as determined by a\r\n * filter function.\r\n *\r\n * An example usage would be to find equivalent positions in two strings which\r\n * contain the same text content except for the addition or removal of\r\n * whitespace at arbitrary locations in the output string.\r\n *\r\n * Where there are multiple possible offsets in the output string that\r\n * correspond to the input offsets, the largest start offset and smallest end\r\n * offset are chosen. In other words, leading and trailing ignored characters\r\n * are trimmed from the output.\r\n *\r\n * @example\r\n *   // The input offsets (1, 3) select the substring \"bc\" in the \"input\" argument.\r\n *   // The returned offsets select the substring \"b c\" in the \"output\" argument.\r\n *   translateOffsets('abcd', ' a b c d ', 1, 3, char => char !== ' ')\r\n *\r\n * @param {string} input\r\n * @param {string} output\r\n * @param {number} start - Start offset in `input`\r\n * @param {number} end - End offset in `input`\r\n * @param {(ch: string) => boolean} filter - Filter function that returns true\r\n *   if a character should be counted when relating positions between `input`\r\n *   and `output`.\r\n * @return {[number, number]} - Start and end offsets in `output`\r\n */\r\nexport function translateOffsets(input, output, start, end, filter) {\r\n  const beforeStartCount = countChars(input, filter, 0, start);\r\n  const startToEndCount = countChars(input, filter, start, end);\r\n\r\n  // Find smallest offset in `output` with same number of non-ignored characters\r\n  // before it as before `start` in the input. This offset might correspond to\r\n  // an ignored character.\r\n  let outputStart = advance(output, beforeStartCount, filter);\r\n\r\n  // Increment this offset until it points to a non-ignored character. This\r\n  // \"trims\" leading ignored characters from the result.\r\n  while (outputStart < output.length && !filter(output[outputStart])) {\r\n    ++outputStart;\r\n  }\r\n\r\n  // Find smallest offset in `output` with same number of non-ignored characters\r\n  // before it as before `end` in the input.\r\n  const outputEnd = advance(output, startToEndCount, filter, outputStart);\r\n\r\n  return [outputStart, outputEnd];\r\n}\r\n","/* global PDFViewerApplication */\r\n\r\nimport { warnOnce } from '../../shared/warn-once';\r\nimport { translateOffsets } from '../util/normalize';\r\nimport { matchQuote } from './match-quote';\r\nimport { createPlaceholder } from './placeholder';\r\nimport { TextPosition, TextRange } from './text-range';\r\nimport { TextQuoteAnchor } from './types';\r\n\r\n/**\r\n * @typedef {import('../../types/api').TextPositionSelector} TextPositionSelector\r\n * @typedef {import('../../types/api').TextQuoteSelector} TextQuoteSelector\r\n * @typedef {import('../../types/api').Selector} Selector\r\n *\r\n * @typedef {import('../../types/pdfjs').PDFPageView} PDFPageView\r\n * @typedef {import('../../types/pdfjs').PDFViewer} PDFViewer\r\n */\r\n\r\n/**\r\n * @typedef PDFTextRange\r\n * @prop {number} pageIndex\r\n * @prop {object} anchor\r\n * @prop {number} anchor.start - Start character offset within the page's text\r\n * @prop {number} anchor.end - End character offset within the page's text\r\n */\r\n\r\n/**\r\n * Enum values for page rendering states (IRenderableView#renderingState)\r\n * in PDF.js. Taken from web/pdf_rendering_queue.js in the PDF.js library.\r\n *\r\n * Reproduced here because this enum is not exported consistently across\r\n * different versions of PDF.js\r\n */\r\nexport const RenderingStates = {\r\n  INITIAL: 0,\r\n  RUNNING: 1,\r\n  PAUSED: 2,\r\n  FINISHED: 3,\r\n};\r\n\r\n// Caches for performance.\r\n\r\n/**\r\n * Map of page index to page text content.\r\n *\r\n * @type {Map<number, Promise<string>>}\r\n */\r\nconst pageTextCache = new Map();\r\n\r\n/**\r\n * A cache that maps a `{quote}:{offset}` key to a specific\r\n * location in the document.\r\n *\r\n * The components of the key come from an annotation's selectors. This is used\r\n * to speed up re-anchoring an annotation that was previously anchored in the\r\n * current session.\r\n *\r\n * @type {Map<string, PDFTextRange>}\r\n */\r\nconst quotePositionCache = new Map();\r\n\r\n/**\r\n * Return a cache key for lookups in `quotePositionCache`.\r\n *\r\n * @param {string} quote\r\n * @param {number} [pos] - Offset in document text\r\n */\r\nfunction quotePositionCacheKey(quote, pos) {\r\n  return `${quote}:${pos}`;\r\n}\r\n\r\n/**\r\n * Return offset of `node` among its siblings\r\n *\r\n * @param {Node} node\r\n */\r\nfunction getSiblingIndex(node) {\r\n  let index = 0;\r\n  while (node.previousSibling) {\r\n    ++index;\r\n    node = node.previousSibling;\r\n  }\r\n  return index;\r\n}\r\n\r\n/**\r\n * Return the text layer element of the PDF page containing `node`.\r\n *\r\n * @param {Node|Element} node\r\n * @return {Element|null}\r\n */\r\nfunction getNodeTextLayer(node) {\r\n  const el = 'closest' in node ? node : node.parentElement;\r\n  return el?.closest('.textLayer') ?? null;\r\n}\r\n\r\n/**\r\n * Get the PDF.js viewer application.\r\n *\r\n * @return {PDFViewer}\r\n */\r\nfunction getPDFViewer() {\r\n  // @ts-ignore - TS doesn't know about PDFViewerApplication global.\r\n  return PDFViewerApplication.pdfViewer;\r\n}\r\n\r\n/**\r\n * Returns the view into which a PDF page is drawn.\r\n *\r\n * If called while the PDF document is still loading, this will delay until\r\n * the document loading has progressed far enough for a `PDFPageView` and its\r\n * associated `PDFPage` to be ready.\r\n *\r\n * @param {number} pageIndex\r\n * @return {Promise<PDFPageView>}\r\n */\r\nasync function getPageView(pageIndex) {\r\n  const pdfViewer = getPDFViewer();\r\n  let pageView = pdfViewer.getPageView(pageIndex);\r\n\r\n  if (!pageView || !pageView.pdfPage) {\r\n    // If the document is still loading, wait for the `pagesloaded` event.\r\n    //\r\n    // Note that loading happens in several stages. Initially the page view\r\n    // objects do not exist (`pageView` will be nullish), then after the\r\n    // \"pagesinit\" event, the page view exists but it does not have a `pdfPage`\r\n    // property set, then finally after the \"pagesloaded\" event, it will have\r\n    // a \"pdfPage\" property.\r\n    pageView = await new Promise(resolve => {\r\n      const onPagesLoaded = () => {\r\n        if (pdfViewer.eventBus) {\r\n          pdfViewer.eventBus.off('pagesloaded', onPagesLoaded);\r\n        } else {\r\n          document.removeEventListener('pagesloaded', onPagesLoaded);\r\n        }\r\n\r\n        resolve(pdfViewer.getPageView(pageIndex));\r\n      };\r\n\r\n      if (pdfViewer.eventBus) {\r\n        pdfViewer.eventBus.on('pagesloaded', onPagesLoaded);\r\n      } else {\r\n        // Old PDF.js versions (< 1.6.210) use DOM events.\r\n        document.addEventListener('pagesloaded', onPagesLoaded);\r\n      }\r\n    });\r\n  }\r\n\r\n  return /** @type {PDFPageView} */ (pageView);\r\n}\r\n\r\n/**\r\n * Return true if the document has selectable text.\r\n */\r\nexport async function documentHasText() {\r\n  const viewer = getPDFViewer();\r\n  let hasText = false;\r\n  for (let i = 0; i < viewer.pagesCount; i++) {\r\n    const pageText = await getPageTextContent(i);\r\n    if (pageText.trim().length > 0) {\r\n      hasText = true;\r\n      break;\r\n    }\r\n  }\r\n  return hasText;\r\n}\r\n\r\n/**\r\n * Return the text of a given PDF page.\r\n *\r\n * The text returned by this function should match the `textContent` of the text\r\n * layer element that PDF.js creates for rendered pages, with the exception\r\n * that differences in whitespace are tolerated.\r\n *\r\n * @param {number} pageIndex\r\n * @return {Promise<string>}\r\n */\r\nfunction getPageTextContent(pageIndex) {\r\n  // If we already have or are fetching the text for this page, return the\r\n  // existing result.\r\n  const cachedText = pageTextCache.get(pageIndex);\r\n  if (cachedText) {\r\n    return cachedText;\r\n  }\r\n\r\n  const getPageText = async () => {\r\n    const pageView = await getPageView(pageIndex);\r\n    const textContent = await pageView.pdfPage.getTextContent({\r\n      // Deprecated option, set for compatibility with older PDF.js releases.\r\n      normalizeWhitespace: true,\r\n    });\r\n    return textContent.items.map(it => it.str).join('');\r\n  };\r\n\r\n  // This function synchronously populates the cache with a promise so that\r\n  // multiple calls don't call `PDFPageProxy.getTextContent` twice.\r\n  const pageText = getPageText();\r\n  pageTextCache.set(pageIndex, pageText);\r\n  return pageText;\r\n}\r\n\r\n/**\r\n * Find the offset within the document's text at which a page begins.\r\n *\r\n * @param {number} pageIndex\r\n * @return {Promise<number>} - Offset of page's text within document text\r\n */\r\nasync function getPageOffset(pageIndex) {\r\n  const viewer = getPDFViewer();\r\n  if (pageIndex >= viewer.pagesCount) {\r\n    /* istanbul ignore next - This should never be triggered */\r\n    throw new Error('Invalid page index');\r\n  }\r\n  let offset = 0;\r\n  for (let i = 0; i < pageIndex; i++) {\r\n    const text = await getPageTextContent(i);\r\n    offset += text.length;\r\n  }\r\n  return offset;\r\n}\r\n\r\n/**\r\n * @typedef PageOffset\r\n * @prop {number} index - Page index\r\n * @prop {number} offset - Character offset of start of page within document text\r\n * @prop {string} text - Text of page\r\n */\r\n\r\n/**\r\n * Find the page containing a text offset within the document.\r\n *\r\n * If the offset is invalid (less than 0 or greater than the length of the document)\r\n * then the nearest (first or last) page is returned.\r\n *\r\n * @param {number} offset\r\n * @return {Promise<PageOffset>}\r\n */\r\nasync function findPageByOffset(offset) {\r\n  const viewer = getPDFViewer();\r\n\r\n  let pageStartOffset = 0;\r\n  let pageEndOffset = 0;\r\n  let text = '';\r\n\r\n  for (let i = 0; i < viewer.pagesCount; i++) {\r\n    text = await getPageTextContent(i);\r\n    pageStartOffset = pageEndOffset;\r\n    pageEndOffset += text.length;\r\n\r\n    if (pageEndOffset >= offset) {\r\n      return { index: i, offset: pageStartOffset, text };\r\n    }\r\n  }\r\n\r\n  // If the offset is beyond the end of the document, just pretend it was on\r\n  // the last page.\r\n  return { index: viewer.pagesCount - 1, offset: pageStartOffset, text };\r\n}\r\n\r\n/**\r\n * Return true if `char` is an ASCII space.\r\n *\r\n * This is more efficient than `/\\s/.test(char)` but does not handle Unicode\r\n * spaces.\r\n *\r\n * @param {string} char\r\n */\r\nfunction isSpace(char) {\r\n  switch (char) {\r\n    case ' ':\r\n    case '\\f':\r\n    case '\\n':\r\n    case '\\r':\r\n    case '\\t':\r\n    case '\\v':\r\n    case '\\u00a0': // nbsp\r\n      return true;\r\n    default:\r\n      return false;\r\n  }\r\n}\r\n\r\n/** @param {string} char */\r\nconst isNotSpace = char => !isSpace(char);\r\n\r\n/**\r\n * Locate the DOM Range which a position selector refers to.\r\n *\r\n * If the page is off-screen it may be in an unrendered state, in which case\r\n * the text layer will not have been created. In that case a placeholder\r\n * DOM element is created and the returned range refers to that placeholder.\r\n * In that case, the selector will need to be re-anchored when the page is\r\n * scrolled into view.\r\n *\r\n * @param {number} pageIndex - The PDF page index\r\n * @param {number} start - Character offset within the page's text\r\n * @param {number} end - Character offset within the page's text\r\n * @return {Promise<Range>}\r\n */\r\nasync function anchorByPosition(pageIndex, start, end) {\r\n  const [page, pageText] = await Promise.all([\r\n    getPageView(pageIndex),\r\n    getPageTextContent(pageIndex),\r\n  ]);\r\n\r\n  if (\r\n    page.renderingState === RenderingStates.FINISHED &&\r\n    page.textLayer &&\r\n    page.textLayer.renderingDone\r\n  ) {\r\n    // The page has been rendered. Locate the position in the text layer.\r\n    //\r\n    // We allow for differences in whitespace between the text returned by\r\n    // `getPageTextContent` and the text layer content. Any other differences\r\n    // will cause mis-anchoring.\r\n\r\n    const root = page.textLayer.textLayerDiv;\r\n    const textLayerStr = /** @type {string} */ (root.textContent);\r\n\r\n    const [textLayerStart, textLayerEnd] = translateOffsets(\r\n      pageText,\r\n      textLayerStr,\r\n      start,\r\n      end,\r\n      isNotSpace\r\n    );\r\n\r\n    const textLayerQuote = stripSpaces(\r\n      textLayerStr.slice(textLayerStart, textLayerEnd)\r\n    );\r\n    const pageTextQuote = stripSpaces(pageText.slice(start, end));\r\n    if (textLayerQuote !== pageTextQuote) {\r\n      warnOnce(\r\n        'Text layer text does not match page text. Highlights will be mis-aligned.'\r\n      );\r\n    }\r\n\r\n    const startPos = new TextPosition(root, textLayerStart);\r\n    const endPos = new TextPosition(root, textLayerEnd);\r\n    return new TextRange(startPos, endPos).toRange();\r\n  }\r\n\r\n  // The page has not been rendered yet. Create a placeholder element and\r\n  // anchor to that instead.\r\n  const placeholder = createPlaceholder(page.div);\r\n  const range = document.createRange();\r\n  range.setStartBefore(placeholder);\r\n  range.setEndAfter(placeholder);\r\n  return range;\r\n}\r\n\r\n/**\r\n * Return a string with spaces stripped.\r\n *\r\n * This function optimizes for performance of stripping the main space chars\r\n * that PDF.js generates over handling all kinds of whitespace that could\r\n * occur in a string.\r\n *\r\n * @param {string} str\r\n */\r\nfunction stripSpaces(str) {\r\n  let stripped = '';\r\n  for (let i = 0; i < str.length; i++) {\r\n    const char = str[i];\r\n    if (isSpace(char)) {\r\n      continue;\r\n    }\r\n    stripped += char;\r\n  }\r\n  return stripped;\r\n}\r\n\r\n/**\r\n * Search for a quote in the given pages.\r\n *\r\n * When comparing quote selectors to document text, ASCII whitespace characters\r\n * are ignored. This is because text extracted from a PDF by different PDF\r\n * viewers, including different versions of PDF.js, can often differ in the\r\n * whitespace between characters and words. For a long time PDF.js in particular\r\n * had issues where it would often produce extra spaces between characters that\r\n * should not be there or omit spaces between words.\r\n *\r\n * @param {TextQuoteSelector} quoteSelector\r\n * @param {number} [positionHint] - Expected start offset of quote\r\n * @return {Promise<Range>} Location of quote\r\n */\r\nasync function anchorQuote(quoteSelector, positionHint) {\r\n  // Determine which pages to search and in what order. If we have a position\r\n  // hint we'll try to use that. Otherwise we'll just search all pages in order.\r\n  const pageCount = getPDFViewer().pagesCount;\r\n  const pageIndexes = Array(pageCount)\r\n    .fill(0)\r\n    .map((_, i) => i);\r\n\r\n  let expectedPageIndex;\r\n  let expectedOffsetInPage;\r\n\r\n  if (positionHint) {\r\n    const { index, offset } = await findPageByOffset(positionHint);\r\n    expectedPageIndex = index;\r\n    expectedOffsetInPage = positionHint - offset;\r\n\r\n    // Sort pages by distance from the page where we expect to find the quote,\r\n    // based on the position hint.\r\n    pageIndexes.sort((a, b) => {\r\n      const distA = Math.abs(a - index);\r\n      const distB = Math.abs(b - index);\r\n      return distA - distB;\r\n    });\r\n  }\r\n\r\n  // Search pages for the best match, ignoring whitespace differences.\r\n  const strippedPrefix =\r\n    quoteSelector.prefix !== undefined\r\n      ? stripSpaces(quoteSelector.prefix)\r\n      : undefined;\r\n  const strippedSuffix =\r\n    quoteSelector.suffix !== undefined\r\n      ? stripSpaces(quoteSelector.suffix)\r\n      : undefined;\r\n  const strippedQuote = stripSpaces(quoteSelector.exact);\r\n\r\n  let bestMatch;\r\n  for (let page of pageIndexes) {\r\n    const text = await getPageTextContent(page);\r\n    const strippedText = stripSpaces(text);\r\n\r\n    // Determine expected offset of quote in current page based on position hint.\r\n    let strippedHint;\r\n    if (expectedPageIndex !== undefined && expectedOffsetInPage !== undefined) {\r\n      if (page < expectedPageIndex) {\r\n        strippedHint = strippedText.length; // Prefer matches closer to end of page.\r\n      } else if (page === expectedPageIndex) {\r\n        // Translate expected offset in whitespace-inclusive version of page\r\n        // text into offset in whitespace-stripped version of page text.\r\n        [strippedHint] = translateOffsets(\r\n          text,\r\n          strippedText,\r\n          expectedOffsetInPage,\r\n          expectedOffsetInPage,\r\n          isNotSpace\r\n        );\r\n      } else {\r\n        strippedHint = 0; // Prefer matches closer to start of page.\r\n      }\r\n    }\r\n\r\n    const match = matchQuote(strippedText, strippedQuote, {\r\n      prefix: strippedPrefix,\r\n      suffix: strippedSuffix,\r\n      hint: strippedHint,\r\n    });\r\n\r\n    if (!match) {\r\n      continue;\r\n    }\r\n\r\n    if (!bestMatch || match.score > bestMatch.match.score) {\r\n      // Translate match offset from whitespace-stripped version of page text\r\n      // back to original text.\r\n      const [start, end] = translateOffsets(\r\n        strippedText,\r\n        text,\r\n        match.start,\r\n        match.end,\r\n        isNotSpace\r\n      );\r\n      bestMatch = {\r\n        page,\r\n        match: {\r\n          start,\r\n          end,\r\n          score: match.score,\r\n        },\r\n      };\r\n\r\n      // If we find a very good match, stop early.\r\n      //\r\n      // There is a tradeoff here between optimizing search performance and\r\n      // ensuring that we have found the best match in the document.\r\n      //\r\n      // The current heuristics are that we require an exact match for the quote\r\n      // and either the preceding or following context. The context matching\r\n      // helps to avoid incorrectly stopping the search early if the quote is\r\n      // a word or phrase that is common in the document.\r\n      const exactQuoteMatch =\r\n        strippedText.slice(match.start, match.end) === strippedQuote;\r\n\r\n      const exactPrefixMatch =\r\n        strippedPrefix !== undefined &&\r\n        strippedText.slice(\r\n          Math.max(0, match.start - strippedPrefix.length),\r\n          match.start\r\n        ) === strippedPrefix;\r\n\r\n      const exactSuffixMatch =\r\n        strippedSuffix !== undefined &&\r\n        strippedText.slice(match.end, strippedSuffix.length) === strippedSuffix;\r\n\r\n      const hasContext =\r\n        strippedPrefix !== undefined || strippedSuffix !== undefined;\r\n\r\n      if (\r\n        exactQuoteMatch &&\r\n        (exactPrefixMatch || exactSuffixMatch || !hasContext)\r\n      ) {\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (bestMatch) {\r\n    const { page, match } = bestMatch;\r\n\r\n    // If we found a match, optimize future anchoring of this selector in the\r\n    // same session by caching the match location.\r\n    if (positionHint) {\r\n      const cacheKey = quotePositionCacheKey(quoteSelector.exact, positionHint);\r\n      quotePositionCache.set(cacheKey, {\r\n        pageIndex: page,\r\n        anchor: match,\r\n      });\r\n    }\r\n\r\n    // Convert the (start, end) position match into a DOM range.\r\n    return anchorByPosition(page, match.start, match.end);\r\n  }\r\n\r\n  throw new Error('Quote not found');\r\n}\r\n\r\n/**\r\n * Anchor a set of selectors to a DOM Range.\r\n *\r\n * `selectors` must include a `TextQuoteSelector` and may include other selector\r\n * types.\r\n *\r\n * @param {HTMLElement} root\r\n * @param {Selector[]} selectors\r\n * @return {Promise<Range>}\r\n */\r\nexport async function anchor(root, selectors) {\r\n  const quote = /** @type {TextQuoteSelector|undefined} */ (\r\n    selectors.find(s => s.type === 'TextQuoteSelector')\r\n  );\r\n\r\n  // The quote selector is required in order to check that text position\r\n  // selector results are still valid.\r\n  if (!quote) {\r\n    throw new Error('No quote selector found');\r\n  }\r\n\r\n  const position = /** @type {TextPositionSelector|undefined} */ (\r\n    selectors.find(s => s.type === 'TextPositionSelector')\r\n  );\r\n\r\n  if (position) {\r\n    // If we have a position selector, try using that first as it is the fastest\r\n    // anchoring method.\r\n    try {\r\n      const { index, offset, text } = await findPageByOffset(position.start);\r\n      const start = position.start - offset;\r\n      const end = position.end - offset;\r\n\r\n      const matchedText = text.substring(start, end);\r\n      if (quote.exact !== matchedText) {\r\n        throw new Error('quote mismatch');\r\n      }\r\n\r\n      const range = await anchorByPosition(index, start, end);\r\n      return range;\r\n    } catch {\r\n      // Fall back to quote selector\r\n    }\r\n\r\n    // If anchoring with the position failed, check for a cached quote-based\r\n    // match using the quote + position as a cache key.\r\n    try {\r\n      const cacheKey = quotePositionCacheKey(quote.exact, position.start);\r\n      const cachedPos = quotePositionCache.get(cacheKey);\r\n      if (cachedPos) {\r\n        const { pageIndex, anchor } = cachedPos;\r\n        const range = await anchorByPosition(\r\n          pageIndex,\r\n          anchor.start,\r\n          anchor.end\r\n        );\r\n        return range;\r\n      }\r\n    } catch {\r\n      // Fall back to uncached quote selector match\r\n    }\r\n  }\r\n\r\n  return anchorQuote(quote, position?.start);\r\n}\r\n\r\n/**\r\n * Prepare a DOM range for generating selectors and find the containing text layer.\r\n *\r\n * @param {Range} range\r\n * @return {[Range, Element]}\r\n * @throws If the range cannot be annotated\r\n */\r\nfunction getTextLayerForRange(range) {\r\n  // \"Shrink\" the range so that the start and endpoints are at offsets within\r\n  // text nodes rather than any containing nodes.\r\n  try {\r\n    range = TextRange.fromRange(range).toRange();\r\n  } catch {\r\n    throw new Error('Selection does not contain text');\r\n  }\r\n\r\n  const startTextLayer = getNodeTextLayer(range.startContainer);\r\n  const endTextLayer = getNodeTextLayer(range.endContainer);\r\n\r\n  if (!startTextLayer || !endTextLayer) {\r\n    throw new Error('Selection is outside page text');\r\n  }\r\n\r\n  if (startTextLayer !== endTextLayer) {\r\n    throw new Error('Selecting across page breaks is not supported');\r\n  }\r\n\r\n  return [range, startTextLayer];\r\n}\r\n\r\n/**\r\n * Return true if selectors can be generated for a range using `describe`.\r\n *\r\n * This function is faster than calling `describe` if the selectors are not\r\n * required.\r\n *\r\n * @param {Range} range\r\n */\r\nexport function canDescribe(range) {\r\n  try {\r\n    getTextLayerForRange(range);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Convert a DOM Range object into a set of selectors.\r\n *\r\n * Converts a DOM `Range` object into a `[position, quote]` tuple of selectors\r\n * which can be saved with an annotation and later passed to `anchor` to\r\n * convert the selectors back to a `Range`.\r\n *\r\n * @param {HTMLElement} root - The root element\r\n * @param {Range} range\r\n * @return {Promise<Selector[]>}\r\n */\r\nexport async function describe(root, range) {\r\n  const [textRange, textLayer] = getTextLayerForRange(range);\r\n\r\n  const startPos = TextPosition.fromPoint(\r\n    textRange.startContainer,\r\n    textRange.startOffset\r\n  ).relativeTo(textLayer);\r\n\r\n  const endPos = TextPosition.fromPoint(\r\n    textRange.endContainer,\r\n    textRange.endOffset\r\n  ).relativeTo(textLayer);\r\n\r\n  const startPageIndex = getSiblingIndex(\r\n    /** @type {Node} */ (textLayer.parentNode)\r\n  );\r\n  const pageOffset = await getPageOffset(startPageIndex);\r\n\r\n  /** @type {TextPositionSelector} */\r\n  const position = {\r\n    type: 'TextPositionSelector',\r\n    start: pageOffset + startPos.offset,\r\n    end: pageOffset + endPos.offset,\r\n  };\r\n\r\n  const quote = TextQuoteAnchor.fromRange(root, textRange).toSelector();\r\n\r\n  return [position, quote];\r\n}\r\n\r\n/**\r\n * Clear this module's internal caches.\r\n *\r\n * This exists mainly as a helper for use in tests.\r\n */\r\nexport function purgeCache() {\r\n  pageTextCache.clear();\r\n  quotePositionCache.clear();\r\n}\r\n","/**\r\n * Render banners at the top of a document in a stacked column.\r\n *\r\n * @param {object} props\r\n *   @param {import(\"preact\").ComponentChildren} props.children\r\n */\r\nexport default function Banners({ children }) {\r\n  return <div className=\"flex flex-col\">{children}</div>;\r\n}\r\n","import classnames from 'classnames';\r\n\r\nimport {\r\n  Link,\r\n  LinkBase,\r\n  CaretLeftIcon,\r\n  CaretRightIcon,\r\n} from '@hypothesis/frontend-shared/lib/next';\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').ContentInfoConfig} ContentInfoConfig\r\n */\r\n\r\n/**\r\n * A banner that displays information about the current document and the entity\r\n * that is providing access to it (eg. JSTOR).\r\n *\r\n * Layout columns:\r\n *  - Logo\r\n *  - Container title (only shown on screens at `2xl` breakpoint and wider)\r\n *  - Item title with previous and next links\r\n *\r\n * @param {object} props\r\n *   @param {ContentInfoConfig} props.info\r\n */\r\nexport default function ContentInfoBanner({ info }) {\r\n  // Format item title to show subtitle\r\n  let itemTitle = info.item.title;\r\n  if (info.item.subtitle) {\r\n    itemTitle += `: ${info.item.subtitle}`;\r\n  }\r\n  return (\r\n    <div\r\n      className={classnames(\r\n        'h-10 bg-white px-4 text-slate-7 text-annotator-base border-b',\r\n        'grid items-center',\r\n        // Two columns in narrower viewports; three in wider\r\n        'grid-cols-[100px_minmax(0,auto)]',\r\n        '2xl:grid-cols-[100px_minmax(0,auto)_minmax(0,auto)] 2xl:gap-x-3'\r\n      )}\r\n    >\r\n      <div data-testid=\"content-logo\">\r\n        {info.logo && (\r\n          <Link href={info.logo.link} target=\"_blank\" data-testid=\"logo-link\">\r\n            <img\r\n              alt={info.logo.title}\r\n              src={info.logo.logo}\r\n              data-testid=\"logo-image\"\r\n            />\r\n          </Link>\r\n        )}\r\n      </div>\r\n      <div\r\n        className={classnames(\r\n          // Container title (this element) is not shown on narrow screens\r\n          'hidden',\r\n          '2xl:block 2xl:whitespace-nowrap 2xl:overflow-hidden 2xl:text-ellipsis',\r\n          'font-semibold'\r\n        )}\r\n        data-testid=\"content-container-info\"\r\n        title={info.container.title}\r\n      >\r\n        {info.container.title}\r\n      </div>\r\n      <div\r\n        className={classnames(\r\n          // Flex layout for item title, next and previous links\r\n          'flex justify-center items-center gap-x-2'\r\n        )}\r\n        data-testid=\"content-item-info\"\r\n      >\r\n        <div\r\n          className={classnames(\r\n            // Narrower viewports center this flex content:\r\n            // this element is not needed for alignment\r\n            'hidden',\r\n            // Wider viewports align this flex content to the right:\r\n            // This empty element is needed to fill extra space at left\r\n            '2xl:block 2xl:grow'\r\n          )}\r\n        />\r\n        {info.links.previousItem && (\r\n          <>\r\n            <Link\r\n              classes=\"flex gap-x-1 items-center text-annotator-sm whitespace-nowrap\"\r\n              title=\"Open previous item\"\r\n              href={info.links.previousItem}\r\n              underline=\"always\"\r\n              target=\"_blank\"\r\n              data-testid=\"content-previous-link\"\r\n            >\r\n              <CaretLeftIcon className=\"w-em h-em\" />\r\n              <span>Previous</span>\r\n            </Link>\r\n            <div className=\"text-annotator-sm\">|</div>\r\n          </>\r\n        )}\r\n        <div\r\n          className={classnames(\r\n            // This element will shrink and truncate fluidly.\r\n            // Overriding min-width `auto` prevents the content from overflowing\r\n            // See https://stackoverflow.com/a/66689926/434243.\r\n            'min-w-0 whitespace-nowrap overflow-hidden text-ellipsis shrink font-medium'\r\n          )}\r\n        >\r\n          <LinkBase\r\n            title={itemTitle}\r\n            href={info.links.currentItem}\r\n            data-testid=\"content-item-link\"\r\n            target=\"_blank\"\r\n            unstyled\r\n          >\r\n            {itemTitle}\r\n          </LinkBase>\r\n        </div>\r\n\r\n        {info.links.nextItem && (\r\n          <>\r\n            <div className=\"text-annotator-sm\">|</div>\r\n            <Link\r\n              title=\"Open next item\"\r\n              classes=\"flex gap-x-1 items-center text-annotator-sm whitespace-nowrap\"\r\n              href={info.links.nextItem}\r\n              underline=\"always\"\r\n              target=\"_blank\"\r\n              data-testid=\"content-next-link\"\r\n            >\r\n              <span>Next</span>\r\n              <CaretRightIcon className=\"w-em h-em\" />\r\n            </Link>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { Icon, Link } from '@hypothesis/frontend-shared';\r\nimport classnames from 'classnames';\r\n\r\n/**\r\n * A banner shown at the top of the PDF viewer if the PDF cannot be annotated\r\n * by Hypothesis.\r\n */\r\nexport default function WarningBanner() {\r\n  return (\r\n    <div className=\"bg-white\">\r\n      <div\r\n        className={classnames(\r\n          'flex items-center gap-x-2',\r\n          'border border-yellow-notice bg-yellow-notice/10 text-annotator-base'\r\n        )}\r\n      >\r\n        <div className=\"bg-yellow-notice text-white p-2\">\r\n          <Icon name=\"caution\" classes=\"text-annotator-xl\" />\r\n        </div>\r\n        <div>\r\n          <strong>This PDF does not contain selectable text:</strong>{' '}\r\n          <Link\r\n            target=\"_blank\"\r\n            href=\"https://web.hypothes.is/help/how-to-ocr-optimize-pdfs/\"\r\n          >\r\n            Learn how to fix this\r\n          </Link>{' '}\r\n          in order to annotate with Hypothesis.\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { normalizeURI } from '../util/url';\r\n\r\n/**\r\n * @typedef {import('../../types/pdfjs').PDFViewerApplication} PDFViewerApplication\r\n */\r\n\r\n/**\r\n * @typedef Link\r\n * @prop {string} href\r\n */\r\n\r\n/**\r\n * @typedef Metadata\r\n * @prop {string} title - The document title\r\n * @prop {Link[]} link - Array of URIs associated with this document\r\n * @prop {string} documentFingerprint - The fingerprint of this PDF. This is\r\n *   referred to as the \"File Identifier\" in the PDF spec. It may be a hash of\r\n *   part of the content if the PDF file does not have a File Identifier.\r\n *\r\n *   PDFs may have two file identifiers. The first is the \"original\" identifier\r\n *   which is not supposed to change if the file is updated and the second\r\n *   one is the \"last modified\" identifier. This property is the original\r\n *   identifier.\r\n */\r\n\r\n/**\r\n * Wait for a PDFViewerApplication to be initialized.\r\n *\r\n * @param {PDFViewerApplication} app\r\n * @return {Promise<void>}\r\n */\r\nfunction pdfViewerInitialized(app) {\r\n  // `initializedPromise` was added in PDF.js v2.4.456.\r\n  // See https://github.com/mozilla/pdf.js/pull/11607. In earlier versions the\r\n  // `initialized` property can be queried.\r\n  if (app.initializedPromise) {\r\n    return app.initializedPromise;\r\n  } else if (app.initialized) {\r\n    return Promise.resolve();\r\n  } else {\r\n    // PDF.js < v2.4.456. The recommended approach is to listen for a `localized`\r\n    // DOM event, but this assumes that PDF.js has been configured to publish\r\n    // events to the DOM. Here we simply poll `app.initialized` because it is\r\n    // easier.\r\n    return new Promise(resolve => {\r\n      const timeout = setInterval(() => {\r\n        if (app.initialized) {\r\n          clearTimeout(timeout);\r\n          resolve();\r\n        }\r\n      }, 5);\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * PDFMetadata extracts metadata about a loading/loaded PDF document from a\r\n * PDF.js PDFViewerApplication object.\r\n *\r\n * @example\r\n * // Invoke in a PDF.js viewer, before or after the PDF has finished loading.\r\n * const meta = new PDFMetadata(window.PDFViewerApplication)\r\n * meta.getUri().then(uri => {\r\n *    // Do something with the URL of the PDF.\r\n * })\r\n */\r\nexport class PDFMetadata {\r\n  /**\r\n   * Construct a `PDFMetadata` that returns URIs/metadata associated with a\r\n   * given PDF viewer.\r\n   *\r\n   * @param {PDFViewerApplication} app - The `PDFViewerApplication` global from PDF.js\r\n   */\r\n  constructor(app) {\r\n    /** @type {Promise<PDFViewerApplication>} */\r\n    this._loaded = pdfViewerInitialized(app).then(() => {\r\n      // Check if document has already loaded.\r\n      if (app.downloadComplete) {\r\n        return app;\r\n      }\r\n\r\n      return new Promise(resolve => {\r\n        const finish = () => {\r\n          if (app.eventBus) {\r\n            app.eventBus.off('documentload', finish);\r\n            app.eventBus.off('documentloaded', finish);\r\n          } else {\r\n            window.removeEventListener('documentload', finish);\r\n          }\r\n          resolve(app);\r\n        };\r\n\r\n        // Listen for \"documentloaded\" event which signals that the document\r\n        // has been downloaded and the first page has been rendered.\r\n        if (app.eventBus) {\r\n          // PDF.js >= v1.6.210 dispatch events via an internal event bus.\r\n          // PDF.js < v2.5.207 also dispatches events to the DOM.\r\n\r\n          // `documentloaded` is the preferred event in PDF.js >= v2.0.943.\r\n          // See https://github.com/mozilla/pdf.js/commit/7bc4bfcc8b7f52b14107f0a551becdf01643c5c2\r\n          app.eventBus.on('documentloaded', finish);\r\n\r\n          // `documentload` is dispatched by PDF.js < v2.1.266.\r\n          app.eventBus.on('documentload', finish);\r\n        } else {\r\n          // PDF.js < v1.6.210 dispatches events only to the DOM.\r\n          window.addEventListener('documentload', finish);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Return the URI of the PDF.\r\n   *\r\n   * If the PDF is currently loading, the returned promise resolves once loading\r\n   * is complete.\r\n   *\r\n   * @return {Promise<string>}\r\n   */\r\n  getUri() {\r\n    return this._loaded.then(app => {\r\n      let uri = getPDFURL(app);\r\n      if (!uri) {\r\n        uri = fingerprintToURN(getFingerprint(app));\r\n      }\r\n      return uri;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns metadata about the document.\r\n   *\r\n   * If the PDF is currently loading, the returned promise resolves once loading\r\n   * is complete.\r\n   *\r\n   * @return {Promise<Metadata>}\r\n   */\r\n  async getMetadata() {\r\n    const app = await this._loaded;\r\n    const {\r\n      info: documentInfo,\r\n      contentDispositionFilename,\r\n      metadata,\r\n    } = await app.pdfDocument.getMetadata();\r\n\r\n    const documentFingerprint = getFingerprint(app);\r\n    const url = getPDFURL(app);\r\n\r\n    // Return the title metadata embedded in the PDF if available, otherwise\r\n    // fall back to values from the `Content-Disposition` header or URL.\r\n    //\r\n    // PDFs contain two embedded metadata sources, the metadata stream and\r\n    // the document info dictionary. Per the specification, the metadata stream\r\n    // is preferred if available.\r\n    //\r\n    // This logic is similar to how PDF.js sets `document.title`.\r\n    let title;\r\n    if (metadata?.has('dc:title') && metadata.get('dc:title') !== 'Untitled') {\r\n      title = /** @type {string} */ (metadata.get('dc:title'));\r\n    } else if (documentInfo?.Title) {\r\n      title = documentInfo.Title;\r\n    } else if (contentDispositionFilename) {\r\n      title = contentDispositionFilename;\r\n    } else if (url) {\r\n      title = filenameFromURL(url);\r\n    } else {\r\n      title = '';\r\n    }\r\n\r\n    const link = [{ href: fingerprintToURN(documentFingerprint) }];\r\n    if (url) {\r\n      link.push({ href: url });\r\n    }\r\n\r\n    return {\r\n      title,\r\n      link,\r\n      documentFingerprint,\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Get the fingerprint/file identifier of the currently loaded PDF.\r\n *\r\n * @param {PDFViewerApplication} app\r\n */\r\nfunction getFingerprint(app) {\r\n  if (Array.isArray(app.pdfDocument.fingerprints)) {\r\n    return app.pdfDocument.fingerprints[0];\r\n  } else {\r\n    return /** @type {string} */ (app.pdfDocument.fingerprint);\r\n  }\r\n}\r\n\r\n/**\r\n * Generate a URI from a PDF fingerprint suitable for storing as the main\r\n * or associated URI of an annotation.\r\n *\r\n * @param {string} fingerprint\r\n */\r\nfunction fingerprintToURN(fingerprint) {\r\n  return `urn:x-pdf:${fingerprint}`;\r\n}\r\n\r\n/**\r\n * @param {PDFViewerApplication} app\r\n * @return {string|null} - Valid URL string or `null`\r\n */\r\nfunction getPDFURL(app) {\r\n  if (!app.url) {\r\n    return null;\r\n  }\r\n\r\n  const url = normalizeURI(app.url);\r\n\r\n  // Local file:// URLs should not be saved in document metadata.\r\n  // Entries in document.link should be URIs. In the case of\r\n  // local files, omit the URL.\r\n  if (url.indexOf('file://') !== 0) {\r\n    return url;\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Return the last component of the path part of a URL.\r\n *\r\n * @param {string} url - A valid URL string\r\n * @return {string}\r\n */\r\nfunction filenameFromURL(url) {\r\n  const parsed = new URL(url);\r\n  const pathSegments = parsed.pathname.split('/');\r\n  return pathSegments[pathSegments.length - 1];\r\n}\r\n","import debounce from 'lodash.debounce';\r\nimport { render } from 'preact';\r\nimport { TinyEmitter } from 'tiny-emitter';\r\n\r\nimport { ListenerCollection } from '../../shared/listener-collection';\r\nimport {\r\n  RenderingStates,\r\n  anchor,\r\n  canDescribe,\r\n  describe,\r\n  documentHasText,\r\n} from '../anchoring/pdf';\r\nimport { isInPlaceholder, removePlaceholder } from '../anchoring/placeholder';\r\nimport Banners from '../components/Banners';\r\nimport ContentInfoBanner from '../components/ContentInfoBanner';\r\nimport WarningBanner from '../components/WarningBanner';\r\nimport { createShadowRoot } from '../util/shadow-root';\r\nimport { offsetRelativeTo, scrollElement } from '../util/scroll';\r\n\r\nimport { PDFMetadata } from './pdf-metadata';\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').Anchor} Anchor\r\n * @typedef {import('../../types/annotator').AnnotationData} AnnotationData\r\n * @typedef {import('../../types/annotator').Annotator} Annotator\r\n * @typedef {import('../../types/annotator').ContentInfoConfig} ContentInfoConfig\r\n * @typedef {import('../../types/annotator').HypothesisWindow} HypothesisWindow\r\n * @typedef {import('../../types/annotator').Integration} Integration\r\n * @typedef {import('../../types/annotator').SidebarLayout} SidebarLayout\r\n * @typedef {import('../../types/api').Selector} Selector\r\n * @typedef {import('../../types/pdfjs').PDFViewerApplication} PDFViewerApplication\r\n */\r\n\r\n// The viewport and controls for PDF.js start breaking down below about 670px\r\n// of available space, so only render PDF and sidebar side-by-side if there\r\n// is enough room. Otherwise, allow sidebar to overlap PDF\r\nconst MIN_PDF_WIDTH = 680;\r\n\r\n/**\r\n * Return true if `anchor` is in an un-rendered page.\r\n *\r\n * @param {Anchor} anchor\r\n */\r\nfunction anchorIsInPlaceholder(anchor) {\r\n  const highlight = anchor.highlights?.[0];\r\n  return highlight && isInPlaceholder(highlight);\r\n}\r\n\r\n/** @param {number} ms */\r\nfunction delay(ms) {\r\n  return new Promise(resolve => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * Is the current document the PDF.js viewer application?\r\n */\r\nexport function isPDF() {\r\n  // @ts-ignore - TS doesn't know about PDFViewerApplication global.\r\n  return typeof PDFViewerApplication !== 'undefined';\r\n}\r\n\r\n/**\r\n * Integration that works with PDF.js\r\n * @implements {Integration}\r\n */\r\nexport class PDFIntegration extends TinyEmitter {\r\n  /**\r\n   * @param {Annotator} annotator\r\n   * @param {object} options\r\n   *   @param {number} [options.reanchoringMaxWait] - Max time to wait for\r\n   *     re-anchoring to complete when scrolling to an un-rendered page.\r\n   */\r\n  constructor(annotator, options = {}) {\r\n    super();\r\n\r\n    this.annotator = annotator;\r\n\r\n    const window_ = /** @type {HypothesisWindow} */ (window);\r\n\r\n    // Assume this class is only used if we're in the PDF.js viewer.\r\n    const pdfViewerApp = /** @type {PDFViewerApplication} */ (\r\n      window_.PDFViewerApplication\r\n    );\r\n\r\n    this.pdfViewer = pdfViewerApp.pdfViewer;\r\n    this.pdfViewer.viewer.classList.add('has-transparent-text-layer');\r\n\r\n    // Get the element that contains all of the PDF.js UI. This is typically\r\n    // `document.body`.\r\n    this.pdfContainer = pdfViewerApp.appConfig?.appContainer ?? document.body;\r\n\r\n    this.pdfMetadata = new PDFMetadata(pdfViewerApp);\r\n\r\n    this.observer = new MutationObserver(debounce(() => this._update(), 100));\r\n    this.observer.observe(this.pdfViewer.viewer, {\r\n      attributes: true,\r\n      attributeFilter: ['data-loaded'],\r\n      childList: true,\r\n      subtree: true,\r\n    });\r\n\r\n    /**\r\n     * Amount of time to wait for re-anchoring to complete when scrolling to\r\n     * an anchor in a not-yet-rendered page.\r\n     */\r\n    this._reanchoringMaxWait = options.reanchoringMaxWait ?? 3000;\r\n\r\n    /**\r\n     * Banners shown at the top of the PDF viewer.\r\n     *\r\n     * @type {HTMLElement|null}\r\n     */\r\n    this._banner = null;\r\n\r\n    /** State indicating which banners to show above the PDF viewer. */\r\n    this._bannerState = {\r\n      /** @type {ContentInfoConfig|null} */\r\n      contentInfo: null,\r\n      /** Warning that the current PDF does not have selectable text. */\r\n      noTextWarning: false,\r\n    };\r\n    this._updateBannerState(this._bannerState);\r\n    this._checkForSelectableText();\r\n\r\n    // Hide annotation layer when the user is making a selection. The annotation\r\n    // layer appears above the invisible text layer and can interfere with text\r\n    // selection. See https://github.com/hypothesis/client/issues/1464.\r\n    this._updateAnnotationLayerVisibility = () => {\r\n      const selection = /** @type {Selection} */ (window_.getSelection());\r\n\r\n      // Add CSS class to indicate whether there is a selection. Annotation\r\n      // layers are then hidden by a CSS rule in `pdfjs-overrides.scss`.\r\n      this.pdfViewer.viewer.classList.toggle(\r\n        'is-selecting',\r\n        !selection.isCollapsed\r\n      );\r\n    };\r\n\r\n    this._listeners = new ListenerCollection();\r\n    this._listeners.add(\r\n      document,\r\n      'selectionchange',\r\n      this._updateAnnotationLayerVisibility\r\n    );\r\n\r\n    // A flag that indicates whether `destroy` has been called. Used to handle\r\n    // `destroy` being called during async code elsewhere in the class.\r\n    this._destroyed = false;\r\n  }\r\n\r\n  destroy() {\r\n    this._listeners.removeAll();\r\n    this.pdfViewer.viewer.classList.remove('has-transparent-text-layer');\r\n    this.observer.disconnect();\r\n    this._banner?.remove();\r\n    this._destroyed = true;\r\n  }\r\n\r\n  /**\r\n   * Return the URL of the currently loaded PDF document.\r\n   */\r\n  uri() {\r\n    return this.pdfMetadata.getUri();\r\n  }\r\n\r\n  /**\r\n   * Return the metadata (eg. title) for the currently loaded PDF document.\r\n   */\r\n  getMetadata() {\r\n    return this.pdfMetadata.getMetadata();\r\n  }\r\n\r\n  /**\r\n   * Display a banner at the top of the PDF viewer showing information about the\r\n   * current document.\r\n   *\r\n   * @param {ContentInfoConfig} contentInfo\r\n   */\r\n  showContentInfo(contentInfo) {\r\n    this._updateBannerState({ contentInfo });\r\n  }\r\n\r\n  /**\r\n   * Resolve serialized `selectors` from an annotation to a range.\r\n   *\r\n   * @param {HTMLElement} root\r\n   * @param {Selector[]} selectors\r\n   * @return {Promise<Range>}\r\n   */\r\n  anchor(root, selectors) {\r\n    // nb. The `root` argument is not really used by `anchor`. It existed for\r\n    // consistency between HTML and PDF anchoring and could be removed.\r\n    return anchor(root, selectors);\r\n  }\r\n\r\n  /**\r\n   * Return true if the text in a range lies within the text layer of a PDF.\r\n   *\r\n   * @param {Range} range\r\n   */\r\n  canAnnotate(range) {\r\n    return canDescribe(range);\r\n  }\r\n\r\n  /**\r\n   * Generate selectors for the text in `range`.\r\n   *\r\n   * @param {HTMLElement} root\r\n   * @param {Range} range\r\n   * @return {Promise<Selector[]>}\r\n   */\r\n  describe(root, range) {\r\n    // nb. The `root` argument is not really used by `anchor`. It existed for\r\n    // consistency between HTML and PDF anchoring and could be removed.\r\n    return describe(root, range);\r\n  }\r\n\r\n  /**\r\n   * Check whether the PDF has selectable text and show a warning if not.\r\n   */\r\n  async _checkForSelectableText() {\r\n    // Wait for PDF to load.\r\n    try {\r\n      await this.uri();\r\n    } catch (e) {\r\n      return;\r\n    }\r\n\r\n    // Handle `PDF` instance being destroyed while URI is fetched. This is only\r\n    // expected to happen in synchronous tests.\r\n    if (this._destroyed) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const hasText = await documentHasText();\r\n      this._updateBannerState({ noTextWarning: !hasText });\r\n    } catch (err) {\r\n      /* istanbul ignore next */\r\n      console.warn('Unable to check for text in PDF:', err);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update banners shown above the PDF viewer.\r\n   *\r\n   * @param {Partial<typeof PDFIntegration.prototype._bannerState>} state\r\n   */\r\n  _updateBannerState(state) {\r\n    this._bannerState = { ...this._bannerState, ...state };\r\n\r\n    // Get a reference to the top-level DOM element associated with the PDF.js\r\n    // viewer.\r\n    const outerContainer = /** @type {HTMLElement} */ (\r\n      document.querySelector('#outerContainer')\r\n    );\r\n\r\n    const showBanner =\r\n      this._bannerState.contentInfo || this._bannerState.noTextWarning;\r\n\r\n    if (!showBanner) {\r\n      this._banner?.remove();\r\n      this._banner = null;\r\n\r\n      // Undo inline styles applied when the banner is shown. The banner will\r\n      // then gets its normal 100% height set by PDF.js's CSS.\r\n      outerContainer.style.height = '';\r\n\r\n      return;\r\n    }\r\n\r\n    if (!this._banner) {\r\n      this._banner = document.createElement('hypothesis-banner');\r\n      document.body.prepend(this._banner);\r\n      createShadowRoot(this._banner);\r\n    }\r\n\r\n    render(\r\n      <Banners>\r\n        {this._bannerState.contentInfo && (\r\n          <ContentInfoBanner info={this._bannerState.contentInfo} />\r\n        )}\r\n        {this._bannerState.noTextWarning && <WarningBanner />}\r\n      </Banners>,\r\n      /** @type {ShadowRoot} */ (this._banner.shadowRoot)\r\n    );\r\n\r\n    const bannerHeight = this._banner.getBoundingClientRect().height;\r\n\r\n    // The `#outerContainer` element normally has height set to 100% of the body.\r\n    //\r\n    // Reduce this by the height of the banner so that it doesn't extend beyond\r\n    // the bottom of the viewport.\r\n    //\r\n    // We don't currently handle the height of the banner changing here.\r\n    outerContainer.style.height = `calc(100% - ${bannerHeight}px)`;\r\n  }\r\n\r\n  // This method (re-)anchors annotations when pages are rendered and destroyed.\r\n  _update() {\r\n    // A list of annotations that need to be refreshed.\r\n    const refreshAnnotations = /** @type {AnnotationData[]} */ ([]);\r\n\r\n    const pageCount = this.pdfViewer.pagesCount;\r\n    for (let pageIndex = 0; pageIndex < pageCount; pageIndex++) {\r\n      const page = this.pdfViewer.getPageView(pageIndex);\r\n      if (!page?.textLayer?.renderingDone) {\r\n        continue;\r\n      }\r\n\r\n      // Detect what needs to be done by checking the rendering state.\r\n      switch (page.renderingState) {\r\n        case RenderingStates.INITIAL:\r\n          // This page has been reset to its initial state so its text layer\r\n          // is no longer valid. Null it out so that we don't process it again.\r\n          page.textLayer = null;\r\n          break;\r\n        case RenderingStates.FINISHED:\r\n          // This page is still rendered. If it has a placeholder node that\r\n          // means the PDF anchoring module anchored annotations before it was\r\n          // rendered. Remove this, which will cause the annotations to anchor\r\n          // again, below.\r\n          removePlaceholder(page.div);\r\n          break;\r\n      }\r\n    }\r\n\r\n    // Find all the anchors that have been invalidated by page state changes.\r\n    for (let anchor of this.annotator.anchors) {\r\n      // Skip any we already know about.\r\n      if (anchor.highlights) {\r\n        if (refreshAnnotations.includes(anchor.annotation)) {\r\n          continue;\r\n        }\r\n\r\n        // If the highlights are no longer in the document it means that either\r\n        // the page was destroyed by PDF.js or the placeholder was removed above.\r\n        // The annotations for these anchors need to be refreshed.\r\n        for (let index = 0; index < anchor.highlights.length; index++) {\r\n          const hl = anchor.highlights[index];\r\n          if (!document.body.contains(hl)) {\r\n            anchor.highlights.splice(index, 1);\r\n            delete anchor.range;\r\n            refreshAnnotations.push(anchor.annotation);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    refreshAnnotations.map(annotation => this.annotator.anchor(annotation));\r\n  }\r\n\r\n  /**\r\n   * Return the scrollable element which contains the document content.\r\n   *\r\n   * @return {HTMLElement}\r\n   */\r\n  contentContainer() {\r\n    return /** @type {HTMLElement} */ (\r\n      document.querySelector('#viewerContainer')\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Attempt to make the PDF viewer and the sidebar fit side-by-side without\r\n   * overlap if there is enough room in the viewport to do so reasonably.\r\n   * Resize the PDF viewer container element to leave the right amount of room\r\n   * for the sidebar, and prompt PDF.js to re-render the PDF pages to scale\r\n   * within that resized container.\r\n   *\r\n   * @param {SidebarLayout} sidebarLayout\r\n   * @return {boolean} - True if side-by-side mode was activated\r\n   */\r\n  fitSideBySide(sidebarLayout) {\r\n    const maximumWidthToFit = window.innerWidth - sidebarLayout.width;\r\n    const active = sidebarLayout.expanded && maximumWidthToFit >= MIN_PDF_WIDTH;\r\n\r\n    // If the sidebar is closed, we reserve enough space for the toolbar controls\r\n    // so that they don't overlap a) the chevron-menu on the right side of\r\n    // PDF.js's top toolbar and b) the document's scrollbar.\r\n    //\r\n    // If the sidebar is open, we reserve space for the whole sidebar if there is\r\n    // room, otherwise we reserve the same space as in the closed state to\r\n    // prevent the PDF content shifting when opening and closing the sidebar.\r\n    const reservedSpace = active\r\n      ? sidebarLayout.width\r\n      : sidebarLayout.toolbarWidth;\r\n    this.pdfContainer.style.width = `calc(100% - ${reservedSpace}px)`;\r\n\r\n    // The following logic is pulled from PDF.js `webViewerResize`\r\n    const currentScaleValue = this.pdfViewer.currentScaleValue;\r\n    if (\r\n      currentScaleValue === 'auto' ||\r\n      currentScaleValue === 'page-fit' ||\r\n      currentScaleValue === 'page-width'\r\n    ) {\r\n      // NB: There is logic within the setter for `currentScaleValue`\r\n      // Setting this scale value will prompt PDF.js to recalculate viewport\r\n      this.pdfViewer.currentScaleValue = currentScaleValue;\r\n    }\r\n    // This will cause PDF pages to re-render if their scaling has changed\r\n    this.pdfViewer.update();\r\n\r\n    return active;\r\n  }\r\n\r\n  /**\r\n   * Scroll to the location of an anchor in the PDF.\r\n   *\r\n   * If the anchor refers to a location that is an un-rendered page far from\r\n   * the viewport, then scrolling happens in three phases. First the document\r\n   * scrolls to the approximate location indicated by the placeholder anchor,\r\n   * then `scrollToAnchor` waits until the page's text layer is rendered and\r\n   * the annotation is re-anchored in the fully rendered page. Then it scrolls\r\n   * again to the final location.\r\n   *\r\n   * @param {Anchor} anchor\r\n   */\r\n  async scrollToAnchor(anchor) {\r\n    const annotation = anchor.annotation;\r\n    const inPlaceholder = anchorIsInPlaceholder(anchor);\r\n    const offset = this._anchorOffset(anchor);\r\n    if (offset === null) {\r\n      return;\r\n    }\r\n\r\n    // nb. We only compute the scroll offset once at the start of scrolling.\r\n    // This is important as the highlight may be removed from the document during\r\n    // the scroll due to a page transitioning from rendered <-> un-rendered.\r\n    await scrollElement(this.contentContainer(), offset);\r\n\r\n    if (inPlaceholder) {\r\n      const anchor = await this._waitForAnnotationToBeAnchored(\r\n        annotation,\r\n        this._reanchoringMaxWait\r\n      );\r\n      if (!anchor) {\r\n        return;\r\n      }\r\n      const offset = this._anchorOffset(anchor);\r\n      if (offset === null) {\r\n        return;\r\n      }\r\n      await scrollElement(this.contentContainer(), offset);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Wait for an annotation to be anchored in a rendered page.\r\n   *\r\n   * @param {AnnotationData} annotation\r\n   * @param {number} maxWait\r\n   * @return {Promise<Anchor|null>}\r\n   */\r\n  async _waitForAnnotationToBeAnchored(annotation, maxWait) {\r\n    const start = Date.now();\r\n    let anchor;\r\n    do {\r\n      // nb. Re-anchoring might result in a different anchor object for the\r\n      // same annotation.\r\n      anchor = this.annotator.anchors.find(a => a.annotation === annotation);\r\n      if (!anchor || anchorIsInPlaceholder(anchor)) {\r\n        anchor = null;\r\n\r\n        // If no anchor was found, wait a bit longer and check again to see if\r\n        // re-anchoring completed.\r\n        await delay(20);\r\n      }\r\n    } while (!anchor && Date.now() - start < maxWait);\r\n    return anchor ?? null;\r\n  }\r\n\r\n  /**\r\n   * Return the offset that the PDF content container would need to be scrolled\r\n   * to, in order to make an anchor visible.\r\n   *\r\n   * @param {Anchor} anchor\r\n   * @return {number|null} - Target offset or `null` if this anchor was not resolved\r\n   */\r\n  _anchorOffset(anchor) {\r\n    if (!anchor.highlights) {\r\n      // This anchor was not resolved to a location in the document.\r\n      return null;\r\n    }\r\n    const highlight = anchor.highlights[0];\r\n    return offsetRelativeTo(highlight, this.contentContainer());\r\n  }\r\n}\r\n","import debounce from 'lodash.debounce';\r\n\r\nexport const DEBOUNCE_WAIT = 40;\r\n\r\n/** @typedef {(frame: HTMLIFrameElement) => void} FrameCallback */\r\n\r\n/**\r\n * FrameObserver detects iframes added and deleted from the document.\r\n *\r\n * To enable annotation, an iframe must be opted-in by adding the\r\n * `enable-annotation` attribute.\r\n *\r\n * We require the `enable-annotation` attribute to avoid the overhead of loading\r\n * the client into frames which are not useful to annotate. See\r\n * https://github.com/hypothesis/client/issues/530\r\n */\r\nexport class FrameObserver {\r\n  /**\r\n   * @param {Element} element - root of the DOM subtree to watch for the addition\r\n   *   and removal of annotatable iframes\r\n   * @param {FrameCallback} onFrameAdded - callback fired when an annotatable iframe is added\r\n   * @param {FrameCallback} onFrameRemoved - callback triggered when the annotatable iframe is removed\r\n   */\r\n  constructor(element, onFrameAdded, onFrameRemoved) {\r\n    this._element = element;\r\n    this._onFrameAdded = onFrameAdded;\r\n    this._onFrameRemoved = onFrameRemoved;\r\n    /** @type {Set<HTMLIFrameElement>} */\r\n    this._annotatableFrames = new Set();\r\n    this._isDisconnected = false;\r\n\r\n    this._mutationObserver = new MutationObserver(\r\n      debounce(() => {\r\n        this._discoverFrames();\r\n      }, DEBOUNCE_WAIT)\r\n    );\r\n    this._discoverFrames();\r\n    this._mutationObserver.observe(this._element, {\r\n      childList: true,\r\n      subtree: true,\r\n      attributeFilter: ['enable-annotation'],\r\n    });\r\n  }\r\n\r\n  disconnect() {\r\n    this._isDisconnected = true;\r\n    this._mutationObserver.disconnect();\r\n  }\r\n\r\n  /**\r\n   * @param {HTMLIFrameElement} frame\r\n   */\r\n  async _addFrame(frame) {\r\n    this._annotatableFrames.add(frame);\r\n    try {\r\n      await onNextDocumentReady(frame);\r\n      if (this._isDisconnected) {\r\n        return;\r\n      }\r\n      const frameWindow = frame.contentWindow;\r\n      // @ts-expect-error\r\n      // This line raises an exception if the iframe is from a different origin\r\n      frameWindow.addEventListener('unload', () => {\r\n        this._removeFrame(frame);\r\n      });\r\n      this._onFrameAdded(frame);\r\n    } catch (e) {\r\n      console.warn(\r\n        `Unable to inject the Hypothesis client (from '${document.location.href}' into a cross-origin frame '${frame.src}')`\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {HTMLIFrameElement} frame\r\n   */\r\n  _removeFrame(frame) {\r\n    this._annotatableFrames.delete(frame);\r\n    this._onFrameRemoved(frame);\r\n  }\r\n\r\n  _discoverFrames() {\r\n    const frames = new Set(\r\n      /** @type {NodeListOf<HTMLIFrameElement> } */ (\r\n        this._element.querySelectorAll('iframe[enable-annotation]')\r\n      )\r\n    );\r\n\r\n    for (let frame of frames) {\r\n      if (!this._annotatableFrames.has(frame)) {\r\n        this._addFrame(frame);\r\n      }\r\n    }\r\n\r\n    for (let frame of this._annotatableFrames) {\r\n      if (!frames.has(frame)) {\r\n        this._removeFrame(frame);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Test if this is the empty document that a new iframe has before the URL\r\n * specified by its `src` attribute loads.\r\n *\r\n * @param {HTMLIFrameElement} frame\r\n */\r\nfunction hasBlankDocumentThatWillNavigate(frame) {\r\n  return (\r\n    frame.contentDocument?.location.href === 'about:blank' &&\r\n    // Do we expect the frame to navigate away from about:blank?\r\n    frame.hasAttribute('src') &&\r\n    frame.src !== 'about:blank'\r\n  );\r\n}\r\n\r\n/**\r\n * Wrapper around {@link onDocumentReady} which returns a promise that resolves\r\n * the first time that a document in `frame` becomes ready.\r\n *\r\n * See {@link onDocumentReady} for the definition of _ready_.\r\n *\r\n * @param {HTMLIFrameElement} frame\r\n * @return {Promise<Document>}\r\n */\r\nexport function onNextDocumentReady(frame) {\r\n  return new Promise((resolve, reject) => {\r\n    const unsubscribe = onDocumentReady(frame, (err, doc) => {\r\n      unsubscribe();\r\n      if (doc) {\r\n        resolve(doc);\r\n      } else {\r\n        reject(err);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Register a callback that is invoked when the content document\r\n * (`frame.contentDocument`) in a same-origin iframe becomes _ready_.\r\n *\r\n * A document is _ready_ when its `readyState` is either \"interactive\" or\r\n * \"complete\". It must also not be the empty document with URL \"about:blank\"\r\n * that iframes have before they navigate to the URL specified by their \"src\"\r\n * attribute.\r\n *\r\n * The callback is fired both for the document that is in the frame when\r\n * `onDocumentReady` is called, as well as for new documents that are\r\n * subsequently loaded into the same frame.\r\n *\r\n * If at any time the frame navigates to an iframe that is cross-origin,\r\n * the callback will fire with an error. It will fire again for subsequent\r\n * navigations, but due to platform limitations, it will only fire after the\r\n * next document fully loads (ie. when the frame's `load` event fires).\r\n *\r\n * @param {HTMLIFrameElement} frame\r\n * @param {(...args: [Error]|[null, Document]) => void} callback\r\n * @param {object} options\r\n *   @param {number} [options.pollInterval]\r\n * @return {() => void} Callback that unsubscribes from future changes\r\n */\r\nexport function onDocumentReady(frame, callback, { pollInterval = 10 } = {}) {\r\n  /** @type {number|undefined} */\r\n  let pollTimer;\r\n  /** @type {() => void} */\r\n  let pollForDocumentChange;\r\n\r\n  // Visited documents for which we have fired the callback or are waiting\r\n  // to become ready.\r\n  const documents = new WeakSet();\r\n\r\n  const cancelPoll = () => {\r\n    clearTimeout(pollTimer);\r\n    pollTimer = undefined;\r\n  };\r\n\r\n  // Begin polling for a document change when the current document is about\r\n  // to go away.\r\n  const pollOnUnload = () => {\r\n    if (frame.contentDocument) {\r\n      frame.contentWindow?.addEventListener('unload', pollForDocumentChange);\r\n    }\r\n  };\r\n\r\n  const checkForDocumentChange = () => {\r\n    const currentDocument = frame.contentDocument;\r\n    if (!currentDocument) {\r\n      callback(new Error('Frame is cross-origin'));\r\n      return;\r\n    }\r\n\r\n    if (documents.has(currentDocument)) {\r\n      return;\r\n    }\r\n    documents.add(currentDocument);\r\n    cancelPoll();\r\n\r\n    if (!hasBlankDocumentThatWillNavigate(frame)) {\r\n      const isReady =\r\n        currentDocument.readyState === 'interactive' ||\r\n        currentDocument.readyState === 'complete';\r\n\r\n      if (isReady) {\r\n        callback(null, currentDocument);\r\n      } else {\r\n        currentDocument.addEventListener('DOMContentLoaded', () =>\r\n          callback(null, currentDocument)\r\n        );\r\n      }\r\n    }\r\n\r\n    // Poll for the next document change.\r\n    pollOnUnload();\r\n  };\r\n\r\n  let canceled = false;\r\n  pollForDocumentChange = () => {\r\n    cancelPoll();\r\n    if (!canceled) {\r\n      pollTimer = setInterval(checkForDocumentChange, pollInterval);\r\n    }\r\n  };\r\n\r\n  // Set up observers for signals that the document either has changed or will\r\n  // soon change. There are two signals with different trade-offs:\r\n  //\r\n  //  - Polling after the current document is about to be unloaded. This allows\r\n  //    us to detect the new document quickly, but may not fire in some\r\n  //    situations (exact circumstances unclear, but eg. MDN warns about this).\r\n  //\r\n  //    This is set up in the first call to `checkForDocumentChange`.\r\n  //\r\n  //  - The iframe's \"load\" event. This is guaranteed to fire but only after the\r\n  //    new document is fully loaded.\r\n  frame.addEventListener('load', checkForDocumentChange);\r\n\r\n  // Notify caller about the current document. This fires asynchronously so that\r\n  // the caller will have received the unsubscribe callback first.\r\n  const initialCheckTimer = setTimeout(checkForDocumentChange, 0);\r\n\r\n  return () => {\r\n    canceled = true;\r\n    clearTimeout(initialCheckTimer);\r\n    cancelPoll();\r\n    frame.removeEventListener('load', checkForDocumentChange);\r\n  };\r\n}\r\n","import debounce from 'lodash.debounce';\r\n\r\nimport { ListenerCollection } from '../../shared/listener-collection';\r\nimport {\r\n  rectCenter,\r\n  rectsOverlapHorizontally,\r\n  rectsOverlapVertically,\r\n  unionRects,\r\n} from '../util/geometry';\r\n\r\n/**\r\n * @typedef WordBox\r\n * @prop {string} text\r\n * @prop {DOMRect} rect - Bounding rectangle of all glyphs in word\r\n */\r\n\r\n/**\r\n * @typedef LineBox\r\n * @prop {WordBox[]} words\r\n * @prop {DOMRect} rect - Bounding rectangle of all words in line\r\n */\r\n\r\n/**\r\n * @typedef ColumnBox\r\n * @prop {LineBox[]} lines\r\n * @prop {DOMRect} rect - Bounding rectangle of all lines in column\r\n */\r\n\r\n/**\r\n * Group characters in a page into words, lines and columns.\r\n *\r\n * The input is assumed to be _roughly_ reading order, more so at the low (word,\r\n * line) level. When the input is not in reading order, the output may be\r\n * divided into more lines / columns than expected. Downstream code is expected\r\n * to tolerate over-segmentation. This function should try to avoid producing\r\n * lines or columns that significantly intersect, as this can impair text\r\n * selection.\r\n *\r\n * @param {DOMRect[]} charBoxes - Bounding rectangle associated with each character on the page\r\n * @param {string} text - Text that corresponds to `charBoxes`\r\n * @return {ColumnBox[]}\r\n */\r\nfunction analyzeLayout(charBoxes, text) {\r\n  /** @type {WordBox[]} */\r\n  const words = [];\r\n\r\n  /** @type {WordBox} */\r\n  let currentWord = { text: '', rect: new DOMRect() };\r\n\r\n  // Group characters into words.\r\n  const addWord = () => {\r\n    if (currentWord.text.length > 0) {\r\n      words.push(currentWord);\r\n      currentWord = { text: '', rect: new DOMRect() };\r\n    }\r\n  };\r\n  for (let [i, rect] of charBoxes.entries()) {\r\n    const char = text[i];\r\n    const isSpace = /\\s/.test(char);\r\n\r\n    currentWord.rect = unionRects(currentWord.rect, rect);\r\n\r\n    // To simplify downstream logic, normalize whitespace.\r\n    currentWord.text += isSpace ? ' ' : char;\r\n\r\n    if (isSpace) {\r\n      addWord();\r\n    }\r\n  }\r\n  addWord();\r\n\r\n  /** @type {LineBox[]} */\r\n  const lines = [];\r\n\r\n  /** @type {LineBox} */\r\n  let currentLine = { words: [], rect: new DOMRect() };\r\n\r\n  // Group words into lines.\r\n  const addLine = () => {\r\n    if (currentLine.words.length > 0) {\r\n      lines.push(currentLine);\r\n      currentLine = { words: [], rect: new DOMRect() };\r\n    }\r\n  };\r\n  for (let word of words) {\r\n    const prevWord = currentLine.words[currentLine.words.length - 1];\r\n    if (prevWord) {\r\n      const prevCenter = rectCenter(prevWord.rect);\r\n      const currentCenter = rectCenter(word.rect);\r\n      const xDist = currentCenter.x - prevCenter.x;\r\n      if (\r\n        !rectsOverlapVertically(prevWord.rect, word.rect) ||\r\n        // Break line if current word is left of previous word\r\n        xDist < 0\r\n      ) {\r\n        addLine();\r\n      }\r\n    }\r\n    currentLine.words.push(word);\r\n    currentLine.rect = unionRects(currentLine.rect, word.rect);\r\n  }\r\n  addLine();\r\n\r\n  /** @type {ColumnBox[]} */\r\n  const columns = [];\r\n\r\n  /** @type {ColumnBox} */\r\n  let currentColumn = { lines: [], rect: new DOMRect() };\r\n\r\n  // Group lines into columns.\r\n  const addColumn = () => {\r\n    if (currentColumn.lines.length > 0) {\r\n      columns.push(currentColumn);\r\n      currentColumn = { lines: [], rect: new DOMRect() };\r\n    }\r\n  };\r\n  for (let line of lines) {\r\n    const prevLine = currentColumn.lines[currentColumn.lines.length - 1];\r\n\r\n    if (prevLine) {\r\n      const prevCenter = rectCenter(prevLine.rect);\r\n      const currentCenter = rectCenter(line.rect);\r\n      const yDist = currentCenter.y - prevCenter.y;\r\n\r\n      if (\r\n        !rectsOverlapHorizontally(prevLine.rect, line.rect) ||\r\n        rectsOverlapVertically(prevLine.rect, line.rect) ||\r\n        // Break column if current line is above previous line.\r\n        //\r\n        // In the case of a two column layout for example, this happens when\r\n        // moving from the bottom of one column to the top of the next.\r\n        yDist < 0 ||\r\n        // Break column if there is a large gap between the previous and current lines.\r\n        //\r\n        // This helps to avoid generating intersecting columns if there happens\r\n        // to be other content between the lines that comes later in the input.\r\n        yDist > line.rect.height * 4\r\n      ) {\r\n        addColumn();\r\n      }\r\n    }\r\n    currentColumn.lines.push(line);\r\n    currentColumn.rect = unionRects(currentColumn.rect, line.rect);\r\n  }\r\n  addColumn();\r\n\r\n  return columns;\r\n}\r\n\r\n/**\r\n * ImageTextLayer maintains a transparent text layer on top of an image\r\n * which contains text. This enables the text in the image to be selected\r\n * and highlighted.\r\n *\r\n * This is similar to the one that PDF.js creates for us in our standard PDF\r\n * viewer.\r\n */\r\nexport class ImageTextLayer {\r\n  /**\r\n   * Create a text layer which is displayed on top of `image`.\r\n   *\r\n   * @param {Element} image - Rendered image on which to overlay the text layer.\r\n   *   The text layer will be inserted into the DOM as the next sibling of `image`.\r\n   * @param {DOMRect[]} charBoxes - Bounding boxes for characters in the image.\r\n   *   Coordinates should be in the range [0-1], where 0 is the top/left corner\r\n   *   of the image and 1 is the bottom/right.\r\n   * @param {string} text - Characters in the image corresponding to `charBoxes`\r\n   */\r\n  constructor(image, charBoxes, text) {\r\n    if (charBoxes.length !== text.length) {\r\n      throw new Error('Char boxes length does not match text length');\r\n    }\r\n\r\n    // Create container for text layer and position it above the image.\r\n    const containerParent = /** @type {HTMLElement} */ (image.parentNode);\r\n    const container = document.createElement('hypothesis-text-layer');\r\n    containerParent.insertBefore(container, image.nextSibling);\r\n\r\n    // Position text layer over image. We assume the image's top-left corner\r\n    // aligns with the top-left corner of its container.\r\n    containerParent.style.position = 'relative';\r\n    container.style.position = 'absolute';\r\n    container.style.top = '0';\r\n    container.style.left = '0';\r\n    container.style.color = 'transparent';\r\n\r\n    // Prevent inherited text alignment from affecting positioning.\r\n    // VitalSource sets `text-align: center` for example.\r\n    container.style.textAlign = 'left';\r\n\r\n    // Use multiply blending to make text in the image more readable when\r\n    // the corresponding text in the text layer is selected or highlighted.\r\n    // We apply a similar effect in PDF.js.\r\n    container.style.mixBlendMode = 'multiply';\r\n\r\n    // Set a fixed font style on the container and create a canvas using the same\r\n    // font which we can use to measure the \"natural\" size of the text. This is\r\n    // later used when scaling the text to fit the underlying part of the image.\r\n    const fontSize = 16;\r\n    const fontFamily = 'sans-serif';\r\n    container.style.fontSize = fontSize + 'px';\r\n    container.style.fontFamily = fontFamily;\r\n    const canvas = document.createElement('canvas');\r\n    const context = /** @type {CanvasRenderingContext2D} */ (\r\n      canvas.getContext('2d')\r\n    );\r\n    context.font = `${fontSize}px ${fontFamily}`;\r\n\r\n    /**\r\n     * Generate a CSS value that scales with the `--x-scale` or `--y-scale` CSS variables.\r\n     *\r\n     * @param {'x'|'y'} dimension\r\n     * @param {number} value\r\n     * @param {string} unit\r\n     */\r\n    const scaledValue = (dimension, value, unit = 'px') =>\r\n      `calc(var(--${dimension}-scale) * ${value}${unit})`;\r\n\r\n    // Group characters into words, lines and columns. Then use the result to\r\n    // create a hierarchical DOM structure in the text layer:\r\n    //\r\n    // 1. Columns are positioned absolutely\r\n    // 2. Columns stack lines vertically using a block layout\r\n    // 3. Lines arrange words horizontally using an inline layout\r\n    //\r\n    // This allows the browser to select the expected text when the cursor is\r\n    // in-between lines or words.\r\n    const columns = analyzeLayout(charBoxes, text);\r\n\r\n    for (let column of columns) {\r\n      const columnEl = document.createElement('hypothesis-text-column');\r\n      columnEl.style.display = 'block';\r\n      columnEl.style.position = 'absolute';\r\n      columnEl.style.left = scaledValue('x', column.rect.left);\r\n      columnEl.style.top = scaledValue('y', column.rect.top);\r\n\r\n      let prevLine = null;\r\n      for (let line of column.lines) {\r\n        const lineEl = document.createElement('hypothesis-text-line');\r\n        lineEl.style.display = 'block';\r\n        lineEl.style.marginLeft = scaledValue(\r\n          'x',\r\n          line.rect.left - column.rect.left\r\n        );\r\n        lineEl.style.height = scaledValue('y', line.rect.height);\r\n\r\n        if (prevLine) {\r\n          lineEl.style.marginTop = scaledValue(\r\n            'y',\r\n            line.rect.top - prevLine.rect.bottom\r\n          );\r\n        }\r\n        prevLine = line;\r\n\r\n        // Prevent line breaks if the word elements don't quite fit the line.\r\n        lineEl.style.whiteSpace = 'nowrap';\r\n\r\n        let prevWord = null;\r\n        for (let word of line.words) {\r\n          const wordEl = document.createElement('hypothesis-text-word');\r\n          wordEl.style.display = 'inline-block';\r\n          wordEl.style.transformOrigin = 'top left';\r\n          wordEl.textContent = word.text;\r\n\r\n          if (prevWord) {\r\n            wordEl.style.marginLeft = scaledValue(\r\n              'x',\r\n              word.rect.left - prevWord.rect.right\r\n            );\r\n          }\r\n          prevWord = word;\r\n\r\n          // Set the size of this box used for layout. This does not affect the\r\n          // rendered size of the content.\r\n          wordEl.style.width = scaledValue('x', word.rect.width);\r\n          wordEl.style.height = scaledValue('y', word.rect.height);\r\n\r\n          // Don't collapse whitespace at end of words, so it remains visible\r\n          // in selected text. Also prevent line breaks due to overflows.\r\n          wordEl.style.whiteSpace = 'pre';\r\n\r\n          // Scale content using a transform. This affects the rendered size\r\n          // of the text, used by text selection and\r\n          // `Element.getBoundingClientRect`, but not layout.\r\n          const metrics = context.measureText(word.text);\r\n          const xScale = scaledValue('x', word.rect.width / metrics.width, '');\r\n          const yScale = scaledValue('y', word.rect.height / fontSize, '');\r\n          wordEl.style.transform = `scale(${xScale}, ${yScale})`;\r\n\r\n          lineEl.append(wordEl);\r\n        }\r\n\r\n        columnEl.append(lineEl);\r\n      }\r\n\r\n      container.append(columnEl);\r\n    }\r\n\r\n    const updateTextLayerSize = () => {\r\n      const { width: imageWidth, height: imageHeight } =\r\n        image.getBoundingClientRect();\r\n      container.style.width = imageWidth + 'px';\r\n      container.style.height = imageHeight + 'px';\r\n\r\n      container.style.setProperty('--x-scale', `${imageWidth}`);\r\n      container.style.setProperty('--y-scale', `${imageHeight}`);\r\n    };\r\n\r\n    updateTextLayerSize();\r\n\r\n    /**\r\n     * Container element for the text layer.\r\n     *\r\n     * This is exposed so that callers can tweak the style if needed (eg.\r\n     * to set a z-index value).\r\n     */\r\n    this.container = container;\r\n\r\n    this._updateTextLayerSize = debounce(updateTextLayerSize, { maxWait: 50 });\r\n    this._listeners = new ListenerCollection();\r\n\r\n    if (typeof ResizeObserver !== 'undefined') {\r\n      this._imageSizeObserver = new ResizeObserver(() => {\r\n        this._updateTextLayerSize();\r\n      });\r\n      this._imageSizeObserver.observe(image);\r\n    }\r\n\r\n    // Fallback for browsers that don't support ResizeObserver (Safari < 13.4).\r\n    // Due to the debouncing, we can register this listener in all browsers for\r\n    // simplicity, without downsides.\r\n    this._listeners.add(window, 'resize', this._updateTextLayerSize);\r\n  }\r\n\r\n  /**\r\n   * Synchronously update the text layer to match the size and position of\r\n   * the image.\r\n   *\r\n   * Normally the text layer is resized automatically but asynchronously when\r\n   * the image size changes (eg. due to the window being resized) and updates\r\n   * are debounced. This method can be used to force an immediate update if\r\n   * needed.\r\n   */\r\n  updateSync() {\r\n    this._updateTextLayerSize();\r\n    this._updateTextLayerSize.flush();\r\n  }\r\n\r\n  destroy() {\r\n    this.container.remove();\r\n    this._listeners.removeAll();\r\n    this._updateTextLayerSize.cancel();\r\n    this._imageSizeObserver?.disconnect();\r\n  }\r\n}\r\n","import { parseJsonConfig } from '../boot/parse-json-config';\r\nimport { generateHexString } from '../shared/random';\r\nimport { onNextDocumentReady, FrameObserver } from './frame-observer';\r\n\r\n/**\r\n * @typedef {import('../types/annotator').Destroyable} Destroyable\r\n */\r\n\r\n/**\r\n * Options for injecting the client into child frames.\r\n *\r\n * This includes the URL of the client's boot script, plus configuration\r\n * for the client when it loads in the child frame.\r\n *\r\n * @typedef {{ clientUrl: string } & Record<string, unknown>} InjectConfig\r\n */\r\n\r\n/**\r\n * HypothesisInjector injects the Hypothesis client into same-origin iframes.\r\n *\r\n * The client will be injected automatically into frames that have the\r\n * `enable-annotation` attribute set (see {@link FrameObserver}) and can be\r\n * manually injected into other frames using {@link injectClient}.\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class HypothesisInjector {\r\n  /**\r\n   * @param {Element} element - root of the DOM subtree to watch for the\r\n   *   addition and removal of annotatable iframes\r\n   * @param {InjectConfig} config\r\n   */\r\n  constructor(element, config) {\r\n    this._config = config;\r\n    this._frameObserver = new FrameObserver(\r\n      element,\r\n      frame => injectClient(frame, config), // Frame added callback\r\n      () => {} // Frame removed callback\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Disables the injection of the Hypothesis client into child iframes.\r\n   */\r\n  destroy() {\r\n    this._frameObserver.disconnect();\r\n  }\r\n}\r\n\r\n/**\r\n * Check if the client was added to a frame by {@link injectHypothesis}.\r\n *\r\n * @param {HTMLIFrameElement} iframe\r\n */\r\nfunction hasHypothesis(iframe) {\r\n  const iframeDocument = /** @type {Document} */ (iframe.contentDocument);\r\n  return iframeDocument.querySelector('script.js-hypothesis-config') !== null;\r\n}\r\n\r\n/**\r\n * Inject Hypothesis client into a frame.\r\n *\r\n * IMPORTANT: This method requires that the iframe is same-origin\r\n * (frame.contentDocument|contentWindow is not null).\r\n *\r\n * This waits for the frame to finish loading before injecting the client.\r\n * See {@link onDocumentReady}.\r\n *\r\n * @param {HTMLIFrameElement} frame\r\n * @param {InjectConfig} config -\r\n */\r\nexport async function injectClient(frame, config) {\r\n  if (hasHypothesis(frame)) {\r\n    return;\r\n  }\r\n\r\n  await onNextDocumentReady(frame);\r\n\r\n  // Propagate the client resource locations from the current frame.\r\n  //\r\n  // These settings are set only in the browser extension and not by the\r\n  // embedded client (served by h).\r\n  //\r\n  // We could potentially do this by allowing these settings to be part of\r\n  // the \"annotator\" config (see `annotator/config/index.js`) which gets passed\r\n  // to the constructor.\r\n  const { assetRoot, notebookAppUrl, sidebarAppUrl } =\r\n    parseJsonConfig(document);\r\n\r\n  const injectedConfig = {\r\n    ...config,\r\n\r\n    assetRoot,\r\n    notebookAppUrl,\r\n    sidebarAppUrl,\r\n\r\n    // Generate a random string to use as a frame ID. The format is not important.\r\n    subFrameIdentifier: generateHexString(10),\r\n  };\r\n\r\n  const configElement = document.createElement('script');\r\n  configElement.className = 'js-hypothesis-config';\r\n  configElement.type = 'application/json';\r\n  configElement.innerText = JSON.stringify(injectedConfig);\r\n\r\n  const bootScript = document.createElement('script');\r\n  bootScript.async = true;\r\n  bootScript.src = config.clientUrl;\r\n\r\n  const iframeDocument = /** @type {Document} */ (frame.contentDocument);\r\n  iframeDocument.body.appendChild(configElement);\r\n  iframeDocument.body.appendChild(bootScript);\r\n}\r\n","import { TinyEmitter } from 'tiny-emitter';\r\n\r\nimport { ListenerCollection } from '../../shared/listener-collection';\r\nimport { FeatureFlags } from '../features';\r\nimport { onDocumentReady } from '../frame-observer';\r\nimport { HTMLIntegration } from './html';\r\nimport { preserveScrollPosition } from './html-side-by-side';\r\nimport { ImageTextLayer } from './image-text-layer';\r\nimport { injectClient } from '../hypothesis-injector';\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').Anchor} Anchor\r\n * @typedef {import('../../types/annotator').Annotator} Annotator\r\n * @typedef {import('../../types/annotator').Integration} Integration\r\n * @typedef {import('../../types/annotator').Selector} Selector\r\n * @typedef {import('../../types/annotator').SidebarLayout} SidebarLayout\r\n * @typedef {import('../hypothesis-injector').InjectConfig} InjectConfig\r\n */\r\n\r\n// When activating side-by-side mode for VitalSource PDF documents, make sure\r\n// at least this much space (in pixels) is left for the PDF document. Any\r\n// smaller and it feels unreadable or too-zoomed-out\r\nconst MIN_CONTENT_WIDTH = 480;\r\n\r\n/**\r\n * Return the custom DOM element that contains the book content iframe.\r\n */\r\nfunction findBookElement(document_ = document) {\r\n  return document_.querySelector('mosaic-book');\r\n}\r\n\r\n/**\r\n * Return the role of the current frame in the VitalSource Bookshelf reader or\r\n * `null` if the frame is not part of Bookshelf.\r\n *\r\n * @return {'container'|'content'|null} - `container` if this is the parent of\r\n *   the content frame, `content` if this is the frame that contains the book\r\n *   content or `null` if the document is not part of the Bookshelf reader.\r\n */\r\nexport function vitalSourceFrameRole(window_ = window) {\r\n  if (findBookElement(window_.document)) {\r\n    return 'container';\r\n  }\r\n\r\n  const parentDoc = window_.frameElement?.ownerDocument;\r\n  if (parentDoc && findBookElement(parentDoc)) {\r\n    return 'content';\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * VitalSourceInjector runs in the book container frame and loads the client into\r\n * book content frames.\r\n *\r\n * The frame structure of the VitalSource book reader looks like this:\r\n *\r\n * [VitalSource top frame - bookshelf.vitalsource.com]\r\n *   |\r\n *   [Book container frame - jigsaw.vitalsource.com]\r\n *     |\r\n *     [Book content frame - jigsaw.vitalsource.com]\r\n *\r\n * The Hypothesis client can be initially loaded in the container frame or the\r\n * content frame. As the user navigates around the book, the container frame\r\n * remains the same but the content frame is swapped out. When used in the\r\n * container frame, this class handles initial injection of the client as a\r\n * guest in the current content frame, and re-injecting the client into new\r\n * content frames when they are created.\r\n */\r\nexport class VitalSourceInjector {\r\n  /**\r\n   * @param {InjectConfig} config - Configuration for injecting the client into\r\n   *   book content frames\r\n   */\r\n  constructor(config) {\r\n    const bookElement = findBookElement();\r\n    if (!bookElement) {\r\n      throw new Error('Book container element not found');\r\n    }\r\n\r\n    /** @type {WeakSet<HTMLIFrameElement>} */\r\n    const contentFrames = new WeakSet();\r\n\r\n    const shadowRoot = /** @type {ShadowRoot} */ (bookElement.shadowRoot);\r\n    const injectClientIntoContentFrame = () => {\r\n      const frame = shadowRoot.querySelector('iframe');\r\n      if (!frame || contentFrames.has(frame)) {\r\n        // Either there is no content frame or we are already watching it.\r\n        return;\r\n      }\r\n      contentFrames.add(frame);\r\n      onDocumentReady(frame, (err, document_) => {\r\n        const body = document_?.body;\r\n        const isBookContent =\r\n          body &&\r\n          // Check that this is not the temporary page containing encrypted and\r\n          // invisible book content, which is replaced with the real content after\r\n          // a form submission. These pages look something like:\r\n          //\r\n          // ```\r\n          // <html>\r\n          //   <title>content</title>\r\n          //   <body><div id=\"page-content\">{ Base64 encoded data }</div></body>\r\n          // </html>\r\n          // ```\r\n          !body.querySelector('#page-content');\r\n\r\n        if (isBookContent) {\r\n          injectClient(frame, config);\r\n        }\r\n      });\r\n    };\r\n\r\n    injectClientIntoContentFrame();\r\n\r\n    // Re-inject client into content frame after a chapter navigation.\r\n    this._frameObserver = new MutationObserver(injectClientIntoContentFrame);\r\n    this._frameObserver.observe(shadowRoot, { childList: true, subtree: true });\r\n  }\r\n\r\n  destroy() {\r\n    this._frameObserver.disconnect();\r\n  }\r\n}\r\n\r\n/**\r\n * Bounding box of a single character in the page.\r\n *\r\n * Coordinates are expressed in percentage distance from the top-left corner\r\n * of the rendered page.\r\n *\r\n * @typedef GlyphBox\r\n * @prop {number} l\r\n * @prop {number} r\r\n * @prop {number} t\r\n * @prop {number} b\r\n */\r\n\r\n/**\r\n * @typedef PDFGlyphData\r\n * @prop {GlyphBox[]} glyphs\r\n */\r\n\r\n/**\r\n * Data that the VitalSource book reader renders into the page about the\r\n * content and location of text in the image.\r\n *\r\n * @typedef PDFTextData\r\n * @prop {PDFGlyphData} glyphs - Locations of each text character in the page\r\n * @prop {string} words - The text in the page\r\n */\r\n\r\nfunction getPDFPageImage() {\r\n  return /** @type {HTMLImageElement|null} */ (\r\n    document.querySelector('img#pbk-page')\r\n  );\r\n}\r\n\r\n/**\r\n * Fix how a VitalSource book content frame scrolls, so that various related\r\n * Hypothesis behaviors (the bucket bar, scrolling annotations into view) work\r\n * as intended.\r\n *\r\n * Some VitalSource books (PDFs) make content scrolling work by making the\r\n * content iframe really tall and having the parent frame scroll. This stops the\r\n * Hypothesis bucket bar and scrolling annotations into view from working.\r\n *\r\n * @param {HTMLIFrameElement} frame\r\n */\r\nfunction makeContentFrameScrollable(frame) {\r\n  if (frame.getAttribute('scrolling') !== 'no') {\r\n    // This is a book (eg. EPUB) where the workaround is not required.\r\n    return;\r\n  }\r\n\r\n  // Override inline styles of iframe (hence `!important`). The iframe lives\r\n  // in Shadow DOM, so the element styles won't affect the rest of the app.\r\n  const style = document.createElement('style');\r\n  style.textContent = `iframe { height: 100% !important; }`;\r\n  frame.insertAdjacentElement('beforebegin', style);\r\n\r\n  const removeScrollingAttr = () => frame.removeAttribute('scrolling');\r\n  removeScrollingAttr();\r\n\r\n  // Sometimes the attribute gets re-added by VS. Remove it if that\r\n  // happens.\r\n  const attrObserver = new MutationObserver(removeScrollingAttr);\r\n  attrObserver.observe(frame, { attributes: true });\r\n}\r\n\r\n/**\r\n * Integration for the content frame in VitalSource's Bookshelf ebook reader.\r\n *\r\n * This integration delegates to the standard HTML integration for most\r\n * functionality, but it adds logic to:\r\n *\r\n *  - Customize the document URI and metadata that is associated with annotations\r\n *  - Prevent VitalSource's built-in selection menu from getting in the way\r\n *    of the adder.\r\n *  - Create a hidden text layer in PDF-based books, so the user can select text\r\n *    in the PDF image. This is similar to what PDF.js does for us in PDFs.\r\n *\r\n * @implements {Integration}\r\n */\r\nexport class VitalSourceContentIntegration extends TinyEmitter {\r\n  /**\r\n   * @param {HTMLElement} container\r\n   */\r\n  constructor(container = document.body) {\r\n    super();\r\n\r\n    const features = new FeatureFlags();\r\n\r\n    // Forcibly enable the side-by-side feature for VS books. This feature is\r\n    // only behind a flag for regular web pages, which are typically more\r\n    // complex and varied than EPUB books.\r\n    features.update({ html_side_by_side: true });\r\n\r\n    this._htmlIntegration = new HTMLIntegration({ container, features });\r\n\r\n    this._listeners = new ListenerCollection();\r\n\r\n    // Prevent mouse events from reaching the window. This prevents VitalSource\r\n    // from showing its native selection menu, which obscures the client's\r\n    // annotation toolbar.\r\n    //\r\n    // To avoid interfering with the client's own selection handling, this\r\n    // event blocking must happen at the same level or higher in the DOM tree\r\n    // than where SelectionObserver listens.\r\n    const stopEvents = ['mouseup', 'mousedown', 'mouseout'];\r\n    for (let event of stopEvents) {\r\n      this._listeners.add(document.documentElement, event, e => {\r\n        e.stopPropagation();\r\n      });\r\n    }\r\n\r\n    // Install scrolling workaround for PDFs. We do this in the content frame\r\n    // so that it works whether Hypothesis is loaded directly into the content\r\n    // frame or injected by VitalSourceInjector from the parent frame.\r\n    const frame = /** @type {HTMLIFrameElement|null} */ (window.frameElement);\r\n    if (frame) {\r\n      makeContentFrameScrollable(frame);\r\n    }\r\n\r\n    // If this is a PDF, create the hidden text layer above the rendered PDF\r\n    // image.\r\n    const bookImage = getPDFPageImage();\r\n\r\n    /** @type {PDFTextData|undefined} */\r\n    const pageData = /** @type {any} */ (window).innerPageData;\r\n\r\n    if (bookImage && pageData) {\r\n      const charRects = pageData.glyphs.glyphs.map(glyph => {\r\n        const left = glyph.l / 100;\r\n        const right = glyph.r / 100;\r\n        const top = glyph.t / 100;\r\n        const bottom = glyph.b / 100;\r\n        return new DOMRect(left, top, right - left, bottom - top);\r\n      });\r\n\r\n      this._textLayer = new ImageTextLayer(\r\n        bookImage,\r\n        charRects,\r\n        pageData.words\r\n      );\r\n\r\n      // VitalSource has several DOM elements in the page which are raised\r\n      // above the image using z-index. One of these is used to handle VS's\r\n      // own text selection functionality.\r\n      //\r\n      // Set a z-index on our text layer to raise it above VS's own one.\r\n      this._textLayer.container.style.zIndex = '100';\r\n    }\r\n  }\r\n\r\n  canAnnotate() {\r\n    return true;\r\n  }\r\n\r\n  destroy() {\r\n    this._textLayer?.destroy();\r\n    this._listeners.removeAll();\r\n    this._htmlIntegration.destroy();\r\n  }\r\n\r\n  /**\r\n   * @param {HTMLElement} root\r\n   * @param {Selector[]} selectors\r\n   */\r\n  anchor(root, selectors) {\r\n    return this._htmlIntegration.anchor(root, selectors);\r\n  }\r\n\r\n  /**\r\n   * @param {HTMLElement} root\r\n   * @param {Range} range\r\n   */\r\n  describe(root, range) {\r\n    return this._htmlIntegration.describe(root, range);\r\n  }\r\n\r\n  contentContainer() {\r\n    return this._htmlIntegration.contentContainer();\r\n  }\r\n\r\n  /**\r\n   * @param {SidebarLayout} layout\r\n   */\r\n  fitSideBySide(layout) {\r\n    // For PDF books, handle side-by-side mode in this integration. For EPUBs,\r\n    // delegate to the HTML integration.\r\n    const bookImage = getPDFPageImage();\r\n    if (bookImage && this._textLayer) {\r\n      const bookContainer = /** @type {HTMLElement} */ (\r\n        bookImage.parentElement\r\n      );\r\n      const textLayer = this._textLayer;\r\n\r\n      // Update the PDF image size and alignment to fit alongside the sidebar.\r\n      // `ImageTextLayer` will handle adjusting the text layer to match.\r\n      const newWidth = window.innerWidth - layout.width;\r\n\r\n      preserveScrollPosition(() => {\r\n        if (layout.expanded && newWidth > MIN_CONTENT_WIDTH) {\r\n          // The VS book viewer sets `text-align: center` on the <body> element\r\n          // by default, which centers the book image in the page. When the sidebar\r\n          // is open we need the image to be left-aligned.\r\n          bookContainer.style.textAlign = 'left';\r\n          bookImage.style.width = `${newWidth}px`;\r\n        } else {\r\n          bookContainer.style.textAlign = '';\r\n          bookImage.style.width = '';\r\n        }\r\n\r\n        // Update text layer to match new image dimensions immediately. This\r\n        // is needed so that `preserveScrollPosition` can see how the content\r\n        // has shifted when this callback returns.\r\n        textLayer.updateSync();\r\n      });\r\n\r\n      return layout.expanded;\r\n    } else {\r\n      return this._htmlIntegration.fitSideBySide(layout);\r\n    }\r\n  }\r\n\r\n  async getMetadata() {\r\n    // Return minimal metadata which includes only the information we really\r\n    // want to include.\r\n    return {\r\n      title: document.title,\r\n      link: [],\r\n    };\r\n  }\r\n\r\n  async uri() {\r\n    // An example of a typical URL for the chapter content in the Bookshelf reader is:\r\n    //\r\n    // https://jigsaw.vitalsource.com/books/9781848317703/epub/OPS/xhtml/chapter_001.html#cfi=/6/10%5B;vnd.vst.idref=chap001%5D!/4\r\n    //\r\n    // Where \"9781848317703\" is the VitalSource book ID (\"vbid\"), \"chapter_001.html\"\r\n    // is the location of the HTML page for the current chapter within the book\r\n    // and the `#cfi` fragment identifies the scroll location.\r\n    //\r\n    // Note that this URL is typically different than what is displayed in the\r\n    // iframe's `src` attribute.\r\n\r\n    // Strip off search parameters and fragments.\r\n    const uri = new URL(document.location.href);\r\n    uri.search = '';\r\n    return uri.toString();\r\n  }\r\n\r\n  /**\r\n   * @param {Anchor} anchor\r\n   */\r\n  async scrollToAnchor(anchor) {\r\n    return this._htmlIntegration.scrollToAnchor(anchor);\r\n  }\r\n}\r\n","import { HTMLIntegration } from './html';\r\nimport { PDFIntegration, isPDF } from './pdf';\r\nimport {\r\n  VitalSourceContentIntegration,\r\n  vitalSourceFrameRole,\r\n} from './vitalsource';\r\n\r\n/**\r\n * @typedef {import('../../types/annotator').Annotator} Annotator\r\n * @typedef {import('../../types/annotator').ContentInfoConfig} ContentInfoBanner\r\n * @typedef {import('../../types/annotator').Integration} Integration\r\n */\r\n\r\n/**\r\n * Create the integration that handles document-type specific aspects of\r\n * guest functionality.\r\n *\r\n * @param {Annotator} annotator\r\n * @return {Integration}\r\n */\r\nexport function createIntegration(annotator) {\r\n  if (isPDF()) {\r\n    return new PDFIntegration(annotator);\r\n  }\r\n\r\n  const vsFrameRole = vitalSourceFrameRole();\r\n  if (vsFrameRole === 'content') {\r\n    return new VitalSourceContentIntegration();\r\n  }\r\n\r\n  return new HTMLIntegration({ features: annotator.features });\r\n}\r\n","import { ListenerCollection } from '../shared/listener-collection';\r\n\r\n/**\r\n * Return the current selection or `null` if there is no selection or it is empty.\r\n *\r\n * @param {Document} document\r\n * @return {Range|null}\r\n */\r\nexport function selectedRange(document) {\r\n  const selection = document.getSelection();\r\n  if (!selection || selection.rangeCount === 0) {\r\n    return null;\r\n  }\r\n  const range = selection.getRangeAt(0);\r\n  if (range.collapsed) {\r\n    return null;\r\n  }\r\n  return range;\r\n}\r\n\r\n/**\r\n * An observer that watches for and buffers changes to the document's current selection.\r\n */\r\nexport class SelectionObserver {\r\n  /**\r\n   * Start observing changes to the current selection in the document.\r\n   *\r\n   * @param {(range: Range|null) => void} callback -\r\n   *   Callback invoked with the selected region of the document when it has\r\n   *   changed.\r\n   * @param {Document} document_ - Test seam\r\n   */\r\n  constructor(callback, document_ = document) {\r\n    let isMouseDown = false;\r\n\r\n    this._pendingCallback = null;\r\n\r\n    const scheduleCallback = (delay = 10) => {\r\n      this._pendingCallback = setTimeout(() => {\r\n        callback(selectedRange(document_));\r\n      }, delay);\r\n    };\r\n\r\n    /** @param {Event} event */\r\n    const eventHandler = event => {\r\n      if (event.type === 'mousedown') {\r\n        isMouseDown = true;\r\n      }\r\n      if (event.type === 'mouseup') {\r\n        isMouseDown = false;\r\n      }\r\n\r\n      // If the user makes a selection with the mouse, wait until they release\r\n      // it before reporting a selection change.\r\n      if (isMouseDown) {\r\n        return;\r\n      }\r\n\r\n      this._cancelPendingCallback();\r\n\r\n      // Schedule a notification after a short delay. The delay serves two\r\n      // purposes:\r\n      //\r\n      // - If this handler was called as a result of a 'mouseup' event then the\r\n      //   selection will not be updated until the next tick of the event loop.\r\n      //   In this case we only need a short delay.\r\n      //\r\n      // - If the user is changing the selection with a non-mouse input (eg.\r\n      //   keyboard or selection handles on mobile) this buffers updates and\r\n      //   makes sure that we only report one when the update has stopped\r\n      //   changing. In this case we want a longer delay.\r\n\r\n      const delay = event.type === 'mouseup' ? 10 : 100;\r\n      scheduleCallback(delay);\r\n    };\r\n\r\n    this._document = document_;\r\n    this._listeners = new ListenerCollection();\r\n\r\n    this._listeners.add(document_, 'selectionchange', eventHandler);\r\n\r\n    // Mouse events are handled on the body because propagation may be stopped\r\n    // before they reach the document in some environments (eg. VitalSource).\r\n    this._listeners.add(document_.body, 'mousedown', eventHandler);\r\n    this._listeners.add(document_.body, 'mouseup', eventHandler);\r\n\r\n    // Report the initial selection.\r\n    scheduleCallback(1);\r\n  }\r\n\r\n  disconnect() {\r\n    this._listeners.removeAll();\r\n    this._cancelPendingCallback();\r\n  }\r\n\r\n  _cancelPendingCallback() {\r\n    if (this._pendingCallback) {\r\n      clearTimeout(this._pendingCallback);\r\n      this._pendingCallback = null;\r\n    }\r\n  }\r\n}\r\n","import { ListenerCollection } from '../shared/listener-collection';\r\nimport { PortFinder, PortRPC } from '../shared/messaging';\r\nimport { generateHexString } from '../shared/random';\r\n\r\nimport { Adder } from './adder';\r\nimport { TextRange } from './anchoring/text-range';\r\nimport { BucketBarClient } from './bucket-bar-client';\r\nimport { FeatureFlags } from './features';\r\nimport {\r\n  getHighlightsContainingNode,\r\n  highlightRange,\r\n  removeAllHighlights,\r\n  removeHighlights,\r\n  setHighlightsFocused,\r\n  setHighlightsVisible,\r\n} from './highlighter';\r\nimport { createIntegration } from './integrations';\r\nimport * as rangeUtil from './range-util';\r\nimport { SelectionObserver, selectedRange } from './selection-observer';\r\nimport { findClosestOffscreenAnchor } from './util/buckets';\r\nimport { frameFillsAncestor } from './util/frame';\r\nimport { normalizeURI } from './util/url';\r\n\r\n/**\r\n * @typedef {import('../types/annotator').AnnotationData} AnnotationData\r\n * @typedef {import('../types/annotator').Annotator} Annotator\r\n * @typedef {import('../types/annotator').Anchor} Anchor\r\n * @typedef {import('../types/annotator').ContentInfoConfig} ContentInfoConfig\r\n * @typedef {import('../types/annotator').Destroyable} Destroyable\r\n * @typedef {import('../types/annotator').SidebarLayout} SidebarLayout\r\n * @typedef {import('../types/api').Target} Target\r\n * @typedef {import('../types/port-rpc-events').HostToGuestEvent} HostToGuestEvent\r\n * @typedef {import('../types/port-rpc-events').GuestToHostEvent} GuestToHostEvent\r\n * @typedef {import('../types/port-rpc-events').GuestToSidebarEvent} GuestToSidebarEvent\r\n * @typedef {import('../types/port-rpc-events').SidebarToGuestEvent} SidebarToGuestEvent\r\n */\r\n\r\n/**\r\n * HTML element created by the highlighter with an associated annotation.\r\n *\r\n * @typedef {HTMLElement & { _annotation?: AnnotationData }} AnnotationHighlight\r\n */\r\n\r\n/**\r\n * Return all the annotations tags associated with the selected text.\r\n *\r\n * @return {string[]}\r\n */\r\nfunction annotationsForSelection() {\r\n  const selection = /** @type {Selection} */ (window.getSelection());\r\n  const range = selection.getRangeAt(0);\r\n  const tags = rangeUtil.itemsForRange(\r\n    range,\r\n    node => /** @type {AnnotationHighlight} */ (node)._annotation?.$tag\r\n  );\r\n  return tags;\r\n}\r\n\r\n/**\r\n * Return the annotation tags associated with any highlights that contain a given\r\n * DOM node.\r\n *\r\n * @param {Node} node\r\n * @return {string[]}\r\n */\r\nfunction annotationsAt(node) {\r\n  const items = getHighlightsContainingNode(node)\r\n    .map(h => /** @type {AnnotationHighlight} */ (h)._annotation)\r\n    .filter(ann => ann !== undefined)\r\n    .map(ann => ann?.$tag);\r\n  return /** @type {string[]} */ (items);\r\n}\r\n\r\n/**\r\n * Resolve an anchor's associated document region to a concrete `Range`.\r\n *\r\n * This may fail if anchoring failed or if the document has been mutated since\r\n * the anchor was created in a way that invalidates the anchor.\r\n *\r\n * @param {Anchor} anchor\r\n * @return {Range|null}\r\n */\r\nfunction resolveAnchor(anchor) {\r\n  if (!anchor.range) {\r\n    return null;\r\n  }\r\n  try {\r\n    return anchor.range.toRange();\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction removeTextSelection() {\r\n  document.getSelection()?.removeAllRanges();\r\n}\r\n\r\n/**\r\n * Subset of the Hypothesis client configuration that is used by {@link Guest}.\r\n *\r\n * @typedef GuestConfig\r\n * @prop {string} [subFrameIdentifier] - An identifier used by this guest to\r\n *   identify the current frame when communicating with the sidebar. This is\r\n *   only set in non-host frames.\r\n * @prop {ContentInfoConfig} [contentInfoBanner] - Configures a banner or other indicators\r\n *   showing where the content has come from.\r\n */\r\n\r\n/**\r\n * `Guest` is the central class of the annotator that handles anchoring (locating)\r\n * annotations in the document when they are fetched by the sidebar, rendering\r\n * highlights for them and handling subsequent interactions with the highlights.\r\n *\r\n * It is also responsible for listening to changes in the current selection\r\n * and triggering the display of controls to create new annotations. When one\r\n * of these controls is clicked, it creates the new annotation and sends it to\r\n * the sidebar.\r\n *\r\n * Within a browser tab, there is typically one `Guest` instance per frame that\r\n * loads Hypothesis (not all frames will be annotation-enabled). In one frame,\r\n * usually the top-level one, there will also be an instance of the `Sidebar`\r\n * class that shows the sidebar app and surrounding UI. The `Guest` instance in\r\n * each frame connects to the sidebar and host frames as part of its\r\n * initialization.\r\n *\r\n * @implements {Annotator}\r\n * @implements {Destroyable}\r\n */\r\nexport class Guest {\r\n  /**\r\n   * @param {HTMLElement} element -\r\n   *   The root element in which the `Guest` instance should be able to anchor\r\n   *   or create annotations. In an ordinary web page this typically `document.body`.\r\n   * @param {GuestConfig} [config]\r\n   * @param {Window} [hostFrame] -\r\n   *   Host frame which this guest is associated with. This is expected to be\r\n   *   an ancestor of the guest frame. It may be same or cross origin.\r\n   */\r\n  constructor(element, config = {}, hostFrame = window) {\r\n    window['guests']=[...(window['guests']??[]),this]\r\n    this.element = element;\r\n    this._hostFrame = hostFrame;\r\n    this._highlightsVisible = false;\r\n    this._isAdderVisible = false;\r\n    this._informHostOnNextSelectionClear = true;\r\n    /** @type {Range[]} - Ranges of the current text selection. */\r\n    this.selectedRanges = [];\r\n\r\n    this._adder = new Adder(this.element, {\r\n      onAnnotate: () => this.createAnnotation(),\r\n      onHighlight: () => this.createAnnotation({ highlight: true }),\r\n      onShowAnnotations: tags => this.selectAnnotations(tags),\r\n    });\r\n\r\n    this._selectionObserver = new SelectionObserver(range => {\r\n      if (range) {\r\n        this._onSelection(range);\r\n      } else {\r\n        this._onClearSelection();\r\n      }\r\n    });\r\n\r\n    /**\r\n     * The anchors generated by resolving annotation selectors to locations in the\r\n     * document. These are added by `anchor` and removed by `detach`.\r\n     *\r\n     * There is one anchor per annotation `Target`, which typically means one\r\n     * anchor per annotation.\r\n     *\r\n     * @type {Anchor[]}\r\n     */\r\n    this.anchors = [];\r\n\r\n    /**\r\n     * Tags of annotations that are currently anchored or being anchored in\r\n     * the guest.\r\n     */\r\n    this._annotations = /** @type {Set<string>} */ (new Set());\r\n\r\n    // Set the frame identifier if it's available.\r\n    // The \"top\" guest instance will have this as null since it's in a top frame not a sub frame\r\n    /** @type {string|null} */\r\n    this._frameIdentifier = config.subFrameIdentifier || null;\r\n\r\n    this._portFinder = new PortFinder({\r\n      hostFrame: this._hostFrame,\r\n      source: 'guest',\r\n    });\r\n\r\n    this.features = new FeatureFlags();\r\n\r\n    /**\r\n     * Integration that handles document-type specific functionality in the\r\n     * guest.\r\n     */\r\n    this._integration = createIntegration(this);\r\n    this._integration.on('uriChanged', async () => {\r\n      const metadata = await this.getDocumentInfo();\r\n      this._sidebarRPC.call('documentInfoChanged', metadata);\r\n    });\r\n    if (config.contentInfoBanner) {\r\n      this._integration.showContentInfo?.(config.contentInfoBanner);\r\n    }\r\n\r\n    /**\r\n     * Channel for host-guest communication.\r\n     *\r\n     * @type {PortRPC<HostToGuestEvent, GuestToHostEvent>}\r\n     */\r\n    this._hostRPC = new PortRPC();\r\n    this._connectHost(hostFrame);\r\n\r\n    /**\r\n     * Channel for guest-sidebar communication.\r\n     *\r\n     * @type {PortRPC<SidebarToGuestEvent, GuestToSidebarEvent>}\r\n     */\r\n    this._sidebarRPC = new PortRPC();\r\n    this._connectSidebar();\r\n\r\n    this._bucketBarClient = new BucketBarClient({\r\n      contentContainer: this._integration.contentContainer(),\r\n      hostRPC: this._hostRPC,\r\n    });\r\n\r\n    this._sideBySideActive = false;\r\n\r\n    // Setup event handlers on the root element\r\n    this._listeners = new ListenerCollection();\r\n    this._setupElementEvents();\r\n\r\n    /**\r\n     * Tags of currently focused annotations. This is used to set the focused\r\n     * state correctly for new highlights if the associated annotation is already\r\n     * focused in the sidebar.\r\n     *\r\n     * @type {Set<string>}\r\n     */\r\n    this._focusedAnnotations = new Set();\r\n  }\r\n\r\n  // Add DOM event listeners for clicks, taps etc. on the document and\r\n  // highlights.\r\n  _setupElementEvents() {\r\n    // Hide the sidebar in response to a document click or tap, so it doesn't obscure\r\n    // the document content.\r\n    /** @param {Element} element */\r\n    const maybeCloseSidebar = element => {\r\n      if (this._sideBySideActive) {\r\n        // Don't hide the sidebar if event was disabled because the sidebar\r\n        // doesn't overlap the content.\r\n        return;\r\n      }\r\n      if (annotationsAt(element).length) {\r\n        // Don't hide the sidebar if the event comes from an element that contains a highlight\r\n        return;\r\n      }\r\n      this._sidebarRPC.call('closeSidebar');\r\n    };\r\n\r\n    this._listeners.add(this.element, 'mouseup', event => {\r\n      const { target, metaKey, ctrlKey } = event;\r\n      const tags = annotationsAt(/** @type {Element} */ (target));\r\n      if (tags.length && this._highlightsVisible) {\r\n        const toggle = metaKey || ctrlKey;\r\n        this.selectAnnotations(tags, toggle);\r\n      }\r\n    });\r\n\r\n    this._listeners.add(this.element, 'mousedown', ({ target }) => {\r\n      maybeCloseSidebar(/** @type {Element} */ (target));\r\n    });\r\n\r\n    // Allow taps on the document to hide the sidebar as well as clicks.\r\n    // On iOS < 13 (2019), elements like h2 or div don't emit 'click' events.\r\n    this._listeners.add(this.element, 'touchstart', ({ target }) => {\r\n      maybeCloseSidebar(/** @type {Element} */ (target));\r\n    });\r\n\r\n    this._listeners.add(this.element, 'mouseover', ({ target }) => {\r\n      const tags = annotationsAt(/** @type {Element} */ (target));\r\n      if (tags.length && this._highlightsVisible) {\r\n        this._sidebarRPC.call('focusAnnotations', tags);\r\n      }\r\n    });\r\n\r\n    this._listeners.add(this.element, 'mouseout', () => {\r\n      if (this._highlightsVisible) {\r\n        this._sidebarRPC.call('focusAnnotations', []);\r\n      }\r\n    });\r\n\r\n    this._listeners.add(window, 'resize', () => this._repositionAdder());\r\n  }\r\n\r\n  /**\r\n   * Retrieve metadata for the current document.\r\n   */\r\n  async getDocumentInfo() {\r\n    const [uri, metadata] = await Promise.all([\r\n      this._integration.uri(),\r\n      this._integration.getMetadata(),\r\n    ]);\r\n\r\n    return {\r\n      uri: normalizeURI(uri),\r\n      metadata,\r\n      frameIdentifier: this._frameIdentifier,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Shift the position of the adder on window 'resize' events\r\n   */\r\n  _repositionAdder() {\r\n    if (this._isAdderVisible === false) {\r\n      return;\r\n    }\r\n    const range = window.getSelection()?.getRangeAt(0);\r\n    if (range) {\r\n      this._onSelection(range);\r\n    }\r\n  }\r\n\r\n  /** @param {Window} hostFrame */\r\n  async _connectHost(hostFrame) {\r\n    this._hostRPC.on('clearSelection', () => {\r\n      if (selectedRange(document)) {\r\n        this._informHostOnNextSelectionClear = false;\r\n        removeTextSelection();\r\n      }\r\n    });\r\n\r\n    this._hostRPC.on('createAnnotation', () => this.createAnnotation());\r\n\r\n    this._hostRPC.on(\r\n      'focusAnnotations',\r\n      /** @param {string[]} tags */\r\n      tags => this._focusAnnotations(tags)\r\n    );\r\n\r\n    this._hostRPC.on(\r\n      'scrollToClosestOffScreenAnchor',\r\n      /**\r\n       * @param {string[]} tags\r\n       * @param {'down'|'up'} direction\r\n       */\r\n      (tags, direction) => this._scrollToClosestOffScreenAnchor(tags, direction)\r\n    );\r\n\r\n    this._hostRPC.on(\r\n      'selectAnnotations',\r\n      /**\r\n       * @param {string[]} tags\r\n       * @param {boolean} toggle\r\n       */\r\n      (tags, toggle) => this.selectAnnotations(tags, toggle)\r\n    );\r\n\r\n    this._hostRPC.on(\r\n      'sidebarLayoutChanged',\r\n      /** @param {SidebarLayout} sidebarLayout */\r\n      sidebarLayout => {\r\n        if (frameFillsAncestor(window, hostFrame)) {\r\n          this.fitSideBySide(sidebarLayout);\r\n        }\r\n      }\r\n    );\r\n\r\n    // Discover and connect to the host frame. All RPC events must be\r\n    // registered before creating the channel.\r\n    const hostPort = await this._portFinder.discover('host');\r\n    this._hostRPC.connect(hostPort);\r\n  }\r\n\r\n  async _connectSidebar() {\r\n    this._sidebarRPC.on(\r\n      'featureFlagsUpdated',\r\n      /** @param {Record<string, boolean>} flags */ flags =>\r\n        this.features.update(flags)\r\n    );\r\n\r\n    // Handlers for events sent when user hovers or clicks on an annotation card\r\n    // in the sidebar.\r\n    this._sidebarRPC.on(\r\n      'focusAnnotations',\r\n      /** @param {string[]} tags */\r\n      tags => this._focusAnnotations(tags)\r\n    );\r\n\r\n    this._sidebarRPC.on(\r\n      'scrollToAnnotation',\r\n      /** @param {string} tag */\r\n      tag => {\r\n        const anchor = this.anchors.find(a => a.annotation.$tag === tag);\r\n        if (!anchor?.highlights) {\r\n          return;\r\n        }\r\n        const range = resolveAnchor(anchor);\r\n        if (!range) {\r\n          return;\r\n        }\r\n\r\n        // Emit a custom event that the host page can respond to. This is useful,\r\n        // for example, if the highlighted content is contained in a collapsible\r\n        // section of the page that needs to be un-collapsed.\r\n        const event = new CustomEvent('scrolltorange', {\r\n          bubbles: true,\r\n          cancelable: true,\r\n          detail: range,\r\n        });\r\n        const defaultNotPrevented = this.element.dispatchEvent(event);\r\n\r\n        if (defaultNotPrevented) {\r\n          this._integration.scrollToAnchor(anchor);\r\n        }\r\n      }\r\n    );\r\n\r\n    // Handler for controls on the sidebar\r\n    this._sidebarRPC.on(\r\n      'setHighlightsVisible',\r\n      /** @param {boolean} showHighlights */ showHighlights => {\r\n        this.setHighlightsVisible(showHighlights);\r\n      }\r\n    );\r\n\r\n    this._sidebarRPC.on(\r\n      'deleteAnnotation',\r\n      /** @param {string} tag */\r\n      tag => this.detach(tag)\r\n    );\r\n\r\n    this._sidebarRPC.on(\r\n      'loadAnnotations',\r\n      /** @param {AnnotationData[]} annotations */\r\n      annotations => annotations.forEach(annotation => this.anchor(annotation))\r\n    );\r\n\r\n    this._sidebarRPC.on(\r\n      'showContentInfo',\r\n      /** @param {ContentInfoConfig} info */\r\n      info => this._integration.showContentInfo?.(info)\r\n    );\r\n\r\n    // Connect to sidebar and send document info/URIs to it.\r\n    //\r\n    // RPC calls are deferred until a connection is made, so these steps can\r\n    // complete in either order.\r\n    this._portFinder.discover('sidebar').then(port => {\r\n      this._sidebarRPC.connect(port);\r\n    });\r\n    this.getDocumentInfo().then(metadata =>\r\n      this._sidebarRPC.call('documentInfoChanged', metadata)\r\n    );\r\n  }\r\n\r\n  destroy() {\r\n    this._portFinder.destroy();\r\n    this._hostRPC.destroy();\r\n    this._sidebarRPC.destroy();\r\n\r\n    this._listeners.removeAll();\r\n\r\n    this._selectionObserver.disconnect();\r\n    this._adder.destroy();\r\n    this._bucketBarClient.destroy();\r\n\r\n    removeAllHighlights(this.element);\r\n\r\n    this._integration.destroy();\r\n  }\r\n\r\n  /**\r\n   * Anchor an annotation's selectors in the document.\r\n   *\r\n   * _Anchoring_ resolves a set of selectors to a concrete region of the document\r\n   * which is then highlighted.\r\n   *\r\n   * Any existing anchors associated with `annotation` will be removed before\r\n   * re-anchoring the annotation.\r\n   *\r\n   * @param {AnnotationData} annotation\r\n   * @return {Promise<Anchor[]>}\r\n   */\r\n  async anchor(annotation) {\r\n    /**\r\n     * Resolve an annotation's selectors to a concrete range.\r\n     *\r\n     * @param {Target} target\r\n     * @return {Promise<Anchor>}\r\n     */\r\n    const locate = async target => {\r\n      // Only annotations with an associated quote can currently be anchored.\r\n      // This is because the quote is used to verify anchoring with other selector\r\n      // types.\r\n      if (\r\n        !target.selector ||\r\n        !target.selector.some(s => s.type === 'TextQuoteSelector')\r\n      ) {\r\n        return { annotation, target };\r\n      }\r\n\r\n      /** @type {Anchor} */\r\n      let anchor;\r\n      try {\r\n        const range = await this._integration.anchor(\r\n          this.element,\r\n          target.selector\r\n        );\r\n        // Convert the `Range` to a `TextRange` which can be converted back to\r\n        // a `Range` later. The `TextRange` representation allows for highlights\r\n        // to be inserted during anchoring other annotations without \"breaking\"\r\n        // this anchor.\r\n        const textRange = TextRange.fromRange(range);\r\n        anchor = { annotation, target, range: textRange };\r\n      } catch (err) {\r\n        anchor = { annotation, target };\r\n      }\r\n      return anchor;\r\n    };\r\n\r\n    /**\r\n     * Highlight the text range that `anchor` refers to.\r\n     *\r\n     * @param {Anchor} anchor\r\n     */\r\n    const highlight = anchor => {\r\n      const range = resolveAnchor(anchor);\r\n      if (!range) {\r\n        return;\r\n      }\r\n\r\n      const highlights = /** @type {AnnotationHighlight[]} */ (\r\n        highlightRange(range)\r\n      );\r\n      highlights.forEach(h => {\r\n        h._annotation = anchor.annotation;\r\n      });\r\n      anchor.highlights = highlights;\r\n\r\n      if (this._focusedAnnotations.has(anchor.annotation.$tag)) {\r\n        setHighlightsFocused(highlights, true);\r\n      }\r\n    };\r\n\r\n    // Remove existing anchors for this annotation.\r\n    this.detach(annotation.$tag, false /* notify */);\r\n\r\n    this._annotations.add(annotation.$tag);\r\n\r\n    // Resolve selectors to ranges and insert highlights.\r\n    if (!annotation.target) {\r\n      annotation.target = [];\r\n    }\r\n    const anchors = await Promise.all(annotation.target.map(locate));\r\n\r\n    // If the annotation was removed while anchoring, don't save the anchors.\r\n    if (!this._annotations.has(annotation.$tag)) {\r\n      return [];\r\n    }\r\n\r\n    for (let anchor of anchors) {\r\n      highlight(anchor);\r\n    }\r\n\r\n    // Set flag indicating whether anchoring succeeded. For each target,\r\n    // anchoring is successful either if there are no selectors (ie. this is a\r\n    // Page Note) or we successfully resolved the selectors to a range.\r\n    annotation.$orphan =\r\n      anchors.length > 0 &&\r\n      anchors.every(anchor => anchor.target.selector && !anchor.range);\r\n\r\n    this._updateAnchors(this.anchors.concat(anchors), true /* notify */);\r\n\r\n    // Let other frames (eg. the sidebar) know about the new annotation.\r\n    this._sidebarRPC.call('syncAnchoringStatus', annotation);\r\n\r\n    return anchors;\r\n  }\r\n\r\n  /**\r\n   * Remove the anchors and associated highlights for an annotation from the document.\r\n   *\r\n   * @param {string} tag\r\n   * @param {boolean} [notify] - For internal use. Whether to inform the host\r\n   *   frame about the removal of an anchor.\r\n   */\r\n  detach(tag, notify = true) {\r\n    this._annotations.delete(tag);\r\n\r\n    /** @type {Anchor[]} */\r\n    const anchors = [];\r\n    for (let anchor of this.anchors) {\r\n      if (anchor.annotation.$tag !== tag) {\r\n        anchors.push(anchor);\r\n      } else if (anchor.highlights) {\r\n        removeHighlights(anchor.highlights);\r\n      }\r\n    }\r\n    this._updateAnchors(anchors, notify);\r\n  }\r\n\r\n  /**\r\n   * @param {Anchor[]} anchors\r\n   * @param {boolean} notify\r\n   */\r\n  _updateAnchors(anchors, notify) {\r\n    this.anchors = anchors;\r\n    if (notify) {\r\n      this._bucketBarClient.update(this.anchors);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a new annotation that is associated with the selected region of\r\n   * the current document.\r\n   *\r\n   * @param {object} options\r\n   *   @param {boolean} [options.highlight] - If true, the new annotation has\r\n   *     the `$highlight` flag set, causing it to be saved immediately without\r\n   *     prompting for a comment.\r\n   * @return {Promise<AnnotationData>} - The new annotation\r\n   */\r\n  async createAnnotation({ highlight = false } = {}) {\r\n    const ranges = this.selectedRanges;\r\n    this.selectedRanges = [];\r\n\r\n    const info = await this.getDocumentInfo();\r\n    const root = this.element;\r\n    const rangeSelectors = await Promise.all(\r\n      ranges.map(range => this._integration.describe(root, range))\r\n    );\r\n    const target = rangeSelectors.map(selectors => ({\r\n      source: info.uri,\r\n\r\n      // In the Hypothesis API the field containing the selectors is called\r\n      // `selector`, despite being a list.\r\n      selector: selectors,\r\n    }));\r\n\r\n    /** @type {AnnotationData} */\r\n    const annotation = {\r\n      uri: info.uri,\r\n      document: info.metadata,\r\n      target,\r\n      $highlight: highlight,\r\n      $tag: 'a:' + generateHexString(8),\r\n    };\r\n\r\n    this._sidebarRPC.call('createAnnotation', annotation);\r\n    this.anchor(annotation);\r\n\r\n    // Removing the text selection triggers the `SelectionObserver` callback,\r\n    // which causes the adder to be removed after some delay.\r\n    removeTextSelection();\r\n\r\n    return annotation;\r\n  }\r\n\r\n  /**\r\n   * Indicate in the sidebar that certain annotations are focused (ie. the\r\n   * associated document region(s) is hovered).\r\n   *\r\n   * @param {string[]} tags\r\n   */\r\n  _focusAnnotations(tags) {\r\n    this._focusedAnnotations.clear();\r\n    tags.forEach(tag => this._focusedAnnotations.add(tag));\r\n\r\n    for (let anchor of this.anchors) {\r\n      if (anchor.highlights) {\r\n        const toggle = tags.includes(anchor.annotation.$tag);\r\n        setHighlightsFocused(anchor.highlights, toggle);\r\n      }\r\n    }\r\n\r\n    this._sidebarRPC.call('focusAnnotations', tags);\r\n  }\r\n\r\n  /**\r\n   * Scroll to the closest off screen anchor.\r\n   *\r\n   * @param {string[]} tags\r\n   * @param {'down'|'up'} direction\r\n   */\r\n  _scrollToClosestOffScreenAnchor(tags, direction) {\r\n    const anchors = this.anchors.filter(({ annotation }) =>\r\n      tags.includes(annotation.$tag)\r\n    );\r\n    const closest = findClosestOffscreenAnchor(anchors, direction);\r\n    if (closest) {\r\n      this._integration.scrollToAnchor(closest);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show or hide the adder toolbar when the selection changes.\r\n   *\r\n   * @param {Range} range\r\n   */\r\n  _onSelection(range) {\r\n    if (!this._integration.canAnnotate(range)) {\r\n      this._onClearSelection();\r\n      return;\r\n    }\r\n\r\n    const selection = /** @type {Selection} */ (document.getSelection());\r\n    const isBackwards = rangeUtil.isSelectionBackwards(selection);\r\n    const focusRect = rangeUtil.selectionFocusRect(selection);\r\n    if (!focusRect) {\r\n      // The selected range does not contain any text\r\n      this._onClearSelection();\r\n      return;\r\n    }\r\n\r\n    this.selectedRanges = [range];\r\n    this._hostRPC.call('textSelected');\r\n\r\n    this._adder.annotationsForSelection = annotationsForSelection();\r\n    this._isAdderVisible = true;\r\n    this._adder.show(focusRect, isBackwards);\r\n  }\r\n\r\n  _onClearSelection() {\r\n    this._isAdderVisible = false;\r\n    this._adder.hide();\r\n    this.selectedRanges = [];\r\n    if (this._informHostOnNextSelectionClear) {\r\n      this._hostRPC.call('textUnselected');\r\n    }\r\n    this._informHostOnNextSelectionClear = true;\r\n  }\r\n\r\n  /**\r\n   * Show the given annotations in the sidebar.\r\n   *\r\n   * This sets up a filter in the sidebar to show only the selected annotations\r\n   * and opens the sidebar.\r\n   *\r\n   * @param {string[]} tags\r\n   * @param {boolean} [toggle] - Toggle whether the annotations are selected\r\n   *   instead of showing them regardless of whether they are currently selected.\r\n   */\r\n  selectAnnotations(tags, toggle = false) {\r\n    if (toggle) {\r\n      this._sidebarRPC.call('toggleAnnotationSelection', tags);\r\n    } else {\r\n      this._sidebarRPC.call('showAnnotations', tags);\r\n    }\r\n    this._sidebarRPC.call('openSidebar');\r\n  }\r\n\r\n  /**\r\n   * Set whether highlights are visible in the document or not.\r\n   *\r\n   * @param {boolean} visible\r\n   */\r\n  setHighlightsVisible(visible) {\r\n    setHighlightsVisible(this.element, visible);\r\n    this._highlightsVisible = visible;\r\n  }\r\n\r\n  /**\r\n   * Attempt to fit the document content alongside the sidebar.\r\n   *\r\n   * @param {SidebarLayout} sidebarLayout\r\n   */\r\n  fitSideBySide(sidebarLayout) {\r\n    this._sideBySideActive = this._integration.fitSideBySide(sidebarLayout);\r\n  }\r\n\r\n  /**\r\n   * Return true if side-by-side mode is currently active.\r\n   *\r\n   * Side-by-side mode is activated or de-activated when `fitSideBySide` is called\r\n   * depending on whether the sidebar is expanded and whether there is room for\r\n   * the content alongside the sidebar.\r\n   */\r\n  get sideBySideActive() {\r\n    return this._sideBySideActive;\r\n  }\r\n\r\n  /**\r\n   * Return the tags of annotations that are currently displayed in a focused\r\n   * state.\r\n   *\r\n   * @return {Set<string>}\r\n   */\r\n  get focusedAnnotationTags() {\r\n    return this._focusedAnnotations;\r\n  }\r\n}\r\n","/**\r\n * Test whether an iframe fills the viewport of an ancestor frame.\r\n *\r\n * @param {Window} frame\r\n * @param {Window} ancestor\r\n */\r\nexport function frameFillsAncestor(frame, ancestor) {\r\n  if (frame === ancestor) {\r\n    return true;\r\n  }\r\n\r\n  if (frame.parent !== ancestor) {\r\n    // To keep things simple, we initially only support direct ancestors.\r\n    return false;\r\n  }\r\n\r\n  if (!frame.frameElement) {\r\n    // This is a cross-origin iframe. In this case we can't tell if it fills\r\n    // the parent frame or not.\r\n    return false;\r\n  }\r\n\r\n  const frameBox = frame.frameElement.getBoundingClientRect();\r\n\r\n  // Threshold for deciding when a frame occupies enough of its parent's width\r\n  // to count as filling the viewport.\r\n  const fullWidthThreshold = 0.8;\r\n\r\n  return frameBox.width / frame.parent.innerWidth >= fullWidthThreshold;\r\n}\r\n","/**\r\n * Encode app configuration in a URL fragment.\r\n *\r\n * This is used by the annotator to pass configuration to the sidebar and\r\n * notebook apps, which they can easily read on startup. The configuration is\r\n * passed in the fragment to avoid invalidating cache entries for the URL\r\n * or adding noise to server logs.\r\n *\r\n * @param {string} baseURL\r\n * @param {object} config\r\n * @return {string} URL with added fragment\r\n */\r\nexport function addConfigFragment(baseURL, config) {\r\n  const url = new URL(baseURL);\r\n  const params = new URLSearchParams();\r\n  params.append('config', JSON.stringify(config));\r\n  url.hash = params.toString();\r\n  return url.toString();\r\n}\r\n\r\n/**\r\n * Parse configuration from a URL generated by {@link addConfigFragment}.\r\n *\r\n * @param {string} url\r\n * @return {Record<string, unknown>}\r\n */\r\nexport function parseConfigFragment(url) {\r\n  const configStr = new URL(url).hash.slice(1);\r\n  const configJSON = new URLSearchParams(configStr).get('config');\r\n  return JSON.parse(configJSON || '{}');\r\n}\r\n","/**\r\n * Create the JSON-serializable subset of annotator configuration that should\r\n * be passed to the sidebar or notebook applications.\r\n *\r\n * @param {string} appURL - URL from which the application will be served\r\n * @param {Record<string, unknown>} config\r\n * @return {Record<string, unknown>}\r\n */\r\nexport function createAppConfig(appURL, config) {\r\n  /** @type {Record<string, unknown>} */\r\n  const appConfig = {};\r\n\r\n  for (let [key, value] of Object.entries(config)) {\r\n    // Remove several annotator-only properties.\r\n    //\r\n    // nb. We don't currently strip all the annotator-only properties here.\r\n    // That's OK because validation / filtering happens in the sidebar app itself.\r\n    // It just results in unnecessary content in the sidebar iframe's URL string.\r\n    if (key === 'notebookAppUrl' || key === 'sidebarAppUrl') {\r\n      continue;\r\n    }\r\n\r\n    // Strip nullish properties, as these are ignored by the application and\r\n    // they add noise to logs etc.\r\n    //\r\n    // eslint-disable-next-line eqeqeq\r\n    if (value == null) {\r\n      continue;\r\n    }\r\n\r\n    appConfig[key] = value;\r\n  }\r\n\r\n  // Pass the expected origin of the app. This is used to detect when it is\r\n  // served from a different location than expected, which may stop it working.\r\n  appConfig.origin = new URL(appURL).origin;\r\n\r\n  // Pass the version of the client, so we can check if it is the same as the\r\n  // one used in the sidebar/notebook.\r\n  appConfig.version = '__VERSION__';\r\n\r\n  // Pass the URL of the page that embedded the client.\r\n  const hostURL = new URL(window.location.href);\r\n  hostURL.hash = '';\r\n  appConfig.hostURL = hostURL.toString();\r\n\r\n  // Some config settings are not JSON-stringifiable (e.g. JavaScript\r\n  // functions) and will be omitted when the config is JSON-stringified.\r\n  // Add a JSON-stringifiable option for each of these so that the sidebar can\r\n  // at least know whether the callback functions were provided or not.\r\n  if (Array.isArray(appConfig.services) && appConfig.services?.length > 0) {\r\n    const service = appConfig.services[0];\r\n    if (service.onLoginRequest) {\r\n      service.onLoginRequestProvided = true;\r\n    }\r\n    if (service.onLogoutRequest) {\r\n      service.onLogoutRequestProvided = true;\r\n    }\r\n    if (service.onSignupRequest) {\r\n      service.onSignupRequestProvided = true;\r\n    }\r\n    if (service.onProfileRequest) {\r\n      service.onProfileRequestProvided = true;\r\n    }\r\n    if (service.onHelpRequest) {\r\n      service.onHelpRequestProvided = true;\r\n    }\r\n  }\r\n\r\n  return appConfig;\r\n}\r\n","import { IconButton } from '@hypothesis/frontend-shared';\r\nimport { useEffect, useRef, useState } from 'preact/hooks';\r\nimport classnames from 'classnames';\r\n\r\nimport { addConfigFragment } from '../../shared/config-fragment';\r\nimport { createAppConfig } from '../config/app';\r\n\r\n/**\r\n * Configuration used to launch the notebook application.\r\n *\r\n * This includes the URL for the iframe and configuration to pass to the\r\n * application on launch.\r\n *\r\n * @typedef {{ notebookAppUrl: string } & Record<string, unknown>} NotebookConfig\r\n */\r\n\r\n/**\r\n * @typedef NotebookIframeProps\r\n * @prop {NotebookConfig} config\r\n * @prop {string} groupId\r\n */\r\n\r\n/**\r\n * Create the iframe that will load the notebook application.\r\n *\r\n * @param {NotebookIframeProps} props\r\n */\r\nfunction NotebookIframe({ config, groupId }) {\r\n  const notebookAppSrc = addConfigFragment(config.notebookAppUrl, {\r\n    ...createAppConfig(config.notebookAppUrl, config),\r\n\r\n    // Explicity set the \"focused\" group\r\n    group: groupId,\r\n  });\r\n\r\n  return (\r\n    <iframe\r\n      title={'Hypothesis annotation notebook'}\r\n      className=\"h-full w-full border-0\"\r\n      // Enable media in annotations to be shown fullscreen\r\n      allowFullScreen\r\n      src={notebookAppSrc}\r\n    />\r\n  );\r\n}\r\n\r\n/** @typedef {import('../util/emitter').Emitter} Emitter */\r\n\r\n/**\r\n * @typedef NotebookModalProps\r\n * @prop {import('../util/emitter').EventBus} eventBus\r\n * @prop {NotebookConfig} config\r\n */\r\n\r\n/**\r\n * Create a modal component that hosts (1) the notebook iframe and (2) a button to close the modal.\r\n *\r\n * @param {NotebookModalProps} props\r\n */\r\nexport default function NotebookModal({ eventBus, config }) {\r\n  // Temporary solution: while there is no mechanism to sync new annotations in\r\n  // the notebook, we force re-rendering of the iframe on every 'openNotebook'\r\n  // event, so that the new annotations are displayed.\r\n  // https://github.com/hypothesis/client/issues/3182\r\n  const [iframeKey, setIframeKey] = useState(0);\r\n  const [isHidden, setIsHidden] = useState(true);\r\n  const [groupId, setGroupId] = useState(/** @type {string|null} */ (null));\r\n  const originalDocumentOverflowStyle = useRef('');\r\n  const emitterRef = useRef(/** @type {Emitter|null} */ (null));\r\n\r\n  // Stores the original overflow CSS property of document.body and reset it\r\n  // when the component is destroyed\r\n  useEffect(() => {\r\n    originalDocumentOverflowStyle.current = document.body.style.overflow;\r\n\r\n    return () => {\r\n      document.body.style.overflow = originalDocumentOverflowStyle.current;\r\n    };\r\n  }, []);\r\n\r\n  // The overflow CSS property is set to hidden to prevent scrolling of the host page,\r\n  // while the notebook modal is open. It is restored when the modal is closed.\r\n  useEffect(() => {\r\n    if (isHidden) {\r\n      document.body.style.overflow = originalDocumentOverflowStyle.current;\r\n    } else {\r\n      document.body.style.overflow = 'hidden';\r\n    }\r\n  }, [isHidden]);\r\n\r\n  useEffect(() => {\r\n    const emitter = eventBus.createEmitter();\r\n    emitter.subscribe('openNotebook', (/** @type {string} */ groupId) => {\r\n      setIsHidden(false);\r\n      setIframeKey(iframeKey => iframeKey + 1);\r\n      setGroupId(groupId);\r\n    });\r\n    emitterRef.current = emitter;\r\n\r\n    return () => {\r\n      emitter.destroy();\r\n    };\r\n  }, [eventBus]);\r\n\r\n  const onClose = () => {\r\n    setIsHidden(true);\r\n    emitterRef.current?.publish('closeNotebook');\r\n  };\r\n\r\n  if (groupId === null) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={classnames(\r\n        'fixed z-max top-0 left-0 right-0 bottom-0 p-3 bg-black/50',\r\n        { hidden: isHidden }\r\n      )}\r\n      data-testid=\"notebook-outer\"\r\n    >\r\n      <div className=\"relative w-full h-full\" data-testid=\"notebook-inner\">\r\n        <div className=\"absolute right-0 text-xl m-3\">\r\n          <IconButton\r\n            icon=\"cancel\"\r\n            title=\"Close the Notebook\"\r\n            onClick={onClose}\r\n            variant=\"dark\"\r\n          />\r\n        </div>\r\n        <NotebookIframe key={iframeKey} config={config} groupId={groupId} />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { createShadowRoot } from './util/shadow-root';\r\nimport { render } from 'preact';\r\nimport NotebookModal from './components/NotebookModal';\r\n\r\n/**\r\n * @typedef {import('../types/annotator').Destroyable} Destroyable\r\n * @typedef {import('./components/NotebookModal').NotebookConfig} NotebookConfig\r\n */\r\n\r\n/** @implements {Destroyable} */\r\nexport class Notebook {\r\n  /**\r\n   * @param {HTMLElement} element\r\n   * @param {import('./util/emitter').EventBus} eventBus -\r\n   *   Enables communication between components sharing the same eventBus\r\n   * @param {NotebookConfig} config\r\n   */\r\n  constructor(element, eventBus, config) {\r\n    /**\r\n     * Un-styled shadow host for the notebook content.\r\n     * This isolates the notebook from the page's styles.\r\n     */\r\n    this._outerContainer = document.createElement('hypothesis-notebook');\r\n    element.appendChild(this._outerContainer);\r\n    this.shadowRoot = createShadowRoot(this._outerContainer);\r\n\r\n    render(\r\n      <NotebookModal eventBus={eventBus} config={config} />,\r\n      this.shadowRoot\r\n    );\r\n  }\r\n\r\n  destroy() {\r\n    render(null, this.shadowRoot);\r\n    this._outerContainer.remove();\r\n  }\r\n}\r\n","/*! Hammer.JS - v2.0.7 - 2016-04-22\n * http://hammerjs.github.io/\n *\n * Copyright (c) 2016 Jorik Tangelder;\n * Licensed under the MIT license */\n(function(window, document, exportName, undefined) {\n  'use strict';\n\nvar VENDOR_PREFIXES = ['', 'webkit', 'Moz', 'MS', 'ms', 'o'];\nvar TEST_ELEMENT = document.createElement('div');\n\nvar TYPE_FUNCTION = 'function';\n\nvar round = Math.round;\nvar abs = Math.abs;\nvar now = Date.now;\n\n/**\n * set a timeout with a given scope\n * @param {Function} fn\n * @param {Number} timeout\n * @param {Object} context\n * @returns {number}\n */\nfunction setTimeoutContext(fn, timeout, context) {\n    return setTimeout(bindFn(fn, context), timeout);\n}\n\n/**\n * if the argument is an array, we want to execute the fn on each entry\n * if it aint an array we don't want to do a thing.\n * this is used by all the methods that accept a single and array argument.\n * @param {*|Array} arg\n * @param {String} fn\n * @param {Object} [context]\n * @returns {Boolean}\n */\nfunction invokeArrayArg(arg, fn, context) {\n    if (Array.isArray(arg)) {\n        each(arg, context[fn], context);\n        return true;\n    }\n    return false;\n}\n\n/**\n * walk objects and arrays\n * @param {Object} obj\n * @param {Function} iterator\n * @param {Object} context\n */\nfunction each(obj, iterator, context) {\n    var i;\n\n    if (!obj) {\n        return;\n    }\n\n    if (obj.forEach) {\n        obj.forEach(iterator, context);\n    } else if (obj.length !== undefined) {\n        i = 0;\n        while (i < obj.length) {\n            iterator.call(context, obj[i], i, obj);\n            i++;\n        }\n    } else {\n        for (i in obj) {\n            obj.hasOwnProperty(i) && iterator.call(context, obj[i], i, obj);\n        }\n    }\n}\n\n/**\n * wrap a method with a deprecation warning and stack trace\n * @param {Function} method\n * @param {String} name\n * @param {String} message\n * @returns {Function} A new function wrapping the supplied method.\n */\nfunction deprecate(method, name, message) {\n    var deprecationMessage = 'DEPRECATED METHOD: ' + name + '\\n' + message + ' AT \\n';\n    return function() {\n        var e = new Error('get-stack-trace');\n        var stack = e && e.stack ? e.stack.replace(/^[^\\(]+?[\\n$]/gm, '')\n            .replace(/^\\s+at\\s+/gm, '')\n            .replace(/^Object.<anonymous>\\s*\\(/gm, '{anonymous}()@') : 'Unknown Stack Trace';\n\n        var log = window.console && (window.console.warn || window.console.log);\n        if (log) {\n            log.call(window.console, deprecationMessage, stack);\n        }\n        return method.apply(this, arguments);\n    };\n}\n\n/**\n * extend object.\n * means that properties in dest will be overwritten by the ones in src.\n * @param {Object} target\n * @param {...Object} objects_to_assign\n * @returns {Object} target\n */\nvar assign;\nif (typeof Object.assign !== 'function') {\n    assign = function assign(target) {\n        if (target === undefined || target === null) {\n            throw new TypeError('Cannot convert undefined or null to object');\n        }\n\n        var output = Object(target);\n        for (var index = 1; index < arguments.length; index++) {\n            var source = arguments[index];\n            if (source !== undefined && source !== null) {\n                for (var nextKey in source) {\n                    if (source.hasOwnProperty(nextKey)) {\n                        output[nextKey] = source[nextKey];\n                    }\n                }\n            }\n        }\n        return output;\n    };\n} else {\n    assign = Object.assign;\n}\n\n/**\n * extend object.\n * means that properties in dest will be overwritten by the ones in src.\n * @param {Object} dest\n * @param {Object} src\n * @param {Boolean} [merge=false]\n * @returns {Object} dest\n */\nvar extend = deprecate(function extend(dest, src, merge) {\n    var keys = Object.keys(src);\n    var i = 0;\n    while (i < keys.length) {\n        if (!merge || (merge && dest[keys[i]] === undefined)) {\n            dest[keys[i]] = src[keys[i]];\n        }\n        i++;\n    }\n    return dest;\n}, 'extend', 'Use `assign`.');\n\n/**\n * merge the values from src in the dest.\n * means that properties that exist in dest will not be overwritten by src\n * @param {Object} dest\n * @param {Object} src\n * @returns {Object} dest\n */\nvar merge = deprecate(function merge(dest, src) {\n    return extend(dest, src, true);\n}, 'merge', 'Use `assign`.');\n\n/**\n * simple class inheritance\n * @param {Function} child\n * @param {Function} base\n * @param {Object} [properties]\n */\nfunction inherit(child, base, properties) {\n    var baseP = base.prototype,\n        childP;\n\n    childP = child.prototype = Object.create(baseP);\n    childP.constructor = child;\n    childP._super = baseP;\n\n    if (properties) {\n        assign(childP, properties);\n    }\n}\n\n/**\n * simple function bind\n * @param {Function} fn\n * @param {Object} context\n * @returns {Function}\n */\nfunction bindFn(fn, context) {\n    return function boundFn() {\n        return fn.apply(context, arguments);\n    };\n}\n\n/**\n * let a boolean value also be a function that must return a boolean\n * this first item in args will be used as the context\n * @param {Boolean|Function} val\n * @param {Array} [args]\n * @returns {Boolean}\n */\nfunction boolOrFn(val, args) {\n    if (typeof val == TYPE_FUNCTION) {\n        return val.apply(args ? args[0] || undefined : undefined, args);\n    }\n    return val;\n}\n\n/**\n * use the val2 when val1 is undefined\n * @param {*} val1\n * @param {*} val2\n * @returns {*}\n */\nfunction ifUndefined(val1, val2) {\n    return (val1 === undefined) ? val2 : val1;\n}\n\n/**\n * addEventListener with multiple events at once\n * @param {EventTarget} target\n * @param {String} types\n * @param {Function} handler\n */\nfunction addEventListeners(target, types, handler) {\n    each(splitStr(types), function(type) {\n        target.addEventListener(type, handler, false);\n    });\n}\n\n/**\n * removeEventListener with multiple events at once\n * @param {EventTarget} target\n * @param {String} types\n * @param {Function} handler\n */\nfunction removeEventListeners(target, types, handler) {\n    each(splitStr(types), function(type) {\n        target.removeEventListener(type, handler, false);\n    });\n}\n\n/**\n * find if a node is in the given parent\n * @method hasParent\n * @param {HTMLElement} node\n * @param {HTMLElement} parent\n * @return {Boolean} found\n */\nfunction hasParent(node, parent) {\n    while (node) {\n        if (node == parent) {\n            return true;\n        }\n        node = node.parentNode;\n    }\n    return false;\n}\n\n/**\n * small indexOf wrapper\n * @param {String} str\n * @param {String} find\n * @returns {Boolean} found\n */\nfunction inStr(str, find) {\n    return str.indexOf(find) > -1;\n}\n\n/**\n * split string on whitespace\n * @param {String} str\n * @returns {Array} words\n */\nfunction splitStr(str) {\n    return str.trim().split(/\\s+/g);\n}\n\n/**\n * find if a array contains the object using indexOf or a simple polyFill\n * @param {Array} src\n * @param {String} find\n * @param {String} [findByKey]\n * @return {Boolean|Number} false when not found, or the index\n */\nfunction inArray(src, find, findByKey) {\n    if (src.indexOf && !findByKey) {\n        return src.indexOf(find);\n    } else {\n        var i = 0;\n        while (i < src.length) {\n            if ((findByKey && src[i][findByKey] == find) || (!findByKey && src[i] === find)) {\n                return i;\n            }\n            i++;\n        }\n        return -1;\n    }\n}\n\n/**\n * convert array-like objects to real arrays\n * @param {Object} obj\n * @returns {Array}\n */\nfunction toArray(obj) {\n    return Array.prototype.slice.call(obj, 0);\n}\n\n/**\n * unique array with objects based on a key (like 'id') or just by the array's value\n * @param {Array} src [{id:1},{id:2},{id:1}]\n * @param {String} [key]\n * @param {Boolean} [sort=False]\n * @returns {Array} [{id:1},{id:2}]\n */\nfunction uniqueArray(src, key, sort) {\n    var results = [];\n    var values = [];\n    var i = 0;\n\n    while (i < src.length) {\n        var val = key ? src[i][key] : src[i];\n        if (inArray(values, val) < 0) {\n            results.push(src[i]);\n        }\n        values[i] = val;\n        i++;\n    }\n\n    if (sort) {\n        if (!key) {\n            results = results.sort();\n        } else {\n            results = results.sort(function sortUniqueArray(a, b) {\n                return a[key] > b[key];\n            });\n        }\n    }\n\n    return results;\n}\n\n/**\n * get the prefixed property\n * @param {Object} obj\n * @param {String} property\n * @returns {String|Undefined} prefixed\n */\nfunction prefixed(obj, property) {\n    var prefix, prop;\n    var camelProp = property[0].toUpperCase() + property.slice(1);\n\n    var i = 0;\n    while (i < VENDOR_PREFIXES.length) {\n        prefix = VENDOR_PREFIXES[i];\n        prop = (prefix) ? prefix + camelProp : property;\n\n        if (prop in obj) {\n            return prop;\n        }\n        i++;\n    }\n    return undefined;\n}\n\n/**\n * get a unique id\n * @returns {number} uniqueId\n */\nvar _uniqueId = 1;\nfunction uniqueId() {\n    return _uniqueId++;\n}\n\n/**\n * get the window object of an element\n * @param {HTMLElement} element\n * @returns {DocumentView|Window}\n */\nfunction getWindowForElement(element) {\n    var doc = element.ownerDocument || element;\n    return (doc.defaultView || doc.parentWindow || window);\n}\n\nvar MOBILE_REGEX = /mobile|tablet|ip(ad|hone|od)|android/i;\n\nvar SUPPORT_TOUCH = ('ontouchstart' in window);\nvar SUPPORT_POINTER_EVENTS = prefixed(window, 'PointerEvent') !== undefined;\nvar SUPPORT_ONLY_TOUCH = SUPPORT_TOUCH && MOBILE_REGEX.test(navigator.userAgent);\n\nvar INPUT_TYPE_TOUCH = 'touch';\nvar INPUT_TYPE_PEN = 'pen';\nvar INPUT_TYPE_MOUSE = 'mouse';\nvar INPUT_TYPE_KINECT = 'kinect';\n\nvar COMPUTE_INTERVAL = 25;\n\nvar INPUT_START = 1;\nvar INPUT_MOVE = 2;\nvar INPUT_END = 4;\nvar INPUT_CANCEL = 8;\n\nvar DIRECTION_NONE = 1;\nvar DIRECTION_LEFT = 2;\nvar DIRECTION_RIGHT = 4;\nvar DIRECTION_UP = 8;\nvar DIRECTION_DOWN = 16;\n\nvar DIRECTION_HORIZONTAL = DIRECTION_LEFT | DIRECTION_RIGHT;\nvar DIRECTION_VERTICAL = DIRECTION_UP | DIRECTION_DOWN;\nvar DIRECTION_ALL = DIRECTION_HORIZONTAL | DIRECTION_VERTICAL;\n\nvar PROPS_XY = ['x', 'y'];\nvar PROPS_CLIENT_XY = ['clientX', 'clientY'];\n\n/**\n * create new input type manager\n * @param {Manager} manager\n * @param {Function} callback\n * @returns {Input}\n * @constructor\n */\nfunction Input(manager, callback) {\n    var self = this;\n    this.manager = manager;\n    this.callback = callback;\n    this.element = manager.element;\n    this.target = manager.options.inputTarget;\n\n    // smaller wrapper around the handler, for the scope and the enabled state of the manager,\n    // so when disabled the input events are completely bypassed.\n    this.domHandler = function(ev) {\n        if (boolOrFn(manager.options.enable, [manager])) {\n            self.handler(ev);\n        }\n    };\n\n    this.init();\n\n}\n\nInput.prototype = {\n    /**\n     * should handle the inputEvent data and trigger the callback\n     * @virtual\n     */\n    handler: function() { },\n\n    /**\n     * bind the events\n     */\n    init: function() {\n        this.evEl && addEventListeners(this.element, this.evEl, this.domHandler);\n        this.evTarget && addEventListeners(this.target, this.evTarget, this.domHandler);\n        this.evWin && addEventListeners(getWindowForElement(this.element), this.evWin, this.domHandler);\n    },\n\n    /**\n     * unbind the events\n     */\n    destroy: function() {\n        this.evEl && removeEventListeners(this.element, this.evEl, this.domHandler);\n        this.evTarget && removeEventListeners(this.target, this.evTarget, this.domHandler);\n        this.evWin && removeEventListeners(getWindowForElement(this.element), this.evWin, this.domHandler);\n    }\n};\n\n/**\n * create new input type manager\n * called by the Manager constructor\n * @param {Hammer} manager\n * @returns {Input}\n */\nfunction createInputInstance(manager) {\n    var Type;\n    var inputClass = manager.options.inputClass;\n\n    if (inputClass) {\n        Type = inputClass;\n    } else if (SUPPORT_POINTER_EVENTS) {\n        Type = PointerEventInput;\n    } else if (SUPPORT_ONLY_TOUCH) {\n        Type = TouchInput;\n    } else if (!SUPPORT_TOUCH) {\n        Type = MouseInput;\n    } else {\n        Type = TouchMouseInput;\n    }\n    return new (Type)(manager, inputHandler);\n}\n\n/**\n * handle input events\n * @param {Manager} manager\n * @param {String} eventType\n * @param {Object} input\n */\nfunction inputHandler(manager, eventType, input) {\n    var pointersLen = input.pointers.length;\n    var changedPointersLen = input.changedPointers.length;\n    var isFirst = (eventType & INPUT_START && (pointersLen - changedPointersLen === 0));\n    var isFinal = (eventType & (INPUT_END | INPUT_CANCEL) && (pointersLen - changedPointersLen === 0));\n\n    input.isFirst = !!isFirst;\n    input.isFinal = !!isFinal;\n\n    if (isFirst) {\n        manager.session = {};\n    }\n\n    // source event is the normalized value of the domEvents\n    // like 'touchstart, mouseup, pointerdown'\n    input.eventType = eventType;\n\n    // compute scale, rotation etc\n    computeInputData(manager, input);\n\n    // emit secret event\n    manager.emit('hammer.input', input);\n\n    manager.recognize(input);\n    manager.session.prevInput = input;\n}\n\n/**\n * extend the data with some usable properties like scale, rotate, velocity etc\n * @param {Object} manager\n * @param {Object} input\n */\nfunction computeInputData(manager, input) {\n    var session = manager.session;\n    var pointers = input.pointers;\n    var pointersLength = pointers.length;\n\n    // store the first input to calculate the distance and direction\n    if (!session.firstInput) {\n        session.firstInput = simpleCloneInputData(input);\n    }\n\n    // to compute scale and rotation we need to store the multiple touches\n    if (pointersLength > 1 && !session.firstMultiple) {\n        session.firstMultiple = simpleCloneInputData(input);\n    } else if (pointersLength === 1) {\n        session.firstMultiple = false;\n    }\n\n    var firstInput = session.firstInput;\n    var firstMultiple = session.firstMultiple;\n    var offsetCenter = firstMultiple ? firstMultiple.center : firstInput.center;\n\n    var center = input.center = getCenter(pointers);\n    input.timeStamp = now();\n    input.deltaTime = input.timeStamp - firstInput.timeStamp;\n\n    input.angle = getAngle(offsetCenter, center);\n    input.distance = getDistance(offsetCenter, center);\n\n    computeDeltaXY(session, input);\n    input.offsetDirection = getDirection(input.deltaX, input.deltaY);\n\n    var overallVelocity = getVelocity(input.deltaTime, input.deltaX, input.deltaY);\n    input.overallVelocityX = overallVelocity.x;\n    input.overallVelocityY = overallVelocity.y;\n    input.overallVelocity = (abs(overallVelocity.x) > abs(overallVelocity.y)) ? overallVelocity.x : overallVelocity.y;\n\n    input.scale = firstMultiple ? getScale(firstMultiple.pointers, pointers) : 1;\n    input.rotation = firstMultiple ? getRotation(firstMultiple.pointers, pointers) : 0;\n\n    input.maxPointers = !session.prevInput ? input.pointers.length : ((input.pointers.length >\n        session.prevInput.maxPointers) ? input.pointers.length : session.prevInput.maxPointers);\n\n    computeIntervalInputData(session, input);\n\n    // find the correct target\n    var target = manager.element;\n    if (hasParent(input.srcEvent.target, target)) {\n        target = input.srcEvent.target;\n    }\n    input.target = target;\n}\n\nfunction computeDeltaXY(session, input) {\n    var center = input.center;\n    var offset = session.offsetDelta || {};\n    var prevDelta = session.prevDelta || {};\n    var prevInput = session.prevInput || {};\n\n    if (input.eventType === INPUT_START || prevInput.eventType === INPUT_END) {\n        prevDelta = session.prevDelta = {\n            x: prevInput.deltaX || 0,\n            y: prevInput.deltaY || 0\n        };\n\n        offset = session.offsetDelta = {\n            x: center.x,\n            y: center.y\n        };\n    }\n\n    input.deltaX = prevDelta.x + (center.x - offset.x);\n    input.deltaY = prevDelta.y + (center.y - offset.y);\n}\n\n/**\n * velocity is calculated every x ms\n * @param {Object} session\n * @param {Object} input\n */\nfunction computeIntervalInputData(session, input) {\n    var last = session.lastInterval || input,\n        deltaTime = input.timeStamp - last.timeStamp,\n        velocity, velocityX, velocityY, direction;\n\n    if (input.eventType != INPUT_CANCEL && (deltaTime > COMPUTE_INTERVAL || last.velocity === undefined)) {\n        var deltaX = input.deltaX - last.deltaX;\n        var deltaY = input.deltaY - last.deltaY;\n\n        var v = getVelocity(deltaTime, deltaX, deltaY);\n        velocityX = v.x;\n        velocityY = v.y;\n        velocity = (abs(v.x) > abs(v.y)) ? v.x : v.y;\n        direction = getDirection(deltaX, deltaY);\n\n        session.lastInterval = input;\n    } else {\n        // use latest velocity info if it doesn't overtake a minimum period\n        velocity = last.velocity;\n        velocityX = last.velocityX;\n        velocityY = last.velocityY;\n        direction = last.direction;\n    }\n\n    input.velocity = velocity;\n    input.velocityX = velocityX;\n    input.velocityY = velocityY;\n    input.direction = direction;\n}\n\n/**\n * create a simple clone from the input used for storage of firstInput and firstMultiple\n * @param {Object} input\n * @returns {Object} clonedInputData\n */\nfunction simpleCloneInputData(input) {\n    // make a simple copy of the pointers because we will get a reference if we don't\n    // we only need clientXY for the calculations\n    var pointers = [];\n    var i = 0;\n    while (i < input.pointers.length) {\n        pointers[i] = {\n            clientX: round(input.pointers[i].clientX),\n            clientY: round(input.pointers[i].clientY)\n        };\n        i++;\n    }\n\n    return {\n        timeStamp: now(),\n        pointers: pointers,\n        center: getCenter(pointers),\n        deltaX: input.deltaX,\n        deltaY: input.deltaY\n    };\n}\n\n/**\n * get the center of all the pointers\n * @param {Array} pointers\n * @return {Object} center contains `x` and `y` properties\n */\nfunction getCenter(pointers) {\n    var pointersLength = pointers.length;\n\n    // no need to loop when only one touch\n    if (pointersLength === 1) {\n        return {\n            x: round(pointers[0].clientX),\n            y: round(pointers[0].clientY)\n        };\n    }\n\n    var x = 0, y = 0, i = 0;\n    while (i < pointersLength) {\n        x += pointers[i].clientX;\n        y += pointers[i].clientY;\n        i++;\n    }\n\n    return {\n        x: round(x / pointersLength),\n        y: round(y / pointersLength)\n    };\n}\n\n/**\n * calculate the velocity between two points. unit is in px per ms.\n * @param {Number} deltaTime\n * @param {Number} x\n * @param {Number} y\n * @return {Object} velocity `x` and `y`\n */\nfunction getVelocity(deltaTime, x, y) {\n    return {\n        x: x / deltaTime || 0,\n        y: y / deltaTime || 0\n    };\n}\n\n/**\n * get the direction between two points\n * @param {Number} x\n * @param {Number} y\n * @return {Number} direction\n */\nfunction getDirection(x, y) {\n    if (x === y) {\n        return DIRECTION_NONE;\n    }\n\n    if (abs(x) >= abs(y)) {\n        return x < 0 ? DIRECTION_LEFT : DIRECTION_RIGHT;\n    }\n    return y < 0 ? DIRECTION_UP : DIRECTION_DOWN;\n}\n\n/**\n * calculate the absolute distance between two points\n * @param {Object} p1 {x, y}\n * @param {Object} p2 {x, y}\n * @param {Array} [props] containing x and y keys\n * @return {Number} distance\n */\nfunction getDistance(p1, p2, props) {\n    if (!props) {\n        props = PROPS_XY;\n    }\n    var x = p2[props[0]] - p1[props[0]],\n        y = p2[props[1]] - p1[props[1]];\n\n    return Math.sqrt((x * x) + (y * y));\n}\n\n/**\n * calculate the angle between two coordinates\n * @param {Object} p1\n * @param {Object} p2\n * @param {Array} [props] containing x and y keys\n * @return {Number} angle\n */\nfunction getAngle(p1, p2, props) {\n    if (!props) {\n        props = PROPS_XY;\n    }\n    var x = p2[props[0]] - p1[props[0]],\n        y = p2[props[1]] - p1[props[1]];\n    return Math.atan2(y, x) * 180 / Math.PI;\n}\n\n/**\n * calculate the rotation degrees between two pointersets\n * @param {Array} start array of pointers\n * @param {Array} end array of pointers\n * @return {Number} rotation\n */\nfunction getRotation(start, end) {\n    return getAngle(end[1], end[0], PROPS_CLIENT_XY) + getAngle(start[1], start[0], PROPS_CLIENT_XY);\n}\n\n/**\n * calculate the scale factor between two pointersets\n * no scale is 1, and goes down to 0 when pinched together, and bigger when pinched out\n * @param {Array} start array of pointers\n * @param {Array} end array of pointers\n * @return {Number} scale\n */\nfunction getScale(start, end) {\n    return getDistance(end[0], end[1], PROPS_CLIENT_XY) / getDistance(start[0], start[1], PROPS_CLIENT_XY);\n}\n\nvar MOUSE_INPUT_MAP = {\n    mousedown: INPUT_START,\n    mousemove: INPUT_MOVE,\n    mouseup: INPUT_END\n};\n\nvar MOUSE_ELEMENT_EVENTS = 'mousedown';\nvar MOUSE_WINDOW_EVENTS = 'mousemove mouseup';\n\n/**\n * Mouse events input\n * @constructor\n * @extends Input\n */\nfunction MouseInput() {\n    this.evEl = MOUSE_ELEMENT_EVENTS;\n    this.evWin = MOUSE_WINDOW_EVENTS;\n\n    this.pressed = false; // mousedown state\n\n    Input.apply(this, arguments);\n}\n\ninherit(MouseInput, Input, {\n    /**\n     * handle mouse events\n     * @param {Object} ev\n     */\n    handler: function MEhandler(ev) {\n        var eventType = MOUSE_INPUT_MAP[ev.type];\n\n        // on start we want to have the left mouse button down\n        if (eventType & INPUT_START && ev.button === 0) {\n            this.pressed = true;\n        }\n\n        if (eventType & INPUT_MOVE && ev.which !== 1) {\n            eventType = INPUT_END;\n        }\n\n        // mouse must be down\n        if (!this.pressed) {\n            return;\n        }\n\n        if (eventType & INPUT_END) {\n            this.pressed = false;\n        }\n\n        this.callback(this.manager, eventType, {\n            pointers: [ev],\n            changedPointers: [ev],\n            pointerType: INPUT_TYPE_MOUSE,\n            srcEvent: ev\n        });\n    }\n});\n\nvar POINTER_INPUT_MAP = {\n    pointerdown: INPUT_START,\n    pointermove: INPUT_MOVE,\n    pointerup: INPUT_END,\n    pointercancel: INPUT_CANCEL,\n    pointerout: INPUT_CANCEL\n};\n\n// in IE10 the pointer types is defined as an enum\nvar IE10_POINTER_TYPE_ENUM = {\n    2: INPUT_TYPE_TOUCH,\n    3: INPUT_TYPE_PEN,\n    4: INPUT_TYPE_MOUSE,\n    5: INPUT_TYPE_KINECT // see https://twitter.com/jacobrossi/status/480596438489890816\n};\n\nvar POINTER_ELEMENT_EVENTS = 'pointerdown';\nvar POINTER_WINDOW_EVENTS = 'pointermove pointerup pointercancel';\n\n// IE10 has prefixed support, and case-sensitive\nif (window.MSPointerEvent && !window.PointerEvent) {\n    POINTER_ELEMENT_EVENTS = 'MSPointerDown';\n    POINTER_WINDOW_EVENTS = 'MSPointerMove MSPointerUp MSPointerCancel';\n}\n\n/**\n * Pointer events input\n * @constructor\n * @extends Input\n */\nfunction PointerEventInput() {\n    this.evEl = POINTER_ELEMENT_EVENTS;\n    this.evWin = POINTER_WINDOW_EVENTS;\n\n    Input.apply(this, arguments);\n\n    this.store = (this.manager.session.pointerEvents = []);\n}\n\ninherit(PointerEventInput, Input, {\n    /**\n     * handle mouse events\n     * @param {Object} ev\n     */\n    handler: function PEhandler(ev) {\n        var store = this.store;\n        var removePointer = false;\n\n        var eventTypeNormalized = ev.type.toLowerCase().replace('ms', '');\n        var eventType = POINTER_INPUT_MAP[eventTypeNormalized];\n        var pointerType = IE10_POINTER_TYPE_ENUM[ev.pointerType] || ev.pointerType;\n\n        var isTouch = (pointerType == INPUT_TYPE_TOUCH);\n\n        // get index of the event in the store\n        var storeIndex = inArray(store, ev.pointerId, 'pointerId');\n\n        // start and mouse must be down\n        if (eventType & INPUT_START && (ev.button === 0 || isTouch)) {\n            if (storeIndex < 0) {\n                store.push(ev);\n                storeIndex = store.length - 1;\n            }\n        } else if (eventType & (INPUT_END | INPUT_CANCEL)) {\n            removePointer = true;\n        }\n\n        // it not found, so the pointer hasn't been down (so it's probably a hover)\n        if (storeIndex < 0) {\n            return;\n        }\n\n        // update the event in the store\n        store[storeIndex] = ev;\n\n        this.callback(this.manager, eventType, {\n            pointers: store,\n            changedPointers: [ev],\n            pointerType: pointerType,\n            srcEvent: ev\n        });\n\n        if (removePointer) {\n            // remove from the store\n            store.splice(storeIndex, 1);\n        }\n    }\n});\n\nvar SINGLE_TOUCH_INPUT_MAP = {\n    touchstart: INPUT_START,\n    touchmove: INPUT_MOVE,\n    touchend: INPUT_END,\n    touchcancel: INPUT_CANCEL\n};\n\nvar SINGLE_TOUCH_TARGET_EVENTS = 'touchstart';\nvar SINGLE_TOUCH_WINDOW_EVENTS = 'touchstart touchmove touchend touchcancel';\n\n/**\n * Touch events input\n * @constructor\n * @extends Input\n */\nfunction SingleTouchInput() {\n    this.evTarget = SINGLE_TOUCH_TARGET_EVENTS;\n    this.evWin = SINGLE_TOUCH_WINDOW_EVENTS;\n    this.started = false;\n\n    Input.apply(this, arguments);\n}\n\ninherit(SingleTouchInput, Input, {\n    handler: function TEhandler(ev) {\n        var type = SINGLE_TOUCH_INPUT_MAP[ev.type];\n\n        // should we handle the touch events?\n        if (type === INPUT_START) {\n            this.started = true;\n        }\n\n        if (!this.started) {\n            return;\n        }\n\n        var touches = normalizeSingleTouches.call(this, ev, type);\n\n        // when done, reset the started state\n        if (type & (INPUT_END | INPUT_CANCEL) && touches[0].length - touches[1].length === 0) {\n            this.started = false;\n        }\n\n        this.callback(this.manager, type, {\n            pointers: touches[0],\n            changedPointers: touches[1],\n            pointerType: INPUT_TYPE_TOUCH,\n            srcEvent: ev\n        });\n    }\n});\n\n/**\n * @this {TouchInput}\n * @param {Object} ev\n * @param {Number} type flag\n * @returns {undefined|Array} [all, changed]\n */\nfunction normalizeSingleTouches(ev, type) {\n    var all = toArray(ev.touches);\n    var changed = toArray(ev.changedTouches);\n\n    if (type & (INPUT_END | INPUT_CANCEL)) {\n        all = uniqueArray(all.concat(changed), 'identifier', true);\n    }\n\n    return [all, changed];\n}\n\nvar TOUCH_INPUT_MAP = {\n    touchstart: INPUT_START,\n    touchmove: INPUT_MOVE,\n    touchend: INPUT_END,\n    touchcancel: INPUT_CANCEL\n};\n\nvar TOUCH_TARGET_EVENTS = 'touchstart touchmove touchend touchcancel';\n\n/**\n * Multi-user touch events input\n * @constructor\n * @extends Input\n */\nfunction TouchInput() {\n    this.evTarget = TOUCH_TARGET_EVENTS;\n    this.targetIds = {};\n\n    Input.apply(this, arguments);\n}\n\ninherit(TouchInput, Input, {\n    handler: function MTEhandler(ev) {\n        var type = TOUCH_INPUT_MAP[ev.type];\n        var touches = getTouches.call(this, ev, type);\n        if (!touches) {\n            return;\n        }\n\n        this.callback(this.manager, type, {\n            pointers: touches[0],\n            changedPointers: touches[1],\n            pointerType: INPUT_TYPE_TOUCH,\n            srcEvent: ev\n        });\n    }\n});\n\n/**\n * @this {TouchInput}\n * @param {Object} ev\n * @param {Number} type flag\n * @returns {undefined|Array} [all, changed]\n */\nfunction getTouches(ev, type) {\n    var allTouches = toArray(ev.touches);\n    var targetIds = this.targetIds;\n\n    // when there is only one touch, the process can be simplified\n    if (type & (INPUT_START | INPUT_MOVE) && allTouches.length === 1) {\n        targetIds[allTouches[0].identifier] = true;\n        return [allTouches, allTouches];\n    }\n\n    var i,\n        targetTouches,\n        changedTouches = toArray(ev.changedTouches),\n        changedTargetTouches = [],\n        target = this.target;\n\n    // get target touches from touches\n    targetTouches = allTouches.filter(function(touch) {\n        return hasParent(touch.target, target);\n    });\n\n    // collect touches\n    if (type === INPUT_START) {\n        i = 0;\n        while (i < targetTouches.length) {\n            targetIds[targetTouches[i].identifier] = true;\n            i++;\n        }\n    }\n\n    // filter changed touches to only contain touches that exist in the collected target ids\n    i = 0;\n    while (i < changedTouches.length) {\n        if (targetIds[changedTouches[i].identifier]) {\n            changedTargetTouches.push(changedTouches[i]);\n        }\n\n        // cleanup removed touches\n        if (type & (INPUT_END | INPUT_CANCEL)) {\n            delete targetIds[changedTouches[i].identifier];\n        }\n        i++;\n    }\n\n    if (!changedTargetTouches.length) {\n        return;\n    }\n\n    return [\n        // merge targetTouches with changedTargetTouches so it contains ALL touches, including 'end' and 'cancel'\n        uniqueArray(targetTouches.concat(changedTargetTouches), 'identifier', true),\n        changedTargetTouches\n    ];\n}\n\n/**\n * Combined touch and mouse input\n *\n * Touch has a higher priority then mouse, and while touching no mouse events are allowed.\n * This because touch devices also emit mouse events while doing a touch.\n *\n * @constructor\n * @extends Input\n */\n\nvar DEDUP_TIMEOUT = 2500;\nvar DEDUP_DISTANCE = 25;\n\nfunction TouchMouseInput() {\n    Input.apply(this, arguments);\n\n    var handler = bindFn(this.handler, this);\n    this.touch = new TouchInput(this.manager, handler);\n    this.mouse = new MouseInput(this.manager, handler);\n\n    this.primaryTouch = null;\n    this.lastTouches = [];\n}\n\ninherit(TouchMouseInput, Input, {\n    /**\n     * handle mouse and touch events\n     * @param {Hammer} manager\n     * @param {String} inputEvent\n     * @param {Object} inputData\n     */\n    handler: function TMEhandler(manager, inputEvent, inputData) {\n        var isTouch = (inputData.pointerType == INPUT_TYPE_TOUCH),\n            isMouse = (inputData.pointerType == INPUT_TYPE_MOUSE);\n\n        if (isMouse && inputData.sourceCapabilities && inputData.sourceCapabilities.firesTouchEvents) {\n            return;\n        }\n\n        // when we're in a touch event, record touches to  de-dupe synthetic mouse event\n        if (isTouch) {\n            recordTouches.call(this, inputEvent, inputData);\n        } else if (isMouse && isSyntheticEvent.call(this, inputData)) {\n            return;\n        }\n\n        this.callback(manager, inputEvent, inputData);\n    },\n\n    /**\n     * remove the event listeners\n     */\n    destroy: function destroy() {\n        this.touch.destroy();\n        this.mouse.destroy();\n    }\n});\n\nfunction recordTouches(eventType, eventData) {\n    if (eventType & INPUT_START) {\n        this.primaryTouch = eventData.changedPointers[0].identifier;\n        setLastTouch.call(this, eventData);\n    } else if (eventType & (INPUT_END | INPUT_CANCEL)) {\n        setLastTouch.call(this, eventData);\n    }\n}\n\nfunction setLastTouch(eventData) {\n    var touch = eventData.changedPointers[0];\n\n    if (touch.identifier === this.primaryTouch) {\n        var lastTouch = {x: touch.clientX, y: touch.clientY};\n        this.lastTouches.push(lastTouch);\n        var lts = this.lastTouches;\n        var removeLastTouch = function() {\n            var i = lts.indexOf(lastTouch);\n            if (i > -1) {\n                lts.splice(i, 1);\n            }\n        };\n        setTimeout(removeLastTouch, DEDUP_TIMEOUT);\n    }\n}\n\nfunction isSyntheticEvent(eventData) {\n    var x = eventData.srcEvent.clientX, y = eventData.srcEvent.clientY;\n    for (var i = 0; i < this.lastTouches.length; i++) {\n        var t = this.lastTouches[i];\n        var dx = Math.abs(x - t.x), dy = Math.abs(y - t.y);\n        if (dx <= DEDUP_DISTANCE && dy <= DEDUP_DISTANCE) {\n            return true;\n        }\n    }\n    return false;\n}\n\nvar PREFIXED_TOUCH_ACTION = prefixed(TEST_ELEMENT.style, 'touchAction');\nvar NATIVE_TOUCH_ACTION = PREFIXED_TOUCH_ACTION !== undefined;\n\n// magical touchAction value\nvar TOUCH_ACTION_COMPUTE = 'compute';\nvar TOUCH_ACTION_AUTO = 'auto';\nvar TOUCH_ACTION_MANIPULATION = 'manipulation'; // not implemented\nvar TOUCH_ACTION_NONE = 'none';\nvar TOUCH_ACTION_PAN_X = 'pan-x';\nvar TOUCH_ACTION_PAN_Y = 'pan-y';\nvar TOUCH_ACTION_MAP = getTouchActionProps();\n\n/**\n * Touch Action\n * sets the touchAction property or uses the js alternative\n * @param {Manager} manager\n * @param {String} value\n * @constructor\n */\nfunction TouchAction(manager, value) {\n    this.manager = manager;\n    this.set(value);\n}\n\nTouchAction.prototype = {\n    /**\n     * set the touchAction value on the element or enable the polyfill\n     * @param {String} value\n     */\n    set: function(value) {\n        // find out the touch-action by the event handlers\n        if (value == TOUCH_ACTION_COMPUTE) {\n            value = this.compute();\n        }\n\n        if (NATIVE_TOUCH_ACTION && this.manager.element.style && TOUCH_ACTION_MAP[value]) {\n            this.manager.element.style[PREFIXED_TOUCH_ACTION] = value;\n        }\n        this.actions = value.toLowerCase().trim();\n    },\n\n    /**\n     * just re-set the touchAction value\n     */\n    update: function() {\n        this.set(this.manager.options.touchAction);\n    },\n\n    /**\n     * compute the value for the touchAction property based on the recognizer's settings\n     * @returns {String} value\n     */\n    compute: function() {\n        var actions = [];\n        each(this.manager.recognizers, function(recognizer) {\n            if (boolOrFn(recognizer.options.enable, [recognizer])) {\n                actions = actions.concat(recognizer.getTouchAction());\n            }\n        });\n        return cleanTouchActions(actions.join(' '));\n    },\n\n    /**\n     * this method is called on each input cycle and provides the preventing of the browser behavior\n     * @param {Object} input\n     */\n    preventDefaults: function(input) {\n        var srcEvent = input.srcEvent;\n        var direction = input.offsetDirection;\n\n        // if the touch action did prevented once this session\n        if (this.manager.session.prevented) {\n            srcEvent.preventDefault();\n            return;\n        }\n\n        var actions = this.actions;\n        var hasNone = inStr(actions, TOUCH_ACTION_NONE) && !TOUCH_ACTION_MAP[TOUCH_ACTION_NONE];\n        var hasPanY = inStr(actions, TOUCH_ACTION_PAN_Y) && !TOUCH_ACTION_MAP[TOUCH_ACTION_PAN_Y];\n        var hasPanX = inStr(actions, TOUCH_ACTION_PAN_X) && !TOUCH_ACTION_MAP[TOUCH_ACTION_PAN_X];\n\n        if (hasNone) {\n            //do not prevent defaults if this is a tap gesture\n\n            var isTapPointer = input.pointers.length === 1;\n            var isTapMovement = input.distance < 2;\n            var isTapTouchTime = input.deltaTime < 250;\n\n            if (isTapPointer && isTapMovement && isTapTouchTime) {\n                return;\n            }\n        }\n\n        if (hasPanX && hasPanY) {\n            // `pan-x pan-y` means browser handles all scrolling/panning, do not prevent\n            return;\n        }\n\n        if (hasNone ||\n            (hasPanY && direction & DIRECTION_HORIZONTAL) ||\n            (hasPanX && direction & DIRECTION_VERTICAL)) {\n            return this.preventSrc(srcEvent);\n        }\n    },\n\n    /**\n     * call preventDefault to prevent the browser's default behavior (scrolling in most cases)\n     * @param {Object} srcEvent\n     */\n    preventSrc: function(srcEvent) {\n        this.manager.session.prevented = true;\n        srcEvent.preventDefault();\n    }\n};\n\n/**\n * when the touchActions are collected they are not a valid value, so we need to clean things up. *\n * @param {String} actions\n * @returns {*}\n */\nfunction cleanTouchActions(actions) {\n    // none\n    if (inStr(actions, TOUCH_ACTION_NONE)) {\n        return TOUCH_ACTION_NONE;\n    }\n\n    var hasPanX = inStr(actions, TOUCH_ACTION_PAN_X);\n    var hasPanY = inStr(actions, TOUCH_ACTION_PAN_Y);\n\n    // if both pan-x and pan-y are set (different recognizers\n    // for different directions, e.g. horizontal pan but vertical swipe?)\n    // we need none (as otherwise with pan-x pan-y combined none of these\n    // recognizers will work, since the browser would handle all panning\n    if (hasPanX && hasPanY) {\n        return TOUCH_ACTION_NONE;\n    }\n\n    // pan-x OR pan-y\n    if (hasPanX || hasPanY) {\n        return hasPanX ? TOUCH_ACTION_PAN_X : TOUCH_ACTION_PAN_Y;\n    }\n\n    // manipulation\n    if (inStr(actions, TOUCH_ACTION_MANIPULATION)) {\n        return TOUCH_ACTION_MANIPULATION;\n    }\n\n    return TOUCH_ACTION_AUTO;\n}\n\nfunction getTouchActionProps() {\n    if (!NATIVE_TOUCH_ACTION) {\n        return false;\n    }\n    var touchMap = {};\n    var cssSupports = window.CSS && window.CSS.supports;\n    ['auto', 'manipulation', 'pan-y', 'pan-x', 'pan-x pan-y', 'none'].forEach(function(val) {\n\n        // If css.supports is not supported but there is native touch-action assume it supports\n        // all values. This is the case for IE 10 and 11.\n        touchMap[val] = cssSupports ? window.CSS.supports('touch-action', val) : true;\n    });\n    return touchMap;\n}\n\n/**\n * Recognizer flow explained; *\n * All recognizers have the initial state of POSSIBLE when a input session starts.\n * The definition of a input session is from the first input until the last input, with all it's movement in it. *\n * Example session for mouse-input: mousedown -> mousemove -> mouseup\n *\n * On each recognizing cycle (see Manager.recognize) the .recognize() method is executed\n * which determines with state it should be.\n *\n * If the recognizer has the state FAILED, CANCELLED or RECOGNIZED (equals ENDED), it is reset to\n * POSSIBLE to give it another change on the next cycle.\n *\n *               Possible\n *                  |\n *            +-----+---------------+\n *            |                     |\n *      +-----+-----+               |\n *      |           |               |\n *   Failed      Cancelled          |\n *                          +-------+------+\n *                          |              |\n *                      Recognized       Began\n *                                         |\n *                                      Changed\n *                                         |\n *                                  Ended/Recognized\n */\nvar STATE_POSSIBLE = 1;\nvar STATE_BEGAN = 2;\nvar STATE_CHANGED = 4;\nvar STATE_ENDED = 8;\nvar STATE_RECOGNIZED = STATE_ENDED;\nvar STATE_CANCELLED = 16;\nvar STATE_FAILED = 32;\n\n/**\n * Recognizer\n * Every recognizer needs to extend from this class.\n * @constructor\n * @param {Object} options\n */\nfunction Recognizer(options) {\n    this.options = assign({}, this.defaults, options || {});\n\n    this.id = uniqueId();\n\n    this.manager = null;\n\n    // default is enable true\n    this.options.enable = ifUndefined(this.options.enable, true);\n\n    this.state = STATE_POSSIBLE;\n\n    this.simultaneous = {};\n    this.requireFail = [];\n}\n\nRecognizer.prototype = {\n    /**\n     * @virtual\n     * @type {Object}\n     */\n    defaults: {},\n\n    /**\n     * set options\n     * @param {Object} options\n     * @return {Recognizer}\n     */\n    set: function(options) {\n        assign(this.options, options);\n\n        // also update the touchAction, in case something changed about the directions/enabled state\n        this.manager && this.manager.touchAction.update();\n        return this;\n    },\n\n    /**\n     * recognize simultaneous with an other recognizer.\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    recognizeWith: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'recognizeWith', this)) {\n            return this;\n        }\n\n        var simultaneous = this.simultaneous;\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        if (!simultaneous[otherRecognizer.id]) {\n            simultaneous[otherRecognizer.id] = otherRecognizer;\n            otherRecognizer.recognizeWith(this);\n        }\n        return this;\n    },\n\n    /**\n     * drop the simultaneous link. it doesnt remove the link on the other recognizer.\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    dropRecognizeWith: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'dropRecognizeWith', this)) {\n            return this;\n        }\n\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        delete this.simultaneous[otherRecognizer.id];\n        return this;\n    },\n\n    /**\n     * recognizer can only run when an other is failing\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    requireFailure: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'requireFailure', this)) {\n            return this;\n        }\n\n        var requireFail = this.requireFail;\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        if (inArray(requireFail, otherRecognizer) === -1) {\n            requireFail.push(otherRecognizer);\n            otherRecognizer.requireFailure(this);\n        }\n        return this;\n    },\n\n    /**\n     * drop the requireFailure link. it does not remove the link on the other recognizer.\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    dropRequireFailure: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'dropRequireFailure', this)) {\n            return this;\n        }\n\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        var index = inArray(this.requireFail, otherRecognizer);\n        if (index > -1) {\n            this.requireFail.splice(index, 1);\n        }\n        return this;\n    },\n\n    /**\n     * has require failures boolean\n     * @returns {boolean}\n     */\n    hasRequireFailures: function() {\n        return this.requireFail.length > 0;\n    },\n\n    /**\n     * if the recognizer can recognize simultaneous with an other recognizer\n     * @param {Recognizer} otherRecognizer\n     * @returns {Boolean}\n     */\n    canRecognizeWith: function(otherRecognizer) {\n        return !!this.simultaneous[otherRecognizer.id];\n    },\n\n    /**\n     * You should use `tryEmit` instead of `emit` directly to check\n     * that all the needed recognizers has failed before emitting.\n     * @param {Object} input\n     */\n    emit: function(input) {\n        var self = this;\n        var state = this.state;\n\n        function emit(event) {\n            self.manager.emit(event, input);\n        }\n\n        // 'panstart' and 'panmove'\n        if (state < STATE_ENDED) {\n            emit(self.options.event + stateStr(state));\n        }\n\n        emit(self.options.event); // simple 'eventName' events\n\n        if (input.additionalEvent) { // additional event(panleft, panright, pinchin, pinchout...)\n            emit(input.additionalEvent);\n        }\n\n        // panend and pancancel\n        if (state >= STATE_ENDED) {\n            emit(self.options.event + stateStr(state));\n        }\n    },\n\n    /**\n     * Check that all the require failure recognizers has failed,\n     * if true, it emits a gesture event,\n     * otherwise, setup the state to FAILED.\n     * @param {Object} input\n     */\n    tryEmit: function(input) {\n        if (this.canEmit()) {\n            return this.emit(input);\n        }\n        // it's failing anyway\n        this.state = STATE_FAILED;\n    },\n\n    /**\n     * can we emit?\n     * @returns {boolean}\n     */\n    canEmit: function() {\n        var i = 0;\n        while (i < this.requireFail.length) {\n            if (!(this.requireFail[i].state & (STATE_FAILED | STATE_POSSIBLE))) {\n                return false;\n            }\n            i++;\n        }\n        return true;\n    },\n\n    /**\n     * update the recognizer\n     * @param {Object} inputData\n     */\n    recognize: function(inputData) {\n        // make a new copy of the inputData\n        // so we can change the inputData without messing up the other recognizers\n        var inputDataClone = assign({}, inputData);\n\n        // is is enabled and allow recognizing?\n        if (!boolOrFn(this.options.enable, [this, inputDataClone])) {\n            this.reset();\n            this.state = STATE_FAILED;\n            return;\n        }\n\n        // reset when we've reached the end\n        if (this.state & (STATE_RECOGNIZED | STATE_CANCELLED | STATE_FAILED)) {\n            this.state = STATE_POSSIBLE;\n        }\n\n        this.state = this.process(inputDataClone);\n\n        // the recognizer has recognized a gesture\n        // so trigger an event\n        if (this.state & (STATE_BEGAN | STATE_CHANGED | STATE_ENDED | STATE_CANCELLED)) {\n            this.tryEmit(inputDataClone);\n        }\n    },\n\n    /**\n     * return the state of the recognizer\n     * the actual recognizing happens in this method\n     * @virtual\n     * @param {Object} inputData\n     * @returns {Const} STATE\n     */\n    process: function(inputData) { }, // jshint ignore:line\n\n    /**\n     * return the preferred touch-action\n     * @virtual\n     * @returns {Array}\n     */\n    getTouchAction: function() { },\n\n    /**\n     * called when the gesture isn't allowed to recognize\n     * like when another is being recognized or it is disabled\n     * @virtual\n     */\n    reset: function() { }\n};\n\n/**\n * get a usable string, used as event postfix\n * @param {Const} state\n * @returns {String} state\n */\nfunction stateStr(state) {\n    if (state & STATE_CANCELLED) {\n        return 'cancel';\n    } else if (state & STATE_ENDED) {\n        return 'end';\n    } else if (state & STATE_CHANGED) {\n        return 'move';\n    } else if (state & STATE_BEGAN) {\n        return 'start';\n    }\n    return '';\n}\n\n/**\n * direction cons to string\n * @param {Const} direction\n * @returns {String}\n */\nfunction directionStr(direction) {\n    if (direction == DIRECTION_DOWN) {\n        return 'down';\n    } else if (direction == DIRECTION_UP) {\n        return 'up';\n    } else if (direction == DIRECTION_LEFT) {\n        return 'left';\n    } else if (direction == DIRECTION_RIGHT) {\n        return 'right';\n    }\n    return '';\n}\n\n/**\n * get a recognizer by name if it is bound to a manager\n * @param {Recognizer|String} otherRecognizer\n * @param {Recognizer} recognizer\n * @returns {Recognizer}\n */\nfunction getRecognizerByNameIfManager(otherRecognizer, recognizer) {\n    var manager = recognizer.manager;\n    if (manager) {\n        return manager.get(otherRecognizer);\n    }\n    return otherRecognizer;\n}\n\n/**\n * This recognizer is just used as a base for the simple attribute recognizers.\n * @constructor\n * @extends Recognizer\n */\nfunction AttrRecognizer() {\n    Recognizer.apply(this, arguments);\n}\n\ninherit(AttrRecognizer, Recognizer, {\n    /**\n     * @namespace\n     * @memberof AttrRecognizer\n     */\n    defaults: {\n        /**\n         * @type {Number}\n         * @default 1\n         */\n        pointers: 1\n    },\n\n    /**\n     * Used to check if it the recognizer receives valid input, like input.distance > 10.\n     * @memberof AttrRecognizer\n     * @param {Object} input\n     * @returns {Boolean} recognized\n     */\n    attrTest: function(input) {\n        var optionPointers = this.options.pointers;\n        return optionPointers === 0 || input.pointers.length === optionPointers;\n    },\n\n    /**\n     * Process the input and return the state for the recognizer\n     * @memberof AttrRecognizer\n     * @param {Object} input\n     * @returns {*} State\n     */\n    process: function(input) {\n        var state = this.state;\n        var eventType = input.eventType;\n\n        var isRecognized = state & (STATE_BEGAN | STATE_CHANGED);\n        var isValid = this.attrTest(input);\n\n        // on cancel input and we've recognized before, return STATE_CANCELLED\n        if (isRecognized && (eventType & INPUT_CANCEL || !isValid)) {\n            return state | STATE_CANCELLED;\n        } else if (isRecognized || isValid) {\n            if (eventType & INPUT_END) {\n                return state | STATE_ENDED;\n            } else if (!(state & STATE_BEGAN)) {\n                return STATE_BEGAN;\n            }\n            return state | STATE_CHANGED;\n        }\n        return STATE_FAILED;\n    }\n});\n\n/**\n * Pan\n * Recognized when the pointer is down and moved in the allowed direction.\n * @constructor\n * @extends AttrRecognizer\n */\nfunction PanRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n\n    this.pX = null;\n    this.pY = null;\n}\n\ninherit(PanRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof PanRecognizer\n     */\n    defaults: {\n        event: 'pan',\n        threshold: 10,\n        pointers: 1,\n        direction: DIRECTION_ALL\n    },\n\n    getTouchAction: function() {\n        var direction = this.options.direction;\n        var actions = [];\n        if (direction & DIRECTION_HORIZONTAL) {\n            actions.push(TOUCH_ACTION_PAN_Y);\n        }\n        if (direction & DIRECTION_VERTICAL) {\n            actions.push(TOUCH_ACTION_PAN_X);\n        }\n        return actions;\n    },\n\n    directionTest: function(input) {\n        var options = this.options;\n        var hasMoved = true;\n        var distance = input.distance;\n        var direction = input.direction;\n        var x = input.deltaX;\n        var y = input.deltaY;\n\n        // lock to axis?\n        if (!(direction & options.direction)) {\n            if (options.direction & DIRECTION_HORIZONTAL) {\n                direction = (x === 0) ? DIRECTION_NONE : (x < 0) ? DIRECTION_LEFT : DIRECTION_RIGHT;\n                hasMoved = x != this.pX;\n                distance = Math.abs(input.deltaX);\n            } else {\n                direction = (y === 0) ? DIRECTION_NONE : (y < 0) ? DIRECTION_UP : DIRECTION_DOWN;\n                hasMoved = y != this.pY;\n                distance = Math.abs(input.deltaY);\n            }\n        }\n        input.direction = direction;\n        return hasMoved && distance > options.threshold && direction & options.direction;\n    },\n\n    attrTest: function(input) {\n        return AttrRecognizer.prototype.attrTest.call(this, input) &&\n            (this.state & STATE_BEGAN || (!(this.state & STATE_BEGAN) && this.directionTest(input)));\n    },\n\n    emit: function(input) {\n\n        this.pX = input.deltaX;\n        this.pY = input.deltaY;\n\n        var direction = directionStr(input.direction);\n\n        if (direction) {\n            input.additionalEvent = this.options.event + direction;\n        }\n        this._super.emit.call(this, input);\n    }\n});\n\n/**\n * Pinch\n * Recognized when two or more pointers are moving toward (zoom-in) or away from each other (zoom-out).\n * @constructor\n * @extends AttrRecognizer\n */\nfunction PinchRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n}\n\ninherit(PinchRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof PinchRecognizer\n     */\n    defaults: {\n        event: 'pinch',\n        threshold: 0,\n        pointers: 2\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_NONE];\n    },\n\n    attrTest: function(input) {\n        return this._super.attrTest.call(this, input) &&\n            (Math.abs(input.scale - 1) > this.options.threshold || this.state & STATE_BEGAN);\n    },\n\n    emit: function(input) {\n        if (input.scale !== 1) {\n            var inOut = input.scale < 1 ? 'in' : 'out';\n            input.additionalEvent = this.options.event + inOut;\n        }\n        this._super.emit.call(this, input);\n    }\n});\n\n/**\n * Press\n * Recognized when the pointer is down for x ms without any movement.\n * @constructor\n * @extends Recognizer\n */\nfunction PressRecognizer() {\n    Recognizer.apply(this, arguments);\n\n    this._timer = null;\n    this._input = null;\n}\n\ninherit(PressRecognizer, Recognizer, {\n    /**\n     * @namespace\n     * @memberof PressRecognizer\n     */\n    defaults: {\n        event: 'press',\n        pointers: 1,\n        time: 251, // minimal time of the pointer to be pressed\n        threshold: 9 // a minimal movement is ok, but keep it low\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_AUTO];\n    },\n\n    process: function(input) {\n        var options = this.options;\n        var validPointers = input.pointers.length === options.pointers;\n        var validMovement = input.distance < options.threshold;\n        var validTime = input.deltaTime > options.time;\n\n        this._input = input;\n\n        // we only allow little movement\n        // and we've reached an end event, so a tap is possible\n        if (!validMovement || !validPointers || (input.eventType & (INPUT_END | INPUT_CANCEL) && !validTime)) {\n            this.reset();\n        } else if (input.eventType & INPUT_START) {\n            this.reset();\n            this._timer = setTimeoutContext(function() {\n                this.state = STATE_RECOGNIZED;\n                this.tryEmit();\n            }, options.time, this);\n        } else if (input.eventType & INPUT_END) {\n            return STATE_RECOGNIZED;\n        }\n        return STATE_FAILED;\n    },\n\n    reset: function() {\n        clearTimeout(this._timer);\n    },\n\n    emit: function(input) {\n        if (this.state !== STATE_RECOGNIZED) {\n            return;\n        }\n\n        if (input && (input.eventType & INPUT_END)) {\n            this.manager.emit(this.options.event + 'up', input);\n        } else {\n            this._input.timeStamp = now();\n            this.manager.emit(this.options.event, this._input);\n        }\n    }\n});\n\n/**\n * Rotate\n * Recognized when two or more pointer are moving in a circular motion.\n * @constructor\n * @extends AttrRecognizer\n */\nfunction RotateRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n}\n\ninherit(RotateRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof RotateRecognizer\n     */\n    defaults: {\n        event: 'rotate',\n        threshold: 0,\n        pointers: 2\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_NONE];\n    },\n\n    attrTest: function(input) {\n        return this._super.attrTest.call(this, input) &&\n            (Math.abs(input.rotation) > this.options.threshold || this.state & STATE_BEGAN);\n    }\n});\n\n/**\n * Swipe\n * Recognized when the pointer is moving fast (velocity), with enough distance in the allowed direction.\n * @constructor\n * @extends AttrRecognizer\n */\nfunction SwipeRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n}\n\ninherit(SwipeRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof SwipeRecognizer\n     */\n    defaults: {\n        event: 'swipe',\n        threshold: 10,\n        velocity: 0.3,\n        direction: DIRECTION_HORIZONTAL | DIRECTION_VERTICAL,\n        pointers: 1\n    },\n\n    getTouchAction: function() {\n        return PanRecognizer.prototype.getTouchAction.call(this);\n    },\n\n    attrTest: function(input) {\n        var direction = this.options.direction;\n        var velocity;\n\n        if (direction & (DIRECTION_HORIZONTAL | DIRECTION_VERTICAL)) {\n            velocity = input.overallVelocity;\n        } else if (direction & DIRECTION_HORIZONTAL) {\n            velocity = input.overallVelocityX;\n        } else if (direction & DIRECTION_VERTICAL) {\n            velocity = input.overallVelocityY;\n        }\n\n        return this._super.attrTest.call(this, input) &&\n            direction & input.offsetDirection &&\n            input.distance > this.options.threshold &&\n            input.maxPointers == this.options.pointers &&\n            abs(velocity) > this.options.velocity && input.eventType & INPUT_END;\n    },\n\n    emit: function(input) {\n        var direction = directionStr(input.offsetDirection);\n        if (direction) {\n            this.manager.emit(this.options.event + direction, input);\n        }\n\n        this.manager.emit(this.options.event, input);\n    }\n});\n\n/**\n * A tap is ecognized when the pointer is doing a small tap/click. Multiple taps are recognized if they occur\n * between the given interval and position. The delay option can be used to recognize multi-taps without firing\n * a single tap.\n *\n * The eventData from the emitted event contains the property `tapCount`, which contains the amount of\n * multi-taps being recognized.\n * @constructor\n * @extends Recognizer\n */\nfunction TapRecognizer() {\n    Recognizer.apply(this, arguments);\n\n    // previous time and center,\n    // used for tap counting\n    this.pTime = false;\n    this.pCenter = false;\n\n    this._timer = null;\n    this._input = null;\n    this.count = 0;\n}\n\ninherit(TapRecognizer, Recognizer, {\n    /**\n     * @namespace\n     * @memberof PinchRecognizer\n     */\n    defaults: {\n        event: 'tap',\n        pointers: 1,\n        taps: 1,\n        interval: 300, // max time between the multi-tap taps\n        time: 250, // max time of the pointer to be down (like finger on the screen)\n        threshold: 9, // a minimal movement is ok, but keep it low\n        posThreshold: 10 // a multi-tap can be a bit off the initial position\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_MANIPULATION];\n    },\n\n    process: function(input) {\n        var options = this.options;\n\n        var validPointers = input.pointers.length === options.pointers;\n        var validMovement = input.distance < options.threshold;\n        var validTouchTime = input.deltaTime < options.time;\n\n        this.reset();\n\n        if ((input.eventType & INPUT_START) && (this.count === 0)) {\n            return this.failTimeout();\n        }\n\n        // we only allow little movement\n        // and we've reached an end event, so a tap is possible\n        if (validMovement && validTouchTime && validPointers) {\n            if (input.eventType != INPUT_END) {\n                return this.failTimeout();\n            }\n\n            var validInterval = this.pTime ? (input.timeStamp - this.pTime < options.interval) : true;\n            var validMultiTap = !this.pCenter || getDistance(this.pCenter, input.center) < options.posThreshold;\n\n            this.pTime = input.timeStamp;\n            this.pCenter = input.center;\n\n            if (!validMultiTap || !validInterval) {\n                this.count = 1;\n            } else {\n                this.count += 1;\n            }\n\n            this._input = input;\n\n            // if tap count matches we have recognized it,\n            // else it has began recognizing...\n            var tapCount = this.count % options.taps;\n            if (tapCount === 0) {\n                // no failing requirements, immediately trigger the tap event\n                // or wait as long as the multitap interval to trigger\n                if (!this.hasRequireFailures()) {\n                    return STATE_RECOGNIZED;\n                } else {\n                    this._timer = setTimeoutContext(function() {\n                        this.state = STATE_RECOGNIZED;\n                        this.tryEmit();\n                    }, options.interval, this);\n                    return STATE_BEGAN;\n                }\n            }\n        }\n        return STATE_FAILED;\n    },\n\n    failTimeout: function() {\n        this._timer = setTimeoutContext(function() {\n            this.state = STATE_FAILED;\n        }, this.options.interval, this);\n        return STATE_FAILED;\n    },\n\n    reset: function() {\n        clearTimeout(this._timer);\n    },\n\n    emit: function() {\n        if (this.state == STATE_RECOGNIZED) {\n            this._input.tapCount = this.count;\n            this.manager.emit(this.options.event, this._input);\n        }\n    }\n});\n\n/**\n * Simple way to create a manager with a default set of recognizers.\n * @param {HTMLElement} element\n * @param {Object} [options]\n * @constructor\n */\nfunction Hammer(element, options) {\n    options = options || {};\n    options.recognizers = ifUndefined(options.recognizers, Hammer.defaults.preset);\n    return new Manager(element, options);\n}\n\n/**\n * @const {string}\n */\nHammer.VERSION = '2.0.7';\n\n/**\n * default settings\n * @namespace\n */\nHammer.defaults = {\n    /**\n     * set if DOM events are being triggered.\n     * But this is slower and unused by simple implementations, so disabled by default.\n     * @type {Boolean}\n     * @default false\n     */\n    domEvents: false,\n\n    /**\n     * The value for the touchAction property/fallback.\n     * When set to `compute` it will magically set the correct value based on the added recognizers.\n     * @type {String}\n     * @default compute\n     */\n    touchAction: TOUCH_ACTION_COMPUTE,\n\n    /**\n     * @type {Boolean}\n     * @default true\n     */\n    enable: true,\n\n    /**\n     * EXPERIMENTAL FEATURE -- can be removed/changed\n     * Change the parent input target element.\n     * If Null, then it is being set the to main element.\n     * @type {Null|EventTarget}\n     * @default null\n     */\n    inputTarget: null,\n\n    /**\n     * force an input class\n     * @type {Null|Function}\n     * @default null\n     */\n    inputClass: null,\n\n    /**\n     * Default recognizer setup when calling `Hammer()`\n     * When creating a new Manager these will be skipped.\n     * @type {Array}\n     */\n    preset: [\n        // RecognizerClass, options, [recognizeWith, ...], [requireFailure, ...]\n        [RotateRecognizer, {enable: false}],\n        [PinchRecognizer, {enable: false}, ['rotate']],\n        [SwipeRecognizer, {direction: DIRECTION_HORIZONTAL}],\n        [PanRecognizer, {direction: DIRECTION_HORIZONTAL}, ['swipe']],\n        [TapRecognizer],\n        [TapRecognizer, {event: 'doubletap', taps: 2}, ['tap']],\n        [PressRecognizer]\n    ],\n\n    /**\n     * Some CSS properties can be used to improve the working of Hammer.\n     * Add them to this method and they will be set when creating a new Manager.\n     * @namespace\n     */\n    cssProps: {\n        /**\n         * Disables text selection to improve the dragging gesture. Mainly for desktop browsers.\n         * @type {String}\n         * @default 'none'\n         */\n        userSelect: 'none',\n\n        /**\n         * Disable the Windows Phone grippers when pressing an element.\n         * @type {String}\n         * @default 'none'\n         */\n        touchSelect: 'none',\n\n        /**\n         * Disables the default callout shown when you touch and hold a touch target.\n         * On iOS, when you touch and hold a touch target such as a link, Safari displays\n         * a callout containing information about the link. This property allows you to disable that callout.\n         * @type {String}\n         * @default 'none'\n         */\n        touchCallout: 'none',\n\n        /**\n         * Specifies whether zooming is enabled. Used by IE10>\n         * @type {String}\n         * @default 'none'\n         */\n        contentZooming: 'none',\n\n        /**\n         * Specifies that an entire element should be draggable instead of its contents. Mainly for desktop browsers.\n         * @type {String}\n         * @default 'none'\n         */\n        userDrag: 'none',\n\n        /**\n         * Overrides the highlight color shown when the user taps a link or a JavaScript\n         * clickable element in iOS. This property obeys the alpha value, if specified.\n         * @type {String}\n         * @default 'rgba(0,0,0,0)'\n         */\n        tapHighlightColor: 'rgba(0,0,0,0)'\n    }\n};\n\nvar STOP = 1;\nvar FORCED_STOP = 2;\n\n/**\n * Manager\n * @param {HTMLElement} element\n * @param {Object} [options]\n * @constructor\n */\nfunction Manager(element, options) {\n    this.options = assign({}, Hammer.defaults, options || {});\n\n    this.options.inputTarget = this.options.inputTarget || element;\n\n    this.handlers = {};\n    this.session = {};\n    this.recognizers = [];\n    this.oldCssProps = {};\n\n    this.element = element;\n    this.input = createInputInstance(this);\n    this.touchAction = new TouchAction(this, this.options.touchAction);\n\n    toggleCssProps(this, true);\n\n    each(this.options.recognizers, function(item) {\n        var recognizer = this.add(new (item[0])(item[1]));\n        item[2] && recognizer.recognizeWith(item[2]);\n        item[3] && recognizer.requireFailure(item[3]);\n    }, this);\n}\n\nManager.prototype = {\n    /**\n     * set options\n     * @param {Object} options\n     * @returns {Manager}\n     */\n    set: function(options) {\n        assign(this.options, options);\n\n        // Options that need a little more setup\n        if (options.touchAction) {\n            this.touchAction.update();\n        }\n        if (options.inputTarget) {\n            // Clean up existing event listeners and reinitialize\n            this.input.destroy();\n            this.input.target = options.inputTarget;\n            this.input.init();\n        }\n        return this;\n    },\n\n    /**\n     * stop recognizing for this session.\n     * This session will be discarded, when a new [input]start event is fired.\n     * When forced, the recognizer cycle is stopped immediately.\n     * @param {Boolean} [force]\n     */\n    stop: function(force) {\n        this.session.stopped = force ? FORCED_STOP : STOP;\n    },\n\n    /**\n     * run the recognizers!\n     * called by the inputHandler function on every movement of the pointers (touches)\n     * it walks through all the recognizers and tries to detect the gesture that is being made\n     * @param {Object} inputData\n     */\n    recognize: function(inputData) {\n        var session = this.session;\n        if (session.stopped) {\n            return;\n        }\n\n        // run the touch-action polyfill\n        this.touchAction.preventDefaults(inputData);\n\n        var recognizer;\n        var recognizers = this.recognizers;\n\n        // this holds the recognizer that is being recognized.\n        // so the recognizer's state needs to be BEGAN, CHANGED, ENDED or RECOGNIZED\n        // if no recognizer is detecting a thing, it is set to `null`\n        var curRecognizer = session.curRecognizer;\n\n        // reset when the last recognizer is recognized\n        // or when we're in a new session\n        if (!curRecognizer || (curRecognizer && curRecognizer.state & STATE_RECOGNIZED)) {\n            curRecognizer = session.curRecognizer = null;\n        }\n\n        var i = 0;\n        while (i < recognizers.length) {\n            recognizer = recognizers[i];\n\n            // find out if we are allowed try to recognize the input for this one.\n            // 1.   allow if the session is NOT forced stopped (see the .stop() method)\n            // 2.   allow if we still haven't recognized a gesture in this session, or the this recognizer is the one\n            //      that is being recognized.\n            // 3.   allow if the recognizer is allowed to run simultaneous with the current recognized recognizer.\n            //      this can be setup with the `recognizeWith()` method on the recognizer.\n            if (session.stopped !== FORCED_STOP && ( // 1\n                    !curRecognizer || recognizer == curRecognizer || // 2\n                    recognizer.canRecognizeWith(curRecognizer))) { // 3\n                recognizer.recognize(inputData);\n            } else {\n                recognizer.reset();\n            }\n\n            // if the recognizer has been recognizing the input as a valid gesture, we want to store this one as the\n            // current active recognizer. but only if we don't already have an active recognizer\n            if (!curRecognizer && recognizer.state & (STATE_BEGAN | STATE_CHANGED | STATE_ENDED)) {\n                curRecognizer = session.curRecognizer = recognizer;\n            }\n            i++;\n        }\n    },\n\n    /**\n     * get a recognizer by its event name.\n     * @param {Recognizer|String} recognizer\n     * @returns {Recognizer|Null}\n     */\n    get: function(recognizer) {\n        if (recognizer instanceof Recognizer) {\n            return recognizer;\n        }\n\n        var recognizers = this.recognizers;\n        for (var i = 0; i < recognizers.length; i++) {\n            if (recognizers[i].options.event == recognizer) {\n                return recognizers[i];\n            }\n        }\n        return null;\n    },\n\n    /**\n     * add a recognizer to the manager\n     * existing recognizers with the same event name will be removed\n     * @param {Recognizer} recognizer\n     * @returns {Recognizer|Manager}\n     */\n    add: function(recognizer) {\n        if (invokeArrayArg(recognizer, 'add', this)) {\n            return this;\n        }\n\n        // remove existing\n        var existing = this.get(recognizer.options.event);\n        if (existing) {\n            this.remove(existing);\n        }\n\n        this.recognizers.push(recognizer);\n        recognizer.manager = this;\n\n        this.touchAction.update();\n        return recognizer;\n    },\n\n    /**\n     * remove a recognizer by name or instance\n     * @param {Recognizer|String} recognizer\n     * @returns {Manager}\n     */\n    remove: function(recognizer) {\n        if (invokeArrayArg(recognizer, 'remove', this)) {\n            return this;\n        }\n\n        recognizer = this.get(recognizer);\n\n        // let's make sure this recognizer exists\n        if (recognizer) {\n            var recognizers = this.recognizers;\n            var index = inArray(recognizers, recognizer);\n\n            if (index !== -1) {\n                recognizers.splice(index, 1);\n                this.touchAction.update();\n            }\n        }\n\n        return this;\n    },\n\n    /**\n     * bind event\n     * @param {String} events\n     * @param {Function} handler\n     * @returns {EventEmitter} this\n     */\n    on: function(events, handler) {\n        if (events === undefined) {\n            return;\n        }\n        if (handler === undefined) {\n            return;\n        }\n\n        var handlers = this.handlers;\n        each(splitStr(events), function(event) {\n            handlers[event] = handlers[event] || [];\n            handlers[event].push(handler);\n        });\n        return this;\n    },\n\n    /**\n     * unbind event, leave emit blank to remove all handlers\n     * @param {String} events\n     * @param {Function} [handler]\n     * @returns {EventEmitter} this\n     */\n    off: function(events, handler) {\n        if (events === undefined) {\n            return;\n        }\n\n        var handlers = this.handlers;\n        each(splitStr(events), function(event) {\n            if (!handler) {\n                delete handlers[event];\n            } else {\n                handlers[event] && handlers[event].splice(inArray(handlers[event], handler), 1);\n            }\n        });\n        return this;\n    },\n\n    /**\n     * emit event to the listeners\n     * @param {String} event\n     * @param {Object} data\n     */\n    emit: function(event, data) {\n        // we also want to trigger dom events\n        if (this.options.domEvents) {\n            triggerDomEvent(event, data);\n        }\n\n        // no handlers, so skip it all\n        var handlers = this.handlers[event] && this.handlers[event].slice();\n        if (!handlers || !handlers.length) {\n            return;\n        }\n\n        data.type = event;\n        data.preventDefault = function() {\n            data.srcEvent.preventDefault();\n        };\n\n        var i = 0;\n        while (i < handlers.length) {\n            handlers[i](data);\n            i++;\n        }\n    },\n\n    /**\n     * destroy the manager and unbinds all events\n     * it doesn't unbind dom events, that is the user own responsibility\n     */\n    destroy: function() {\n        this.element && toggleCssProps(this, false);\n\n        this.handlers = {};\n        this.session = {};\n        this.input.destroy();\n        this.element = null;\n    }\n};\n\n/**\n * add/remove the css properties as defined in manager.options.cssProps\n * @param {Manager} manager\n * @param {Boolean} add\n */\nfunction toggleCssProps(manager, add) {\n    var element = manager.element;\n    if (!element.style) {\n        return;\n    }\n    var prop;\n    each(manager.options.cssProps, function(value, name) {\n        prop = prefixed(element.style, name);\n        if (add) {\n            manager.oldCssProps[prop] = element.style[prop];\n            element.style[prop] = value;\n        } else {\n            element.style[prop] = manager.oldCssProps[prop] || '';\n        }\n    });\n    if (!add) {\n        manager.oldCssProps = {};\n    }\n}\n\n/**\n * trigger dom event\n * @param {String} event\n * @param {Object} data\n */\nfunction triggerDomEvent(event, data) {\n    var gestureEvent = document.createEvent('Event');\n    gestureEvent.initEvent(event, true, true);\n    gestureEvent.gesture = data;\n    data.target.dispatchEvent(gestureEvent);\n}\n\nassign(Hammer, {\n    INPUT_START: INPUT_START,\n    INPUT_MOVE: INPUT_MOVE,\n    INPUT_END: INPUT_END,\n    INPUT_CANCEL: INPUT_CANCEL,\n\n    STATE_POSSIBLE: STATE_POSSIBLE,\n    STATE_BEGAN: STATE_BEGAN,\n    STATE_CHANGED: STATE_CHANGED,\n    STATE_ENDED: STATE_ENDED,\n    STATE_RECOGNIZED: STATE_RECOGNIZED,\n    STATE_CANCELLED: STATE_CANCELLED,\n    STATE_FAILED: STATE_FAILED,\n\n    DIRECTION_NONE: DIRECTION_NONE,\n    DIRECTION_LEFT: DIRECTION_LEFT,\n    DIRECTION_RIGHT: DIRECTION_RIGHT,\n    DIRECTION_UP: DIRECTION_UP,\n    DIRECTION_DOWN: DIRECTION_DOWN,\n    DIRECTION_HORIZONTAL: DIRECTION_HORIZONTAL,\n    DIRECTION_VERTICAL: DIRECTION_VERTICAL,\n    DIRECTION_ALL: DIRECTION_ALL,\n\n    Manager: Manager,\n    Input: Input,\n    TouchAction: TouchAction,\n\n    TouchInput: TouchInput,\n    MouseInput: MouseInput,\n    PointerEventInput: PointerEventInput,\n    TouchMouseInput: TouchMouseInput,\n    SingleTouchInput: SingleTouchInput,\n\n    Recognizer: Recognizer,\n    AttrRecognizer: AttrRecognizer,\n    Tap: TapRecognizer,\n    Pan: PanRecognizer,\n    Swipe: SwipeRecognizer,\n    Pinch: PinchRecognizer,\n    Rotate: RotateRecognizer,\n    Press: PressRecognizer,\n\n    on: addEventListeners,\n    off: removeEventListeners,\n    each: each,\n    merge: merge,\n    extend: extend,\n    assign: assign,\n    inherit: inherit,\n    bindFn: bindFn,\n    prefixed: prefixed\n});\n\n// this prevents errors when Hammer is loaded in the presence of an AMD\n//  style loader but by script tag, not by the loader.\nvar freeGlobal = (typeof window !== 'undefined' ? window : (typeof self !== 'undefined' ? self : {})); // jshint ignore:line\nfreeGlobal.Hammer = Hammer;\n\nif (typeof define === 'function' && define.amd) {\n    define(function() {\n        return Hammer;\n    });\n} else if (typeof module != 'undefined' && module.exports) {\n    module.exports = Hammer;\n} else {\n    window[exportName] = Hammer;\n}\n\n})(window, document, 'Hammer');\n","import { LabeledButton } from '@hypothesis/frontend-shared';\r\nimport classnames from 'classnames';\r\n\r\n/**\r\n * @typedef {import('../util/buckets').Bucket} Bucket\r\n * @typedef {import(\"preact\").ComponentChildren} Children\r\n */\r\n\r\n/**\r\n * Render a set of buckets in a vertical channel positioned along the edge of\r\n * the sidebar.\r\n *\r\n * @param {object} props\r\n *   @param {Children} props.children\r\n */\r\nfunction BucketList({ children }) {\r\n  return (\r\n    <ul\r\n      className={classnames(\r\n        // 2020-11-20: Making bucket bar one pixel wider (23px vs 22px) is an\r\n        // interim and pragmatic solution for an apparent glitch on\r\n        // Safari and Chrome. Adding one pixel resolves this issue:\r\n        // https://github.com/hypothesis/client/pull/2750\r\n        'absolute w-[23px] left-[-22px] h-full',\r\n        // The background is set to low opacity when the sidebar is collapsed.\r\n        'bg-grey-2 sidebar-collapsed:bg-black/[.08]',\r\n        // Disable pointer events along the sidebar itself; re-enable them in\r\n        // bucket indicator buttons\r\n        'pointer-events-none'\r\n      )}\r\n    >\r\n      {children}\r\n    </ul>\r\n  );\r\n}\r\n\r\n/**\r\n * Render a vertically-positioned bucket-list item.\r\n *\r\n * @param {object} props\r\n *  @param {Children} props.children\r\n *  @param {number} props.topPosition - The vertical top position, in pixels,\r\n *   for this bucket item relative to the top of the containing BucketList\r\n */\r\nfunction BucketItem({ children, topPosition }) {\r\n  return (\r\n    <li\r\n      className={classnames(\r\n        'absolute right-0',\r\n        // Re-enable pointer events, which are disabled on the containing list\r\n        'pointer-events-auto'\r\n      )}\r\n      style={{ top: topPosition }}\r\n    >\r\n      {children}\r\n    </li>\r\n  );\r\n}\r\n\r\n/**\r\n * A list of buckets, including up and down navigation (when applicable) and\r\n * on-screen buckets\r\n *\r\n * This component and its buttons are sized with absolute units such that they\r\n * don't scale with changes to the host page's root font size. They will still\r\n * properly scale with user/browser zooming.\r\n *\r\n * @param {object} props\r\n *   @param {Bucket} props.above\r\n *   @param {Bucket} props.below\r\n *   @param {Bucket[]} props.buckets\r\n *   @param {(tags: string[]) => void} props.onFocusAnnotations\r\n *   @param {(tags: string[], direction: 'down'|'up') => void} props.onScrollToClosestOffScreenAnchor\r\n *   @param {(tags: string[], toggle: boolean) => void} props.onSelectAnnotations\r\n */\r\nexport default function Buckets({\r\n  above,\r\n  below,\r\n  buckets,\r\n  onFocusAnnotations,\r\n  onScrollToClosestOffScreenAnchor,\r\n  onSelectAnnotations,\r\n}) {\r\n  const showUpNavigation = above.tags.size > 0;\r\n  const showDownNavigation = below.tags.size > 0;\r\n\r\n  return (\r\n    <BucketList>\r\n      {showUpNavigation && (\r\n        <BucketItem topPosition={above.position}>\r\n          <LabeledButton\r\n            className={classnames(\r\n              'BucketButton UpBucketButton',\r\n              // Center the button vertically at `above.position` by pulling\r\n              // its top margin up by about half the button's height.\r\n              // This puts it nearer the toolbar's other buttons above the\r\n              // bucket list.\r\n              'right-0 mt-[-11px]'\r\n            )}\r\n            data-testid=\"up-navigation-button\"\r\n            onClick={() =>\r\n              onScrollToClosestOffScreenAnchor([...above.tags], 'up')\r\n            }\r\n            onBlur={() => onFocusAnnotations([])}\r\n            onFocus={() => onFocusAnnotations([...above.tags])}\r\n            onMouseEnter={() => onFocusAnnotations([...above.tags])}\r\n            onMouseOut={() => onFocusAnnotations([])}\r\n            title={`Go up to next annotations (${above.tags.size})`}\r\n          >\r\n            {above.tags.size}\r\n          </LabeledButton>\r\n        </BucketItem>\r\n      )}\r\n      {buckets.map((bucket, index) => (\r\n        <BucketItem topPosition={bucket.position} key={index}>\r\n          <LabeledButton\r\n            className={classnames(\r\n              'BucketButton LeftBucketButton',\r\n              // Center the bucket indicator button vertically on `bucket.position`\r\n              // by pulling it by half the height of the button\r\n              'right-0 mt-[-8px]'\r\n            )}\r\n            onClick={event =>\r\n              onSelectAnnotations(\r\n                [...bucket.tags],\r\n                event.metaKey || event.ctrlKey\r\n              )\r\n            }\r\n            onBlur={() => onFocusAnnotations([])}\r\n            onFocus={() => onFocusAnnotations([...bucket.tags])}\r\n            onMouseEnter={() => onFocusAnnotations([...bucket.tags])}\r\n            onMouseOut={() => onFocusAnnotations([])}\r\n            title={`Select nearby annotations (${bucket.tags.size})`}\r\n          >\r\n            {bucket.tags.size}\r\n          </LabeledButton>\r\n        </BucketItem>\r\n      ))}\r\n      {showDownNavigation && (\r\n        <BucketItem topPosition={below.position}>\r\n          <LabeledButton\r\n            className=\"BucketButton DownBucketButton right-0\"\r\n            data-testid=\"down-navigation-button\"\r\n            onClick={() =>\r\n              onScrollToClosestOffScreenAnchor([...below.tags], 'down')\r\n            }\r\n            onBlur={() => onFocusAnnotations([])}\r\n            onFocus={() => onFocusAnnotations([...below.tags])}\r\n            onMouseEnter={() => onFocusAnnotations([...below.tags])}\r\n            onMouseOut={() => onFocusAnnotations([])}\r\n            title={`Go up to next annotations (${below.tags.size})`}\r\n          >\r\n            {below.tags.size}\r\n          </LabeledButton>\r\n        </BucketItem>\r\n      )}\r\n    </BucketList>\r\n  );\r\n}\r\n","import { render } from 'preact';\r\n\r\nimport Buckets from './components/Buckets';\r\nimport { computeBuckets } from './util/buckets';\r\n\r\n/**\r\n * @typedef {import('../types/annotator').AnchorPosition} AnchorPosition\r\n * @typedef {import('../types/annotator').Destroyable} Destroyable\r\n */\r\n\r\n/**\r\n * Controller for the \"bucket bar\" shown alongside the sidebar indicating where\r\n * annotations are in the document.\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class BucketBar {\r\n  /**\r\n   * @param {HTMLElement} container\r\n   * @param {object} options\r\n   *   @param {(tags: string[]) => void} options.onFocusAnnotations\r\n   *   @param {(tags: string[], direction: 'down'|'up') => void} options.onScrollToClosestOffScreenAnchor\r\n   *   @param {(tags: string[], toggle: boolean) => void} options.onSelectAnnotations\r\n   */\r\n  constructor(\r\n    container,\r\n    {\r\n      onFocusAnnotations,\r\n      onScrollToClosestOffScreenAnchor,\r\n      onSelectAnnotations,\r\n    }\r\n  ) {\r\n    this._bucketsContainer = document.createElement('div');\r\n    container.appendChild(this._bucketsContainer);\r\n\r\n    this._onFocusAnnotations = onFocusAnnotations;\r\n    this._onScrollToClosestOffScreenAnchor = onScrollToClosestOffScreenAnchor;\r\n    this._onSelectAnnotations = onSelectAnnotations;\r\n\r\n    // Immediately render the bucket bar\r\n    this.update([]);\r\n  }\r\n\r\n  destroy() {\r\n    render(null, this._bucketsContainer);\r\n    this._bucketsContainer.remove();\r\n  }\r\n\r\n  /**\r\n   * @param {AnchorPosition[]} positions\r\n   */\r\n  update(positions) {\r\n    const buckets = computeBuckets(positions);\r\n    render(\r\n      <Buckets\r\n        above={buckets.above}\r\n        below={buckets.below}\r\n        buckets={buckets.buckets}\r\n        onFocusAnnotations={tags => this._onFocusAnnotations(tags)}\r\n        onScrollToClosestOffScreenAnchor={(tags, direction) =>\r\n          this._onScrollToClosestOffScreenAnchor(tags, direction)\r\n        }\r\n        onSelectAnnotations={(tags, toogle) =>\r\n          this._onSelectAnnotations(tags, toogle)\r\n        }\r\n      />,\r\n      this._bucketsContainer\r\n    );\r\n  }\r\n}\r\n","import { IconButton } from '@hypothesis/frontend-shared';\r\nimport classnames from 'classnames';\r\n\r\n/**\r\n * @typedef {import(\"@hypothesis/frontend-shared/lib/components/buttons\").IconButtonProps} IconButtonProps\r\n *\r\n * @typedef {Omit<IconButtonProps, \"className\">} ToolbarButtonProps\r\n */\r\n\r\n/**\r\n * Style an IconButton for use on the Toolbar\r\n *\r\n * @param {ToolbarButtonProps} props\r\n */\r\nfunction ToolbarButton({ ...buttonProps }) {\r\n  const { icon, title, ...restProps } = buttonProps;\r\n  return (\r\n    <IconButton\r\n      className={classnames(\r\n        'w-[30px] h-[30px]', // These buttons have precise dimensions\r\n        'rounded-px', // size of border radius in absolute units\r\n        'flex items-center justify-center',\r\n        'border bg-white text-grey-6 hover:text-grey-9',\r\n        'shadow transition-colors'\r\n      )}\r\n      icon={icon}\r\n      title={title}\r\n      {...restProps}\r\n    />\r\n  );\r\n}\r\n\r\n/**\r\n * @typedef ToolbarProps\r\n *\r\n * @prop {() => void} closeSidebar -\r\n *   Callback for the \"Close sidebar\" button. This button is only shown when\r\n *   `useMinimalControls` is true and the sidebar is open.\r\n * @prop {() => void} createAnnotation -\r\n *   Callback for the \"Create annotation\" / \"Create page note\" button. The type\r\n *   of annotation depends on whether there is a text selection and is decided\r\n *   by the caller.\r\n * @prop {boolean} isSidebarOpen - Is the sidebar currently visible?\r\n * @prop {'annotation'|'note'} newAnnotationType -\r\n *   Icon to show on the \"Create annotation\" button indicating what kind of annotation\r\n *   will be created.\r\n * @prop {boolean} showHighlights - Are highlights currently visible in the document?\r\n * @prop {() => void} toggleHighlights -\r\n *   Callback to toggle visibility of highlights in the document.\r\n * @prop {() => void} toggleSidebar -\r\n *   Callback to toggle the visibility of the sidebar.\r\n * @prop {import(\"preact\").Ref<HTMLButtonElement>} [toggleSidebarRef] -\r\n *   Ref that gets set to the toolbar button for toggling the sidebar.\r\n *   This is exposed to enable the drag-to-resize functionality of this\r\n *   button.\r\n * @prop {boolean} [useMinimalControls] -\r\n *   If true, all controls are hidden except for the \"Close sidebar\" button\r\n *   when the sidebar is open. This is enabled in the \"clean\" theme.\r\n */\r\n\r\n/**\r\n * Controls on the edge of the sidebar for opening/closing the sidebar,\r\n * controlling highlight visibility and creating new page notes.\r\n *\r\n * This component and its buttons are sized with absolute units such that they\r\n * don't scale with changes to the host page's root font size. They will still\r\n * properly scale with user/browser zooming.\r\n *\r\n * @param {ToolbarProps} props\r\n */\r\nexport default function Toolbar({\r\n  closeSidebar,\r\n  createAnnotation,\r\n  isSidebarOpen,\r\n  newAnnotationType,\r\n  showHighlights,\r\n  toggleHighlights,\r\n  toggleSidebar,\r\n  toggleSidebarRef,\r\n  useMinimalControls = false,\r\n}) {\r\n  return (\r\n    <div\r\n      className={classnames(\r\n        'absolute left-[-33px] w-[33px] z-2',\r\n        'text-px-base leading-none' // non-scaling sizing\r\n      )}\r\n    >\r\n      {/* In the clean theme (`useMinimalControls` is `true`),\r\n          the only button that should appear is a button\r\n          to close the sidebar, and only if the sidebar is open. This button is\r\n          absolutely positioned some way down the edge of the sidebar.\r\n      */}\r\n      {useMinimalControls && isSidebarOpen && (\r\n        <IconButton\r\n          className={classnames(\r\n            'w-[27px] h-[27px] mt-[140px] ml-px-1.5',\r\n            'flex items-center justify-center bg-white border',\r\n            'text-grey-6 hover:text-grey-9 transition-colors',\r\n            // Turn off right border to blend with sidebar\r\n            'border-r-0',\r\n            // A more intense shadow than other ToolbarButtons, to match that\r\n            // of the edge of the sidebar in clean theme\r\n            'shadow-sidebar'\r\n          )}\r\n          title=\"Close annotation sidebar\"\r\n          icon=\"cancel\"\r\n          onClick={closeSidebar}\r\n        />\r\n      )}\r\n      {!useMinimalControls && (\r\n        <>\r\n          <IconButton\r\n            className={classnames(\r\n              // Height and width to align with the sidebar's top bar\r\n              'h-[40px] w-[33px] pl-px-1.5',\r\n              'bg-white text-grey-5 hover:text-grey-9',\r\n              // Turn on left and bottom borders to continue the\r\n              // border of the sidebar's top bar\r\n              'border-l border-b'\r\n            )}\r\n            buttonRef={toggleSidebarRef}\r\n            title=\"Annotation sidebar\"\r\n            icon={isSidebarOpen ? 'caret-right' : 'caret-left'}\r\n            expanded={isSidebarOpen}\r\n            pressed={isSidebarOpen}\r\n            onClick={toggleSidebar}\r\n          />\r\n          <div className=\"space-y-px-1.5 mt-px-2\">\r\n            <ToolbarButton\r\n              title=\"Show highlights\"\r\n              icon={showHighlights ? 'show' : 'hide'}\r\n              selected={showHighlights}\r\n              onClick={toggleHighlights}\r\n            />\r\n            <ToolbarButton\r\n              title={\r\n                newAnnotationType === 'note'\r\n                  ? 'New page note'\r\n                  : 'New annotation'\r\n              }\r\n              icon={newAnnotationType === 'note' ? 'note' : 'annotate'}\r\n              onClick={createAnnotation}\r\n            />\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import { createRef, render } from 'preact';\r\n\r\nimport Toolbar from './components/Toolbar';\r\n\r\n/**\r\n * @typedef ToolbarOptions\r\n * @prop {() => void} createAnnotation\r\n * @prop {(open: boolean) => void} setSidebarOpen\r\n * @prop {(visible: boolean) => void} setHighlightsVisible\r\n */\r\n\r\n/**\r\n * Controller for the toolbar on the edge of the sidebar.\r\n *\r\n * This toolbar provides controls for opening and closing the sidebar, toggling\r\n * highlight visibility etc.\r\n */\r\nexport class ToolbarController {\r\n  /**\r\n   * @param {HTMLElement} container - Element into which the toolbar is rendered\r\n   * @param {ToolbarOptions} options\r\n   */\r\n  constructor(container, options) {\r\n    const { createAnnotation, setSidebarOpen, setHighlightsVisible } = options;\r\n\r\n    this._container = container;\r\n\r\n    this._useMinimalControls = false;\r\n\r\n    /** @type {'annotation'|'note'} */\r\n    this._newAnnotationType = 'note';\r\n\r\n    this._highlightsVisible = false;\r\n    this._sidebarOpen = false;\r\n\r\n    this._closeSidebar = () => setSidebarOpen(false);\r\n    this._toggleSidebar = () => setSidebarOpen(!this._sidebarOpen);\r\n    this._toggleHighlights = () =>\r\n      setHighlightsVisible(!this._highlightsVisible);\r\n    this._createAnnotation = () => {\r\n      createAnnotation();\r\n      setSidebarOpen(true);\r\n    };\r\n\r\n    /** Reference to the sidebar toggle button. */\r\n    this._sidebarToggleButton = createRef();\r\n\r\n    this.render();\r\n  }\r\n\r\n  getWidth() {\r\n    const content = /** @type {HTMLElement} */ (this._container.firstChild);\r\n    return content.getBoundingClientRect().width;\r\n  }\r\n\r\n  /**\r\n   * Set whether the toolbar is in the \"minimal controls\" mode where\r\n   * only the \"Close\" button is shown.\r\n   */\r\n  set useMinimalControls(minimal) {\r\n    this._useMinimalControls = minimal;\r\n    this.render();\r\n  }\r\n\r\n  get useMinimalControls() {\r\n    return this._useMinimalControls;\r\n  }\r\n\r\n  /**\r\n   * Update the toolbar to reflect whether the sidebar is open or not.\r\n   */\r\n  set sidebarOpen(open) {\r\n    this._sidebarOpen = open;\r\n    this.render();\r\n  }\r\n\r\n  get sidebarOpen() {\r\n    return this._sidebarOpen;\r\n  }\r\n\r\n  /**\r\n   * Update the toolbar to reflect whether the \"Create annotation\" button will\r\n   * create a page note (if there is no selection) or an annotation (if there is\r\n   * a selection).\r\n   */\r\n  set newAnnotationType(type) {\r\n    this._newAnnotationType = type;\r\n    this.render();\r\n  }\r\n\r\n  get newAnnotationType() {\r\n    return this._newAnnotationType;\r\n  }\r\n\r\n  /**\r\n   * Update the toolbar to reflect whether highlights are currently visible.\r\n   */\r\n  set highlightsVisible(visible) {\r\n    this._highlightsVisible = visible;\r\n    this.render();\r\n  }\r\n\r\n  get highlightsVisible() {\r\n    return this._highlightsVisible;\r\n  }\r\n\r\n  /**\r\n   * Return the DOM element that toggles the sidebar's visibility.\r\n   *\r\n   * @type {HTMLButtonElement}\r\n   */\r\n  get sidebarToggleButton() {\r\n    return this._sidebarToggleButton.current;\r\n  }\r\n\r\n  render() {\r\n    render(\r\n      <Toolbar\r\n        closeSidebar={this._closeSidebar}\r\n        createAnnotation={this._createAnnotation}\r\n        newAnnotationType={this._newAnnotationType}\r\n        isSidebarOpen={this._sidebarOpen}\r\n        showHighlights={this._highlightsVisible}\r\n        toggleHighlights={this._toggleHighlights}\r\n        toggleSidebar={this._toggleSidebar}\r\n        toggleSidebarRef={this._sidebarToggleButton}\r\n        useMinimalControls={this.useMinimalControls}\r\n      />,\r\n      this._container\r\n    );\r\n  }\r\n}\r\n","import * as Hammer from 'hammerjs';\r\n\r\nimport { addConfigFragment } from '../shared/config-fragment';\r\nimport { sendErrorsTo } from '../shared/frame-error-capture';\r\nimport { ListenerCollection } from '../shared/listener-collection';\r\nimport { PortRPC } from '../shared/messaging';\r\n\r\nimport { annotationCounts } from './annotation-counts';\r\nimport { BucketBar } from './bucket-bar';\r\nimport { createAppConfig } from './config/app';\r\nimport { FeatureFlags } from './features';\r\nimport { sidebarTrigger } from './sidebar-trigger';\r\nimport { ToolbarController } from './toolbar';\r\nimport { createShadowRoot } from './util/shadow-root';\r\n\r\n/**\r\n * @typedef {import('./guest').Guest} Guest\r\n * @typedef {import('../types/annotator').AnchorPosition} AnchorPosition\r\n * @typedef {import('../types/annotator').SidebarLayout} SidebarLayout\r\n * @typedef {import('../types/annotator').Destroyable} Destroyable\r\n * @typedef {import('../types/config').Service} Service\r\n * @typedef {import('../types/port-rpc-events').GuestToHostEvent} GuestToHostEvent\r\n * @typedef {import('../types/port-rpc-events').HostToGuestEvent} HostToGuestEvent\r\n * @typedef {import('../types/port-rpc-events').HostToSidebarEvent} HostToSidebarEvent\r\n * @typedef {import('../types/port-rpc-events').SidebarToHostEvent} SidebarToHostEvent\r\n */\r\n\r\n// Minimum width to which the iframeContainer can be resized.\r\nexport const MIN_RESIZE = 280;\r\n\r\n/**\r\n * Client configuration used to launch the sidebar application.\r\n *\r\n * This includes the URL for the iframe and configuration to pass to the\r\n * application on launch.\r\n *\r\n * @typedef {{ sidebarAppUrl: string } & Record<string, unknown>} SidebarConfig\r\n */\r\n\r\n/**\r\n * Client configuration used by the sidebar container ({@link Sidebar}).\r\n *\r\n * @typedef SidebarContainerConfig\r\n * @prop {Service[]} [services] - Details of the annotation service the\r\n *   client should connect to. This includes callbacks provided by the host\r\n *   page to handle certain actions in the sidebar (eg. the Login button).\r\n * @prop {string} [externalContainerSelector] - CSS selector of a container\r\n *   element in the host page which the sidebar should be added into, instead\r\n *   of creating a new container.\r\n * @prop {(layout: SidebarLayout) => void} [onLayoutChange] - Callback that\r\n *   allows the host page to react to the sidebar being opened, closed or\r\n *   resized\r\n */\r\n\r\n/**\r\n * Create the iframe that will load the sidebar application.\r\n *\r\n * @param {SidebarConfig} config\r\n * @return {HTMLIFrameElement}\r\n */\r\nfunction createSidebarIframe(config) {\r\n  const sidebarURL = /** @type {string} */ (config.sidebarAppUrl);\r\n  const sidebarAppSrc = addConfigFragment(\r\n    sidebarURL,\r\n    createAppConfig(sidebarURL, config)\r\n  );\r\n\r\n  const sidebarFrame = document.createElement('iframe');\r\n\r\n  // Enable media in annotations to be shown fullscreen\r\n  sidebarFrame.setAttribute('allowfullscreen', '');\r\n\r\n  sidebarFrame.src = sidebarAppSrc;\r\n  sidebarFrame.title = 'Hypothesis annotation viewer';\r\n  sidebarFrame.className = 'sidebar-frame';\r\n\r\n  return sidebarFrame;\r\n}\r\n\r\n/**\r\n * The `Sidebar` class creates (1) the sidebar application iframe, (2) its container,\r\n * as well as (3) the adjacent controls.\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class Sidebar {\r\n  /**\r\n   * @param {HTMLElement} element\r\n   * @param {import('./util/emitter').EventBus} eventBus -\r\n   *   Enables communication between components sharing the same eventBus\r\n   * @param {SidebarContainerConfig & SidebarConfig} config\r\n   */\r\n  constructor(element, eventBus, config) {\r\n    this._emitter = eventBus.createEmitter();\r\n\r\n    /**\r\n     * Tracks which `Guest` has a text selection. `null` indicates to default\r\n     * to the first connected guest frame.\r\n     *\r\n     * @type {PortRPC<GuestToHostEvent, HostToGuestEvent>|null}\r\n     */\r\n    this._guestWithSelection = null;\r\n\r\n    /**\r\n     * Channels for host-guest communication.\r\n     *\r\n     * @type {PortRPC<GuestToHostEvent, HostToGuestEvent>[]}\r\n     */\r\n    this._guestRPC = [];\r\n\r\n    /**\r\n     * Channel for host-sidebar communication.\r\n     *\r\n     * @type {PortRPC<SidebarToHostEvent, HostToSidebarEvent>}\r\n     */\r\n    this._sidebarRPC = new PortRPC();\r\n\r\n    /**\r\n     * The `<iframe>` element containing the sidebar application.\r\n     */\r\n    this.iframe = createSidebarIframe(config);\r\n\r\n    this._config = config;\r\n\r\n    /** @type {BucketBar|null} */\r\n    this.bucketBar = null;\r\n\r\n    this.features = new FeatureFlags();\r\n\r\n    if (config.externalContainerSelector) {\r\n      this.externalFrame =\r\n        /** @type {HTMLElement} */\r\n        (document.querySelector(config.externalContainerSelector)) ?? element;\r\n      this.externalFrame.appendChild(this.iframe);\r\n    } else {\r\n      this.iframeContainer = document.createElement('div');\r\n      this.iframeContainer.style.display = 'none';\r\n      this.iframeContainer.className = 'sidebar-container';\r\n\r\n      if (config.theme === 'clean') {\r\n        this.iframeContainer.classList.add('theme-clean');\r\n      } else {\r\n        this.bucketBar = new BucketBar(this.iframeContainer, {\r\n          onFocusAnnotations: tags =>\r\n            this._guestRPC.forEach(rpc => rpc.call('focusAnnotations', tags)),\r\n          onScrollToClosestOffScreenAnchor: (tags, direction) =>\r\n            this._guestRPC.forEach(rpc =>\r\n              rpc.call('scrollToClosestOffScreenAnchor', tags, direction)\r\n            ),\r\n          onSelectAnnotations: (tags, toggle) =>\r\n            this._guestRPC.forEach(rpc =>\r\n              rpc.call('selectAnnotations', tags, toggle)\r\n            ),\r\n        });\r\n      }\r\n\r\n      this.iframeContainer.appendChild(this.iframe);\r\n\r\n      // Wrap up the 'iframeContainer' element into a shadow DOM so it is not affected by host CSS styles\r\n      this.hypothesisSidebar = document.createElement('hypothesis-sidebar');\r\n      const shadowRoot = createShadowRoot(this.hypothesisSidebar);\r\n      shadowRoot.appendChild(this.iframeContainer);\r\n\r\n      element.appendChild(this.hypothesisSidebar);\r\n    }\r\n\r\n    // Register the sidebar as a handler for Hypothesis errors in this frame.\r\n    if (this.iframe.contentWindow) {\r\n      sendErrorsTo(this.iframe.contentWindow);\r\n    }\r\n\r\n    this._listeners = new ListenerCollection();\r\n\r\n    // Set up the toolbar on the left edge of the sidebar.\r\n    const toolbarContainer = document.createElement('div');\r\n    this.toolbar = new ToolbarController(toolbarContainer, {\r\n      createAnnotation: () => {\r\n        if (this._guestRPC.length === 0) {\r\n          return;\r\n        }\r\n\r\n        const rpc = this._guestWithSelection ?? this._guestRPC[0];\r\n        rpc.call('createAnnotation');\r\n      },\r\n      setSidebarOpen: open => (open ? this.open() : this.close()),\r\n      setHighlightsVisible: show => this.setHighlightsVisible(show),\r\n    });\r\n\r\n    if (config.theme === 'clean') {\r\n      this.toolbar.useMinimalControls = true;\r\n    } else {\r\n      this.toolbar.useMinimalControls = false;\r\n    }\r\n\r\n    if (this.iframeContainer) {\r\n      // If using our own container frame for the sidebar, add the toolbar to it.\r\n      this.iframeContainer.prepend(toolbarContainer);\r\n      this.toolbarWidth = this.toolbar.getWidth();\r\n    } else {\r\n      // If using a host-page provided container for the sidebar, the toolbar is\r\n      // not shown.\r\n      this.toolbarWidth = 0;\r\n    }\r\n\r\n    this._listeners.add(window, 'resize', () => this._onResize());\r\n\r\n    this._gestureState = {\r\n      // Initial position at the start of a drag/pan resize event (in pixels).\r\n      initial: /** @type {number|null} */ (null),\r\n\r\n      // Final position at end of drag resize event.\r\n      final: /** @type {number|null} */ (null),\r\n    };\r\n    this._setupGestures();\r\n    this.close();\r\n\r\n    // Publisher-provided callback functions\r\n    const [serviceConfig] = config.services || [];\r\n    if (serviceConfig) {\r\n      this.onLoginRequest = serviceConfig.onLoginRequest;\r\n      this.onLogoutRequest = serviceConfig.onLogoutRequest;\r\n      this.onSignupRequest = serviceConfig.onSignupRequest;\r\n      this.onProfileRequest = serviceConfig.onProfileRequest;\r\n      this.onHelpRequest = serviceConfig.onHelpRequest;\r\n    }\r\n\r\n    this.onLayoutChange = config.onLayoutChange;\r\n\r\n    /** @type {SidebarLayout} */\r\n    this._layoutState = {\r\n      expanded: false,\r\n      width: 0,\r\n      toolbarWidth: 0,\r\n    };\r\n\r\n    // Initial layout notification\r\n    this._updateLayoutState(false);\r\n    this._setupSidebarEvents();\r\n  }\r\n\r\n  destroy() {\r\n    this._guestRPC.forEach(rpc => rpc.destroy());\r\n    this._sidebarRPC.destroy();\r\n    this.bucketBar?.destroy();\r\n    this._listeners.removeAll();\r\n    this._hammerManager?.destroy();\r\n    if (this.hypothesisSidebar) {\r\n      this.hypothesisSidebar.remove();\r\n    } else {\r\n      this.iframe.remove();\r\n    }\r\n    this._emitter.destroy();\r\n\r\n    // Unregister the sidebar iframe as a handler for errors in this frame.\r\n    sendErrorsTo(null);\r\n  }\r\n\r\n  /**\r\n   * Setup communication with a frame that has connected to the host.\r\n   *\r\n   * @param {'guest'|'sidebar'} source\r\n   * @param {MessagePort} port\r\n   */\r\n  onFrameConnected(source, port) {\r\n    switch (source) {\r\n      case 'guest':\r\n        this._connectGuest(port);\r\n        break;\r\n      case 'sidebar':\r\n        this._sidebarRPC.connect(port);\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {MessagePort} port\r\n   */\r\n  _connectGuest(port) {\r\n    /** @type {PortRPC<GuestToHostEvent, HostToGuestEvent>} */\r\n    const guestRPC = new PortRPC();\r\n\r\n    guestRPC.on('textSelected', () => {\r\n      this._guestWithSelection = guestRPC;\r\n      this.toolbar.newAnnotationType = 'annotation';\r\n      this._guestRPC\r\n        .filter(port => port !== guestRPC)\r\n        .forEach(rpc => rpc.call('clearSelection'));\r\n    });\r\n\r\n    guestRPC.on('textUnselected', () => {\r\n      this._guestWithSelection = null;\r\n      this.toolbar.newAnnotationType = 'note';\r\n      this._guestRPC\r\n        .filter(port => port !== guestRPC)\r\n        .forEach(rpc => rpc.call('clearSelection'));\r\n    });\r\n\r\n    // The listener will do nothing if the sidebar doesn't have a bucket bar\r\n    // (clean theme)\r\n    const bucketBar = this.bucketBar;\r\n    // Currently, we ignore `anchorsChanged` for all the guests except the first connected guest.\r\n    if (bucketBar) {\r\n      guestRPC.on(\r\n        'anchorsChanged',\r\n        /** @param {AnchorPosition[]} positions  */\r\n        positions => {\r\n          if (this._guestRPC.indexOf(guestRPC) === 0) {\r\n            bucketBar.update(positions);\r\n          }\r\n        }\r\n      );\r\n    }\r\n\r\n    guestRPC.on('close', () => {\r\n      guestRPC.destroy();\r\n      if (guestRPC === this._guestWithSelection) {\r\n        this._guestWithSelection = null;\r\n      }\r\n      this._guestRPC = this._guestRPC.filter(rpc => rpc !== guestRPC);\r\n    });\r\n\r\n    guestRPC.connect(port);\r\n    this._guestRPC.push(guestRPC);\r\n\r\n    guestRPC.call('sidebarLayoutChanged', this._layoutState);\r\n  }\r\n\r\n  _setupSidebarEvents() {\r\n    annotationCounts(document.body, this._sidebarRPC);\r\n    sidebarTrigger(document.body, () => this.open());\r\n\r\n    this._sidebarRPC.on(\r\n      'featureFlagsUpdated',\r\n      /** @param {Record<string, boolean>} flags */ flags =>\r\n        this.features.update(flags)\r\n    );\r\n\r\n    this._sidebarRPC.on('connect', () => {\r\n      // Show the UI\r\n      if (this.iframeContainer) {\r\n        this.iframeContainer.style.display = '';\r\n      }\r\n\r\n      const showHighlights = this._config.showHighlights === 'always';\r\n      this.setHighlightsVisible(showHighlights);\r\n\r\n      if (\r\n        this._config.openSidebar ||\r\n        this._config.annotations ||\r\n        this._config.query ||\r\n        this._config.group\r\n      ) {\r\n        this.open();\r\n      }\r\n    });\r\n\r\n    this._sidebarRPC.on('showHighlights', () =>\r\n      this.setHighlightsVisible(true)\r\n    );\r\n\r\n    this._sidebarRPC.on('openSidebar', () => this.open());\r\n\r\n    this._sidebarRPC.on('closeSidebar', () => this.close());\r\n\r\n    // Sidebar listens to the `openNotebook` event coming from the sidebar's\r\n    // iframe and re-publishes it via the emitter to the Notebook\r\n    this._sidebarRPC.on(\r\n      'openNotebook',\r\n      /** @param {string} groupId */\r\n      groupId => {\r\n        this.hide();\r\n        this._emitter.publish('openNotebook', groupId);\r\n      }\r\n    );\r\n\r\n    this._emitter.subscribe('closeNotebook', () => {\r\n      this.show();\r\n    });\r\n\r\n    /** @type {Array<[SidebarToHostEvent, Function|undefined]>} */\r\n    const eventHandlers = [\r\n      ['loginRequested', this.onLoginRequest],\r\n      ['logoutRequested', this.onLogoutRequest],\r\n      ['signupRequested', this.onSignupRequest],\r\n      ['profileRequested', this.onProfileRequest],\r\n      ['helpRequested', this.onHelpRequest],\r\n    ];\r\n    eventHandlers.forEach(([event, handler]) => {\r\n      if (handler) {\r\n        this._sidebarRPC.on(event, () => handler());\r\n      }\r\n    });\r\n  }\r\n\r\n  _resetGestureState() {\r\n    this._gestureState = { initial: null, final: null };\r\n  }\r\n\r\n  _setupGestures() {\r\n    const toggleButton = this.toolbar.sidebarToggleButton;\r\n    if (toggleButton) {\r\n      this._hammerManager = new Hammer.Manager(toggleButton);\r\n      this._hammerManager.on(\r\n        'panstart panend panleft panright',\r\n        /* istanbul ignore next */\r\n        event => this._onPan(event)\r\n      );\r\n      this._hammerManager.add(\r\n        new Hammer.Pan({ direction: Hammer.DIRECTION_HORIZONTAL })\r\n      );\r\n    }\r\n  }\r\n\r\n  // Schedule any changes needed to update the sidebar layout.\r\n  _updateLayout() {\r\n    // Only schedule one frame at a time.\r\n    if (this.renderFrame) {\r\n      return;\r\n    }\r\n\r\n    // Schedule a frame.\r\n    this.renderFrame = requestAnimationFrame(() => {\r\n      this.renderFrame = null;\r\n\r\n      if (\r\n        this._gestureState.final !== this._gestureState.initial &&\r\n        this.iframeContainer\r\n      ) {\r\n        const margin = /** @type {number} */ (this._gestureState.final);\r\n        const width = -margin;\r\n        this.iframeContainer.style.marginLeft = `${margin}px`;\r\n        if (width >= MIN_RESIZE) {\r\n          this.iframeContainer.style.width = `${width}px`;\r\n        }\r\n        this._updateLayoutState();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the current layout state and notify the embedder if they provided\r\n   * an `onLayoutChange` callback in the Hypothesis config, as well as guests\r\n   * so they can enable/adapt side-by-side mode.\r\n   *\r\n   * This is called when the sidebar is opened, closed or resized.\r\n   *\r\n   * @param {boolean} [expanded] -\r\n   *   `true` or `false` if the sidebar is being directly opened or closed, as\r\n   *   opposed to being resized via the sidebar's drag handles\r\n   */\r\n  _updateLayoutState(expanded) {\r\n    // The sidebar structure is:\r\n    //\r\n    // [ Toolbar    ][                                   ]\r\n    // [ ---------- ][ Sidebar iframe container (@frame) ]\r\n    // [ Bucket Bar ][                                   ]\r\n    //\r\n    // The sidebar iframe is hidden or shown by adjusting the left margin of\r\n    // its container.\r\n\r\n    const toolbarWidth = (this.iframeContainer && this.toolbar.getWidth()) || 0;\r\n    const frame = /** @type {HTMLElement} */ (\r\n      this.iframeContainer ?? this.externalFrame\r\n    );\r\n    const rect = frame.getBoundingClientRect();\r\n    const computedStyle = window.getComputedStyle(frame);\r\n    const width = parseInt(computedStyle.width);\r\n    const leftMargin = parseInt(computedStyle.marginLeft);\r\n\r\n    // The width of the sidebar that is visible on screen, including the\r\n    // toolbar, which is always visible.\r\n    let frameVisibleWidth = toolbarWidth;\r\n\r\n    if (typeof expanded === 'boolean') {\r\n      if (expanded) {\r\n        frameVisibleWidth += width;\r\n      }\r\n    } else {\r\n      if (leftMargin < MIN_RESIZE) {\r\n        frameVisibleWidth -= leftMargin;\r\n      } else {\r\n        frameVisibleWidth += width;\r\n      }\r\n\r\n      // Infer expanded state based on whether at least part of the sidebar\r\n      // frame is visible.\r\n      expanded = frameVisibleWidth > toolbarWidth;\r\n    }\r\n\r\n    const layoutState = /** @type {SidebarLayout} */ ({\r\n      expanded,\r\n      width: expanded ? frameVisibleWidth : toolbarWidth,\r\n      height: rect.height,\r\n      toolbarWidth,\r\n    });\r\n\r\n    this._layoutState = layoutState;\r\n    if (this.onLayoutChange) {\r\n      this.onLayoutChange(layoutState);\r\n    }\r\n\r\n    this._guestRPC.forEach(rpc =>\r\n      rpc.call('sidebarLayoutChanged', layoutState)\r\n    );\r\n  }\r\n\r\n  /**\r\n   *  On window resize events, update the marginLeft of the sidebar by calling hide/show methods.\r\n   */\r\n  _onResize() {\r\n    if (this.toolbar.sidebarOpen === true) {\r\n      if (window.innerWidth < MIN_RESIZE) {\r\n        this.close();\r\n      } else {\r\n        this.open();\r\n      }\r\n    }\r\n  }\r\n\r\n  /** @param {HammerInput} event */\r\n  _onPan(event) {\r\n    const frame = this.iframeContainer;\r\n    if (!frame) {\r\n      return;\r\n    }\r\n\r\n    switch (event.type) {\r\n      case 'panstart':\r\n        this._resetGestureState();\r\n\r\n        // Disable animated transition of sidebar position\r\n        frame.classList.add('sidebar-no-transition');\r\n\r\n        // Disable pointer events on the iframe.\r\n        frame.style.pointerEvents = 'none';\r\n\r\n        this._gestureState.initial = parseInt(\r\n          getComputedStyle(frame).marginLeft\r\n        );\r\n\r\n        break;\r\n      case 'panend':\r\n        frame.classList.remove('sidebar-no-transition');\r\n\r\n        // Re-enable pointer events on the iframe.\r\n        frame.style.pointerEvents = '';\r\n\r\n        // Snap open or closed.\r\n        if (\r\n          this._gestureState.final === null ||\r\n          this._gestureState.final <= -MIN_RESIZE\r\n        ) {\r\n          this.open();\r\n        } else {\r\n          this.close();\r\n        }\r\n        this._resetGestureState();\r\n        break;\r\n      case 'panleft':\r\n      case 'panright': {\r\n        if (typeof this._gestureState.initial !== 'number') {\r\n          return;\r\n        }\r\n\r\n        const margin = this._gestureState.initial;\r\n        const delta = event.deltaX;\r\n        this._gestureState.final = Math.min(Math.round(margin + delta), 0);\r\n        this._updateLayout();\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  open() {\r\n    this._sidebarRPC.call('sidebarOpened');\r\n\r\n    if (this.iframeContainer) {\r\n      const width = this.iframeContainer.getBoundingClientRect().width;\r\n      this.iframeContainer.style.marginLeft = `${-1 * width}px`;\r\n      this.iframeContainer.classList.remove('sidebar-collapsed');\r\n    }\r\n\r\n    this.toolbar.sidebarOpen = true;\r\n\r\n    if (this._config.showHighlights === 'whenSidebarOpen') {\r\n      this.setHighlightsVisible(true);\r\n    }\r\n\r\n    this._updateLayoutState(true);\r\n  }\r\n\r\n  close() {\r\n    if (this.iframeContainer) {\r\n      this.iframeContainer.style.marginLeft = '';\r\n      this.iframeContainer.classList.add('sidebar-collapsed');\r\n    }\r\n\r\n    this.toolbar.sidebarOpen = false;\r\n\r\n    if (this._config.showHighlights === 'whenSidebarOpen') {\r\n      this.setHighlightsVisible(false);\r\n    }\r\n\r\n    this._updateLayoutState(false);\r\n  }\r\n\r\n  /**\r\n   * Set whether highlights are visible in guest frames.\r\n   *\r\n   * @param {boolean} visible\r\n   */\r\n  setHighlightsVisible(visible) {\r\n    this.toolbar.highlightsVisible = visible;\r\n\r\n    // Notify sidebar app of change which will in turn reflect state to guest frames.\r\n    this._sidebarRPC.call('setHighlightsVisible', visible);\r\n  }\r\n\r\n  /**\r\n   * Shows the sidebar's controls\r\n   */\r\n  show() {\r\n    if (this.iframeContainer) {\r\n      this.iframeContainer.classList.remove('is-hidden');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hides the sidebar's controls\r\n   */\r\n  hide() {\r\n    if (this.iframeContainer) {\r\n      this.iframeContainer.classList.add('is-hidden');\r\n    }\r\n  }\r\n}\r\n","const ANNOTATION_COUNT_ATTR = 'data-hypothesis-annotation-count';\r\n\r\n/**\r\n * Update the elements in the container element with the count data attribute\r\n * with the new annotation count. See:\r\n * https://h.readthedocs.io/projects/client/en/latest/publishers/host-page-integration/#cmdoption-arg-data-hypothesis-annotation-count\r\n *\r\n * @param {Element} rootEl - The DOM element which contains the elements that\r\n *   display annotation count.\r\n * @param {import('../shared/messaging').PortRPC<'publicAnnotationCountChanged', string>} rpc - Channel for host-sidebar communication\r\n */\r\nexport function annotationCounts(rootEl, rpc) {\r\n  rpc.on('publicAnnotationCountChanged', updateAnnotationCountElems);\r\n\r\n  /** @param {number} newCount */\r\n  function updateAnnotationCountElems(newCount) {\r\n    const elems = rootEl.querySelectorAll('[' + ANNOTATION_COUNT_ATTR + ']');\r\n    Array.from(elems).forEach(elem => {\r\n      elem.textContent = newCount.toString();\r\n    });\r\n  }\r\n}\r\n","const SIDEBAR_TRIGGER_BTN_ATTR = 'data-hypothesis-trigger';\r\n\r\n/**\r\n * Show the sidebar when user clicks on an element with the\r\n * trigger data attribute.\r\n *\r\n * @param {Element} rootEl - The DOM element which contains the trigger elements.\r\n * @param {() => void} showFn - Function which shows the sidebar.\r\n */\r\nexport function sidebarTrigger(rootEl, showFn) {\r\n  const triggerElems = rootEl.querySelectorAll(\r\n    '[' + SIDEBAR_TRIGGER_BTN_ATTR + ']'\r\n  );\r\n\r\n  Array.from(triggerElems).forEach(triggerElem => {\r\n    triggerElem.addEventListener('click', e => {\r\n      showFn();\r\n      e.stopPropagation();\r\n    });\r\n  });\r\n}\r\n","import { TinyEmitter } from 'tiny-emitter';\r\n\r\n/** @typedef {import('../../types/annotator').Destroyable} Destroyable */\r\n\r\n/**\r\n * Emitter is a communication class that implements the publisher/subscriber\r\n * pattern. It allows sending and listening events through a shared EventBus.\r\n * The different elements of the application can communicate with each other\r\n * without being tightly coupled.\r\n *\r\n * @implements {Destroyable}\r\n */\r\nexport class Emitter {\r\n  /**\r\n   * @param {TinyEmitter} emitter\r\n   */\r\n  constructor(emitter) {\r\n    this._emitter = emitter;\r\n\r\n    /** @type {[event: string, callback: Function][]} */\r\n    this._subscriptions = [];\r\n  }\r\n\r\n  /**\r\n   * Fire an event.\r\n   *\r\n   * @param {string} event\r\n   * @param {unknown[]} args\r\n   */\r\n  publish(event, ...args) {\r\n    this._emitter.emit(event, ...args);\r\n  }\r\n\r\n  /**\r\n   * Register an event listener.\r\n   *\r\n   * @param {string} event\r\n   * @param {Function} callback\r\n   */\r\n  subscribe(event, callback) {\r\n    this._emitter.on(event, callback);\r\n    this._subscriptions.push([event, callback]);\r\n  }\r\n\r\n  /**\r\n   * Remove an event listener.\r\n   *\r\n   * @param {string} event\r\n   * @param {Function} callback\r\n   */\r\n  unsubscribe(event, callback) {\r\n    this._emitter.off(event, callback);\r\n    this._subscriptions = this._subscriptions.filter(\r\n      ([subEvent, subCallback]) =>\r\n        subEvent !== event || subCallback !== callback\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove all event listeners.\r\n   */\r\n  destroy() {\r\n    for (let [event, callback] of this._subscriptions) {\r\n      this._emitter.off(event, callback);\r\n    }\r\n    this._subscriptions = [];\r\n  }\r\n}\r\n\r\nexport class EventBus {\r\n  constructor() {\r\n    this._emitter = new TinyEmitter();\r\n  }\r\n\r\n  createEmitter() {\r\n    return new Emitter(this._emitter);\r\n  }\r\n}\r\n","// Load polyfill for :focus-visible pseudo-class.\r\nimport 'focus-visible';\r\n\r\n// Enable debug checks for Preact. Removed in prod builds by Rollup config.\r\nimport 'preact/debug';\r\n\r\n// Load icons.\r\nimport { registerIcons } from '@hypothesis/frontend-shared';\r\nimport { annotatorIcons } from './icons';\r\nregisterIcons(annotatorIcons);\r\n\r\nimport {\r\n  PortProvider,\r\n  installPortCloseWorkaroundForSafari,\r\n} from '../shared/messaging';\r\nimport { getConfig } from './config/index';\r\nimport { Guest } from './guest';\r\nimport { HypothesisInjector } from './hypothesis-injector';\r\nimport {\r\n  VitalSourceInjector,\r\n  vitalSourceFrameRole,\r\n} from './integrations/vitalsource';\r\nimport { Notebook } from './notebook';\r\nimport { Sidebar } from './sidebar';\r\nimport { EventBus } from './util/emitter';\r\n\r\n/** @typedef {import('../types/annotator').Destroyable} Destroyable */\r\n\r\n// Look up the URL of the sidebar. This element is added to the page by the\r\n// boot script before the \"annotator\" bundle loads.\r\nconst sidebarLinkElement = /** @type {HTMLLinkElement} */ (\r\n  document.querySelector(\r\n    'link[type=\"application/annotator+html\"][rel=\"sidebar\"]'\r\n  )\r\n);\r\n\r\n/**\r\n * @typedef {import('./components/NotebookModal').NotebookConfig} NotebookConfig\r\n * @typedef {import('./guest').GuestConfig} GuestConfig\r\n * @typedef {import('./hypothesis-injector').InjectConfig} InjectConfig\r\n * @typedef {import('./sidebar').SidebarConfig} SidebarConfig\r\n * @typedef {import('./sidebar').SidebarContainerConfig} SidebarContainerConfig\r\n */\r\n\r\n/**\r\n * Entry point for the part of the Hypothesis client that runs in the page being\r\n * annotated.\r\n *\r\n * Depending on the client configuration in the current frame, this can\r\n * initialize different functionality. In \"host\" frames the sidebar controls and\r\n * iframe containing the sidebar application are created. In \"guest\" frames the\r\n * functionality to support anchoring and creating annotations is loaded. An\r\n * instance of Hypothesis will have one host frame, one sidebar frame and one or\r\n * more guest frames. The most common case is that the host frame, where the\r\n * client is initially loaded, is also the only guest frame.\r\n */\r\nfunction init() {\r\n  const annotatorConfig = /** @type {GuestConfig & InjectConfig} */ (\r\n    getConfig('annotator')\r\n  );\r\n\r\n  const hostFrame = annotatorConfig.subFrameIdentifier ? window.parent : window;\r\n\r\n  /** @type {Destroyable[]} */\r\n  const destroyables = [];\r\n\r\n  if (hostFrame === window) {\r\n    // Ensure port \"close\" notifications from eg. guest frames are delivered properly.\r\n    const removeWorkaround = installPortCloseWorkaroundForSafari();\r\n    destroyables.push({ destroy: removeWorkaround });\r\n\r\n    const sidebarConfig = /** @type {SidebarConfig} */ (getConfig('sidebar'));\r\n\r\n    const hypothesisAppsOrigin = new URL(sidebarConfig.sidebarAppUrl).origin;\r\n    const portProvider = new PortProvider(hypothesisAppsOrigin);\r\n\r\n    const eventBus = new EventBus();\r\n    const sidebar = new Sidebar(document.body, eventBus, sidebarConfig);\r\n    const notebook = new Notebook(\r\n      document.body,\r\n      eventBus,\r\n      /** @type {NotebookConfig} */ (getConfig('notebook'))\r\n    );\r\n\r\n    portProvider.on('frameConnected', (source, port) =>\r\n      sidebar.onFrameConnected(source, port)\r\n    );\r\n    destroyables.push(portProvider, sidebar, notebook);\r\n  }\r\n\r\n  const vsFrameRole = vitalSourceFrameRole();\r\n  if (vsFrameRole === 'container') {\r\n    const vitalSourceInjector = new VitalSourceInjector(annotatorConfig);\r\n    destroyables.push(vitalSourceInjector);\r\n  } else {\r\n    // Set up automatic injection of the client into iframes in this frame.\r\n    const hypothesisInjector = new HypothesisInjector(\r\n      document.body,\r\n      annotatorConfig\r\n    );\r\n    // Create the guest that handles creating annotations and displaying highlights.\r\n    const guest = new Guest(document.body, annotatorConfig, hostFrame);\r\n    destroyables.push(hypothesisInjector, guest);\r\n  }\r\n\r\n  sidebarLinkElement.addEventListener('destroy', () => {\r\n    destroyables.forEach(instance => instance.destroy());\r\n\r\n    // Remove all the `<link>`, `<script>` and `<style>` elements added to the\r\n    // page by the boot script.\r\n    const clientAssets = document.querySelectorAll('[data-hypothesis-asset]');\r\n    clientAssets.forEach(el => el.remove());\r\n  });\r\n}\r\n\r\n/**\r\n * Returns a Promise that resolves when the document has loaded (but subresources\r\n * may still be loading).\r\n *\r\n * @return {Promise<void>}\r\n */\r\nfunction documentReady() {\r\n  return new Promise(resolve => {\r\n    if (document.readyState !== 'loading') {\r\n      resolve();\r\n    }\r\n    // nb. `readystatechange` may be emitted twice, but `resolve` only resolves\r\n    // on the first call.\r\n    document.addEventListener('readystatechange', () => resolve());\r\n  });\r\n}\r\n\r\ndocumentReady().then(init);\r\n"],"names":["applyFocusVisiblePolyfill","scope","hadKeyboardEvent","hadFocusVisibleRecently","hadFocusVisibleRecentlyTimeout","inputTypesAllowlist","text","search","url","tel","email","password","number","date","month","week","time","datetime","isValidFocusTarget","el","document","nodeName","classList","focusTriggersKeyboardModality","type","tagName","readOnly","isContentEditable","addFocusVisibleClass","contains","add","setAttribute","removeFocusVisibleClass","hasAttribute","remove","removeAttribute","onKeyDown","e","metaKey","altKey","ctrlKey","activeElement","onPointerDown","onFocus","target","onBlur","window","clearTimeout","setTimeout","onVisibilityChange","visibilityState","addInitialPointerMoveListeners","addEventListener","onInitialPointerMove","removeInitialPointerMoveListeners","removeEventListener","toLowerCase","nodeType","Node","DOCUMENT_FRAGMENT_NODE","host","DOCUMENT_NODE","documentElement","event","CustomEvent","error","createEvent","initCustomEvent","dispatchEvent","factory","n","l","u","t","o","r","f","c","s","a","h","parentNode","removeChild","y","i","props","key","ref","__k","__","__b","__e","__d","__c","__h","constructor","__v","vnode","d","children","_","this","context","k","indexOf","length","b","base","m","push","g","__r","debounceRendering","sort","some","__P","j","__n","ownerSVGElement","z","w","v","p","A","Array","isArray","x","P","N","M","appendChild","nextSibling","insertBefore","$","setProperty","test","H","style","cssText","replace","slice","T","I","contextType","value","__E","prototype","render","O","sub","state","__s","getDerivedStateFromProps","componentWillMount","componentDidMount","componentWillReceiveProps","shouldComponentUpdate","forEach","componentWillUpdate","componentDidUpdate","getChildContext","getSnapshotBeforeUpdate","L","diffed","call","localName","createTextNode","createElementNS","createElement","is","data","childNodes","dangerouslySetInnerHTML","attributes","name","__html","innerHTML","C","checked","current","unmount","componentWillUnmount","S","arguments","defaultProps","firstChild","D","Consumer","Provider","splice","getDerivedStateFromError","setState","componentDidCatch","forceUpdate","Promise","then","bind","resolve","__PREACT_DEVTOOLS__","attachPreact","Fragment","Component","displayName","__o","reduce","__source","fileName","lineNumber","console","warn","WeakMap","hasOwnProperty","Object","toString","JSON","stringify","pop","useEffect","useLayoutEffect","lazyPropTypes","Error","componentStack","propTypes","has","set","__f","keys","message","get","create","__self","__proto__","join","hasOwn","classNames","classes","arg","argType","inner","apply","module","exports","default","__H","shift","requestAnimationFrame","cancelAnimationFrame","filter","iconRegistry","Map","SvgIcon","className","inline","title","markup","element","useRef","svg","querySelector","spanProps","_jsxDEV","classnames","columnNumber","registerIcon","Symbol","_jsxFileName","ButtonBase","buttonRef","icon","iconPosition","size","variant","expanded","pressed","restProps","_restProps$role","role","ariaProps","IconButton","LabeledButton","cancelSVG","Icon","containerClasses","Link","linkRef","rel","annotatorIcons","annotate","cancel","caution","hide","highlight","note","pointer","show","ListenerCollection","_listeners","eventTarget","eventType","listener","options","symbol","listenerId","delete","removeAll","clear","byteToHex","val","str","generateHexString","len","bytes","Uint8Array","crypto","getRandomValues","from","map","isMessage","property","isMessageEqual","PortFinder","hostFrame","source","_hostFrame","_source","destroy","async","isValidRequest","requestId","reject","postRequest","postMessage","frame1","frame2","intervalId","setInterval","timeoutId","clearInterval","ports","E","on","callback","ctx","fn","once","self","off","emit","evtArr","evts","liveEvents","tinyEmitterModule","TinyEmitter","tinyEmitter","errorDestination","serializeError","err","stack","String","undefined","sendError","postErr","DOMException","sendErr","sendErrorsTo","destination","PortProvider","hypothesisAppsOrigin","_hypothesisAppsOrigin","_emitter","_handledRequests","Set","_sidebarHostChannel","MessageChannel","_allowedMessages","allowedOrigin","_listen","errorContext","sentErrors","reportError","origin","channel","MessagePort","ServiceWorker","isSourceWindow","find","allowedMessage","_messageMatches","messageChannel","port1","port2","args","eventName","handler","VERSION","PROTOCOL","sendCall","port","method","sequence","protocol","version","shouldUseSafariWorkaround","userAgent","webkitVersionMatch","match","parseInt","PortRPC","navigator","currentWindow","_port","_methods","_sequence","_callbacks","parent","_pendingCalls","_receivedCloseEvent","connect","_handle","start","close","_destroyed","seq","finalArg","_parseMessage","msg","response","cb","object","parseJsonConfig","config","settingsElements","querySelectorAll","settings","parse","textContent","assign","toBoolean","trim","toLocaleLowerCase","numericalVal","Number","isNaN","Boolean","urlFromLinkTag","window_","link","href","checkIfString","settingsFrom","configFuncSettings","hypothesisConfig","docs","configFuncSettingsFrom","jsonConfigs","hostPageSetting","ignoreOtherConfiguration","annotations","annotFragmentMatch","location","annotationsFromURL","clientUrl","group","groupFragmentMatch","groupFromURL","notebookAppUrl","showHighlights","sidebarAppUrl","query","queryFragmentMatch","decodeURIComponent","queryFromURL","getHostPageSetting","configDefinitions","allowInBrowserExt","defaultValue","getValue","appType","branding","contentInfoBanner","enableExperimentalNewNoteButton","focus","theme","usernameUrl","onLayoutChange","openSidebar","coerce","requestConfigFromFrame","services","subFrameIdentifier","externalContainerSelector","getConfig","contexts","annotator","sidebar","notebook","configurationKeys","configDef","hasDefault","isURLFromBrowserExtension","startsWith","AnnotateIcon","xmlns","width","height","viewBox","fill","CaretLeftIcon","stroke","CaretRightIcon","HighlightIcon","PointerDownIcon","PointerUpIcon","ButtonBaseNext","elementRef","unstyled","htmlAttributes","LinkBaseNext","LinkNext","underline","color","LinkBase","modifiers","alt","ctrl","meta","installShortcut","shortcut","onPress","rootElement","onKeydown","parts","split","requiredModifiers","requiredKey","part","modifierFlag","shiftKey","matchShortcut","useShortcut","NumberIcon","badgeCount","_jsx","AdderToolbarArrow","arrowDirection","ToolbarButton","label","onClick","_jsxs","AdderToolbar","isVisible","onCommand","annotationCount","annotateShortcut","highlightShortcut","showShortcut","dir","visibility","_Fragment","isTouchDevice","_window","matchMedia","matches","createShadowRoot","container","shadowRoot","attachShadow","mode","_document$querySelect","linkEl","loadStyles","applyFocusVisible","stopPropagation","passive","toPx","pixels","Adder","_outerContainer","_shadowRoot","position","top","left","_view","ownerDocument","defaultView","_width","getBoundingClientRect","_height","_isVisible","_arrowDirection","_onAnnotate","onAnnotate","_onHighlight","onHighlight","_onShowAnnotations","onShowAnnotations","_annotationsForSelection","_render","annotationsForSelection","ids","selectionRect","isRTLselection","_calculateTarget","_showAt","hMargin","Math","min","adderWidth","touchScreenOffset","adderHeight","innerHeight","max","innerWidth","_findZindex","elementsFromPoint","zIndexes","getComputedStyle","zIndex","isInteger","parentRect","parentEl","parentElement","nearestPositionedAncestor","command","nodeTextLength","node","ELEMENT_NODE","TEXT_NODE","previousSiblingsTextLength","sibling","previousSibling","resolveOffsets","offsets","nextOffset","nodeIter","createNodeIterator","NodeFilter","SHOW_TEXT","results","textNode","currentNode","nextNode","offset","RangeError","TextPosition","relativeTo","direction","tw","createTreeWalker","getRootNode","forwards","previousNode","static","fromPoint","textOffset","TextRange","end","toRange","range","Range","setStart","setEnd","startContainer","startOffset","endContainer","endOffset","root","placeholderSelector","isInPlaceholder","closest","isSelectionBackwards","selection","focusNode","anchorNode","focusOffset","anchorOffset","getRangeAt","isNodeInRange","_node$nodeValue$lengt","_node$nodeValue","nodeValue","comparePoint","forEachNodeInRange","commonAncestorContainer","SHOW_ALL","selectionFocusRect","isCollapsed","textBoxes","whitespaceOnly","textNodes","rects","nodeRange","createRange","selectNodeContents","collapsed","viewportRects","getClientRects","detach","concat","getTextBoundingBoxes","SVG_NAMESPACE","highlightRange","cssClass","splitText","wholeTextNodesInRange","inPlaceholder","textNodeSpans","prevNode","currentSpan","whitespace","span","highlights","nodes","highlightEl","replaceChild","highlightEls","canvasEl","pageEl","getPDFCanvas","svgHighlightLayer","svgStyle","mixBlendMode","canvasRect","highlightRects","highlightRect","rect","svgHighlight","append","drawHighlightsAbovePDFCanvas","replaceWith","replacements","removeHighlights","setHighlightsFocused","focused","toggle","collection","acc","bottom","right","BucketBarClient","contentContainer","hostRPC","_hostRPC","_updatePending","_anchors","update","anchors","positions","annotation","tag","$tag","anchor1","anchor2","computeAnchorPositions","shownWarnings","warnOnce","reset","annotatorFlags","FeatureFlags","knownFlags","super","_flags","_knownFlags","flags","flag","entries","flagEnabled","_this$_flags$get","includes","allFlags","fromEntries","reverse","oneIfNotZero","advanceBlock","peq","hIn","pV","mV","hInIsNegative","eq","xV","xH","pH","mH","hOut","lastRowMask","findMatchEnds","pattern","maxErrors","bMax","ceil","Uint32Array","emptyPeq","asciiPeq","charCodeAt","charPeq","idx","score","charCode","carry","maxBlockScore","remainder","errors","patRev","minStart","rm","findMatchStarts","matchPos","exactMatches","approxSearch","textMatchScore","matchQuote","quote","scoreMatch","quoteScore","prefixScore","prefix","suffixScore","suffix","posScore","hint","abs","quoteWeight","scoredMatches","getPathSegment","result","getNodeName","pos","tmp","getNodePosition","xpathFromNode","xpath","elem","nthChildOfType","index","toUpperCase","matchIndex","child","nodeFromXPath","body","segments","segment","elementName","elementIndex","separatorPos","indexStr","evaluateSimpleXPath","evaluate","XPathResult","FIRST_ORDERED_NODE_TYPE","singleNodeValue","RangeAnchor","selector","startPos","fromCharOffset","endPos","toSelector","normalizedRange","fromRange","textRange","TextPositionAnchor","fromOffsets","TextQuoteAnchor","exact","toPositionAnchor","anchor","selectors","maybeAssertQuote","_quote","promise","range_","catch","fromSelector","position_","quote_","describe","types","normalizeURI","uri","baseURI","URL","HTMLMetadata","_getDocumentHref","links","_getLinks","getDocumentMetadata","metadata","dc","_getMetaTags","eprints","facebook","highwire","prism","twitter","favicon","_getFavicon","_getTitle","dcLink","documentFingerprint","attribute","tags","getAttribute","content","RegExp","linkElements","hreflang","_absoluteUrl","values","doi","id","dcRelationValues","dcIdentifierValues","identifier","dcUrnRelationComponent","dcUrnIdentifierComponent","dcUrn","encodeURIComponent","allowedSchemes","scheme","rectIsEmpty","linesOverlap","rectIntersects","rectA","rectB","rectsOverlapVertically","rectsOverlapHorizontally","unionRects","DOMRect","rectCenter","DOMPoint","contentSelectors","textRectRange","textRect","elementContentRect","scrollLeft","scrollTop","scrollHeight","scrollWidth","textNodesInRect","shouldVisit","contentIntersectsRect","getScrollAnchor","viewport","anchorRange","hasFixedPosition","textNodeLoop","textLen","word","wordBox","preserveScrollPosition","scrollRoot","anchorTop","scrollDelta","observeCalls","origHandler","stripFragment","NavigationObserver","onNavigate","getLocation","lastURL","checkForURLChange","newURL","navigation","unpatchers","history","_unpatchHistory","cleanup","disconnect","_this$_unpatchHistory","COMPLETE","CANCELED","setElementScroll","scrollTo","animate","scrollSettings","_scrollSettings","maxSynchronousAlignments","parentPosition","differenceX","differenceY","targetWidth","targetHeight","align","targetPosition","leftAlign","topAlign","leftOffset","topOffset","leftScalar","topScalar","isWindow","pageXOffset","pageYOffset","lockX","lockY","offsetLeft","offsetTop","clientWidth","clientHeight","getTargetScrollLocation","Date","now","startTime","timeValue","endIterations","easeValue","ease","scrollAncestor","task","raf","defaultIsWindow","defaultIsScrollable","overflow","defaultValidTarget","findParentElement","assignedSlot","ownerWindow","scrollIntoView","pow","parents","validTarget","isScrollable","debug","log","scrollingElements","done","cancelHandler","idle","lastSettings","passiveOptions","endType","cancellable","transitionScrollTo","interpolate","fraction","scrollElement","maxDuration","scrollStart","scrollDuration","scrollFraction","HTMLIntegration","features","_htmlMeta","_prevURI","_sideBySideEnabled","_sideBySideActive","_lastLayout","_navObserver","_checkForURIChange","_metaObserver","MutationObserver","observe","head","childList","subtree","attributeFilter","_flagsChanged","sideBySide","fitSideBySide","currentURI","canAnnotate","layout","maximumWidthToFit","active","_activateSideBySide","_deactivateSideBySide","sidebarWidth","rightMargin","computeLeftMargin","marginLeft","marginRight","beforeBodyLeft","contentArea","leftMarginVotes","rightMarginVotes","contentSelector","paragraphs","textLength","_leftMarginVotes$get","_rightMarginVotes$get","leftVotes","rightVotes","leftMargin","leftPos","rightPos","guessMainContentArea","freeSpace","adjustedMargin","_anchor$highlights","defineProperty","configurable","scrollElementIntoView","reTrim","reIsBadHex","reIsBinary","reIsOctal","freeParseInt","freeGlobal","global","freeSelf","Function","objectToString","nativeMax","nativeMin","isObject","toNumber","isObjectLike","isSymbol","other","valueOf","isBinary","lodash_debounce","func","wait","lastArgs","lastThis","maxWait","timerId","lastCallTime","lastInvokeTime","leading","maxing","trailing","TypeError","invokeFunc","thisArg","leadingEdge","timerExpired","shouldInvoke","timeSinceLastCall","trailingEdge","remainingWait","debounced","isInvoking","flush","advance","count","countChars","translateOffsets","input","output","beforeStartCount","startToEndCount","outputStart","RenderingStates","pageTextCache","quotePositionCache","quotePositionCacheKey","getNodeTextLayer","_el$closest","getPDFViewer","PDFViewerApplication","pdfViewer","getPageView","pageIndex","pageView","pdfPage","onPagesLoaded","eventBus","getPageTextContent","cachedText","pageText","getTextContent","normalizeWhitespace","items","it","getPageText","findPageByOffset","viewer","pageStartOffset","pageEndOffset","pagesCount","isSpace","char","isNotSpace","anchorByPosition","page","all","renderingState","textLayer","renderingDone","textLayerDiv","textLayerStr","textLayerStart","textLayerEnd","stripSpaces","placeholder","createPlaceholder","div","setStartBefore","setEndAfter","stripped","matchedText","substring","cacheKey","cachedPos","quoteSelector","positionHint","pageCount","pageIndexes","expectedPageIndex","expectedOffsetInPage","strippedPrefix","strippedSuffix","strippedQuote","bestMatch","strippedText","strippedHint","exactQuoteMatch","exactPrefixMatch","exactSuffixMatch","hasContext","anchorQuote","getTextLayerForRange","startTextLayer","endTextLayer","startPageIndex","getSiblingIndex","pageOffset","getPageOffset","Banners","ContentInfoBanner","info","itemTitle","item","subtitle","logo","src","previousItem","currentItem","nextItem","WarningBanner","PDFMetadata","app","_loaded","initializedPromise","initialized","timeout","pdfViewerInitialized","downloadComplete","finish","getUri","getPDFURL","fingerprintToURN","getFingerprint","documentInfo","contentDispositionFilename","pdfDocument","getMetadata","Title","pathSegments","pathname","filenameFromURL","fingerprints","fingerprint","anchorIsInPlaceholder","delay","ms","PDFIntegration","_pdfViewerApp$appConf","_pdfViewerApp$appConf2","_options$reanchoringM","pdfViewerApp","pdfContainer","appConfig","appContainer","pdfMetadata","observer","debounce","_update","_reanchoringMaxWait","reanchoringMaxWait","_banner","_bannerState","contentInfo","noTextWarning","_updateBannerState","_checkForSelectableText","_updateAnnotationLayerVisibility","getSelection","_this$_banner","showContentInfo","canDescribe","hasText","documentHasText","outerContainer","_this$_banner2","prepend","bannerHeight","refreshAnnotations","_page$textLayer","_container$querySelec","hl","sidebarLayout","reservedSpace","toolbarWidth","currentScaleValue","_anchorOffset","_waitForAnnotationToBeAnchored","_anchor","offsetParent","offsetRelativeTo","FrameObserver","onFrameAdded","onFrameRemoved","_element","_onFrameAdded","_onFrameRemoved","_annotatableFrames","_isDisconnected","_mutationObserver","_discoverFrames","frame","onNextDocumentReady","contentWindow","_removeFrame","frames","_addFrame","unsubscribe","onDocumentReady","doc","pollInterval","pollTimer","pollForDocumentChange","documents","WeakSet","cancelPoll","checkForDocumentChange","currentDocument","contentDocument","_frame$contentDocumen","hasBlankDocumentThatWillNavigate","readyState","_frame$contentWindow","canceled","initialCheckTimer","ImageTextLayer","image","charBoxes","containerParent","textAlign","fontFamily","fontSize","getContext","font","scaledValue","dimension","unit","columns","words","currentWord","addWord","lines","currentLine","addLine","prevWord","prevCenter","xDist","currentColumn","addColumn","line","prevLine","yDist","analyzeLayout","column","columnEl","display","lineEl","marginTop","whiteSpace","wordEl","transformOrigin","metrics","measureText","xScale","yScale","transform","updateTextLayerSize","imageWidth","imageHeight","_updateTextLayerSize","ResizeObserver","_imageSizeObserver","updateSync","_this$_imageSizeObser","HypothesisInjector","_config","_frameObserver","injectClient","assetRoot","injectedConfig","configElement","innerText","bootScript","iframeDocument","findBookElement","document_","vitalSourceFrameRole","_window_$frameElement","parentDoc","frameElement","VitalSourceInjector","bookElement","contentFrames","injectClientIntoContentFrame","getPDFPageImage","VitalSourceContentIntegration","html_side_by_side","_htmlIntegration","stopEvents","insertAdjacentElement","removeScrollingAttr","makeContentFrameScrollable","bookImage","pageData","innerPageData","charRects","glyphs","glyph","_textLayer","_this$_textLayer","bookContainer","newWidth","scrollToAnchor","createIntegration","selectedRange","rangeCount","SelectionObserver","isMouseDown","_pendingCallback","scheduleCallback","eventHandler","_cancelPendingCallback","_document","itemForNode","checkedNodes","rangeUtil","_node$_annotation","_annotation","annotationsAt","getHighlightsContainingNode","ann","resolveAnchor","removeTextSelection","_document$getSelectio","removeAllRanges","Guest","_window$guests","_this$_integration$sh","_this$_integration","_highlightsVisible","_isAdderVisible","_informHostOnNextSelectionClear","selectedRanges","_adder","createAnnotation","selectAnnotations","_selectionObserver","_onSelection","_onClearSelection","_annotations","_frameIdentifier","_portFinder","_integration","getDocumentInfo","_sidebarRPC","_connectHost","_connectSidebar","_bucketBarClient","_setupElementEvents","_focusedAnnotations","maybeCloseSidebar","_repositionAdder","frameIdentifier","_window$getSelection","_focusAnnotations","_scrollToClosestOffScreenAnchor","ancestor","hostPort","discover","bubbles","cancelable","detail","setHighlightsVisible","_this$_integration$sh2","_this$_integration2","removeAllHighlights","$orphan","every","_updateAnchors","notify","ranges","$highlight","closestAnchor","closestTop","findClosestOffscreenAnchor","isBackwards","focusRect","visible","sideBySideActive","focusedAnnotationTags","addConfigFragment","baseURL","params","URLSearchParams","hash","createAppConfig","appURL","_appConfig$services","hostURL","service","onLoginRequest","onLoginRequestProvided","onLogoutRequest","onLogoutRequestProvided","onSignupRequest","onSignupRequestProvided","onProfileRequest","onProfileRequestProvided","onHelpRequest","onHelpRequestProvided","NotebookIframe","groupId","allowFullScreen","NotebookModal","iframeKey","setIframeKey","useState","isHidden","setIsHidden","setGroupId","originalDocumentOverflowStyle","emitterRef","emitter","createEmitter","subscribe","hidden","_emitterRef$current","publish","Notebook","exportName","VENDOR_PREFIXES","TEST_ELEMENT","round","setTimeoutContext","bindFn","invokeArrayArg","each","obj","iterator","deprecate","deprecationMessage","nextKey","extend","dest","merge","inherit","properties","childP","baseP","_super","boolOrFn","ifUndefined","val1","val2","addEventListeners","splitStr","removeEventListeners","hasParent","inStr","inArray","findByKey","toArray","uniqueArray","prefixed","prop","camelProp","_uniqueId","getWindowForElement","parentWindow","SUPPORT_TOUCH","SUPPORT_POINTER_EVENTS","SUPPORT_ONLY_TOUCH","INPUT_TYPE_TOUCH","INPUT_TYPE_MOUSE","DIRECTION_VERTICAL","DIRECTION_UP","PROPS_XY","PROPS_CLIENT_XY","Input","manager","inputTarget","domHandler","ev","enable","init","inputHandler","pointersLen","pointers","changedPointersLen","changedPointers","isFirst","isFinal","session","pointersLength","firstInput","simpleCloneInputData","firstMultiple","offsetCenter","center","getCenter","timeStamp","deltaTime","angle","getAngle","distance","getDistance","offsetDelta","prevDelta","prevInput","deltaX","deltaY","computeDeltaXY","offsetDirection","getDirection","overallVelocity","getVelocity","overallVelocityX","overallVelocityY","scale","rotation","getRotation","maxPointers","velocity","velocityX","velocityY","last","lastInterval","computeIntervalInputData","srcEvent","computeInputData","recognize","clientX","clientY","p1","p2","sqrt","atan2","PI","evEl","evTarget","evWin","MOUSE_INPUT_MAP","mousedown","mousemove","mouseup","MOUSE_ELEMENT_EVENTS","MOUSE_WINDOW_EVENTS","MouseInput","button","which","pointerType","POINTER_INPUT_MAP","pointerdown","pointermove","pointerup","pointercancel","pointerout","IE10_POINTER_TYPE_ENUM","POINTER_ELEMENT_EVENTS","POINTER_WINDOW_EVENTS","PointerEventInput","store","pointerEvents","MSPointerEvent","PointerEvent","removePointer","eventTypeNormalized","isTouch","storeIndex","pointerId","SINGLE_TOUCH_INPUT_MAP","touchstart","touchmove","touchend","touchcancel","SINGLE_TOUCH_TARGET_EVENTS","SINGLE_TOUCH_WINDOW_EVENTS","SingleTouchInput","started","normalizeSingleTouches","touches","changed","changedTouches","TOUCH_INPUT_MAP","TOUCH_TARGET_EVENTS","TouchInput","targetIds","getTouches","allTouches","targetTouches","changedTargetTouches","touch","TouchMouseInput","mouse","primaryTouch","lastTouches","recordTouches","eventData","setLastTouch","lastTouch","lts","isSyntheticEvent","dx","dy","inputEvent","inputData","isMouse","sourceCapabilities","firesTouchEvents","PREFIXED_TOUCH_ACTION","NATIVE_TOUCH_ACTION","TOUCH_ACTION_COMPUTE","TOUCH_ACTION_AUTO","TOUCH_ACTION_MANIPULATION","TOUCH_ACTION_NONE","TOUCH_ACTION_PAN_X","TOUCH_ACTION_PAN_Y","TOUCH_ACTION_MAP","touchMap","cssSupports","CSS","supports","getTouchActionProps","TouchAction","compute","actions","touchAction","recognizers","recognizer","getTouchAction","hasPanX","hasPanY","cleanTouchActions","preventDefaults","prevented","preventDefault","hasNone","isTapPointer","isTapMovement","isTapTouchTime","DIRECTION_LEFT","preventSrc","STATE_FAILED","Recognizer","defaults","simultaneous","requireFail","stateStr","directionStr","getRecognizerByNameIfManager","otherRecognizer","AttrRecognizer","PanRecognizer","pX","pY","PinchRecognizer","PressRecognizer","_timer","_input","RotateRecognizer","SwipeRecognizer","TapRecognizer","pTime","pCenter","Hammer","preset","Manager","recognizeWith","dropRecognizeWith","requireFailure","dropRequireFailure","hasRequireFailures","canRecognizeWith","additionalEvent","tryEmit","canEmit","inputDataClone","process","attrTest","optionPointers","isRecognized","isValid","threshold","DIRECTION_HORIZONTAL","directionTest","hasMoved","inOut","validPointers","validMovement","validTime","taps","interval","posThreshold","validTouchTime","failTimeout","validInterval","validMultiTap","tapCount","domEvents","inputClass","cssProps","userSelect","touchSelect","touchCallout","contentZooming","userDrag","tapHighlightColor","handlers","oldCssProps","toggleCssProps","stop","force","stopped","curRecognizer","existing","events","gestureEvent","initEvent","gesture","triggerDomEvent","INPUT_START","INPUT_MOVE","INPUT_END","INPUT_CANCEL","STATE_POSSIBLE","STATE_BEGAN","STATE_CHANGED","STATE_ENDED","STATE_RECOGNIZED","STATE_CANCELLED","DIRECTION_NONE","DIRECTION_RIGHT","DIRECTION_DOWN","DIRECTION_ALL","Tap","Pan","Swipe","Pinch","Rotate","Press","BucketList","BucketItem","topPosition","Buckets","above","below","buckets","onFocusAnnotations","onScrollToClosestOffScreenAnchor","onSelectAnnotations","showUpNavigation","showDownNavigation","onMouseEnter","onMouseOut","bucket","BucketBar","_bucketsContainer","_onFocusAnnotations","_onScrollToClosestOffScreenAnchor","_onSelectAnnotations","anchorPositions","aboveTags","belowTags","currentBucket","newBucket","aPos","isContainedWithin","updatedBottom","updatedHeight","computeBuckets","toogle","buttonProps","Toolbar","closeSidebar","isSidebarOpen","newAnnotationType","toggleHighlights","toggleSidebar","toggleSidebarRef","useMinimalControls","selected","ToolbarController","setSidebarOpen","_container","_useMinimalControls","_newAnnotationType","_sidebarOpen","_closeSidebar","_toggleSidebar","_toggleHighlights","_createAnnotation","_sidebarToggleButton","getWidth","minimal","sidebarOpen","open","highlightsVisible","sidebarToggleButton","MIN_RESIZE","Sidebar","_guestWithSelection","_guestRPC","iframe","sidebarURL","sidebarAppSrc","sidebarFrame","createSidebarIframe","bucketBar","externalFrame","iframeContainer","rpc","hypothesisSidebar","toolbarContainer","toolbar","_this$_guestWithSelec","_onResize","_gestureState","initial","final","_setupGestures","serviceConfig","_layoutState","_updateLayoutState","_setupSidebarEvents","_this$bucketBar","_this$_hammerManager","_hammerManager","onFrameConnected","_connectGuest","guestRPC","rootEl","newCount","elems","showFn","triggerElems","triggerElem","sidebarTrigger","_resetGestureState","toggleButton","_onPan","_updateLayout","renderFrame","margin","_this$iframeContainer","computedStyle","frameVisibleWidth","layoutState","delta","Emitter","_subscriptions","subEvent","subCallback","EventBus","icons","registerIcons","sidebarLinkElement","annotatorConfig","destroyables","removeWorkaround","_event$data","installPortCloseWorkaroundForSafari","sidebarConfig","portProvider","vitalSourceInjector","hypothesisInjector","guest","instance"],"mappings":"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"}